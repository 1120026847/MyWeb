<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¢¨å¢¨é£ Â· è‹±è¯­èƒŒå•è¯</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS v2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* è‡ªå®šä¹‰ç»†èŠ‚ */
    .btn { @apply px-4 py-2 rounded-2xl shadow font-medium transition active:scale-[.98]; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-ghost { @apply bg-white text-slate-700 hover:bg-slate-100 border border-slate-200; }
    .btn-danger { @apply bg-rose-600 text-white hover:bg-rose-700; }
    .chip { @apply text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-800">
  <!-- é¡¶æ  -->
  <header class="sticky top-0 z-20 bg-white/70 backdrop-blur shadow-sm">
    <div class="mx-auto max-w-4xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ğŸ“˜</span>
        <h1 class="text-lg sm:text-xl font-semibold">å¢¨å¢¨é£ Â· è‹±è¯­èƒŒå•è¯</h1>
        <span id="studyProgress" class="ml-3 chip hidden"></span>
      </div>
      <nav class="flex items-center gap-2">
        <button id="btnImport" class="btn btn-ghost hidden">å¯¼å…¥å•è¯</button>
        <button id="btnExport" class="btn btn-ghost hidden">å¯¼å‡ºå•è¯</button>
        <button id="btnUploadCloud" class="btn btn-ghost hidden">ä¸Šä¼ åˆ°äº‘ç«¯</button>
        <button id="btnDeleteLearned" class="btn btn-danger hidden">åˆ é™¤å·²æŒæ¡</button>
        <div id="authArea" class="ml-2"></div>
      </nav>
    </div>
  </header>

  <!-- ä¸»ä½“ -->
  <main class="mx-auto max-w-2xl px-4 py-8">
    <!-- å­¦ä¹ å¡ç‰‡ -->
    <section class="bg-white rounded-3xl shadow p-6 sm:p-8">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-sm text-slate-500">å½“å‰å•è¯</div>
          <div id="wordText" class="mt-1 text-3xl sm:text-4xl font-bold tracking-wide">â€”</div>
        </div>
        <span id="memoryBadge" class="chip">è®°å¿†åº¦ 0</span>
      </div>

      <div id="meaningBox" class="mt-5 hidden">
        <div class="text-sm text-slate-500">ä¸­æ–‡æ„æ€</div>
        <div id="meaningText" class="mt-1 text-xl sm:text-2xl font-semibold">â€”</div>
      </div>

      <div class="mt-8 flex flex-col sm:flex-row gap-3">
        <button id="btnShowMeaning" class="btn btn-primary w-full">æ˜¾ç¤ºæ„æ€</button>
        <button id="btnKnown" class="btn btn-ghost w-full hidden">è®¤è¯† âœ“</button>
        <button id="btnUnknown" class="btn btn-ghost w-full hidden">ä¸è®¤è¯† âœ—</button>
      </div>

      <p id="emptyHint" class="mt-6 text-center text-slate-500 hidden">è¯åº“ä¸ºç©ºæˆ–æ²¡æœ‰ç”Ÿè¯ï¼ˆè®°å¿†åº¦ â‰¤ 5ï¼‰ã€‚è¯·å¯¼å…¥å•è¯å¼€å§‹å­¦ä¹ ï½</p>
    </section>

    <!-- åˆ—è¡¨ï¼ˆå¯é€‰ï¼šå±•ç¤ºå…¨éƒ¨è¯ï¼‰ -->
    <details class="mt-6 bg-white rounded-2xl shadow p-5">
      <summary class="cursor-pointer text-slate-700 font-medium select-none">æŸ¥çœ‹å…¨éƒ¨å•è¯</summary>
      <div id="listContainer" class="mt-4 space-y-2 text-sm text-slate-600"></div>
    </details>
  </main>

  <!-- å¯¼å…¥å¼¹çª— -->
  <dialog id="importDialog" class="rounded-2xl p-0 w-[95vw] max-w-2xl">
    <form method="dialog" class="bg-white rounded-2xl shadow-xl">
      <div class="p-5 sm:p-6 border-b border-slate-200 flex items-center justify-between">
        <h3 class="font-semibold">æ‰¹é‡å¯¼å…¥å•è¯ï¼ˆCSV / æ¯è¡Œä¸€æ¡ï¼‰</h3>
        <button class="btn btn-ghost" value="cancel">å…³é—­</button>
      </div>
      <div class="p-5 sm:p-6 space-y-4">
        <p class="text-sm text-slate-600">æ ¼å¼æ”¯æŒï¼š
          <code class="px-1 bg-slate-100 rounded">apple,è‹¹æœ</code>ã€
          <code class="px-1 bg-slate-100 rounded">apple è‹¹æœ</code>ï¼Œæˆ–å¸¦è®°å¿†åº¦ï¼š
          <code class="px-1 bg-slate-100 rounded">apple,è‹¹æœ,2</code>
        </p>
        <textarea id="importTextarea" class="w-full h-56 p-3 bg-slate-50 rounded-xl border border-slate-200" placeholder="æ¯è¡Œä¸€æ¡ï¼Œä¾‹å¦‚ï¼š\nhello,ä½ å¥½\nworld,ä¸–ç•Œ"></textarea>
        <div class="text-xs text-slate-500">æç¤ºï¼šè‹¥é‡å¤å¯¼å…¥ï¼Œä¼˜å…ˆä»¥æœ¬æ¬¡å†…å®¹ä¸ºå‡†ï¼ˆupsertï¼‰ï¼Œå¯èƒ½é‡ç½®è¯¥è¯è®°å¿†åº¦ã€‚</div>
      </div>
      <div class="p-5 sm:p-6 border-t border-slate-200 flex justify-end gap-2">
        <button class="btn btn-ghost" value="cancel">å–æ¶ˆ</button>
        <button id="btnDoImport" class="btn btn-primary" value="confirm">å¼€å§‹å¯¼å…¥</button>
      </div>
    </form>
  </dialog>

  <!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
  <dialog id="authDialog" class="rounded-2xl p-0 w-[95vw] max-w-md">
    <form method="dialog" class="bg-white rounded-2xl shadow-xl">
      <div class="p-5 sm:p-6 border-b border-slate-200 flex items-center justify-between">
        <h3 id="authTitle" class="font-semibold">ç™»å½•</h3>
        <button class="btn btn-ghost" value="cancel">å…³é—­</button>
      </div>
      <div class="p-5 sm:p-6 space-y-3">
        <input id="authEmail" type="email" placeholder="é‚®ç®±" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200" required />
        <input id="authPassword" type="password" placeholder="å¯†ç ï¼ˆè‡³å°‘ 6 ä½ï¼‰" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200" required />
        <div class="flex items-center justify-between">
          <label class="text-sm text-slate-600">
            <input id="switchRegister" type="checkbox" class="mr-2" /> æ²¡è´¦å·ï¼Ÿå‹¾é€‰æ³¨å†Œ
          </label>
        </div>
        <p id="authMsg" class="text-sm text-slate-500"></p>
      </div>
      <div class="p-5 sm:p-6 border-t border-slate-200 flex justify-end gap-2">
        <button class="btn btn-ghost" value="cancel">å–æ¶ˆ</button>
        <button id="btnSubmitAuth" class="btn btn-primary" value="confirm">æäº¤</button>
      </div>
    </form>
  </dialog>

  <script>
    // ====== é…ç½®ä½ æä¾›çš„ Supabase é¡¹ç›®ï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰ ======
    const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== çŠ¶æ€ ======
    let user = null;
    let words = [];       // å…¨éƒ¨è¯
    let studyList = [];   // è®°å¿†åº¦ â‰¤ 5 çš„ç”Ÿè¯åˆ—è¡¨
    let idx = 0;          // å½“å‰ç´¢å¼•

    // ====== DOM ======
    const wordText = document.getElementById('wordText');
    const meaningBox = document.getElementById('meaningBox');
    const meaningText = document.getElementById('meaningText');
    const memoryBadge = document.getElementById('memoryBadge');

    const btnShowMeaning = document.getElementById('btnShowMeaning');
    const btnKnown = document.getElementById('btnKnown');
    const btnUnknown = document.getElementById('btnUnknown');

    const studyProgress = document.getElementById('studyProgress');
    const emptyHint = document.getElementById('emptyHint');
    const listContainer = document.getElementById('listContainer');

    const btnImport = document.getElementById('btnImport');
    const btnExport = document.getElementById('btnExport');
    const btnUploadCloud = document.getElementById('btnUploadCloud');
    const btnDeleteLearned = document.getElementById('btnDeleteLearned');

    const importDialog = document.getElementById('importDialog');
    const importTextarea = document.getElementById('importTextarea');
    const btnDoImport = document.getElementById('btnDoImport');

    const authArea = document.getElementById('authArea');
    const authDialog = document.getElementById('authDialog');
    const authTitle = document.getElementById('authTitle');
    const switchRegister = document.getElementById('switchRegister');
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');
    const btnSubmitAuth = document.getElementById('btnSubmitAuth');
    const authMsg = document.getElementById('authMsg');

    // ====== å·¥å…·å‡½æ•° ======
    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    function renderList() {
      listContainer.innerHTML = '';
      if (!words.length) {
        listContainer.innerHTML = '<div class="text-slate-400">æš‚æ— æ•°æ®</div>';
        return;
      }
      for (const w of words) {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between border border-slate-200 rounded-xl p-3';
        row.innerHTML = `
          <div class="flex-1">
            <div class="font-semibold">${escapeHtml(w.word)}</div>
            <div class="text-xs text-slate-500">${escapeHtml(w.meaning)}</div>
          </div>
          <div class="chip">è®°å¿†åº¦ ${w.memory}</div>
        `;
        listContainer.appendChild(row);
      }
    }

    const escapeHtml = (s) => (s+"").replace(/[&<>"])/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

    function rebuildStudyList() {
      studyList = words.filter(w => (w.memory ?? 0) <= 5);
      idx = 0;
      updateProgress();
    }

    function updateProgress() {
      if (!studyList.length) {
        hide(studyProgress);
      } else {
        studyProgress.textContent = `ç”Ÿè¯ ${idx + 1}/${studyList.length}`;
        show(studyProgress);
      }
    }

    function renderCurrent() {
      if (!studyList.length) {
        wordText.textContent = 'â€”';
        meaningText.textContent = 'â€”';
        memoryBadge.textContent = 'è®°å¿†åº¦ 0';
        hide(meaningBox); hide(btnKnown); hide(btnUnknown);
        show(btnShowMeaning);
        show(emptyHint);
        return;
      }
      hide(emptyHint);
      const cur = studyList[idx];
      wordText.textContent = cur.word;
      meaningText.textContent = cur.meaning;
      memoryBadge.textContent = `è®°å¿†åº¦ ${cur.memory}`;
      hide(meaningBox); hide(btnKnown); hide(btnUnknown);
      show(btnShowMeaning);
      updateProgress();
    }

    function nextWord() {
      if (!studyList.length) return;
      idx = (idx + 1) % studyList.length;
      renderCurrent();
    }

    btnShowMeaning.addEventListener('click', () => {
      show(meaningBox);
      hide(btnShowMeaning);
      show(btnKnown);
      show(btnUnknown);
    });

    btnKnown.addEventListener('click', async () => {
      await adjustMemory(+1);
    });

    btnUnknown.addEventListener('click', async () => {
      await adjustMemory(-1);
    });

    async function adjustMemory(delta) {
      if (!studyList.length) return;
      const cur = studyList[idx];
      const newVal = (cur.memory ?? 0) + delta;
      // æ›´æ–°æ•°æ®åº“
      const { error } = await supabase.from('words').update({ memory: newVal }).eq('id', cur.id);
      if (error) { alert('æ›´æ–°å¤±è´¥ï¼š' + error.message); return; }
      // æ›´æ–°æœ¬åœ°
      cur.memory = newVal;
      const target = words.find(w => w.id === cur.id);
      if (target) target.memory = newVal;
      // è‹¥è¶…è¿‡ 5ï¼Œå°±ä»ç”Ÿè¯åˆ—è¡¨ç§»é™¤
      if (newVal > 5) {
        rebuildStudyList();
      } else {
        nextWord();
      }
      renderList();
    }

    // ====== å¯¼å…¥ / å¯¼å‡º ======
    btnImport.addEventListener('click', () => importDialog.showModal());

    btnDoImport.addEventListener('click', async (e) => {
      e.preventDefault();
      const lines = importTextarea.value.split(/\n+/).map(s => s.trim()).filter(Boolean);
      if (!lines.length) { importDialog.close(); return; }
      const payload = [];
      for (const line of lines) {
        let parts = line.split(',');
        if (parts.length < 2) {
          parts = line.split('ï¼Œ'); // å…¼å®¹ä¸­æ–‡é€—å·
        }
        if (parts.length < 2) {
          // æœ€åå°è¯•æŒ‰ç©ºç™½æ‹†åˆ†ï¼šè‹±æ–‡ ç¬¬ä¸€æ®µï¼›ä¸­æ–‡ å…¶ä½™
          const segs = line.split(/\s+/);
          if (segs.length >= 2) {
            parts = [segs[0], segs.slice(1).join(' ')];
          }
        }
        if (parts.length < 2) continue;
        const word = parts[0].trim();
        const meaning = parts[1].trim();
        const memory = parts[2] !== undefined ? parseInt(parts[2], 10) || 0 : 0;
        payload.push({ word, meaning, memory });
      }
      if (!payload.length) { alert('æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®'); return; }
      // upsertï¼šé¿å…é‡å¤ï¼ˆåŸºäº user_id + word çš„å”¯ä¸€çº¦æŸï¼‰
      const rows = payload.map(r => ({ ...r, user_id: user.id }));
      const { error } = await supabase.from('words').upsert(rows, { onConflict: 'user_id,word' }).select();
      if (error) { alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message); return; }
      importDialog.close();
      importTextarea.value = '';
      await loadWords();
      alert('å¯¼å…¥å®Œæˆ âœ…');
    });

    btnExport.addEventListener('click', async () => {
      const csv = toCSV(words);
      const filename = `words-${new Date().toISOString().slice(0,10)}.csv`;
      downloadText(csv, filename);
    });

    btnUploadCloud.addEventListener('click', async () => {
      try {
        const csv = toCSV(words);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const filename = `words-${new Date().toISOString().replace(/[:T]/g,'-').slice(0,19)}.csv`;
        const path = `${user.id}/${filename}`;
        const { error } = await supabase.storage.from('wordlists').upload(path, blob, { upsert: true, contentType: 'text/csv' });
        if (error) throw error;
        alert('å·²ä¸Šä¼ åˆ°äº‘ç«¯ Storage âœ…\nï¼ˆBucket: wordlistsï¼‰');
      } catch (e) {
        alert('ä¸Šä¼ å¤±è´¥ï¼š' + e.message + '\nè¯·å…ˆåœ¨ Supabase åˆ›å»º wordlists bucket å¹¶è®¾ç½® RLS ç­–ç•¥');
      }
    });

    btnDeleteLearned.addEventListener('click', async () => {
      if (!confirm('ç¡®å®šåˆ é™¤è®°å¿†åº¦ > 5 çš„å•è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
      const { error } = await supabase.from('words').delete().gt('memory', 5);
      if (error) { alert('åˆ é™¤å¤±è´¥ï¼š' + error.message); return; }
      await loadWords();
      alert('å·²åˆ é™¤è®°å¿†åº¦ > 5 çš„å•è¯ âœ…');
    });

    function toCSV(arr) {
      const rows = arr.map(r => [r.word, r.meaning, r.memory ?? 0].map(v => escapeCSV(v)).join(','));
      return 'word,meaning,memory\n' + rows.join('\n');
    }
    function escapeCSV(v) {
      const s = String(v ?? '').replace(/"/g, '""');
      return /[",\n]/.test(s) ? `"${s}"` : s;
    }
    function downloadText(text, filename) {
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 2000);
    }

    // ====== Auth UI ======
    function renderAuthArea() {
      authArea.innerHTML = '';
      if (!user) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-primary';
        btn.textContent = 'ç™»å½•/æ³¨å†Œ';
        btn.onclick = () => authDialog.showModal();
        authArea.appendChild(btn);
        hide(btnImport); hide(btnExport); hide(btnUploadCloud); hide(btnDeleteLearned);
      } else {
        const emailSpan = document.createElement('span');
        emailSpan.className = 'chip';
        emailSpan.textContent = user.email || 'å·²ç™»å½•';
        const btn = document.createElement('button');
        btn.className = 'btn btn-ghost';
        btn.textContent = 'é€€å‡ºç™»å½•';
        btn.onclick = async () => { await supabase.auth.signOut(); };
        authArea.appendChild(emailSpan);
        authArea.appendChild(btn);
        show(btnImport); show(btnExport); show(btnUploadCloud); show(btnDeleteLearned);
      }
    }

    // ç™»å½•/æ³¨å†Œåˆ‡æ¢
    switchRegister.addEventListener('change', () => {
      const isReg = switchRegister.checked;
      authTitle.textContent = isReg ? 'æ³¨å†Œ' : 'ç™»å½•';
      btnSubmitAuth.textContent = 'æäº¤';
      authMsg.textContent = isReg ? 'æ³¨å†ŒæˆåŠŸåå¯èƒ½éœ€è¦é‚®ä»¶éªŒè¯ï¼ˆå–å†³äºé¡¹ç›®è®¾ç½®ï¼‰ã€‚' : '';
    });

    btnSubmitAuth.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = authEmail.value.trim();
      const password = authPassword.value.trim();
      if (!email || !password) return;
      try {
        if (switchRegister.checked) {
          const { error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          authMsg.textContent = 'æ³¨å†ŒæˆåŠŸï¼Œè¯·æ£€æŸ¥é‚®ç®±è¿›è¡ŒéªŒè¯ï¼ˆè‹¥å·²å¼€å¯ï¼‰ã€‚';
        } else {
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          authDialog.close();
        }
      } catch (err) {
        authMsg.textContent = 'é”™è¯¯ï¼š' + err.message;
      }
    });

    // ====== æ•°æ®åŠ è½½ ======
    async function loadWords() {
      if (!user) return;
      const { data, error } = await supabase.from('words').select('*').order('created_at', { ascending: true });
      if (error) { alert('åŠ è½½å¤±è´¥ï¼š' + error.message); return; }
      words = data || [];
      rebuildStudyList();
      renderCurrent();
      renderList();
    }

    // ====== å¯åŠ¨ & ç›‘å¬ ======
    (async function init() {
      // å…ˆç›‘å¬ï¼Œå†è·å– sessionï¼ˆå¯é¿å…æç«¯ç«æ€ï¼‰
      supabase.auth.onAuthStateChange((_event, session) => {
        user = session?.user || null;
        renderAuthArea();
        if (user) loadWords(); else { words = []; studyList = []; renderCurrent(); renderList(); }
      });
      const { data: { session } } = await supabase.auth.getSession();
      user = session?.user || null;
      renderAuthArea();
      if (user) await loadWords(); else renderCurrent();
    })();
  </script>
</body>
</html>
