<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>背单词123123</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f7f9fc;--card:#fff;--line:#e5e7eb;--text:#0b1220;--muted:#6b7280;
    --accent:#2563eb;--accent-weak:#eef2ff;--green:#22c55e;--red:#ef4444;--radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .container{padding:12px 16px}
  .nav{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:clamp(18px,4.5vw,22px)}
  .account{margin-left:auto;display:flex;gap:10px;align-items:center}
  .account-btn{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe;
    padding:8px 12px;border-radius:999px;font-weight:600;max-width:70vw;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }
  .pill{font-size:12px;color:#666;border:1px solid #e1e1e1;border-radius:999px;padding:4px 8px;background:#fff}
  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);
        padding:16px;box-shadow:0 6px 26px rgba(0,0,0,.06);max-width:920px;margin:16px auto}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  button{border-radius:12px;padding:12px 16px;border:1px solid #cfe3ff;background:var(--accent-weak);color:#1e3a8a;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  button.green{background:var(--green);color:#fff;border:none}
  button.red{background:var(--red);color:#fff;border:none}
  button:disabled{opacity:.6;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .word{font-size:clamp(28px,8vw,64px);text-align:center;margin:36px 0 10px}
  .meaning{font-size:clamp(20px,6vw,36px);text-align:center;color:#1e40af;min-height:40px;display:none;margin:18px 0}
  .actions{display:flex;justify-content:center;gap:12px;margin:26px 0 10px;flex-wrap:wrap}
  /* 进度条放在按钮下面并留空隙 */
  .progress-wrap{display:flex;justify-content:center;margin:12px 0 4px}
  .bar{width:86%;height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#22c55e)}
  /* 弹出提示 */
  .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;background:#111827;color:#fff;padding:10px 14px;border-radius:12px}
  /* 模态（登录/注册/账户） */
  .modal{position:fixed;inset:0;z-index:30000;display:none}
  .modal.show{display:block}
  .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .modal .panel{
    position:absolute;left:50%;top:10%;transform:translateX(-50%);
    width:min(92vw,480px);max-height:80vh;overflow:auto;
    background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px
  }
  @media (max-width:680px){
    .modal .panel{left:12px;right:12px;top:auto;bottom:12px;transform:none;width:auto;max-height:84vh;border-radius:16px 16px 12px 12px}
  }
  .modal .close-x{position:absolute;right:10px;top:10px;width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .modal .title{margin:0 40px 10px 0;font-size:18px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  textarea,input[type="text"]{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font:inherit}
  .m-pop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:20000;align-items:center;justify-content:center}
  .m-pop .dialog{background:#fff;padding:16px;border-radius:14px;width:min(92vw,560px)}
  .m-pop .actions{display:flex;justify-content:flex-end;margin:8px 0 0}
  .debug{background:#f0f0f0;border:1px solid #ccc;padding:8px;font-family:monospace;font-size:12px;margin:8px 0;white-space:pre-wrap}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <h1>背单词（墨墨风格）</h1>
    <div class="account">
      <span id="syncBadge" class="pill">离线 · 未登录</span>
      <button id="accountBtn" class="account-btn" type="button">登录 / 注册</button>
    </div>
  </div>
</header>

<main class="card">
  <div class="toolbar">
    <input id="fileInput" type="file" hidden accept="application/json" />
    <button id="btnImportJson" type="button">导入 JSON</button>
    <button id="btnImportText" type="button">导入单词（文本）</button>
    <button id="btnExport" class="primary" type="button">导出 JSON</button>
    <button id="btnSync" style="margin-left:auto" type="button">保存 / 加载</button>
  </div>

  <div id="emptyMsg" class="muted" style="text-align:center;margin:20px 0;display:none">词库为空，请先导入</div>

  <div id="word" class="word"></div>
  <div id="meaning" class="meaning"></div>

  <div class="actions">
    <button id="btnShow" class="primary" type="button">显示意思</button>
    <button id="btnKnow" class="green" style="display:none" type="button">认识</button>
    <button id="btnDont" class="red" style="display:none" type="button">不认识</button>
    <button id="btnRestart" style="display:none" type="button">重新开始</button>
  </div>

  <!-- 进度条在按钮下面 -->
  <div class="progress-wrap"><div class="bar"><i id="progress"></i></div></div>
  
  <!-- 调试信息 -->
  <div id="debugInfo" class="debug" style="display:none"></div>
</main>

<!-- 文本导入弹窗 -->
<div id="dlgImportText" class="m-pop">
  <div class="dialog">
    <h3 style="margin:0 0 8px">批量导入（每行：英文 空格 中文）</h3>
    <textarea id="textBulk" placeholder="apple 苹果&#10;take off 脱下；起飞"></textarea>
    <div class="actions">
      <button id="okImportText" class="primary" type="button">确定</button>
      <button id="cancelImportText" type="button">取消</button>
    </div>
  </div>
</div>

<!-- 账号模态 -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-hidden="true">
  <div class="backdrop" id="modalBackdrop"></div>
  <div class="panel" role="document">
    <button class="close-x" id="modalClose" aria-label="关闭" type="button">✕</button>
    <h3 id="dialogTitle" class="title">登录 / 注册</h3>
    <div id="dialogBody"></div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ========= 修复的地方：优化错误处理和调试信息 ========= */

/* ========= 1) Supabase ========= */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';        
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

// 更稳妥的会话存储（localStorage 不可用时回退至 Cookie）
const cookieStorage = {
  getItem:k=>{const m=document.cookie.match(new RegExp('(?:^|; )'+encodeURIComponent(k)+'=([^;]*)'));return m?decodeURIComponent(m[1]):null},
  setItem:(k,v)=>{const e=new Date();e.setFullYear(e.getFullYear()+1);document.cookie=`${encodeURIComponent(k)}=${encodeURIComponent(v)}; Path=/; Expires=${e.toUTCString()}; SameSite=Lax; Secure`},
  removeItem:k=>{document.cookie=`${encodeURIComponent(k)}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax; Secure`}
};
function safeStorage(){try{const t='__sb__'+Math.random();localStorage.setItem(t,'1');localStorage.removeItem(t);return localStorage}catch{return cookieStorage}}
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:false, storage: safeStorage(), storageKey:'sb-words-auth' }
});

/* ========= 2) DOM & 状态 ========= */
const $=id=>document.getElementById(id);
const els={
  word:$('word'), meaning:$('meaning'), progress:$('progress'), empty:$('emptyMsg'),
  btnShow:$('btnShow'), btnKnow:$('btnKnow'), btnDont:$('btnDont'), btnRestart:$('btnRestart'),
  fileInput:$('fileInput'), btnImportJson:$('btnImportJson'), btnImportText:$('btnImportText'),
  btnExport:$('btnExport'), btnSync:$('btnSync'),
  dlgImportText:$('dlgImportText'), textBulk:$('textBulk'), okImportText:$('okImportText'), cancelImportText:$('cancelImportText'),
  accountBtn:$('accountBtn'), sync:$('syncBadge'),
  modal:$('modal'),backdrop:$('modalBackdrop'),close:$('modalClose'),title:$('dialogTitle'),body:$('dialogBody'),
  toast:$('toast'), debug:$('debugInfo')
};
let sessionUser=null, rtChannel=null;
let dataMap = {};   // { word: { meaning, memoryLevel } }
let queue = [];     // 学习队列
let cur = null;     // 当前

/* ========= 3) 小工具 ========= */
function showToast(msg, ms=1800){ els.toast.textContent=msg; els.toast.style.display='block'; setTimeout(()=>{els.toast.style.display='none'}, ms); }
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
const saveLocal=()=>{try{localStorage.setItem('words_local',JSON.stringify(dataMap))}catch(e){log('saveLocal error',e)}};
const loadLocal=()=>{try{dataMap=JSON.parse(localStorage.getItem('words_local')||'{}')||{}}catch{dataMap={}}};

function updateBadge(){
  const parts=[]; parts.push(navigator.onLine?'🟢 在线':'🔴 离线'); parts.push(sessionUser?`已登录：${sessionUser.email||'用户'}`:'未登录');
  els.sync.textContent = parts.join(' · ');
}
window.addEventListener('online',updateBadge);
window.addEventListener('offline',updateBadge);

function log(...args){ 
  console.log('[WORDS]', ...args); 
  // 显示调试信息
  const debugText = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
  els.debug.textContent += new Date().toLocaleTimeString() + ': ' + debugText + '\n';
  els.debug.style.display = 'block';
  // 只保留最后10行
  const lines = els.debug.textContent.split('\n');
  if(lines.length > 10){
    els.debug.textContent = lines.slice(-10).join('\n');
  }
}

/* ========= 4) 登录模态 ========= */
let lastFocus=null;
function openModal(title,html){
  els.title.textContent=title;els.body.innerHTML=html;
  lastFocus=document.activeElement;els.modal.classList.add('show');els.modal.removeAttribute('aria-hidden');
  document.body.style.overflow='hidden';
  const f=els.body.querySelector('input,button');if(f)setTimeout(()=>f.focus(),0);
}
function closeModal(){ els.modal.classList.remove('show');els.modal.setAttribute('aria-hidden','true');document.body.style.overflow=''; if(lastFocus)lastFocus.focus(); }
els.backdrop.onclick=closeModal;els.close.onclick=closeModal;document.addEventListener('keydown',e=>{if(e.key==='Escape'&&els.modal.classList.contains('show'))closeModal()});

function showAuth(){
  openModal('登录 / 注册', `
    <div class="field"><label>邮箱</label><input id="em" type="email" placeholder="you@example.com"></div>
    <div class="field"><label>密码（≥6位）</label><input id="pw" type="password" placeholder="******"></div>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <button id="lg" class="primary" type="button">登录</button>
      <button id="sg" type="button">注册</button>
    </div>
    <div id="hint" class="muted" style="margin-top:6px"></div>
  `);
  const hint=$('hint');
  $('lg').onclick=async()=>{
    try{
      const email=$('em').value.trim(),password=$('pw').value;
      if(!email||!password){hint.textContent='请输入邮箱和密码';return}
      log('尝试登录', email);
      const { error, data } = await sb.auth.signInWithPassword({ email,password });
      if(error){ 
        log('登录失败', error);
        hint.textContent='登录失败：'+error.message; 
        return; 
      }
      log('登录成功', data);
      showToast('登录成功'); closeModal();
    }catch(err){ 
      log('登录异常', err);
      hint.textContent='登录异常：'+(err?.message||err)
    }
  };
  $('sg').onclick=async()=>{
    try{
      const email=$('em').value.trim(),password=$('pw').value;
      if(!email||!password){hint.textContent='请输入邮箱和密码';return}
      log('尝试注册', email);
      const { error, data } = await sb.auth.signUp({ email,password });
      log('注册结果', { error, data });
      hint.textContent = error ? ('注册失败：'+error.message) : '注册成功。如开启邮箱验证，请到邮箱确认后再登录。';
    }catch(err){ 
      log('注册异常', err);
      hint.textContent='注册异常：'+(err?.message||err)
    }
  };
}
function showAccount(u){
  openModal('账户', `
    <div class="field"><div class="muted">邮箱：${u.email||''}</div></div>
    <div class="row" style="gap:8px;justify-content:flex-end"><button id="lo" class="primary" type="button">退出登录</button></div>
  `);
  $('lo').onclick=async()=>{ await sb.auth.signOut(); showToast('已退出'); closeModal(); };
}
els.accountBtn.onclick=()=>{sessionUser?showAccount(sessionUser):showAuth()};

/* ========= 5) 学习流程 ========= */
function resetQueue(){
  queue = shuffle(Object.entries(dataMap));
  cur=null;
  els.progress.style.width='0%';
  els.meaning.style.display='none';
  els.btnShow.style.display='inline-block';
  els.btnKnow.style.display='none';
  els.btnDont.style.display='none';
  els.btnRestart.style.display='none';
  els.empty.style.display = queue.length? 'none':'block';
  next();
}
function next(){
  if(queue.length===0){
    els.word.textContent='恭喜，今日学习完成！';
    els.meaning.style.display='none';
    els.btnShow.style.display='none';
    els.btnKnow.style.display='none';
    els.btnDont.style.display='none';
    els.btnRestart.style.display='inline-block';
    return;
  }
  cur = queue.pop();
  els.word.textContent = cur[0];
  els.meaning.textContent = cur[1].meaning || '';
  els.meaning.style.display='none';
  els.btnShow.style.display='inline-block';
  els.btnKnow.style.display='none';
  els.btnDont.style.display='none';
  els.btnRestart.style.display='none';
  updateProgress();
}
function updateProgress(){
  const total = Object.keys(dataMap).length || 1;
  const remain = queue.length;
  els.progress.style.width = (((total-remain)/total*100).toFixed(1))+'%';
}
els.btnShow.onclick=()=>{ els.meaning.style.display='block'; els.btnShow.style.display='none'; els.btnKnow.style.display='inline-block'; els.btnDont.style.display='inline-block'; };
els.btnKnow.onclick=()=>vote(true);
els.btnDont.onclick=()=>vote(false);
els.btnRestart.onclick=resetQueue;

function vote(known){
  if(!cur) return;
  const [w, v] = cur;
  v.memoryLevel = (v.memoryLevel||0) + (known?1:-1);
  if(!known){ queue.unshift([w,v]); }
  dataMap[w] = v; saveLocal();
  if(sessionUser) updateOne(w).catch(err=>log('updateOne error', err));
  next();
}

/* ========= 6) 导入导出 ========= */
els.btnImportJson.onclick=()=>els.fileInput.click();
els.fileInput.onchange=async e=>{
  const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); e.target.value='';
  try{
    const obj=JSON.parse(text);
    Object.assign(dataMap, obj); saveLocal();
    if(sessionUser) await upsertMany(obj);
    resetQueue(); showToast('导入 JSON 完成');
  }catch(err){ alert('JSON 解析失败：'+(err?.message||err)) }
};

els.btnImportText.onclick=()=>{ els.dlgImportText.style.display='flex'; };
els.cancelImportText.onclick=()=>{ els.dlgImportText.style.display='none'; };
els.okImportText.onclick=()=>{
  const lines=(els.textBulk.value||'').split('\n').map(s=>s.trim()).filter(Boolean);
  const obj={};
  for(const line of lines){
    const [w,...rest]=line.split(/\s+/); const meaning=rest.join(' ');
    if(w && meaning){ obj[w] = { meaning, memoryLevel: dataMap[w]?.memoryLevel||0 }; }
  }
  Object.assign(dataMap,obj); saveLocal();
  if(sessionUser) upsertMany(obj).catch(err=>log('upsertMany error', err));
  els.textBulk.value=''; els.dlgImportText.style.display='none'; resetQueue();
  showToast(`导入 ${Object.keys(obj).length} 个单词`);
};

els.btnExport.onclick=()=>exportJSON();

async function exportJSON(){
  try{
    if(sessionUser){
      log('导出云端数据');
      const { data, error } = await sb.from('words')
        .select('word,meaning,memory_level')
        .eq('user_id', sessionUser.id)
        .order('created_at',{ascending:true});
      if(error) throw error;
      log('云端数据条数', data?.length || 0);
      const map={}; (data||[]).forEach(r=>map[r.word]={meaning:r.meaning,memoryLevel:r.memory_level||0});
      return downloadJSON(map,'words_cloud.json');
    }
    log('导出本地数据');
    return downloadJSON(dataMap,'words_local.json');
  }catch(err){
    log('导出失败', err);
    alert('导出失败：'+(err?.message||err));
  }
}
function downloadJSON(obj, filename){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.style.display='none'; a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},0);
}

/* ========= 7) 一键保存 / 加载（本地→云 & 云→本地） ========= */
els.btnSync.onclick = async ()=>{
  if(!sessionUser){ 
    alert('请先登录'); 
    return; 
  }
  
  els.btnSync.disabled = true;
  els.btnSync.textContent = '同步中...';
  
  try{
    log('开始同步，本地单词数', Object.keys(dataMap).length);
    
    // 1) 本地 → 云端（批量 upsert），分批处理避免超时
    const localEntries = Object.entries(dataMap);
    if(localEntries.length > 0){
      log('上传本地数据到云端');
      
      // 分批处理，每次100个
      const BATCH_SIZE = 100;
      for(let i = 0; i < localEntries.length; i += BATCH_SIZE){
        const batch = localEntries.slice(i, i + BATCH_SIZE);
        const rows = batch.map(([w,v])=>({
          user_id:sessionUser.id, 
          word:w, 
          meaning:v.meaning||'', 
          memory_level:v.memoryLevel||0
        }));
        
        log(`上传批次 ${Math.floor(i/BATCH_SIZE) + 1}，包含 ${rows.length} 个单词`);
        
        const { error } = await sb.from('words')
          .upsert(rows, { onConflict:'user_id,word' });
          
        if(error){
          log('批次上传失败', error);
          throw error;
        }
        
        // 给UI一点时间更新
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      log('本地数据上传完成');
    }
    
    // 2) 云端 → 本地（覆盖加载）
    log('从云端加载数据');
    await loadAllFromCloud();
    log('同步完成');
    showToast('已保存并加载（同步完成）');
    
  }catch(err){
    log('同步失败', err);
    const msg=(err && err.message)||String(err);
    
    // 更详细的错误信息
    let errorDetails = msg;
    if(err.code){
      errorDetails += `\n错误代码: ${err.code}`;
    }
    if(err.details){
      errorDetails += `\n详细信息: ${err.details}`;
    }
    if(err.hint){
      errorDetails += `\n提示: ${err.hint}`;
    }
    
    alert('保存/加载失败：' + errorDetails + '\n\n请检查:\n1. 网络连接\n2. Supabase配置\n3. 数据库表是否存在\n4. RLS策略是否正确');
  }finally{
    els.btnSync.disabled = false;
    els.btnSync.textContent = '保存 / 加载';
    updateBadge();
  }
};

/* ========= 8) 云端 CRUD ========= */
async function loadAllFromCloud(){
  if(!sessionUser) return;
  log('查询用户单词数据', sessionUser.id);
  
  const { data, error } = await sb.from('words')
    .select('word,meaning,memory_level')
    .eq('user_id',sessionUser.id)
    .order('created_at',{ascending:true});
    
  if(error){ 
    log('查询失败', error);
    throw error; 
  }
  
  log('查询到单词数量', data?.length || 0);
  const map={}; 
  (data||[]).forEach(r=>{
    map[r.word]={
      meaning:r.meaning||'',
      memoryLevel:r.memory_level||0
    };
  });
  
  dataMap = map; 
  saveLocal(); 
  resetQueue(); 
  updateBadge();
  log('本地数据已更新');
}

async function upsertMany(obj){
  if(!sessionUser) return;
  const rows = Object.entries(obj).map(([w,v])=>({ 
    user_id:sessionUser.id, 
    word:w, 
    meaning:v.meaning||'', 
    memory_level:v.memoryLevel||0 
  }));
  if(rows.length===0) return;
  
  log('批量upsert', rows.length, '个单词');
  const { error } = await sb.from('words').upsert(rows, { onConflict:'user_id,word' });
  if(error){
    log('upsertMany失败', error);
    throw error;
  }
}

async function updateOne(word){
  if(!sessionUser) return;
  const v=dataMap[word]; if(!v) return;
  const { error } = await sb.from('words').upsert(
    { user_id:sessionUser.id, word, meaning:v.meaning||'', memory_level:v.memoryLevel||0 },
    { onConflict:'user_id,word' }
  );
  if(error) {
    log('updateOne失败', word, error);
    throw error;
  }
}

/* ========= 9) Realtime（可选） ========= */
function subscribeRealtime(){
  if(rtChannel) sb.removeChannel(rtChannel);
  if(!sessionUser) return;
  
  log('订阅实时更新', sessionUser.id);
