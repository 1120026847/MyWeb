<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>èƒŒå•è¯ï¼ˆå¢¨å¢¨é£æ ¼ï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f7f9fc;--card:#fff;--line:#e5e7eb;--text:#0b1220;--muted:#6b7280;
    --accent:#2563eb;--accent-weak:#eef2ff;--green:#22c55e;--red:#ef4444;--radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}

  /* é¡¶éƒ¨ + å®‰å…¨åŒº */
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);
         padding-top:env(safe-area-inset-top)}
  .container{padding:12px 16px}

  /* ç”¨ Grid è®©æ ‡é¢˜ä¸è´¦å·åŒºåœ¨çª„å±è‡ªç„¶æ¢è¡Œ */
  .nav{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px}
  h1{margin:0;font-size:clamp(18px,4.5vw,22px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .account{
    margin-left:auto;display:grid;grid-auto-flow:column;grid-auto-columns:max-content;align-items:center;gap:8px
  }
  .account-btn{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe;
    padding:8px 12px;border-radius:999px;font-weight:600;max-width:70vw;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }
  .pill{font-size:12px;color:#666;border:1px solid #e1e1e1;border-radius:999px;padding:4px 8px;background:#fff}

  .card{
    background:#fff;border:1px solid var(--line);border-radius:var(--radius);
    padding:16px;box-shadow:0 6px 26px rgba(0,0,0,.06);max-width:920px;margin:16px auto
  }

  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)}

  button{border-radius:12px;padding:12px 16px;border:1px solid #cfe3ff;background:var(--accent-weak);color:#1e3a8a;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  button.green{background:var(--green);color:#fff;border:none}
  button.red{background:var(--red);color:#fff;border:none}
  button:disabled{opacity:.6;cursor:not-allowed}

  /* å·¥å…·æ ï¼šè‡ªé€‚åº”ç½‘æ ¼ï¼›æ‰‹æœºä¸Šâ€œä¿å­˜/åŒæ­¥â€ç‹¬å ä¸€è¡Œï¼Œæ˜“ç‚¹æŒ‰ */
  .toolbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;justify-content:stretch}
  #btnSync{justify-self:end}

  .word{font-size:clamp(28px,8vw,64px);text-align:center;margin:36px 0 10px}
  .meaning{font-size:clamp(20px,6vw,36px);text-align:center;color:#1e40af;min-height:40px;display:none;margin:18px 0}

  .actions{display:flex;justify-content:center;gap:12px;margin:26px 0 10px;flex-wrap:wrap}

  /* è¿›åº¦æ¡ */
  .progress-wrap{display:flex;justify-content:center;margin:12px 0 4px;padding:0 8px}
  .bar{width:100%;height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#22c55e)}

  /* Toast */
  .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;background:#111827;color:#fff;padding:10px 14px;border-radius:12px}

  /* æ¨¡æ€ï¼ˆç™»å½•/æ³¨å†Œ/è´¦æˆ·ï¼‰ */
  .modal{position:fixed;inset:0;z-index:30000;display:none}
  .modal.show{display:block}
  .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .modal .panel{
    position:absolute;left:50%;top:10%;transform:translateX(-50%);
    width:min(92vw,480px);max-height:80vh;overflow:auto;
    background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px
  }
  @media (max-width:680px){
    .modal .panel{left:12px;right:12px;top:auto;bottom:12px;transform:none;width:auto;max-height:84vh;border-radius:16px 16px 12px 12px}
    .nav{grid-template-columns:1fr}
    .account{margin:0;grid-auto-flow:row;justify-items:stretch}
    .account-btn{max-width:100%}
    #btnSync{grid-column:1 / -1;justify-self:stretch}
  }
  .modal .close-x{position:absolute;right:10px;top:10px;width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .modal .title{margin:0 40px 10px 0;font-size:18px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  textarea,input[type="text"],input[type="email"],input[type="password"]{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font:inherit}
</style>
</head>

<body>
<header>
  <div class="container nav">
    <h1>èƒŒå•è¯ï¼ˆå¢¨å¢¨é£æ ¼ï¼‰</h1>
    <div class="account">
      <span id="syncBadge" class="pill">ç¦»çº¿ Â· æœªç™»å½•</span>
      <button id="accountBtn" class="account-btn" type="button">ç™»å½• / æ³¨å†Œ</button>
    </div>
  </div>
</header>

<main class="card">
  <div class="toolbar">
    <input id="fileInput" type="file" hidden accept=".csv,text/csv" />
    <button id="btnImportCsv" type="button">å¯¼å…¥ CSV</button>
    <button id="btnExportCsv" class="primary" type="button">å¯¼å‡º CSV</button>
    <button id="btnSync" type="button">ä¿å­˜ / åŒæ­¥</button>
  </div>

  <div id="emptyMsg" class="muted" style="text-align:center;margin:20px 0;display:none">è¯åº“ä¸ºç©ºï¼Œè¯·å…ˆå¯¼å…¥ CSV</div>

  <div id="word" class="word"></div>
  <div id="meaning" class="meaning"></div>

  <div class="actions">
    <button id="btnShow" class="primary" type="button">æ˜¾ç¤ºæ„æ€</button>
    <button id="btnKnow" class="green" style="display:none" type="button">è®¤è¯†</button>
    <button id="btnDont" class="red" style="display:none" type="button">ä¸è®¤è¯†</button>
    <button id="btnRestart" style="display:none" type="button">é‡æ–°å¼€å§‹</button>
  </div>

  <div class="progress-wrap"><div class="bar"><i id="progress"></i></div></div>
</main>

<!-- è´¦å·æ¨¡æ€ -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-hidden="true">
  <div class="backdrop" id="modalBackdrop"></div>
  <div class="panel" role="document">
    <button class="close-x" id="modalClose" aria-label="å…³é—­" type="button">âœ•</button>
    <h3 id="dialogTitle" class="title">ç™»å½• / æ³¨å†Œ</h3>
    <div id="dialogBody"></div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ========= 1) Supabase ========= */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';        // â† æ¢æˆä½ çš„
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';               // â† æ¢æˆä½ çš„
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:false, storage: safeStorage(), storageKey:'sb-words-auth' }
});
// Auth API ä¸è°ƒç”¨æ–¹å¼å‚ç…§å®˜æ–¹æ–‡æ¡£ã€‚:contentReference[oaicite:3]{index=3}

/* æ›´ç¨³å¦¥çš„ä¼šè¯å­˜å‚¨ï¼ˆlocalStorage ä¸å¯ç”¨æ—¶å›é€€è‡³ Cookieï¼‰ */
const cookieStorage = {
  getItem:k=>{const m=document.cookie.match(new RegExp('(?:^|; )'+encodeURIComponent(k)+'=([^;]*)'));return m?decodeURIComponent(m[1]):null},
  setItem:(k,v)=>{const e=new Date();e.setFullYear(e.getFullYear()+1);document.cookie=`${encodeURIComponent(k)}=${encodeURIComponent(v)}; Path=/; Expires=${e.toUTCString()}; SameSite=Lax; Secure`},
  removeItem:k=>{document.cookie=`${encodeURIComponent(k)}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax; Secure`}
};
function safeStorage(){try{const t='__sb__'+Math.random();localStorage.setItem(t,'1');localStorage.removeItem(t);return localStorage}catch{return cookieStorage}}

/* ========= 2) DOM & çŠ¶æ€ ========= */
const $=id=>document.getElementById(id);
const els={
  word:$('word'), meaning:$('meaning'), progress:$('progress'), empty:$('emptyMsg'),
  btnShow:$('btnShow'), btnKnow:$('btnKnow'), btnDont:$('btnDont'), btnRestart:$('btnRestart'),
  fileInput:$('fileInput'), btnImportCsv:$('btnImportCsv'), btnExportCsv:$('btnExportCsv'),
  btnSync:$('btnSync'),
  accountBtn:$('accountBtn'), sync:$('syncBadge'),
  modal:$('modal'),backdrop:$('modalBackdrop'),close:$('modalClose'),title:$('dialogTitle'),body:$('dialogBody'),
  toast:$('toast')
};

let sessionUser=null, rtChannel=null;
let dataMap = {};   // { word: { meaning, memoryLevel } }
let queue = [];     // å­¦ä¹ é˜Ÿåˆ—
let cur = null;     // å½“å‰

/* ========== è¡Œä¸ºå¼€å…³ ========== */
/** æ˜¯å¦åœ¨â€œæ¯è½®å­¦ä¹ å®Œæˆâ€åè‡ªåŠ¨åŒæ­¥äº‘ç«¯ã€‚æŒ‰ä½ çš„è¦æ±‚é»˜è®¤å…³é—­ï¼Œå¦‚éœ€å¼€å¯æ”¹ä¸º trueã€‚ */
const AUTO_SYNC_AFTER_ROUND = false;

/* ========= 3) å°å·¥å…· ========= */
function showToast(msg, ms=1800){ els.toast.textContent=msg; els.toast.style.display='block'; setTimeout(()=>{els.toast.style.display='none'}, ms); }
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
function updateBadge(){
  const parts=[]; parts.push(navigator.onLine?'ğŸŸ¢ åœ¨çº¿':'ğŸ”´ ç¦»çº¿'); parts.push(sessionUser?`å·²ç™»å½•ï¼š${sessionUser.email||'ç”¨æˆ·'}`:'æœªç™»å½•');
  els.sync.textContent = parts.join(' Â· ');
}
window.addEventListener('online',updateBadge); window.addEventListener('offline',updateBadge);
function log(...args){ console.log('[WORDS]', ...args); }

/* ========= 4) CSV å·¥å…·ï¼ˆRFC4180 ç®€æ˜“å®ç°ï¼‰ ========= */
/** CSV è½¬ä¹‰ï¼šéœ€è¦æ—¶åŠ åŒå¼•å·ï¼Œå†…éƒ¨åŒå¼•å·è½¬ä¹‰ä¸ºä¸¤æ¬¡åŒå¼•å· */
function csvEscape(v){
  if(v==null) return '';
  const s=String(v).replace(/"/g,'""');
  return /[",\n]/.test(s) ? `"${s}"` : s;
}
/** è§£æä¸€è¡Œï¼ˆæ”¯æŒå¼•å·ä¸é€—å·ï¼‰ */
function parseCsvLine(line){
  const out=[]; let cur='', i=0, inQ=false;
  while(i<line.length){
    const ch=line[i];
    if(inQ){
      if(ch==='"' && line[i+1]==='"'){ cur+='"'; i+=2; continue; }
      if(ch==='"'){ inQ=false; i++; continue; }
      cur+=ch; i++; continue;
    }else{
      if(ch===','){ out.push(cur); cur=''; i++; continue; }
      if(ch==='"'){ inQ=true; i++; continue; }
      cur+=ch; i++; continue;
    }
  }
  out.push(cur); return out;
}
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  if(lines.length===0) return {};
  const head = parseCsvLine(lines[0]).map(h=>h.trim().toLowerCase());
  const iWord = head.indexOf('word');
  const iMeaning = head.indexOf('meaning');
  const iMem = head.indexOf('memory_level');
  const map={};
  for(let i=1;i<lines.length;i++){
    const arr = parseCsvLine(lines[i]);
    const w = (arr[iWord]||'').trim();
    if(!w) continue;
    map[w] = {
      meaning: (arr[iMeaning]||'').trim(),
      memoryLevel: Number(arr[iMem]||0) || 0
    };
  }
  return map;
}
function toCSV(mapObj){
  const lines=['word,meaning,memory_level'];
  for(const [w,v] of Object.entries(mapObj)){
    lines.push([csvEscape(w), csvEscape(v.meaning||''), String(v.memoryLevel||0)].join(','));
  }
  return '\ufeff' + lines.join('\n'); // åŠ  BOM ä¾¿äº Excel è¯†åˆ« UTF-8ã€‚:contentReference[oaicite:4]{index=4}
}
function downloadCSV(filename, text){
  const blob=new Blob([text],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); // ä½¿ç”¨ blob URL è§¦å‘ä¸‹è½½ï¼Œå®Œæˆåå¯ revokeã€‚:contentReference[oaicite:5]{index=5}
  const a=document.createElement('a'); a.style.display='none'; a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},0);
}

/* ========= 5) ä¼šè¯å†…çš„â€œæœ¬åœ°æŒä¹…åŒ–â€ï¼ˆCSV æ ¼å¼ï¼‰ ========= */
/** æŠŠå½“å‰ dataMap ä»¥ CSV æ–‡æœ¬å†™å…¥ localStorageï¼ˆè€Œé JSONï¼‰ */
function saveLocalCsv(){ try{ localStorage.setItem('words_local_csv', toCSV(dataMap)); }catch{} }
function loadLocalCsv(){
  try{
    const csv = localStorage.getItem('words_local_csv') || '';
    if(!csv) { dataMap={}; return; }
    dataMap = parseCSV(csv);
  }catch{ dataMap = {}; }
}

/* ========= 6) ç™»å½•æ¨¡æ€ ========= */
let lastFocus=null;
function openModal(title,html){
  els.title.textContent=title;els.body.innerHTML=html;
  lastFocus=document.activeElement;els.modal.classList.add('show');els.modal.removeAttribute('aria-hidden');
  document.body.style.overflow='hidden';
  const f=els.body.querySelector('input,button');if(f)setTimeout(()=>f.focus(),0);
}
function closeModal(){ els.modal.classList.remove('show');els.modal.setAttribute('aria-hidden','true');document.body.style.overflow=''; if(lastFocus)lastFocus.focus(); }
els.backdrop.onclick=closeModal;els.close.onclick=closeModal;document.addEventListener('keydown',e=>{if(e.key==='Escape'&&els.modal.classList.contains('show'))closeModal()});

function showAuth(){
  openModal('ç™»å½• / æ³¨å†Œ', `
    <div class="field"><label>é‚®ç®±</label><input id="em" type="email" placeholder="you@example.com"></div>
    <div class="field"><label>å¯†ç ï¼ˆâ‰¥6ä½ï¼‰</label><input id="pw" type="password" placeholder="******"></div>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <button id="lg" class="primary" type="button">ç™»å½•</button>
      <button id="sg" type="button">æ³¨å†Œ</button>
    </div>
    <div id="hint" class="muted" style="margin-top:6px"></div>
  `);
  const hint=$('hint');
  $('lg').onclick=async()=>{
    try{
      const email=$('em').value.trim(),password=$('pw').value;
      if(!email||!password){hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';return}
      const { error } = await sb.auth.signInWithPassword({ email,password }); // :contentReference[oaicite:6]{index=6}
      if(error){ hint.textContent='ç™»å½•å¤±è´¥ï¼š'+error.message; return; }
      showToast('ç™»å½•æˆåŠŸ'); closeModal();
    }catch(err){ hint.textContent='ç™»å½•å¼‚å¸¸ï¼š'+(err?.message||err)}
  };
  $('sg').onclick=async()=>{
    try{
      const email=$('em').value.trim(),password=$('pw').value;
      if(!email||!password){hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';return}
      const { error } = await sb.auth.signUp({ email,password });
      hint.textContent = error ? ('æ³¨å†Œå¤±è´¥ï¼š'+error.message) : 'æ³¨å†ŒæˆåŠŸã€‚å¦‚å¼€å¯é‚®ç®±éªŒè¯ï¼Œè¯·åˆ°é‚®ç®±ç¡®è®¤åå†ç™»å½•ã€‚';
    }catch(err){ hint.textContent='æ³¨å†Œå¼‚å¸¸ï¼š'+(err?.message||err)}
  };
}
function showAccount(u){
  openModal('è´¦æˆ·', `
    <div class="field"><div class="muted">é‚®ç®±ï¼š${u.email||''}</div></div>
    <div class="row" style="gap:8px;justify-content:flex-end"><button id="lo" class="primary" type="button">é€€å‡ºç™»å½•</button></div>
  `);
  $('lo').onclick=async()=>{ await sb.auth.signOut(); showToast('å·²é€€å‡º'); closeModal(); };
}
els.accountBtn.onclick=()=>{sessionUser?showAccount(sessionUser):showAuth()};

/* ========= 7) å­¦ä¹ æµç¨‹ ========= */
function resetQueue(){
  queue = shuffle(Object.entries(dataMap));
  cur=null;
  els.progress.style.width='0%';
  els.meaning.style.display='none';
  els.btnShow.style.display='inline-block';
  els.btnKnow.style.display='none';
  els.btnDont.style.display='none';
  els.btnRestart.style.display='none';
  els.empty.style.display = queue.length? 'none':'block';
  next();
}
function next(){
  if(queue.length===0){
    els.word.textContent='æ­å–œï¼Œä»Šæ—¥å­¦ä¹ å®Œæˆï¼';
    els.meaning.style.display='none';
    els.btnShow.style.display='none';
    els.btnKnow.style.display='none';
    els.btnDont.style.display='none';
    els.btnRestart.style.display='inline-block';

    // ä¾ä½ è¦æ±‚ï¼šé»˜è®¤ä¸è‡ªåŠ¨åŒæ­¥ï¼ˆå¯é€šè¿‡å¸¸é‡å¼€å¯ï¼‰
    if(AUTO_SYNC_AFTER_ROUND && sessionUser){ syncNow().catch(err=>log('autosync error', err)); }
    return;
  }
  cur = queue.pop();
  els.word.textContent = cur[0];
  els.meaning.textContent = cur[1].meaning || '';
  els.meaning.style.display='none';
  els.btnShow.style.display='inline-block';
  els.btnKnow.style.display='none';
  els.btnDont.style.display='none';
  els.btnRestart.style.display='none';
  updateProgress();
}
function updateProgress(){
  const total = Object.keys(dataMap).length || 1;
  const remain = queue.length;
  els.progress.style.width = (((total-remain)/total*100).toFixed(1))+'%';
}
els.btnShow.onclick=()=>{ els.meaning.style.display='block'; els.btnShow.style.display='none'; els.btnKnow.style.display='inline-block'; els.btnDont.style.display='inline-block'; };
els.btnKnow.onclick=()=>vote(true);
els.btnDont.onclick=()=>vote(false);
els.btnRestart.onclick=resetQueue;

function vote(known){
  if(!cur) return;
  const [w, v] = cur;
  v.memoryLevel = (v.memoryLevel||0) + (known?1:-1);
  if(!known){ queue.unshift([w,v]); }
  dataMap[w] = v; saveLocalCsv();
  next();
}

/* ========= 8) å¯¼å…¥å¯¼å‡ºï¼ˆCSVï¼‰ ========= */
els.btnImportCsv.onclick=()=>els.fileInput.click();
els.fileInput.onchange=async e=>{
  const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); e.target.value='';
  try{
    const obj = parseCSV(text);
    Object.assign(dataMap, obj); saveLocalCsv();
    if(sessionUser) await upsertMany(obj); // æ”¯æŒä¸€é”®åŒæ­¥åˆ°äº‘ç«¯ï¼ˆå¯é€‰ï¼‰
    resetQueue(); showToast('å¯¼å…¥ CSV å®Œæˆ');
  }catch(err){ alert('CSV è§£æå¤±è´¥ï¼š'+(err?.message||err)) }
};
els.btnExportCsv.onclick=()=>downloadCSV('words.csv', toCSV(dataMap));

/* ========= 9) ä¸€é”®â€œä¿å­˜ / åŒæ­¥â€ï¼ˆæœ¬åœ°â†’äº‘ & äº‘â†’æœ¬åœ°ï¼‰ ========= */
let _syncing = false;
async function syncNow(){
  if(!sessionUser){ alert('è¯·å…ˆç™»å½•'); return; }
  if(_syncing) return;
  _syncing = true;
  const oldText = els.btnSync.textContent;
  els.btnSync.disabled = true;
  els.btnSync.textContent = 'åŒæ­¥ä¸­â€¦';
  try{
    // 1) æœ¬åœ° â†’ äº‘ç«¯ï¼ˆæ‰¹é‡ upsertï¼‰
    const rows = Object.entries(dataMap).map(([w,v])=>({
      user_id:sessionUser.id, word:w, meaning:v.meaning||'', memory_level:v.memoryLevel||0
    }));
    if(rows.length){
      const { error } = await sb.from('words').upsert(rows, { onConflict:'user_id,word' }).select(); // æ’å…¥/æ›´æ–°å¹¶è¿”å›å—å½±å“è¡Œã€‚:contentReference[oaicite:7]{index=7}
      if(error) throw error;
    }
    // 2) äº‘ç«¯ â†’ æœ¬åœ°ï¼ˆè¦†ç›–åŠ è½½ï¼‰
    await loadAllFromCloud();
    showToast('åŒæ­¥å®Œæˆï¼ˆå·²ä¿å­˜å¹¶åŠ è½½ï¼‰');
  }catch(err){
    log('Sync error', err);
    const msg=(err && err.message)||String(err);
    alert('ä¿å­˜/åŠ è½½å¤±è´¥ï¼š'+msg+'\n\nè¯·ç¡®è®¤å·²æŒ‰æ–‡æ¡£åˆ›å»ºè¡¨ä¸ RLS ç­–ç•¥ï¼ˆå«æˆæƒï¼‰ã€‚'); // RLS å‚è€ƒã€‚:contentReference[oaicite:8]{index=8}
  }finally{
    els.btnSync.disabled = false;
    els.btnSync.textContent = oldText;
    _syncing = false;
    updateBadge();
  }
}
els.btnSync.onclick = syncNow;

/* ========= 10) äº‘ç«¯ CRUD ========= */
async function loadAllFromCloud(){
  if(!sessionUser) return;
  const { data, error } = await sb.from('words')
    .select('word,meaning,memory_level')
    .eq('user_id',sessionUser.id)
    .order('created_at',{ascending:true});
  if(error){ throw error; }
  const map={}; (data||[]).forEach(r=>map[r.word]={meaning:r.meaning,memoryLevel:r.memory_level||0});
  dataMap = map; saveLocalCsv(); resetQueue(); updateBadge();
}
async function upsertMany(obj){
  if(!sessionUser) return;
  const rows = Object.entries(obj).map(([w,v])=>({ user_id:sessionUser.id, word:w, meaning:v.meaning||'', memory_level:v.memoryLevel||0 }));
  if(!rows.length) return;
  const { error } = await sb.from('words').upsert(rows, { onConflict:'user_id,word' });
  if(error) throw error;
}

/* ========= 11) Realtimeï¼ˆå¯é€‰ï¼‰ ========= */
function subscribeRealtime(){
  if(rtChannel) sb.removeChannel(rtChannel);
  if(!sessionUser) return;
  rtChannel = sb.channel('words-ch')
    .on('postgres_changes',{event:'*',schema:'public',table:'words',filter:`user_id=eq.${sessionUser.id}`}, async ()=>{
      try{ await loadAllFromCloud(); }catch(err){ log('realtime refresh error', err); }
    })
    .subscribe();
}
function unsubscribeRealtime(){ if(rtChannel){ sb.removeChannel(rtChannel); rtChannel=null; } }

/* ========= 12) ä¼šè¯ç›‘å¬ & åˆå§‹åŒ– ========= */
sb.auth.onAuthStateChange(async (_evt,sess)=>{
  sessionUser = sess?.user || null;
  els.accountBtn.textContent = sessionUser?`å·²ç™»å½•ï¼š${sessionUser.email||'ç”¨æˆ·'}`:'ç™»å½• / æ³¨å†Œ';
  updateBadge();
  if(sessionUser){ try{ await loadAllFromCloud(); }catch(err){ log('load cloud error', err); } subscribeRealtime(); }
  else{ unsubscribeRealtime(); loadLocalCsv(); resetQueue(); }
});

(async function init(){
  // æœ¬åœ°å…ˆå¯ç”¨ï¼ˆCSV æŒä¹…åŒ–ï¼‰
  loadLocalCsv(); resetQueue(); updateBadge();
  // æ¢å¤ä¼šè¯
  try{
    const { data:{session} } = await sb.auth.getSession();
    sessionUser = session?.user || null;
    els.accountBtn.textContent = sessionUser?`å·²ç™»å½•ï¼š${sessionUser.email||'ç”¨æˆ·'}`:'ç™»å½• / æ³¨å†Œ';
    if(sessionUser){ try{ await loadAllFromCloud(); }catch(err){ log('getSession cloud error', err); } subscribeRealtime(); }
  }catch(err){ log('getSession error', err); }
})();
</script>
</body>
</html>
