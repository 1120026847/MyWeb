<!doctype html>
authArea.appendChild(emailSpan);
authArea.appendChild(btn);
show(btnImport); show(btnExport); show(btnUploadCloud); show(btnDeleteLearned);
}
}


// 登录/注册切换
switchRegister.addEventListener('change', () => {
const isReg = switchRegister.checked;
authTitle.textContent = isReg ? '注册' : '登录';
btnSubmitAuth.textContent = '提交';
authMsg.textContent = isReg ? '注册成功后可能需要邮件验证（取决于项目设置）。' : '';
});


btnSubmitAuth.addEventListener('click', async (e) => {
e.preventDefault();
const email = authEmail.value.trim();
const password = authPassword.value.trim();
if (!email || !password) return;
try {
if (switchRegister.checked) {
const { error } = await supabase.auth.signUp({ email, password });
if (error) throw error;
authMsg.textContent = '注册成功，请检查邮箱进行验证（若已开启）。';
} else {
const { error } = await supabase.auth.signInWithPassword({ email, password });
if (error) throw error;
authDialog.close();
}
} catch (err) {
authMsg.textContent = '错误：' + err.message;
}
});


// ====== 数据加载 ======
async function loadWords() {
if (!user) return;
const { data, error } = await supabase.from('words').select('*').order('created_at', { ascending: true });
if (error) { alert('加载失败：' + error.message); return; }
words = data || [];
rebuildStudyList();
renderCurrent();
renderList();
}


// ====== 启动 & 监听 ======
(async function init() {
// 先监听，再获取 session（可避免极端竞态）
supabase.auth.onAuthStateChange((_event, session) => {
user = session?.user || null;
renderAuthArea();
if (user) loadWords(); else { words = []; studyList = []; renderCurrent(); renderList(); }
});
const { data: { session } } = await supabase.auth.getSession();
user = session?.user || null;
renderAuthArea();
if (user) await loadWords(); else renderCurrent();
})();
</script>
</body>
</html>
