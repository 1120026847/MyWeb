<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>待办事项清单 · 云端同步版</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(135deg,#74ebd5,#acb6e5);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Noto Sans SC','Microsoft Yahei',sans-serif;color:#333}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#ffffffb8;backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid #e7e7e7}
    .app-title{font-weight:800}
    .auth{display:flex;gap:8px;align-items:center}
    .auth input{padding:8px 10px;border:1px solid #ddd;border-radius:8px;min-width:160px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #e1e1e1;background:#fff;cursor:pointer}
    .btn.primary{background:#4CAF50;color:#fff;border-color:#4CAF50}
    .pill{padding:4px 8px;border:1px solid #e1e1e1;border-radius:999px;font-size:12px;color:#666}

    .container{background:#fff;border-radius:15px;box-shadow:0 10px 20px rgba(0,0,0,.1);padding:20px;margin:20px auto;width:min(96%,760px)}
    h1{margin:0 0 16px;color:#4CAF50}

    .topbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .topbar input[type="text"]{flex:1;padding:12px 14px;border:2px solid #ddd;border-radius:8px}
    .topbar input[type="text"]:focus{border-color:#4CAF50;outline:none;box-shadow:0 0 0 2px rgba(76,175,80,.15)}
    .add-btn{padding:0 18px;background:#4CAF50;border:0;border-radius:8px;color:#fff;font-weight:600}

    .stats{display:flex;justify-content:space-between;margin:10px 0;padding:8px 0;border-top:1px solid #eee;border-bottom:1px solid #eee}
    .count{display:flex;gap:6px;align-items:center}
    .count span{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:#4CAF50;color:#fff;font-size:12px}
    .count.done span{background:#9e9e9e}

    .tabs{display:flex;gap:10px;border-bottom:1px solid #eee;margin:12px 0}
    .tab{padding:8px 12px;cursor:pointer;border-bottom:3px solid transparent;font-weight:600}
    .tab.active{color:#4CAF50;border-bottom-color:#4CAF50}

    ul{list-style:none;margin:0;padding:0}
    li{display:flex;gap:10px;align-items:center;padding:12px;margin:10px 0;background:#f9f9f9;border-radius:10px}
    .task-content{flex:1;word-break:break-word}
    .task-content.completed{text-decoration:line-through;color:#9e9e9e}
    .check{width:22px;height:22px;border:2px solid #4CAF50;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .check.checked{background:#4CAF50;color:#fff}
    .check.checked::after{content:'✓';font-size:12px}
    .edit-input{flex:1;padding:8px 10px;border:2px solid #4CAF50;border-radius:8px}
    .btn.small{padding:6px 10px}
    .danger{background:#dc3545;color:#fff;border:0}
    .warn{background:#ffc107;color:#212529;border:0}
    .info{background:#17a2b8;color:#fff;border:0}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .muted{color:#666;font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="app-title">📝 待办事项清单</div>
    <div class="auth">
      <div id="signed-out">
        <input type="email" id="email" placeholder="邮箱" />
        <input type="password" id="password" placeholder="密码（≥6位）" />
        <button class="btn" id="btnSignUp">注册</button>
        <button class="btn primary" id="btnSignIn">登录</button>
      </div>
      <div id="signed-in" style="display:none;gap:8px;align-items:center">
        <span class="pill" id="userEmail"></span>
        <span class="pill" id="syncBadge">未登录</span>
        <button class="btn" id="btnSignOut">退出</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="toolbar">
      <button class="btn small info" id="btnExport">导出 JSON</button>
      <input type="file" id="fileImport" accept="application/json" style="display:none"/>
      <button class="btn small" id="btnImport">导入 JSON</button>
      <button class="btn small" id="btnSyncLocal">立即同步本地 → 云端</button>
      <span class="muted">（未登录时仅保存到本地）</span>
    </div>

    <div class="topbar">
      <input type="text" id="title" placeholder="添加新任务..."/>
      <button class="add-btn" id="add-btn">添加</button>
    </div>

    <div class="stats">
      <div class="count">待完成：<span id="todo-count">0</span></div>
      <div class="count done">已完成：<span id="done-count">0</span></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="all">全部任务</div>
      <div class="tab" data-tab="todo">待完成</div>
      <div class="tab" data-tab="done">已完成</div>
    </div>

    <ul id="todo-list"></ul>
  </div>

  <script>
    // =============== Supabase 客户端（替换为你的项目配置） ===============
    const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_ANON_PUBLIC_KEY';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    // =============== 全局状态 ===============
    let tasks = []; // 始终代表当前页面展示的数据
    let activeTab = 'all';
    let currentUser = null;
    let rtChannel = null;

    // =============== DOM ===============
    const els = {
      title: document.getElementById('title'),
      addBtn: document.getElementById('add-btn'),
      list: document.getElementById('todo-list'),
      todoCount: document.getElementById('todo-count'),
      doneCount: document.getElementById('done-count'),
      tabs: document.querySelectorAll('.tab'),
      exportBtn: document.getElementById('btnExport'),
      importBtn: document.getElementById('btnImport'),
      importFile: document.getElementById('fileImport'),
      syncLocalBtn: document.getElementById('btnSyncLocal'),
      signedOut: document.getElementById('signed-out'),
      signedIn: document.getElementById('signed-in'),
      userEmail: document.getElementById('userEmail'),
      syncBadge: document.getElementById('syncBadge'),
    };

    // =============== 启动 ===============
    window.addEventListener('load', async () => {
      wireUI();
      restoreLocal();
      render();
      await initAuth();
    });

    function wireUI(){
      els.addBtn.onclick = addNewTask;
      els.title.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addNewTask(); }});
      els.tabs.forEach(tab=> tab.addEventListener('click', ()=>{ els.tabs.forEach(t=>t.classList.remove('active')); tab.classList.add('active'); activeTab = tab.dataset.tab; render(); }));
      els.exportBtn.onclick = exportJSON;
      els.importBtn.onclick = ()=> els.importFile.click();
      els.importFile.onchange = importJSON;
      els.syncLocalBtn.onclick = syncLocalToCloud;

      document.getElementById('btnSignUp').onclick = signUp;
      document.getElementById('btnSignIn').onclick = signIn;
      document.getElementById('btnSignOut').onclick = signOut;
    }

    // =============== 本地存储 ===============
    function restoreLocal(){ const raw = localStorage.getItem('todoList'); tasks = raw? JSON.parse(raw) : []; }
    function saveLocal(){ localStorage.setItem('todoList', JSON.stringify(tasks)); }

    // =============== Auth ===============
    async function initAuth(){
      const { data: { session } } = await sb.auth.getSession();
      currentUser = session?.user || null; updateAuthUI();
      if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); }
      sb.auth.onAuthStateChange(async (_event, session)=>{
        currentUser = session?.user || null; updateAuthUI();
        if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); }
        else { unsubscribeRealtime(); restoreLocal(); render(); }
      });
    }
    function updateAuthUI(){
      if(currentUser){
        els.signedOut.style.display='none';
        els.signedIn.style.display='flex';
        els.userEmail.textContent = currentUser.email || '已登录';
      } else {
        els.signedOut.style.display='block';
        els.signedIn.style.display='none';
      }
      updateStatusIndicator();
    } else {
        els.signedOut.style.display='block';
        els.signedIn.style.display='none';
        els.syncBadge.textContent = '未登录';
      }
    }
    async function signUp(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try{
        toggleBtn('btnSignUp', true, '注册中…');
        const { error } = await sb.auth.signUp({ email, password });
        if(error) throw error;
        alert('注册成功：如果开启了邮件验证，请先到邮箱完成验证再登录。');
      }catch(err){
        console.error('[signUp]', err);
        alert('注册失败：' + (err?.message || err));
      }finally{
        toggleBtn('btnSignUp', false, '注册');
      }
    }
    async function signIn(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if(!email || !password){ alert('请输入邮箱和密码'); return; }
      try{
        toggleBtn('btnSignIn', true, '登录中…');
        console.log('[signIn] start', { email });
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error){
          const map = {
            'Email not confirmed': '邮箱未验证：请到邮箱点确认链接（或在 Auth/Email 临时关闭 Confirm email）',
            'Invalid login credentials': '邮箱或密码不正确'
          };
          alert('登录失败：' + (map[error.message] || error.message));
          return;
        }
        // 关键：不等事件，立刻切换到已登录并拉数据/订阅
        currentUser = data?.user || (await sb.auth.getUser()).data?.user || null;
        updateAuthUI();
        await loadAllFromCloud();
        subscribeRealtime();
        console.log('[signIn] success', currentUser?.id);
      }catch(err){
        console.error('[signIn] error', err);
        alert('网络或脚本错误：' + (err?.message || err));
      }finally{
        toggleBtn('btnSignIn', false, '登录');
      }
    }
    async function signOut(){
      try{
        toggleBtn('btnSignOut', true, '退出中…');
        await sb.auth.signOut();
      }catch(err){
        console.error('[signOut]', err);
        alert('退出失败：' + (err?.message || err));
      }finally{
        toggleBtn('btnSignOut', false, '退出');
      }
    }

    async function addNewTask(){
      const title = els.title.value.trim();
      if(!title){ alert('请输入任务内容'); return; }

      if(currentUser){
        const { data, error } = await sb
          .from('todos')
          .insert({ user_id: currentUser.id, title, done: false })
          .select('*')
          .single();
        if(error){ alert('云端新增失败：'+error.message); return; }
        tasks.push({ id: data.id, title: data.title, done: data.done, created_at: data.created_at });
      } else {
        const localId = 'local-'+Date.now();
        tasks.push({ id: localId, title, done: false, created_at: new Date().toISOString() });
      }
      els.title.value='';
      saveLocal();
      render();
    }

    async function toggleTask(id){
      const idx = tasks.findIndex(t=>t.id===id);
      if(idx===-1) return;
      const newDone = !tasks[idx].done;
      tasks[idx].done = newDone; // 先本地更新
      render(); saveLocal();

      if(currentUser && !String(id).startsWith('local-')){
        const { error } = await sb.from('todos').update({ done: newDone }).eq('id', id);
        if(error){ console.warn('云端更新失败：', error.message); }
      }
    }

    function editTask(id){
      const li = document.querySelector(`li[data-id="${id}"]`);
      const task = tasks.find(t=>t.id===id); if(!task || !li) return;
      li.innerHTML = `
        <div class="check ${task.done?'checked':''}" onclick="toggleTask('${id}')"></div>
        <input type="text" class="edit-input" value="${escapeHtml(task.title)}"/>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn small info" onclick="saveTask('${id}')">保存</button>
          <button class="btn small danger" onclick="deleteTask('${id}')">删除</button>
        </div>`;
      li.querySelector('.edit-input').focus();
    }

    async function saveTask(id){
      const li = document.querySelector(`li[data-id="${id}"]`);
      const input = li?.querySelector('.edit-input');
      if(!input) return; const newTitle = input.value.trim();
      if(!newTitle){ alert('任务内容不能为空'); return; }
      const idx = tasks.findIndex(t=>t.id===id); if(idx===-1) return;
      tasks[idx].title = newTitle; render(); saveLocal();

      if(currentUser && !String(id).startsWith('local-')){
        const { error } = await sb.from('todos').update({ title: newTitle }).eq('id', id);
        if(error){ console.warn('云端更新失败：', error.message); }
      }
    }

    async function deleteTask(id){
      tasks = tasks.filter(t=>t.id!==id); render(); saveLocal();
      if(currentUser && !String(id).startsWith('local-')){
        const { error } = await sb.from('todos').delete().eq('id', id);
        if(error){ console.warn('云端删除失败：', error.message); }
      }
    }

    // =============== 渲染 ===============
    function render(){
      const filtered = tasks.filter(t=> activeTab==='all' ? true : activeTab==='todo' ? !t.done : t.done);
      els.list.innerHTML = '';
      if(filtered.length===0){
        els.list.innerHTML = `<li style="justify-content:center;color:#999;">📭 没有找到任务</li>`;
      } else {
        for(const task of filtered){
          const li = document.createElement('li'); li.dataset.id = task.id;
          li.innerHTML = `
            <div class="check ${task.done?'checked':''}" onclick="toggleTask('${task.id}')"></div>
            <div class="task-content ${task.done?'completed':''}">${escapeHtml(task.title)}</div>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button class="btn small warn" onclick="editTask('${task.id}')">编辑</button>
              <button class="btn small danger" onclick="deleteTask('${task.id}')">删除</button>
            </div>`;
          els.list.appendChild(li);
        }
      }
      const todoN = tasks.filter(t=>!t.done).length;
      const doneN = tasks.filter(t=> t.done).length;
      els.todoCount.textContent = todoN; els.doneCount.textContent = doneN;
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // =============== 导入 / 导出 / 同步 ===============
    async function exportJSON(){
      if(currentUser){
        const { data, error } = await sb.from('todos').select('*').eq('user_id', currentUser.id).order('created_at',{ascending:true});
        if(error){ alert('导出失败：'+error.message); return; }
        downloadBlob(new Blob([JSON.stringify(data, null, 2)],{type:'application/json'}), 'todos-export.json');
      } else {
        downloadBlob(new Blob([JSON.stringify(tasks, null, 2)],{type:'application/json'}), 'todos-export-local.json');
      }
    }
    async function importJSON(e){
      const file = e.target.files?.[0]; if(!file) return; const text = await file.text(); e.target.value='';
      try{
        const arr = JSON.parse(text); if(!Array.isArray(arr)) throw new Error('JSON 须为数组');
        if(currentUser){
          const rows = arr.map(x=>({ user_id: currentUser.id, title: x.title||'', done: !!x.done, created_at: x.created_at || new Date().toISOString() }));
          const { error } = await sb.from('todos').insert(rows); if(error) throw error; await loadAllFromCloud();
        } else {
          const mapped = arr.map(x=>({ id: 'local-'+Date.now()+Math.random(), title: x.title||'', done: !!x.done, created_at: x.created_at || new Date().toISOString() }));
          tasks.push(...mapped); saveLocal(); render();
        }
        alert('导入完成');
      }catch(err){ alert('导入失败：'+err.message); }
    }
    async function syncLocalToCloud(){
      if(!currentUser){ alert('请先登录'); return; }
      const locals = tasks.filter(t=> String(t.id).startsWith('local-'));
      if(locals.length===0){ alert('没有需要同步的本地任务'); return; }
      const rows = locals.map(t=>({ user_id: currentUser.id, title: t.title, done: t.done, created_at: t.created_at }));
      const { error } = await sb.from('todos').insert(rows);
      if(error){ alert('同步失败：'+error.message); return; }
      await loadAllFromCloud();
      alert('本地任务已同步至云端');
    }
    function downloadBlob(blob, filename){ const a=document.createElement('a'); a.download=filename; a.href=URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href); }

    // =============== Realtime ===============
    function subscribeRealtime(){
      if(rtChannel) sb.removeChannel(rtChannel);
      rtChannel = sb.channel('todos-ch');
      rtChannel.on('postgres_changes', { event:'*', schema:'public', table:'todos', filter:`user_id=eq.${currentUser.id}` }, async ()=>{ await loadAllFromCloud(); }).subscribe();
    }
    function unsubscribeRealtime(){ if(rtChannel){ sb.removeChannel(rtChannel); rtChannel=null; } }

    // 暴露给 HTML 内联事件
    window.toggleTask = toggleTask;
    window.deleteTask = deleteTask;
    window.editTask = editTask;
    window.saveTask = saveTask;
  </script>

  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"70f3b625243c456f9ab4034f8b8b3974","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous">// —— 状态指示灯 & 工具 ——
    function updateStatusIndicator(){
      const online = navigator.onLine;
      const pending = JSON.parse(localStorage.getItem('words_pending')||'[]').length;
      let parts = [];
      parts.push(online ? '🟢 在线' : '🔴 离线');
      parts.push(currentUser ? '已登录' : '未登录');
      if(currentUser){
        parts.push(pending>0 ? `待同步(${pending})` : '已同步');
      }
      els.syncBadge.textContent = parts.join(' · ');
    }
    window.addEventListener('online', ()=>{ updateStatusIndicator(); try{ flushPending(); }catch(e){} });
    window.addEventListener('offline', updateStatusIndicator);

    function toggleBtn(id, disabled, text){
      const btn = document.getElementById(id);
      if(!btn) return;
      btn.disabled = !!disabled;
      if(text) btn.textContent = text;
    }
    window.addEventListener('unhandledrejection', (e)=>{
      console.error('[unhandledrejection]', e.reason);
      alert('出错了：' + (e.reason?.message || e.reason));
    });
  </script>
</body>
</html>
