<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºèƒ½å•è¯è®°å¿†ç³»ç»Ÿ Â· äº‘ç«¯åŒæ­¥ç‰ˆ</title>
  <style>
    :root{--primary:#4CAF50;--blue:#2196F3;--red:#f44336}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;flex-direction:column;background:#f5f5f5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Noto Sans SC','Microsoft Yahei',sans-serif;color:#222}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:5}
    .app-title{font-weight:800}
    .auth{display:flex;gap:8px;align-items:center}
    .auth input{padding:8px 10px;border:1px solid #ddd;border-radius:8px;min-width:160px}
    .btn{padding:10px 16px;border-radius:8px;border:1px solid #e1e1e1;background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .pill{padding:4px 8px;border:1px solid #e1e1e1;border-radius:999px;font-size:12px;color:#666}

    .main{flex:1;max-width:880px;margin:20px auto;padding:20px;background:#fff;border-radius:14px;box-shadow:0 10px 20px rgba(0,0,0,.06)}
    .control-group{display:flex;gap:10px;justify-content:center;margin:10px 0;flex-wrap:wrap}
    .word-display{text-align:center;font-size:5em;margin:40px 0;min-height:120px;line-height:1.2}
    .meaning-display{text-align:center;font-size:3.2em;color:var(--blue);margin:30px 0;min-height:80px;display:none;line-height:1.3}
    .action-buttons{display:flex;justify-content:center;gap:12px;margin:40px 0}
    #knowBtn,#dontKnowBtn,#showMeaningBtn,#restartBtn{padding:18px 36px;font-size:22px;min-width:160px}
    #restartBtn{display:none;background:var(--blue);color:#fff;border:0}
    #knowBtn{background:var(--primary);color:#fff;border:0}
    #dontKnowBtn{background:var(--red);color:#fff;border:0}
    #showMeaningBtn{background:var(--blue);color:#fff;border:0}

    #progressBar{width:80%;height:12px;background:#ddd;border-radius:6px;margin:30px auto 20px}
    #progress{height:100%;background:var(--primary);transition:width .3s;border-radius:6px}

    .modal{display:none;position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
    .dialog{background:#fff;padding:24px;border-radius:12px;min-width:420px;max-width:92vw}
    .dialog textarea{width:100%;height:180px;margin:12px 0;padding:12px;font-size:15px;border:2px solid #ddd;border-radius:10px;resize:vertical;line-height:1.6}
    .dialog-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .muted{color:#666;font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="app-title">ğŸ“š æ™ºèƒ½å•è¯è®°å¿†ç³»ç»Ÿ</div>
    <div class="auth">
      <div id="signed-out">
        <input type="email" id="email" placeholder="é‚®ç®±" />
        <input type="password" id="password" placeholder="å¯†ç ï¼ˆâ‰¥6ä½ï¼‰" />
        <button class="btn" id="btnSignUp">æ³¨å†Œ</button>
        <button class="btn primary" id="btnSignIn">ç™»å½•</button>
      </div>
      <div id="signed-in" style="display:none;gap:8px;align-items:center">
        <span class="pill" id="userEmail"></span>
        <span class="pill" id="syncBadge">æœªç™»å½•</span>
        <button class="btn" id="btnSignOut">é€€å‡º</button>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="toolbar">
      <button class="btn" onclick="location.href='https://www.molijun.com'">é¦–é¡µ</button>
      <input type="file" id="fileInput" hidden accept="application/json"/>
      <button class="btn" id="btnImport">å¯¼å…¥æ•°æ®</button>
      <button class="btn" id="addDataBtn">æ·»åŠ æ•°æ®</button>
      <button class="btn" id="exportBtn">å¯¼å‡ºæ•°æ®</button>
      <button class="btn" id="syncLocalBtn">åŒæ­¥æœ¬åœ° â†’ äº‘ç«¯</button>
      <span class="muted">ï¼ˆæœªç™»å½•åˆ™åªä¿å­˜åœ¨æœ¬åœ°ï¼‰</span>
    </div>

    <div class="control-group">
      <button class="btn" id="deleteWordBtn">åˆ é™¤å•è¯</button>
      <button class="btn" id="helpBtn">è¯´æ˜</button>
    </div>

    <div id="progressBar"><div id="progress"></div></div>
    <div id="emptyMsg" style="display:none;text-align:center;margin:30px 0;font-size:1.6em;">æ•°æ®ä¸ºç©ºï¼Œè¯·æ·»åŠ æ•°æ®</div>

    <div class="word-display" id="wordDisplay"></div>
    <div class="meaning-display" id="meaningDisplay"></div>

    <div class="action-buttons">
      <button class="btn" id="knowBtn" style="display:none;">è®¤è¯†</button>
      <button class="btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
      <button class="btn" id="showMeaningBtn">æ˜¾ç¤ºé‡Šä¹‰</button>
      <button class="btn" id="dontKnowBtn" style="display:none;">ä¸è®¤è¯†</button>
    </div>
  </main>

  <!-- æ·»åŠ æ•°æ®å¼¹çª— -->
  <div class="modal" id="addDataModal">
    <div class="dialog">
      <h3 style="margin:0 0 10px">æ·»åŠ æ–°å•è¯</h3>
      <textarea id="newDataInput" placeholder="æ¯è¡Œï¼šå•è¯ é‡Šä¹‰ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰\nç¤ºä¾‹ï¼š\napple è‹¹æœ\nbanana é¦™è•‰"></textarea>
      <div class="dialog-actions">
        <button class="btn" id="confirmAdd">ç¡®å®š</button>
        <button class="btn" id="cancelAdd">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- åˆ é™¤é˜ˆå€¼å¼¹çª— -->
  <div class="modal" id="deleteModal">
    <div class="dialog">
      <h4 style="margin:0 0 6px">åˆ é™¤è®°å¿†æ¬¡æ•°è¾ƒå¤šçš„å•è¯</h4>
      <p style="margin:10px 0">è¯·è¾“å…¥è¦åˆ é™¤çš„è®°å¿†æ¬¡æ•°é˜ˆå€¼ï¼ˆä¸ä½äº 5ï¼‰</p>
      <input type="number" id="deleteThreshold" placeholder="è¯·è¾“å…¥æ•°å­—" min="5" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"/>
      <div class="dialog-actions">
        <button class="btn" id="confirmDelete">ç¡®å®š</button>
        <button class="btn" id="cancelDelete">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // ================= Supabase é…ç½®ï¼ˆä½¿ç”¨ä½ æä¾›çš„é¡¹ç›®ï¼‰ =================
    const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ================= çŠ¶æ€ =================
    const els = {
      fileInput: document.getElementById('fileInput'),
      btnImport: document.getElementById('btnImport'),
      addDataBtn: document.getElementById('addDataBtn'),
      exportBtn: document.getElementById('exportBtn'),
      syncLocalBtn: document.getElementById('syncLocalBtn'),
      addDataModal: document.getElementById('addDataModal'),
      newDataInput: document.getElementById('newDataInput'),
      deleteModal: document.getElementById('deleteModal'),
      deleteThreshold: document.getElementById('deleteThreshold'),
      wordDisplay: document.getElementById('wordDisplay'),
      meaningDisplay: document.getElementById('meaningDisplay'),
      progress: document.getElementById('progress'),
      emptyMsg: document.getElementById('emptyMsg'),
      knowBtn: document.getElementById('knowBtn'),
      showMeaningBtn: document.getElementById('showMeaningBtn'),
      dontKnowBtn: document.getElementById('dontKnowBtn'),
      restartBtn: document.getElementById('restartBtn'),
      // auth
      signedOut: document.getElementById('signed-out'),
      signedIn: document.getElementById('signed-in'),
      userEmail: document.getElementById('userEmail'),
      syncBadge: document.getElementById('syncBadge'),
    };

    let wordData = { original: {}, backup: [] };
    let currentWord = null;
    let currentUser = null;
    let rtChannel = null;

    // ================= åˆå§‹åŒ– =================
    window.addEventListener('DOMContentLoaded', async () => {
      wireUI();
      restoreLocal();
      resetLearning();
      await initAuth();
    });

    function wireUI(){
      els.btnImport.onclick = ()=> els.fileInput.click();
      els.fileInput.onchange = onImportFile;
      els.addDataBtn.onclick = ()=> showModal(els.addDataModal, true);
      document.getElementById('confirmAdd').onclick = onConfirmAdd;
      document.getElementById('cancelAdd').onclick = ()=> showModal(els.addDataModal, false);

      document.getElementById('deleteWordBtn').onclick = ()=> showModal(els.deleteModal, true);
      document.getElementById('confirmDelete').onclick = onConfirmDelete;
      document.getElementById('cancelDelete').onclick = ()=> showModal(els.deleteModal, false);

      els.exportBtn.onclick = exportData;
      els.syncLocalBtn.onclick = syncLocalToCloud;

      document.getElementById('helpBtn').onclick = showHelp;

      els.showMeaningBtn.onclick = showMeaning;
      els.knowBtn.onclick = () => handleKnow(true);
      els.dontKnowBtn.onclick = () => handleKnow(false);
      els.restartBtn.onclick = resetLearning;

      document.getElementById('btnSignUp').onclick = signUp;
      document.getElementById('btnSignIn').onclick = signIn;
      document.getElementById('btnSignOut').onclick = signOut;

      window.addEventListener('online', flushPending);
    }

    function showModal(el, on){ el.style.display = on? 'flex':'none'; el.style.alignItems='center'; el.style.justifyContent='center'; }

    // ================= æœ¬åœ°å­˜å‚¨ =================
    function restoreLocal(){
      try {
        const saved = localStorage.getItem('wordData');
        if(saved){ const parsed = JSON.parse(saved); wordData.original = parsed.original || {}; }
      } catch(e){ console.warn('è¯»å–æœ¬åœ°å¤±è´¥', e); }
    }
    function saveLocal(){ localStorage.setItem('wordData', JSON.stringify(wordData)); }

    // ================= Auth =================
    async function initAuth(){
      const { data: { session } } = await sb.auth.getSession();
      currentUser = session?.user || null; updateAuthUI();
      if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
      sb.auth.onAuthStateChange(async (_e, session)=>{
        currentUser = session?.user || null; updateAuthUI();
        if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
        else { unsubscribeRealtime(); restoreLocal(); resetLearning(); }
      });
    }
    function updateAuthUI(){
      if(currentUser){
        els.signedOut.style.display='none';
        els.signedIn.style.display='flex';
        els.userEmail.textContent = currentUser.email||'å·²ç™»å½•';
        els.syncBadge.textContent = 'å·²ç™»å½•';
      } else {
        els.signedOut.style.display='block';
        els.signedIn.style.display='none';
        els.syncBadge.textContent = 'æœªç™»å½•';
      }
    }
    async function signUp(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await sb.auth.signUp({ email, password });
      if(error) alert('æ³¨å†Œå¤±è´¥ï¼š'+error.message); else alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç»§ç»­ç™»å½•ã€‚');
    }
    async function signIn(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error) alert('ç™»å½•å¤±è´¥ï¼š'+error.message);
    }
    async function signOut(){ await sb.auth.signOut(); }

    // ================= äº‘ç«¯äº¤äº’ =================
    async function loadAllFromCloud(){
      if(!currentUser) return;
      const { data, error } = await sb
        .from('words')
        .select('word, meaning, memory_level')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: true });
      if(error){ console.warn('åŠ è½½äº‘ç«¯å¤±è´¥ï¼š', error.message); return; }
      const map = {}; (data||[]).forEach(r=>{ map[r.word] = { meaning: r.meaning, memoryLevel: r.memory_level||0 }; });
      wordData.original = map; saveLocal(); resetLearning();
    }

    async function upsertMany(obj){
      if(!currentUser) return;
      const rows = Object.entries(obj).map(([w,v])=>({ user_id: currentUser.id, word: w, meaning: v.meaning||'', memory_level: v.memoryLevel||0 }));
      if(rows.length===0) return;
      const { error } = await sb.from('words').upsert(rows, { onConflict: 'user_id,word' });
      if(error){ console.warn('äº‘ç«¯ upsert å¤±è´¥ï¼ŒåŠ å…¥å¾…åŒæ­¥ï¼š', error.message); queuePending({ type:'upsertMany', rows }); }
    }

    async function updateOne(word){
      if(!currentUser) return;
      const v = wordData.original[word]; if(!v) return;
      const { error } = await sb.from('words').update({ meaning: v.meaning||'', memory_level: v.memoryLevel||0 }).match({ user_id: currentUser.id, word });
      if(error){ console.warn('äº‘ç«¯æ›´æ–°å¤±è´¥ï¼ŒåŠ å…¥å¾…åŒæ­¥ï¼š', error.message); queuePending({ type:'updateOne', word, payload:{ meaning:v.meaning||'', memory_level:v.memoryLevel||0 } }); }
    }

    async function deleteByThreshold(th){
      if(!currentUser) return;
      const { error } = await sb.from('words').delete().eq('user_id', currentUser.id).gte('memory_level', th);
      if(error){ alert('äº‘ç«¯åˆ é™¤å¤±è´¥ï¼š'+error.message); }
    }

    function subscribeRealtime(){
      if(rtChannel) sb.removeChannel(rtChannel);
      rtChannel = sb.channel('words-ch');
      rtChannel.on('postgres_changes', { event:'*', schema:'public', table:'words', filter:`user_id=eq.${currentUser.id}` }, async ()=>{ await loadAllFromCloud(); }).subscribe();
    }
    function unsubscribeRealtime(){ if(rtChannel){ sb.removeChannel(rtChannel); rtChannel=null; } }

    // ç¦»çº¿å¾…åŒæ­¥
    function queuePending(item){ const q = JSON.parse(localStorage.getItem('words_pending')||'[]'); q.push(item); localStorage.setItem('words_pending', JSON.stringify(q)); els.syncBadge.textContent='å¾…åŒæ­¥'; }
    async function flushPending(){
      if(!currentUser) return;
      let q = JSON.parse(localStorage.getItem('words_pending')||'[]'); if(q.length===0){ els.syncBadge.textContent='å·²åŒæ­¥'; return; }
      for(const it of q){
        if(it.type==='upsertMany'){
          const { error } = await sb.from('words').upsert(it.rows, { onConflict:'user_id,word' });
          if(error){ console.warn('flush upsert å¤±è´¥', error.message); return; }
        } else if(it.type==='updateOne'){
          const { error } = await sb.from('words').update(it.payload).match({ user_id: currentUser.id, word: it.word });
          if(error){ console.warn('flush update å¤±è´¥', error.message); return; }
        }
      }
      localStorage.removeItem('words_pending'); els.syncBadge.textContent='å·²åŒæ­¥';
    }

    // ================= ä¸šåŠ¡é€»è¾‘ï¼ˆä¸ä½ åŸé€»è¾‘ä¸€è‡´ï¼‰ =================
    function resetLearning(){
      wordData.backup = shuffle(Object.entries(wordData.original));
      els.progress.style.width = '0%';
      els.restartBtn.style.display = 'none';
      els.showMeaningBtn.style.display = 'inline-block';
      els.knowBtn.style.display = 'none';
      els.dontKnowBtn.style.display = 'none';
      checkEmptyData();
      showNextWord();
    }

    function showNextWord(){
      if(wordData.backup.length===0){
        els.showMeaningBtn.style.display='none';
        els.restartBtn.style.display='inline-block';
        els.knowBtn.style.display='none';
        els.dontKnowBtn.style.display='none';
        return;
      }
      els.meaningDisplay.style.display='none';
      els.showMeaningBtn.style.display='inline-block';
      els.knowBtn.style.display='none';
      els.dontKnowBtn.style.display='none';
      els.restartBtn.style.display='none';

      currentWord = wordData.backup.pop(); // [word, {meaning, memoryLevel}]
      els.wordDisplay.textContent = currentWord[0];
      els.meaningDisplay.textContent = currentWord[1].meaning || '';
      updateProgress();
    }

    function updateProgress(){
      const total = Object.keys(wordData.original).length || 1;
      const remaining = wordData.backup.length;
      const p = ((total - remaining) / total * 100).toFixed(1);
      els.progress.style.width = `${p}%`;
    }

    function showMeaning(){
      els.meaningDisplay.style.display='block';
      els.showMeaningBtn.style.display='none';
      els.knowBtn.style.display='inline-block';
      els.dontKnowBtn.style.display='inline-block';
    }

    function handleKnow(know){
      if(!currentWord) return;
      const [w, v] = currentWord;
      v.memoryLevel = (v.memoryLevel||0) + (know? 1 : -1);
      if(!know){ wordData.backup.unshift([w, v]); } // ä¸è®¤è¯† â†’ æ”¾å›é˜Ÿåˆ—å‰ç«¯
      wordData.original[w] = v;
      saveLocal();
      if(currentUser) updateOne(w);
      showNextWord();
    }

    function checkEmptyData(){ els.emptyMsg.style.display = Object.keys(wordData.original).length? 'none':'block'; }

    // ================= å¯¼å…¥ / å¯¼å‡º =================
    async function onImportFile(e){
      const file = e.target.files?.[0]; if(!file) return; const text = await file.text(); e.target.value='';
      try{
        const obj = JSON.parse(text); // æœŸæœ›ï¼š{ word: { meaning, memoryLevel } }
        if(currentUser){ await upsertMany(obj); await loadAllFromCloud(); }
        else { wordData.original = { ...(wordData.original||{}), ...obj }; saveLocal(); resetLearning(); }
        alert('å¯¼å…¥å®Œæˆ');
      }catch(err){ alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š'+err.message); }
    }

    async function exportData(){
      if(currentUser){
        const { data, error } = await sb.from('words').select('word, meaning, memory_level').eq('user_id', currentUser.id).order('created_at', { ascending:true });
        if(error){ alert('å¯¼å‡ºå¤±è´¥ï¼š'+error.message); return; }
        const map = {}; (data||[]).forEach(r=>{ map[r.word] = { meaning: r.meaning, memoryLevel: r.memory_level||0 }; });
        downloadJSON(map, 'word-data_cloud.json');
      } else {
        downloadJSON(wordData.original||{}, 'word-data_local.json');
      }
    }

    async function syncLocalToCloud(){
      if(!currentUser){ alert('è¯·å…ˆç™»å½•'); return; }
      await upsertMany(wordData.original||{});
      await loadAllFromCloud();
      alert('æœ¬åœ°æ•°æ®å·²åŒæ­¥è‡³äº‘ç«¯');
    }

    function downloadJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
    }

    // ================= æ·»åŠ  / åˆ é™¤æ‰¹é‡é€»è¾‘ =================
    function onConfirmAdd(){
      const text = els.newDataInput.value||''; if(!text.trim()){ showModal(els.addDataModal,false); return; }
      const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
      const obj = {};
      for(const line of lines){ const [word, ...rest] = line.split(/\s+/); if(!word||rest.length===0) continue; const meaning = rest.join(' '); obj[word] = { meaning, memoryLevel: wordData.original?.[word]?.memoryLevel || 0 }; }
      // åˆå¹¶åˆ°æœ¬åœ°å†…å­˜
      wordData.original = { ...(wordData.original||{}), ...obj };
      saveLocal();
      if(currentUser) upsertMany(obj);
      els.newDataInput.value='';
      showModal(els.addDataModal,false);
      resetLearning();
    }

    async function onConfirmDelete(){
      const th = parseInt(els.deleteThreshold.value,10);
      if(!(th>=5)){ alert('è¯·è¾“å…¥ä¸å°äº 5 çš„æ•°å­—'); return; }
      // æœ¬åœ°
      const obj = wordData.original || {};
      for(const k of Object.keys(obj)){ if((obj[k].memoryLevel||0) >= th) delete obj[k]; }
      saveLocal(); resetLearning();
      // äº‘ç«¯
      if(currentUser){ await deleteByThreshold(th); await loadAllFromCloud(); }
      alert(`å·²åˆ é™¤è®°å¿†æ¬¡æ•° â‰¥ ${th} çš„å•è¯`);
      showModal(els.deleteModal,false);
    }

    // ================= å·¥å…·å‡½æ•° =================
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    function showHelp(){
      const help = document.createElement('div'); help.className='modal'; help.style.display='flex'; help.style.alignItems='center'; help.style.justifyContent='center';
      help.innerHTML = `<div class="dialog"><h3 style="margin:0 0 10px">ç³»ç»Ÿè¯´æ˜</h3>
      <div style="line-height:1.7">ç‚¹å‡»â€œæ˜¾ç¤ºé‡Šä¹‰â€æŸ¥çœ‹ä¸­æ–‡æ„æ€ï¼›æ”¯æŒå¯¼å…¥ JSON æ•°æ®ï¼›â€œæ·»åŠ æ•°æ®â€æ”¯æŒæŒ‰è¡Œæ·»åŠ ï¼›å¯â€œå¯¼å‡ºæ•°æ®â€ã€‚<br>ç™»å½•åæ•°æ®ä¼šä¿å­˜åˆ° Supabase äº‘ç«¯å¹¶åœ¨å¤šç«¯å®æ—¶åŒæ­¥ï¼›æœªç™»å½•ä»…ä¿å­˜åœ¨æœ¬åœ°ç¼“å­˜ã€‚</div>
      <div class="dialog-actions"><button class="btn" onclick="this.closest('.modal').remove()">å…³é—­</button></div></div>`;
      document.body.appendChild(help);
    }
  </script>
</body>
</html>
