<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¾…åŠäº‹é¡¹æ¸…å• Â· äº‘ç«¯åŒæ­¥ç‰ˆ</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(135deg,#74ebd5,#acb6e5);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Noto Sans SC','Microsoft Yahei',sans-serif;color:#333}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#ffffffb8;backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid #e7e7e7}
    .app-title{font-weight:800}
    .auth{display:flex;gap:8px;align-items:center}
    .auth input{padding:8px 10px;border:1px solid #ddd;border-radius:8px;min-width:160px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #e1e1e1;background:#fff;cursor:pointer}
    .btn.primary{background:#4CAF50;color:#fff;border-color:#4CAF50}
    .pill{padding:4px 8px;border:1px solid #e1e1e1;border-radius:999px;font-size:12px;color:#666}

    .container{background:#fff;border-radius:15px;box-shadow:0 10px 20px rgba(0,0,0,.1);padding:20px;margin:20px auto;width:min(96%,760px)}
    h1{margin:0 0 16px;color:#4CAF50}

    .topbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .topbar input[type="text"]{flex:1;padding:12px 14px;border:2px solid #ddd;border-radius:8px}
    .topbar input[type="text"]:focus{border-color:#4CAF50;outline:none;box-shadow:0 0 0 2px rgba(76,175,80,.15)}
    .add-btn{padding:0 18px;background:#4CAF50;border:0;border-radius:8px;color:#fff;font-weight:600}

    .stats{display:flex;justify-content:space-between;margin:10px 0;padding:8px 0;border-top:1px solid #eee;border-bottom:1px solid #eee}
    .count{display:flex;gap:6px;align-items:center}
    .count span{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:#4CAF50;color:#fff;font-size:12px}
    .count.done span{background:#9e9e9e}

    .tabs{display:flex;gap:10px;border-bottom:1px solid #eee;margin:12px 0}
    .tab{padding:8px 12px;cursor:pointer;border-bottom:3px solid transparent;font-weight:600}
    .tab.active{color:#4CAF50;border-bottom-color:#4CAF50}

    ul{list-style:none;margin:0;padding:0}
    li{display:flex;gap:10px;align-items:center;padding:12px;margin:10px 0;background:#f9f9f9;border-radius:10px}
    .task-content{flex:1;word-break:break-word}
    .task-content.completed{text-decoration:line-through;color:#9e9e9e}
    .check{width:22px;height:22px;border:2px solid #4CAF50;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .check.checked{background:#4CAF50;color:#fff}
    .check.checked::after{content:'âœ“';font-size:12px}
    .edit-input{flex:1;padding:8px 10px;border:2px solid #4CAF50;border-radius:8px}
    .btn.small{padding:6px 10px}
    .danger{background:#dc3545;color:#fff;border:0}
    .warn{background:#ffc107;color:#212529;border:0}
    .info{background:#17a2b8;color:#fff;border:0}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .muted{color:#666;font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="app-title">ğŸ“ å¾…åŠäº‹é¡¹æ¸…å•</div>
    <div class="auth">
      <div id="signed-out">
        <input type="email" id="email" placeholder="é‚®ç®±" />
        <input type="password" id="password" placeholder="å¯†ç ï¼ˆâ‰¥6ä½ï¼‰" />
        <button class="btn" id="btnSignUp">æ³¨å†Œ</button>
        <button class="btn primary" id="btnSignIn">ç™»å½•</button>
      </div>
      <div id="signed-in" style="display:none;gap:8px;align-items:center">
        <span class="pill" id="userEmail"></span>
        <span class="pill" id="syncBadge">æœªç™»å½•</span>
        <button class="btn" id="btnSignOut">é€€å‡º</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="toolbar">
      <button class="btn small info" id="btnExport">å¯¼å‡º JSON</button>
      <input type="file" id="fileImport" accept="application/json" style="display:none"/>
      <button class="btn small" id="btnImport">å¯¼å…¥ JSON</button>
      <button class="btn small" id="btnSyncLocal">ç«‹å³åŒæ­¥æœ¬åœ° â†’ äº‘ç«¯</button>
      <span class="muted">ï¼ˆæœªç™»å½•æ—¶ä»…ä¿å­˜åˆ°æœ¬åœ°ï¼‰</span>
    </div>

    <div class="topbar">
      <input type="text" id="title" placeholder="æ·»åŠ æ–°ä»»åŠ¡..."/>
      <button class="add-btn" id="add-btn">æ·»åŠ </button>
    </div>

    <div class="stats">
      <div class="count">å¾…å®Œæˆï¼š<span id="todo-count">0</span></div>
      <div class="count done">å·²å®Œæˆï¼š<span id="done-count">0</span></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="all">å…¨éƒ¨ä»»åŠ¡</div>
      <div class="tab" data-tab="todo">å¾…å®Œæˆ</div>
      <div class="tab" data-tab="done">å·²å®Œæˆ</div>
    </div>

    <ul id="todo-list"></ul>
  </div>

  <script>
    // =============== Supabase å®¢æˆ·ç«¯ï¼ˆæ›¿æ¢ä¸ºä½ çš„é¡¹ç›®é…ç½®ï¼‰ ===============
    const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_ANON_PUBLIC_KEY';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    // =============== å…¨å±€çŠ¶æ€ ===============
    let tasks = []; // å§‹ç»ˆä»£è¡¨å½“å‰é¡µé¢å±•ç¤ºçš„æ•°æ®
    let activeTab = 'all';
    let currentUser = null;
    let rtChannel = null;

    // =============== DOM ===============
    const els = {
      title: document.getElementById('title'),
      addBtn: document.getElementById('add-btn'),
      list: document.getElementById('todo-list'),
      todoCount: document.getElementById('todo-count'),
      doneCount: document.getElementById('done-count'),
      tabs: document.querySelectorAll('.tab'),
      exportBtn: document.getElementById('btnExport'),
      importBtn: document.getElementById('btnImport'),
      importFile: document.getElementById('fileImport'),
      syncLocalBtn: document.getElementById('btnSyncLocal'),
      signedOut: document.getElementById('signed-out'),
      signedIn: document.getElementById('signed-in'),
      userEmail: document.getElementById('userEmail'),
      syncBadge: document.getElementById('syncBadge'),
    };

    // =============== å¯åŠ¨ ===============
    window.addEventListener('load', async () => {
      wireUI();
      restoreLocal();
      render();
      await initAuth();
    });

    function wireUI(){
      els.addBtn.onclick = addNewTask;
      els.title.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addNewTask(); }});
      els.tabs.forEach(tab=> tab.addEventListener('click', ()=>{ els.tabs.forEach(t=>t.classList.remove('active')); tab.classList.add('active'); activeTab = tab.dataset.tab; render(); }));
      els.exportBtn.onclick = exportJSON;
      els.importBtn.onclick = ()=> els.importFile.click();
      els.importFile.onchange = importJSON;
      els.syncLocalBtn.onclick = syncLocalToCloud;

      document.getElementById('btnSignUp').onclick = signUp;
      document.getElementById('btnSignIn').onclick = signIn;
      document.getElementById('btnSignOut').onclick = signOut;
    }

    // =============== æœ¬åœ°å­˜å‚¨ ===============
    function restoreLocal(){ const raw = localStorage.getItem('todoList'); tasks = raw? JSON.parse(raw) : []; }
    function saveLocal(){ localStorage.setItem('todoList', JSON.stringify(tasks)); }

    // =============== Auth ===============
    async function initAuth(){
      const { data: { session } } = await sb.auth.getSession();
      currentUser = session?.user || null; updateAuthUI();
      if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); }
      sb.auth.onAuthStateChange(async (_event, session)=>{
        currentUser = session?.user || null; updateAuthUI();
        if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); }
        else { unsubscribeRealtime(); restoreLocal(); render(); }
      });
    }
    function updateAuthUI(){
      if(currentUser){
        els.signedOut.style.display='none';
        els.signedIn.style.display='flex';
        els.userEmail.textContent = currentUser.email || 'å·²ç™»å½•';
      } else {
        els.signedOut.style.display='block';
        els.signedIn.style.display='none';
      }
      updateStatusIndicator();
    } else {
        els.signedOut.style.display='block';
        els.signedIn.style.display='none';
        els.syncBadge.textContent = 'æœªç™»å½•';
      }
    }
    async function signUp(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try{
        toggleBtn('btnSignUp', true, 'æ³¨å†Œä¸­â€¦');
        const { error } = await sb.auth.signUp({ email, password });
        if(error) throw error;
        alert('æ³¨å†ŒæˆåŠŸï¼šå¦‚æœå¼€å¯äº†é‚®ä»¶éªŒè¯ï¼Œè¯·å…ˆåˆ°é‚®ç®±å®ŒæˆéªŒè¯å†ç™»å½•ã€‚');
      }catch(err){
        console.error('[signUp]', err);
        alert('æ³¨å†Œå¤±è´¥ï¼š' + (err?.message || err));
      }finally{
        toggleBtn('btnSignUp', false, 'æ³¨å†Œ');
      }
    }
    async function signIn(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if(!email || !password){ alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç '); return; }
      try{
        toggleBtn('btnSignIn', true, 'ç™»å½•ä¸­â€¦');
        console.log('[signIn] start', { email });
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error){
          const map = {
            'Email not confirmed': 'é‚®ç®±æœªéªŒè¯ï¼šè¯·åˆ°é‚®ç®±ç‚¹ç¡®è®¤é“¾æ¥ï¼ˆæˆ–åœ¨ Auth/Email ä¸´æ—¶å…³é—­ Confirm emailï¼‰',
            'Invalid login credentials': 'é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®'
          };
          alert('ç™»å½•å¤±è´¥ï¼š' + (map[error.message] || error.message));
          return;
        }
        // å…³é”®ï¼šä¸ç­‰äº‹ä»¶ï¼Œç«‹åˆ»åˆ‡æ¢åˆ°å·²ç™»å½•å¹¶æ‹‰æ•°æ®/è®¢é˜…
        currentUser = data?.user || (await sb.auth.getUser()).data?.user || null;
        updateAuthUI();
        await loadAllFromCloud();
        subscribeRealtime();
        console.log('[signIn] success', currentUser?.id);
      }catch(err){
        console.error('[signIn] error', err);
        alert('ç½‘ç»œæˆ–è„šæœ¬é”™è¯¯ï¼š' + (err?.message || err));
      }finally{
        toggleBtn('btnSignIn', false, 'ç™»å½•');
      }
    }
    async function signOut(){
      try{
        toggleBtn('btnSignOut', true, 'é€€å‡ºä¸­â€¦');
        await sb.auth.signOut();
      }catch(err){
        console.error('[signOut]', err);
        alert('é€€å‡ºå¤±è´¥ï¼š' + (err?.message || err));
      }finally{
        toggleBtn('btnSignOut', false, 'é€€å‡º');
      }
    }

    async function addNewTask(){
      const title = els.title.value.trim();
      if(!title){ alert('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹'); return; }

      if(currentUser){
        const { data, error } = await sb
          .from('todos')
          .insert({ user_id: currentUser.id, title, done: false })
          .select('*')
          .single();
        if(error){ alert('äº‘ç«¯æ–°å¢å¤±è´¥ï¼š'+error.message); return; }
        tasks.push({ id: data.id, title: data.title, done: data.done, created_at: data.created_at });
      } else {
        const localId = 'local-'+Date.now();
        tasks.push({ id: localId, title, done: false, created_at: new Date().toISOString() });
      }
      els.title.value='';
      saveLocal();
      render();
    }

    async function toggleTask(id){
      const idx = tasks.findIndex(t=>t.id===id);
      if(idx===-1) return;
      const newDone = !tasks[idx].done;
      tasks[idx].done = newDone; // å…ˆæœ¬åœ°æ›´æ–°
      render(); saveLocal();

      if(currentUser && !String(id).startsWith('local-')){
        const { error } = await sb.from('todos').update({ done: newDone }).eq('id', id);
        if(error){ console.warn('äº‘ç«¯æ›´æ–°å¤±è´¥ï¼š', error.message); }
      }
    }

    function editTask(id){
      const li = document.querySelector(`li[data-id="${id}"]`);
      const task = tasks.find(t=>t.id===id); if(!task || !li) return;
      li.innerHTML = `
        <div class="check ${task.done?'checked':''}" onclick="toggleTask('${id}')"></div>
        <input type="text" class="edit-input" value="${escapeHtml(task.title)}"/>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn small info" onclick="saveTask('${id}')">ä¿å­˜</button>
          <button class="btn small danger" onclick="deleteTask('${id}')">åˆ é™¤</button>
        </div>`;
      li.querySelector('.edit-input').focus();
    }

    async function saveTask(id){
      const li = document.querySelector(`li[data-id="${id}"]`);
      const input = li?.querySelector('.edit-input');
      if(!input) return; const newTitle = input.value.trim();
      if(!newTitle){ alert('ä»»åŠ¡å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
      const idx = tasks.findIndex(t=>t.id===id); if(idx===-1) return;
      tasks[idx].title = newTitle; render(); saveLocal();

      if(currentUser && !String(id).startsWith('local-')){
        const { error } = await sb.from('todos').update({ title: newTitle }).eq('id', id);
        if(error){ console.warn('äº‘ç«¯æ›´æ–°å¤±è´¥ï¼š', error.message); }
      }
    }

    async function deleteTask(id){
      tasks = tasks.filter(t=>t.id!==id); render(); saveLocal();
      if(currentUser && !String(id).startsWith('local-')){
        const { error } = await sb.from('todos').delete().eq('id', id);
        if(error){ console.warn('äº‘ç«¯åˆ é™¤å¤±è´¥ï¼š', error.message); }
      }
    }

    // =============== æ¸²æŸ“ ===============
    function render(){
      const filtered = tasks.filter(t=> activeTab==='all' ? true : activeTab==='todo' ? !t.done : t.done);
      els.list.innerHTML = '';
      if(filtered.length===0){
        els.list.innerHTML = `<li style="justify-content:center;color:#999;">ğŸ“­ æ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡</li>`;
      } else {
        for(const task of filtered){
          const li = document.createElement('li'); li.dataset.id = task.id;
          li.innerHTML = `
            <div class="check ${task.done?'checked':''}" onclick="toggleTask('${task.id}')"></div>
            <div class="task-content ${task.done?'completed':''}">${escapeHtml(task.title)}</div>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button class="btn small warn" onclick="editTask('${task.id}')">ç¼–è¾‘</button>
              <button class="btn small danger" onclick="deleteTask('${task.id}')">åˆ é™¤</button>
            </div>`;
          els.list.appendChild(li);
        }
      }
      const todoN = tasks.filter(t=>!t.done).length;
      const doneN = tasks.filter(t=> t.done).length;
      els.todoCount.textContent = todoN; els.doneCount.textContent = doneN;
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // =============== å¯¼å…¥ / å¯¼å‡º / åŒæ­¥ ===============
    async function exportJSON(){
      if(currentUser){
        const { data, error } = await sb.from('todos').select('*').eq('user_id', currentUser.id).order('created_at',{ascending:true});
        if(error){ alert('å¯¼å‡ºå¤±è´¥ï¼š'+error.message); return; }
        downloadBlob(new Blob([JSON.stringify(data, null, 2)],{type:'application/json'}), 'todos-export.json');
      } else {
        downloadBlob(new Blob([JSON.stringify(tasks, null, 2)],{type:'application/json'}), 'todos-export-local.json');
      }
    }
    async function importJSON(e){
      const file = e.target.files?.[0]; if(!file) return; const text = await file.text(); e.target.value='';
      try{
        const arr = JSON.parse(text); if(!Array.isArray(arr)) throw new Error('JSON é¡»ä¸ºæ•°ç»„');
        if(currentUser){
          const rows = arr.map(x=>({ user_id: currentUser.id, title: x.title||'', done: !!x.done, created_at: x.created_at || new Date().toISOString() }));
          const { error } = await sb.from('todos').insert(rows); if(error) throw error; await loadAllFromCloud();
        } else {
          const mapped = arr.map(x=>({ id: 'local-'+Date.now()+Math.random(), title: x.title||'', done: !!x.done, created_at: x.created_at || new Date().toISOString() }));
          tasks.push(...mapped); saveLocal(); render();
        }
        alert('å¯¼å…¥å®Œæˆ');
      }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message); }
    }
    async function syncLocalToCloud(){
      if(!currentUser){ alert('è¯·å…ˆç™»å½•'); return; }
      const locals = tasks.filter(t=> String(t.id).startsWith('local-'));
      if(locals.length===0){ alert('æ²¡æœ‰éœ€è¦åŒæ­¥çš„æœ¬åœ°ä»»åŠ¡'); return; }
      const rows = locals.map(t=>({ user_id: currentUser.id, title: t.title, done: t.done, created_at: t.created_at }));
      const { error } = await sb.from('todos').insert(rows);
      if(error){ alert('åŒæ­¥å¤±è´¥ï¼š'+error.message); return; }
      await loadAllFromCloud();
      alert('æœ¬åœ°ä»»åŠ¡å·²åŒæ­¥è‡³äº‘ç«¯');
    }
    function downloadBlob(blob, filename){ const a=document.createElement('a'); a.download=filename; a.href=URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href); }

    // =============== Realtime ===============
    function subscribeRealtime(){
      if(rtChannel) sb.removeChannel(rtChannel);
      rtChannel = sb.channel('todos-ch');
      rtChannel.on('postgres_changes', { event:'*', schema:'public', table:'todos', filter:`user_id=eq.${currentUser.id}` }, async ()=>{ await loadAllFromCloud(); }).subscribe();
    }
    function unsubscribeRealtime(){ if(rtChannel){ sb.removeChannel(rtChannel); rtChannel=null; } }

    // æš´éœ²ç»™ HTML å†…è”äº‹ä»¶
    window.toggleTask = toggleTask;
    window.deleteTask = deleteTask;
    window.editTask = editTask;
    window.saveTask = saveTask;
  </script>

  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"70f3b625243c456f9ab4034f8b8b3974","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous">// â€”â€” çŠ¶æ€æŒ‡ç¤ºç¯ & å·¥å…· â€”â€”
    function updateStatusIndicator(){
      const online = navigator.onLine;
      const pending = JSON.parse(localStorage.getItem('words_pending')||'[]').length;
      let parts = [];
      parts.push(online ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿');
      parts.push(currentUser ? 'å·²ç™»å½•' : 'æœªç™»å½•');
      if(currentUser){
        parts.push(pending>0 ? `å¾…åŒæ­¥(${pending})` : 'å·²åŒæ­¥');
      }
      els.syncBadge.textContent = parts.join(' Â· ');
    }
    window.addEventListener('online', ()=>{ updateStatusIndicator(); try{ flushPending(); }catch(e){} });
    window.addEventListener('offline', updateStatusIndicator);

    function toggleBtn(id, disabled, text){
      const btn = document.getElementById(id);
      if(!btn) return;
      btn.disabled = !!disabled;
      if(text) btn.textContent = text;
    }
    window.addEventListener('unhandledrejection', (e)=>{
      console.error('[unhandledrejection]', e.reason);
      alert('å‡ºé”™äº†ï¼š' + (e.reason?.message || e.reason));
    });
  </script>
</body>
</html>
