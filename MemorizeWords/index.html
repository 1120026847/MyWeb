<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>èƒŒå•è¯ï¼ˆå¢¨å¢¨é£æ ¼ï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f7f9fc;--card:#fff;--line:#e5e7eb;--text:#0b1220;--muted:#6b7280;
    --accent:#2563eb;--accent-weak:#eef2ff;--green:#22c55e;--red:#ef4444;--radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}

  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .container{padding:12px 16px}
  .nav{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:clamp(18px,4.5vw,22px)}
  .account{margin-left:auto;display:flex;gap:10px;align-items:center}
  .account-btn{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe;
    padding:8px 12px;border-radius:999px;font-weight:600;max-width:70vw;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }
  .pill{font-size:12px;color:#666;border:1px solid #e1e1e1;border-radius:999px;padding:4px 8px;background:#fff}

  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);
        padding:16px;box-shadow:0 6px 26px rgba(0,0,0,.06);max-width:920px;margin:16px auto}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)}

  button{border-radius:12px;padding:12px 16px;border:1px solid #cfe3ff;background:var(--accent-weak);color:#1e3a8a;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  button.green{background:var(--green);color:#fff;border:none}
  button.red{background:var(--red);color:#fff;border:none}
  button:disabled{opacity:.6;cursor:not-allowed}

  /* ä¸»åŒºåŸŸ */
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .status{margin-left:auto}

  .word{font-size:clamp(28px,8vw,64px);text-align:center;margin:36px 0 10px}
  .meaning{font-size:clamp(20px,6vw,36px);text-align:center;color:#1e40af;min-height:40px;display:none;margin:18px 0}
  .actions{display:flex;justify-content:center;gap:12px;margin:26px 0 6px;flex-wrap:wrap}
  .progress-wrap{display:flex;justify-content:center}
  .bar{width:86%;height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#22c55e)}

  /* æ¨¡æ€ï¼ˆä¸â€œå¤‡å¿˜å½•â€ä¸€è‡´é£æ ¼ï¼‰ */
  .modal{position:fixed;inset:0;z-index:30000;display:none}
  .modal.show{display:block}
  .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .modal .panel{
    position:absolute;left:50%;top:10%;transform:translateX(-50%);
    width:min(92vw,480px);max-height:80vh;overflow:auto;
    background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px
  }
  @media (max-width:680px){
    .modal .panel{
      left:12px;right:12px;top:auto;bottom:12px;transform:none;width:auto;max-height:84vh;
      border-radius:16px 16px 12px 12px
    }
  }
  .modal .close-x{
    position:absolute;right:10px;top:10px;width:36px;height:36px;
    border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer
  }
  .modal .title{margin:0 40px 10px 0;font-size:18px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .panel .btn{height:42px}

  textarea,input[type="text"]{
    width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font:inherit
  }

  /* å¯¼å…¥/åˆ é™¤å¼¹çª— */
  .m-pop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:20000;align-items:center;justify-content:center}
  .m-pop .dialog{background:#fff;padding:16px;border-radius:14px;width:min(92vw,560px)}
  .m-pop .actions{justify-content:flex-end;margin:8px 0 0}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <h1>èƒŒå•è¯ï¼ˆå¢¨å¢¨é£æ ¼ï¼‰</h1>
    <div class="account">
      <span id="syncBadge" class="pill">æœªç™»å½•</span>
      <button id="accountBtn" class="account-btn">ç™»å½• / æ³¨å†Œ</button>
    </div>
  </div>
</header>

<main class="card">
  <div class="toolbar">
    <input id="fileInput" type="file" hidden accept="application/json" />
    <button id="btnImportJson">å¯¼å…¥ JSON</button>
    <button id="btnImportText">å¯¼å…¥å•è¯ï¼ˆæ–‡æœ¬ï¼‰</button>
    <button id="btnExport" class="primary">å¯¼å‡º JSON</button>
    <button id="btnSyncLocal">æœ¬åœ° â†’ äº‘ç«¯</button>
    <button id="btnDelete" style="margin-left:auto">åˆ é™¤è®°å¿†åº¦ â‰¥ 5</button>
    <button id="btnHelp">è¯´æ˜</button>
  </div>

  <div class="progress-wrap"><div class="bar"><i id="progress"></i></div></div>

  <div id="emptyMsg" class="muted" style="text-align:center;margin:20px 0;display:none">è¯åº“ä¸ºç©ºï¼Œè¯·å…ˆå¯¼å…¥</div>

  <div id="word" class="word"></div>
  <div id="meaning" class="meaning"></div>

  <div class="actions">
    <button id="btnShow" class="primary">æ˜¾ç¤ºæ„æ€</button>
    <button id="btnKnow" class="green" style="display:none">è®¤è¯†</button>
    <button id="btnDont" class="red" style="display:none">ä¸è®¤è¯†</button>
    <button id="btnRestart" style="display:none">é‡æ–°å¼€å§‹</button>
  </div>
</main>

<!-- æ–‡æœ¬å¯¼å…¥å¼¹çª— -->
<div id="dlgImportText" class="m-pop">
  <div class="dialog">
    <h3 style="margin:0 0 8px">æ‰¹é‡å¯¼å…¥ï¼ˆæ¯è¡Œä¸€ç»„ï¼šè‹±æ–‡ ç©ºæ ¼ ä¸­æ–‡ï¼‰</h3>
    <textarea id="textBulk" placeholder="apple è‹¹æœ&#10;take off è„±ä¸‹ï¼›èµ·é£"></textarea>
    <div class="actions">
      <button id="okImportText" class="primary">ç¡®å®š</button>
      <button id="cancelImportText">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- åˆ é™¤é˜ˆå€¼å¼¹çª— -->
<div id="dlgDelete" class="m-pop">
  <div class="dialog">
    <h3 style="margin:0 0 8px">åˆ é™¤è®°å¿†åº¦â‰¥é˜ˆå€¼</h3>
    <div class="row">
      <input id="deleteTh" type="number" min="5" value="5" style="max-width:140px" />
      <span class="muted">é»˜è®¤ 5ï¼Œå¯æ”¹</span>
    </div>
    <div class="actions">
      <button id="okDelete" class="primary">ç¡®å®š</button>
      <button id="cancelDelete">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- è´¦å·æ¨¡æ€ï¼ˆæ²¿ç”¨â€œå¤‡å¿˜å½•â€æ ·å¼ä¸äº¤äº’ï¼‰ -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-hidden="true">
  <div class="backdrop" id="modalBackdrop"></div>
  <div class="panel" role="document">
    <button class="close-x" id="modalClose" aria-label="å…³é—­">âœ•</button>
    <h3 id="dialogTitle" class="title">ç™»å½• / æ³¨å†Œ</h3>
    <div id="dialogBody"></div>
  </div>
</div>

<script>
/* ========= Supabase =========
 * éœ€è¦çš„è¡¨ï¼ˆSQLï¼‰ï¼š
 * create table if not exists public.words(
 *   user_id uuid references auth.users(id) on delete cascade,
 *   word text not null,
 *   meaning text default '',
 *   memory_level int default 0,
 *   created_at timestamptz default now(),
 *   primary key(user_id, word)
 * );
 * å¯ç”¨ RLS å¹¶ç»™ anon æˆæƒå¯¹åº”ç­–ç•¥ï¼ˆæˆ–ä»…ç™»å½•å¯è¯»å†™ï¼‰ã€‚
 */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true} });

/* ========= DOM & çŠ¶æ€ ========= */
const $=id=>document.getElementById(id);
const els={
  word:$('word'), meaning:$('meaning'), progress:$('progress'), empty:$('emptyMsg'),
  btnShow:$('btnShow'), btnKnow:$('btnKnow'), btnDont:$('btnDont'), btnRestart:$('btnRestart'),
  fileInput:$('fileInput'), btnImportJson:$('btnImportJson'), btnImportText:$('btnImportText'),
  btnExport:$('btnExport'), btnSyncLocal:$('btnSyncLocal'),
  btnDelete:$('btnDelete'), dlgDelete:$('dlgDelete'), th:$('deleteTh'), okDelete:$('okDelete'), cancelDelete:$('cancelDelete'),
  dlgImportText:$('dlgImportText'), textBulk:$('textBulk'), okImportText:$('okImportText'), cancelImportText:$('cancelImportText'),
  accountBtn:$('accountBtn'), sync:$('syncBadge'),
  modal:$('modal'),backdrop:$('modalBackdrop'),close:$('modalClose'),title:$('dialogTitle'),body:$('dialogBody')
};

let sessionUser=null, rtChannel=null;
let dataMap = {};                 // { word: { meaning, memoryLevel } }
let queue = [];                   // å­¦ä¹ é˜Ÿåˆ—  [ [word, obj], ... ]
let cur = null;                   // å½“å‰ [word, obj]
let dirtyLocal=false;

/* ========= å°å·¥å…· ========= */
const toast=(m)=>{console.log('[toast]',m)};
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
const saveLocal=()=>localStorage.setItem('words_local',JSON.stringify(dataMap));
const loadLocal=()=>{try{dataMap=JSON.parse(localStorage.getItem('words_local')||'{}')||{}}catch{dataMap={}}};
const pendingQKey='words_pending';
const getPending=()=>JSON.parse(localStorage.getItem(pendingQKey)||'[]');
const setPending=q=>localStorage.setItem(pendingQKey,JSON.stringify(q));

/* ========= è´¦æˆ·æ¨¡æ€ï¼ˆæ²¿ç”¨å¤‡å¿˜å½•äº¤äº’ï¼‰ ========= */
let lastFocus=null;
function openModal(title,html){
  els.title.textContent=title;els.body.innerHTML=html;
  lastFocus=document.activeElement;els.modal.classList.add('show');els.modal.removeAttribute('aria-hidden');
  document.body.style.overflow='hidden';
  const f=els.body.querySelector('input,button');if(f)setTimeout(()=>f.focus(),0);
}
function closeModal(){
  els.modal.classList.remove('show');els.modal.setAttribute('aria-hidden','true');document.body.style.overflow='';
  if(lastFocus)lastFocus.focus();
}
els.backdrop.onclick=closeModal;els.close.onclick=closeModal;
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&els.modal.classList.contains('show'))closeModal()});

function showAuth(){
  openModal('ç™»å½• / æ³¨å†Œ', `
    <div class="field"><label>é‚®ç®±</label><input id="em" type="email" placeholder="you@example.com"></div>
    <div class="field"><label>å¯†ç ï¼ˆâ‰¥6ä½ï¼‰</label><input id="pw" type="password" placeholder="******"></div>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <button id="lg" class="primary">ç™»å½•</button>
      <button id="sg">æ³¨å†Œ</button>
    </div>
    <div id="hint" class="muted" style="margin-top:6px"></div>
  `);
  const hint=$('hint');
  $('lg').onclick=async()=>{
    const email=$('em').value.trim(),password=$('pw').value; if(!email||!password){hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';return}
    try{
      const { error } = await sb.auth.signInWithPassword({ email,password });
      if(error){ hint.textContent='ç™»å½•å¤±è´¥ï¼š'+error.message; return; }
      toast('ç™»å½•æˆåŠŸ'); closeModal();
    }catch(err){ hint.textContent='ç™»å½•å¼‚å¸¸ï¼š'+(err?.message||err)}
  };
  $('sg').onclick=async()=>{
    const email=$('em').value.trim(),password=$('pw').value; if(!email||!password){hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';return}
    try{
      const { error } = await sb.auth.signUp({ email,password });
      hint.textContent = error ? ('æ³¨å†Œå¤±è´¥ï¼š'+error.message) : 'æ³¨å†ŒæˆåŠŸã€‚å¦‚å¼€å¯é‚®ç®±éªŒè¯ï¼Œè¯·åˆ°é‚®ç®±ç¡®è®¤åå†ç™»å½•ã€‚';
    }catch(err){ hint.textContent='æ³¨å†Œå¼‚å¸¸ï¼š'+(err?.message||err)}
  };
}
function showAccount(u){
  openModal('è´¦æˆ·', `
    <div class="field"><div class="muted">é‚®ç®±ï¼š${u.email||''}</div></div>
    <div class="row" style="gap:8px;justify-content:flex-end"><button id="lo" class="primary">é€€å‡ºç™»å½•</button></div>
  `);
  $('lo').onclick=async()=>{ await sb.auth.signOut(); toast('å·²é€€å‡º'); closeModal(); };
}
els.accountBtn.onclick=()=>{sessionUser?showAccount(sessionUser):showAuth()};

/* ========= UI & å­¦ä¹ æµç¨‹ ========= */
function resetQueue(){
  queue = shuffle(Object.entries(dataMap));
  cur=null;
  els.progress.style.width='0%';
  els.meaning.style.display='none';
  els.btnShow.style.display='inline-block';
  els.btnKnow.style.display='none';
  els.btnDont.style.display='none';
  els.btnRestart.style.display='none';
  els.empty.style.display = queue.length? 'none':'block';
  next();
}
function next(){
  if(queue.length===0){
    els.word.textContent='æ­å–œï¼Œä»Šæ—¥å­¦ä¹ å®Œæˆï¼';
    els.meaning.style.display='none';
    els.btnShow.style.display='none';
    els.btnKnow.style.display='none';
    els.btnDont.style.display='none';
    els.btnRestart.style.display='inline-block';
    return;
  }
  cur = queue.pop(); // [word, obj]
  els.word.textContent = cur[0];
  els.meaning.textContent = cur[1].meaning || '';
  els.meaning.style.display='none';
  els.btnShow.style.display='inline-block';
  els.btnKnow.style.display='none';
  els.btnDont.style.display='none';
  els.btnRestart.style.display='none';
  updateProgress();
}
function updateProgress(){
  const total = Object.keys(dataMap).length || 1;
  const remain = queue.length;
  els.progress.style.width = (((total-remain)/total*100).toFixed(1))+'%';
}
els.btnShow.onclick=()=>{ els.meaning.style.display='block'; els.btnShow.style.display='none'; els.btnKnow.style.display='inline-block'; els.btnDont.style.display='inline-block'; };
els.btnKnow.onclick=()=>vote(true);
els.btnDont.onclick=()=>vote(false);
els.btnRestart.onclick=resetQueue;

function vote(known){
  if(!cur) return;
  const [w, v] = cur;
  v.memoryLevel = (v.memoryLevel||0) + (known?1:-1);
  if(!known){ queue.unshift([w,v]); }  // ä¸è®¤è¯† â†’ æ”¾å›é˜Ÿåˆ—å‰ç«¯
  dataMap[w] = v; saveLocal(); dirtyLocal=true;
  if(sessionUser) updateOne(w);
  next();
}

/* ========= å¯¼å…¥å¯¼å‡º ========= */
function showPop(el,on){ el.style.display = on?'flex':'none'; }
$('btnImportJson').onclick=()=>els.fileInput.click();
els.fileInput.onchange=async e=>{
  const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); e.target.value='';
  try{
    const obj=JSON.parse(text); // { word:{meaning,memoryLevel} }
    Object.assign(dataMap, obj); saveLocal(); dirtyLocal=true;
    if(sessionUser) await upsertMany(obj);
    resetQueue(); toast('å¯¼å…¥ JSON å®Œæˆ');
  }catch(err){ alert('JSON è§£æå¤±è´¥ï¼š'+(err?.message||err)) }
};
$('btnImportText').onclick=()=>showPop(els.dlgImportText,true);
els.okImportText.onclick=()=>{
  const lines=(els.textBulk.value||'').split('\n').map(s=>s.trim()).filter(Boolean);
  const obj={};
  for(const line of lines){
    const [w,...rest]=line.split(/\s+/); const meaning=rest.join(' ');
    if(w && meaning){ obj[w] = { meaning, memoryLevel: dataMap[w]?.memoryLevel||0 }; }
  }
  Object.assign(dataMap,obj); saveLocal(); dirtyLocal=true;
  if(sessionUser) upsertMany(obj);
  els.textBulk.value=''; showPop(els.dlgImportText,false); resetQueue();
};
els.cancelImportText.onclick=()=>showPop(els.dlgImportText,false);

$('btnExport').onclick=async()=>{
  if(sessionUser){
    // ä»äº‘ç«¯å¯¼å‡º
    const { data, error } = await sb.from('words').select('word,meaning,memory_level').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
    if(error){ alert('å¯¼å‡ºå¤±è´¥ï¼š'+error.message); return; }
    const map={}; (data||[]).forEach(r=>map[r.word]={meaning:r.meaning,memoryLevel:r.memory_level||0});
    download(map,'words_cloud.json');
  }else{
    download(dataMap,'words_local.json');
  }
};
function download(obj,name){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href);
}

/* ========= åˆ é™¤ï¼ˆé˜ˆå€¼ â‰¥ 5ï¼‰ ========= */
$('btnDelete').onclick=()=>showPop(els.dlgDelete,true);
els.cancelDelete.onclick=()=>showPop(els.dlgDelete,false);
els.okDelete.onclick=async()=>{
  const th = Math.max(5, parseInt(els.th.value||'5',10));
  for(const k of Object.keys(dataMap)){ if((dataMap[k].memoryLevel||0) >= th) delete dataMap[k]; }
  saveLocal(); resetQueue();
  if(sessionUser){ await deleteByThreshold(th); await loadAllFromCloud(); }
  showPop(els.dlgDelete,false); alert(`å·²åˆ é™¤è®°å¿†åº¦ â‰¥ ${th} çš„å•è¯`);
};

/* ========= äº‘ç«¯ï¼šåŠ è½½/å†™å…¥/åŒæ­¥ ========= */
function updateBadge(){
  const online = navigator.onLine;
  const pend = getPending().length;
  const parts=[];
  parts.push(online?'ğŸŸ¢ åœ¨çº¿':'ğŸ”´ ç¦»çº¿');
  parts.push(sessionUser?'å·²ç™»å½•':'æœªç™»å½•');
  if(sessionUser) parts.push(pend>0?`å¾…åŒæ­¥(${pend})`:'å·²åŒæ­¥');
  els.sync.textContent = parts.join(' Â· ');
}
window.addEventListener('online',()=>{updateBadge(); flushPending();});
window.addEventListener('offline',updateBadge);

async function loadAllFromCloud(){
  if(!sessionUser) return;
  const { data, error } = await sb.from('words').select('word,meaning,memory_level').eq('user_id',sessionUser.id).order('created_at',{ascending:true});
  if(error){ console.warn('äº‘ç«¯åŠ è½½å¤±è´¥ï¼š',error.message); return; }
  const map={}; (data||[]).forEach(r=>map[r.word]={meaning:r.meaning,memoryLevel:r.memory_level||0});
  dataMap = map; saveLocal(); resetQueue(); updateBadge();
}

async function upsertMany(obj){
  if(!sessionUser) return;
  const rows = Object.entries(obj).map(([w,v])=>({ user_id:sessionUser.id, word:w, meaning:v.meaning||'', memory_level:v.memoryLevel||0 }));
  if(rows.length===0) return;
  const { error } = await sb.from('words').upsert(rows, { onConflict:'user_id,word' });
  if(error){ queuePending({type:'upsertMany',rows}); updateBadge(); }
}

async function updateOne(word){
  if(!sessionUser) return;
  const v=dataMap[word]; if(!v) return;
  const { error } = await sb.from('words').update({ meaning:v.meaning||'', memory_level:v.memoryLevel||0 }).match({ user_id:sessionUser.id, word });
  if(error){ queuePending({type:'updateOne', word, payload:{ meaning:v.meaning||'', memory_level:v.memoryLevel||0 }}); updateBadge(); }
}

async function deleteByThreshold(th){
  if(!sessionUser) return;
  const { error } = await sb.from('words').delete().eq('user_id',sessionUser.id).gte('memory_level',th);
  if(error) alert('äº‘ç«¯åˆ é™¤å¤±è´¥ï¼š'+error.message);
}

function subscribeRealtime(){
  if(rtChannel) sb.removeChannel(rtChannel);
  if(!sessionUser) return;
  rtChannel = sb.channel('words-ch')
    .on('postgres_changes',{event:'*',schema:'public',table:'words',filter:`user_id=eq.${sessionUser.id}`}, async ()=>{ await loadAllFromCloud(); })
    .subscribe();
}
function unsubscribeRealtime(){ if(rtChannel){ sb.removeChannel(rtChannel); rtChannel=null; } }

/* ç¦»çº¿å¾…åŒæ­¥ */
function queuePending(item){ const q=getPending(); q.push(item); setPending(q); }
async function flushPending(){
  if(!sessionUser) return;
  let q=getPending(); if(q.length===0){ updateBadge(); return; }
  for(const it of q){
    if(it.type==='upsertMany'){
      const { error } = await sb.from('words').upsert(it.rows,{ onConflict:'user_id,word' });
      if(error){ console.warn('flush upsert å¤±è´¥',error.message); return; }
    }else if(it.type==='updateOne'){
      const { error } = await sb.from('words').update(it.payload).match({ user_id:sessionUser.id, word:it.word });
      if(error){ console.warn('flush update å¤±è´¥',error.message); return; }
    }
  }
  setPending([]); updateBadge();
}

/* ========= è®¤è¯ç›‘å¬ & åˆå§‹åŒ– ========= */
sb.auth.onAuthStateChange(async (_evt,sess)=>{
  sessionUser = sess?.user || null;
  els.accountBtn.textContent = sessionUser?`å·²ç™»å½•ï¼š${sessionUser.email||'ç”¨æˆ·'}`:'ç™»å½• / æ³¨å†Œ';
  updateBadge();
  if(sessionUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
  else{ unsubscribeRealtime(); loadLocal(); resetQueue(); }
});

(async function init(){
  loadLocal(); resetQueue(); updateBadge();
  const { data:{session} } = await sb.auth.getSession();
  sessionUser = session?.user || null;
  els.accountBtn.textContent = sessionUser?`å·²ç™»å½•ï¼š${sessionUser.email||'ç”¨æˆ·'}`:'ç™»å½• / æ³¨å†Œ';
  if(sessionUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
})();
</script>
</body>
</html>
