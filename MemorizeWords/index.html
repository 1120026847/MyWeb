<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ™ºèƒ½å•è¯è®°å¿†ç³»ç»Ÿ Â· äº‘ç«¯åŒæ­¥ç‰ˆ</title>
  <style>
    :root{--primary:#4CAF50;--blue:#2196F3;--red:#f44336;}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;flex-direction:column;background:#f5f5f5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Noto Sans SC','Microsoft Yahei',sans-serif;color:#222}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:5}
    .app-title{font-weight:800}
    .auth{display:flex;gap:8px;align-items:center}
    .auth input{padding:8px 10px;border:1px solid #ddd;border-radius:8px;min-width:160px}
    .btn{padding:10px 16px;border-radius:8px;border:1px solid #e1e1e1;background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .pill{padding:4px 8px;border:1px solid #e1e1e1;border-radius:999px;font-size:12px;color:#666}

    .main{flex:1;max-width:880px;margin:20px auto;padding:20px;background:#fff;border-radius:14px;box-shadow:0 10px 20px rgba(0,0,0,.06)}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .word-display{text-align:center;font-size:5em;margin:40px 0;min-height:120px;line-height:1.2}
    .meaning-display{text-align:center;font-size:3.2em;color:var(--blue);margin:30px 0;min-height:80px;display:none;line-height:1.3}
    .action-buttons{display:flex;justify-content:center;gap:12px;margin:40px 0}
    #knowBtn,#dontKnowBtn,#showMeaningBtn,#restartBtn{padding:18px 36px;font-size:22px;min-width:160px;border:0;color:#fff;border-radius:10px}
    #restartBtn{display:none;background:var(--blue)}
    #knowBtn{background:var(--primary)}
    #dontKnowBtn{background:var(--red)}
    #showMeaningBtn{background:var(--blue)}

    #progressBar{width:80%;height:12px;background:#ddd;border-radius:6px;margin:30px auto 20px}
    #progress{height:100%;background:var(--primary);transition:width .3s;border-radius:6px}

    .modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
    .dialog{background:#fff;padding:24px;border-radius:12px;min-width:420px;max-width:92vw}
    .dialog textarea{width:100%;height:180px;margin:12px 0;padding:12px;font-size:15px;border:2px solid #ddd;border-radius:10px;resize:vertical;line-height:1.6}
    .dialog-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .warning-text{color:#d33}

    .control-group{display:flex;gap:10px;justify-content:center;margin:10px 0;flex-wrap:wrap}
    #emptyMsg{text-align:center;margin:40px 0;font-size:1.6em;color:#666}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="app-title">ğŸ“š æ™ºèƒ½å•è¯è®°å¿†ç³»ç»Ÿ</div>
    <div class="auth">
      <div id="signed-out">
        <input type="email" id="email" placeholder="é‚®ç®±"/>
        <input type="password" id="password" placeholder="å¯†ç ï¼ˆâ‰¥6ä½ï¼‰"/>
        <button class="btn" id="btnSignUp">æ³¨å†Œ</button>
        <button class="btn primary" id="btnSignIn">ç™»å½•</button>
      </div>
      <div id="signed-in" style="display:none;gap:8px;align-items:center">
        <span class="pill" id="userEmail"></span>
        <span class="pill" id="syncBadge">æœªç™»å½•</span>
        <button class="btn" id="btnSignOut">é€€å‡º</button>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="toolbar">
      <button class="btn" onclick="location.href='https://www.molijun.com'">é¦–é¡µ</button>
      <input type="file" id="fileInput" hidden accept="application/json"/>
      <button class="btn" id="btnImport">å¯¼å…¥ JSON</button>
      <button class="btn" id="btnAdd">æ·»åŠ æ•°æ®</button>
      <button class="btn" id="btnExport">å¯¼å‡º JSON</button>
      <button class="btn" id="btnSyncLocal">åŒæ­¥æœ¬åœ° â†’ äº‘ç«¯</button>
      <span style="color:#666;font-size:12px">ï¼ˆæœªç™»å½•ä»…ä¿å­˜åœ¨æœ¬åœ°ï¼‰</span>
    </div>

    <div class="control-group">
      <button class="btn" id="btnDeleteWords">åˆ é™¤å•è¯</button>
      <button class="btn" id="btnHelp">è¯´æ˜</button>
    </div>

    <div id="progressBar"><div id="progress"></div></div>
    <div id="emptyMsg" style="display:none;">æ•°æ®ä¸ºç©ºï¼Œè¯·æ·»åŠ æ•°æ®</div>

    <div class="word-display" id="wordDisplay"></div>
    <div class="meaning-display" id="meaningDisplay"></div>

    <div class="action-buttons">
      <button class="btn" id="knowBtn" style="display:none;background:var(--primary);">è®¤è¯†</button>
      <button class="btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
      <button class="btn" id="showMeaningBtn" style="background:var(--blue);">æ˜¾ç¤ºé‡Šä¹‰</button>
      <button class="btn" id="dontKnowBtn" style="display:none;background:var(--red);">ä¸è®¤è¯†</button>
    </div>
  </main>

  <!-- æ·»åŠ æ•°æ® -->
  <div id="addDataModal" class="modal">
    <div class="dialog">
      <h3 style="margin:0 0 8px">æ·»åŠ æ–°å•è¯</h3>
      <textarea id="newDataInput" placeholder="æ¯è¡Œï¼šå•è¯ é‡Šä¹‰ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰&#10;ç¤ºä¾‹ï¼š&#10;apple è‹¹æœ&#10;banana é¦™è•‰"></textarea>
      <div class="dialog-actions">
        <button class="btn" id="confirmAdd">ç¡®å®š</button>
        <button class="btn" id="cancelAdd">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- åˆ é™¤é˜ˆå€¼ -->
  <div id="deleteModal" class="modal">
    <div class="dialog">
      <h4 style="margin:0 0 8px">åˆ é™¤è®°å¿†æ¬¡æ•°è¾ƒå¤šçš„å•è¯</h4>
      <p>è¯·è¾“å…¥è¦åˆ é™¤çš„è®°å¿†æ¬¡æ•°é˜ˆå€¼ï¼ˆä¸ä½äº 5ï¼‰</p>
      <input type="number" id="deleteThreshold" min="5" placeholder="è¯·è¾“å…¥æ•°å­—" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"/>
      <div class="dialog-actions">
        <button class="btn" id="confirmDelete">ç¡®å®š</button>
        <button class="btn" id="cancelDelete">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

<script>
/** ================= Supabaseï¼ˆä½ çš„é¡¹ç›®é…ç½®ï¼‰ ================= */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/** ================= çŠ¶æ€ ================= */
const els = {
  wordDisplay: document.getElementById('wordDisplay'),
  meaningDisplay: document.getElementById('meaningDisplay'),
  progress: document.getElementById('progress'),
  emptyMsg: document.getElementById('emptyMsg'),
  knowBtn: document.getElementById('knowBtn'),
  dontKnowBtn: document.getElementById('dontKnowBtn'),
  showMeaningBtn: document.getElementById('showMeaningBtn'),
  restartBtn: document.getElementById('restartBtn'),
  // toolbar
  fileInput: document.getElementById('fileInput'),
  btnImport: document.getElementById('btnImport'),
  btnAdd: document.getElementById('btnAdd'),
  btnExport: document.getElementById('btnExport'),
  btnSyncLocal: document.getElementById('btnSyncLocal'),
  btnDeleteWords: document.getElementById('btnDeleteWords'),
  btnHelp: document.getElementById('btnHelp'),
  addDataModal: document.getElementById('addDataModal'),
  deleteModal: document.getElementById('deleteModal'),
  newDataInput: document.getElementById('newDataInput'),
  deleteThreshold: document.getElementById('deleteThreshold'),
  // auth
  signedOut: document.getElementById('signed-out'),
  signedIn: document.getElementById('signed-in'),
  userEmail: document.getElementById('userEmail'),
  syncBadge: document.getElementById('syncBadge'),
};

let wordData = { original: {}, backup: [] }; // original: { word: { meaning, memoryLevel } }
let currentWord = null;                       // [word, obj]
let currentUser = null;
let rtChannel = null;

/** ================= å¯åŠ¨ ================= */
window.addEventListener('DOMContentLoaded', async () => {
  wireUI();
  restoreLocal();
  resetLearning();
  await initAuth();
});

function wireUI(){
  els.btnImport.onclick = ()=> els.fileInput.click();
  els.fileInput.onchange = onImportFile;
  els.btnAdd.onclick = ()=> showModal(els.addDataModal, true);
  document.getElementById('confirmAdd').onclick = onConfirmAdd;
  document.getElementById('cancelAdd').onclick = ()=> showModal(els.addDataModal, false);

  els.btnDeleteWords.onclick = ()=> showModal(els.deleteModal, true);
  document.getElementById('confirmDelete').onclick = onConfirmDelete;
  document.getElementById('cancelDelete').onclick = ()=> showModal(els.deleteModal, false);

  els.btnExport.onclick = exportData;
  els.btnSyncLocal.onclick = syncLocalToCloud;
  els.btnHelp.onclick = showHelp;

  els.showMeaningBtn.onclick = showMeaning;
  els.knowBtn.onclick = () => handleKnow(true);
  els.dontKnowBtn.onclick = () => handleKnow(false);
  els.restartBtn.onclick = resetLearning;

  document.getElementById('btnSignUp').onclick = signUp;
  document.getElementById('btnSignIn').onclick = signIn;
  document.getElementById('btnSignOut').onclick = signOut;

  window.addEventListener('online', ()=>{ updateStatusIndicator(); flushPending(); });
  window.addEventListener('offline', updateStatusIndicator);
}

function showModal(el, on){ el.style.display = on? 'flex':'none'; }

/** ================= æœ¬åœ°å­˜å‚¨ ================= */
function restoreLocal(){ try{ const saved=JSON.parse(localStorage.getItem('wordData')||'{}'); wordData.original = saved.original || {}; }catch{} }
function saveLocal(){ localStorage.setItem('wordData', JSON.stringify(wordData)); }

/** ================= Auth ================= */
async function initAuth(){
  const { data: { session } } = await sb.auth.getSession();
  currentUser = session?.user || null; updateAuthUI();
  if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
  sb.auth.onAuthStateChange(async (_e, session) => {
    currentUser = session?.user || null; updateAuthUI();
    if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
    else { unsubscribeRealtime(); restoreLocal(); resetLearning(); }
  });
}

async function signUp(){
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  try{
    toggleBtn('btnSignUp', true, 'æ³¨å†Œä¸­â€¦');
    const { error } = await sb.auth.signUp({ email, password });
    if(error) throw error;
    alert('æ³¨å†ŒæˆåŠŸï¼šè‹¥å¼€å¯é‚®ç®±éªŒè¯ï¼Œè¯·å…ˆåˆ°é‚®ç®±å®ŒæˆéªŒè¯å†ç™»å½•ã€‚');
  }catch(err){
    console.error('[signUp]', err);
    alert('æ³¨å†Œå¤±è´¥ï¼š' + (err?.message || err));
  }finally{ toggleBtn('btnSignUp', false, 'æ³¨å†Œ'); }
}

async function signIn(){
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  if(!email || !password){ alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç '); return; }

  try{
    toggleBtn('btnSignIn', true, 'ç™»å½•ä¸­â€¦');
    console.log('[signIn] start', { email });
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      const map = {
        'Email not confirmed': 'é‚®ç®±æœªéªŒè¯ï¼šè¯·åˆ°é‚®ç®±ç‚¹ç¡®è®¤é“¾æ¥ï¼ˆæˆ–åœ¨ Auth/Email ä¸´æ—¶å…³é—­ Confirm emailï¼‰',
        'Invalid login credentials': 'é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®',
      };
      alert('ç™»å½•å¤±è´¥ï¼š' + (map[error.message] || error.message));
      return;
    }
    currentUser = data?.user || (await sb.auth.getUser()).data?.user || null;
    updateAuthUI();
    await loadAllFromCloud();
    subscribeRealtime();
    console.log('[signIn] success', currentUser?.id);
  }catch(err){
    console.error('[signIn] error', err);
    alert('ç½‘ç»œæˆ–è„šæœ¬é”™è¯¯ï¼š' + (err?.message || err));
  }finally{
    toggleBtn('btnSignIn', false, 'ç™»å½•');
  }
}

async function signOut(){
  try{
    toggleBtn('btnSignOut', true, 'é€€å‡ºä¸­â€¦');
    await sb.auth.signOut();
  }catch(err){
    console.error('[signOut]', err);
    alert('é€€å‡ºå¤±è´¥ï¼š' + (err?.message || err));
  }finally{ toggleBtn('btnSignOut', false, 'é€€å‡º'); }
}

function updateAuthUI(){
  if(currentUser){
    els.signedOut.style.display='none';
    els.signedIn.style.display='flex';
    els.userEmail.textContent = currentUser.email || 'å·²ç™»å½•';
  }else{
    els.signedOut.style.display='block';
    els.signedIn.style.display='none';
  }
  updateStatusIndicator();
}

/** ================= äº‘ç«¯äº¤äº’ ================= */
async function loadAllFromCloud(){
  if(!currentUser) return;
  const { data, error } = await sb.from('words')
    .select('word, meaning, memory_level')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: true });
  if(error){ console.warn('åŠ è½½äº‘ç«¯å¤±è´¥ï¼š', error.message); return; }
  const map = {};
  (data||[]).forEach(r => { map[r.word] = { meaning: r.meaning, memoryLevel: r.memory_level || 0 }; });
  wordData.original = map; saveLocal(); resetLearning();
}

async function upsertMany(obj){
  if(!currentUser) return;
  const rows = Object.entries(obj).map(([w,v])=>({ user_id: currentUser.id, word:w, meaning:v.meaning||'', memory_level: v.memoryLevel||0 }));
  if(rows.length===0) return;
  const { error } = await sb.from('words').upsert(rows, { onConflict:'user_id,word' });
  if(error){ console.warn('äº‘ç«¯ upsert å¤±è´¥ï¼š', error.message); queuePending({ type:'upsertMany', rows }); }
}

async function updateOne(word){
  if(!currentUser) return;
  const v = wordData.original[word]; if(!v) return;
  const { error } = await sb.from('words').update({ meaning:v.meaning||'', memory_level:v.memoryLevel||0 }).match({ user_id: currentUser.id, word });
  if(error){ console.warn('äº‘ç«¯æ›´æ–°å¤±è´¥ï¼š', error.message); queuePending({ type:'updateOne', word, payload:{ meaning:v.meaning||'', memory_level:v.memoryLevel||0 } }); }
}

async function deleteByThreshold(th){
  if(!currentUser) return;
  const { error } = await sb.from('words').delete().eq('user_id', currentUser.id).gte('memory_level', th);
  if(error){ alert('äº‘ç«¯åˆ é™¤å¤±è´¥ï¼š'+error.message); }
}

function subscribeRealtime(){
  if(rtChannel) sb.removeChannel(rtChannel);
  rtChannel = sb.channel('words-ch');
  rtChannel.on('postgres_changes', { event:'*', schema:'public', table:'words', filter:`user_id=eq.${currentUser.id}` }, async ()=>{ await loadAllFromCloud(); }).subscribe();
}
function unsubscribeRealtime(){ if(rtChannel){ sb.removeChannel(rtChannel); rtChannel=null; } }

/** ================= ç¦»çº¿å¾…åŒæ­¥ ================= */
function queuePending(item){
  const q = JSON.parse(localStorage.getItem('words_pending')||'[]');
  q.push(item);
  localStorage.setItem('words_pending', JSON.stringify(q));
  updateStatusIndicator();
}
async function flushPending(){
  if(!currentUser) return;
  let q = JSON.parse(localStorage.getItem('words_pending')||'[]');
  if(q.length===0){ updateStatusIndicator(); return; }
  for(const it of q){
    if(it.type==='upsertMany'){
      const { error } = await sb.from('words').upsert(it.rows, { onConflict:'user_id,word' });
      if(error){ console.warn('flush upsert å¤±è´¥', error.message); return; }
    }else if(it.type==='updateOne'){
      const { error } = await sb.from('words').update(it.payload).match({ user_id: currentUser.id, word: it.word });
      if(error){ console.warn('flush update å¤±è´¥', error.message); return; }
    }
  }
  localStorage.removeItem('words_pending');
  updateStatusIndicator();
}

/** ================= ä¸šåŠ¡é€»è¾‘ ================= */
function resetLearning(){
  wordData.backup = shuffle(Object.entries(wordData.original));
  els.progress.style.width='0%';
  els.restartBtn.style.display='none';
  els.showMeaningBtn.style.display='inline-block';
  els.knowBtn.style.display='none';
  els.dontKnowBtn.style.display='none';
  checkEmptyData();
  showNextWord();
}

function showNextWord(){
  if(wordData.backup.length===0){
    els.showMeaningBtn.style.display='none';
    els.restartBtn.style.display='inline-block';
    els.knowBtn.style.display='none';
    els.dontKnowBtn.style.display='none';
    return;
  }
  els.meaningDisplay.style.display='none';
  els.showMeaningBtn.style.display='inline-block';
  els.knowBtn.style.display='none';
  els.dontKnowBtn.style.display='none';
  els.restartBtn.style.display='none';

  currentWord = wordData.backup.pop(); // [word, {meaning, memoryLevel}]
  els.wordDisplay.textContent = currentWord[0];
  els.meaningDisplay.textContent = currentWord[1].meaning || '';
  updateProgress();
}

function updateProgress(){
  const total = Object.keys(wordData.original).length || 1;
  const remaining = wordData.backup.length;
  els.progress.style.width = (((total-remaining)/total*100).toFixed(1)) + '%';
}

function showMeaning(){
  els.meaningDisplay.style.display='block';
  els.showMeaningBtn.style.display='none';
  els.knowBtn.style.display='inline-block';
  els.dontKnowBtn.style.display='inline-block';
}

function handleKnow(know){
  if(!currentWord) return;
  const [w, v] = currentWord;
  v.memoryLevel = (v.memoryLevel||0) + (know?1:-1);
  if(!know) wordData.backup.unshift([w, v]); // ä¸è®¤è¯† â†’ æ”¾å›é˜Ÿåˆ—å‰ç«¯å†æµ‹
  wordData.original[w] = v;
  saveLocal();
  if(currentUser) updateOne(w);
  showNextWord();
}

function checkEmptyData(){ els.emptyMsg.style.display = Object.keys(wordData.original).length? 'none':'block'; }

/** ================= å¯¼å…¥ / å¯¼å‡º / åŒæ­¥ ================= */
async function onImportFile(e){
  const file = e.target.files?.[0]; if(!file) return; const text = await file.text(); e.target.value='';
  try{
    const obj = JSON.parse(text); // { word: { meaning, memoryLevel } }
    if(currentUser){ await upsertMany(obj); await loadAllFromCloud(); }
    else { wordData.original = { ...(wordData.original||{}), ...obj }; saveLocal(); resetLearning(); }
    alert('å¯¼å…¥å®Œæˆ');
  }catch(err){ alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + err.message); }
}

async function exportData(){
  if(currentUser){
    const { data, error } = await sb.from('words').select('word,meaning,memory_level').eq('user_id', currentUser.id).order('created_at',{ascending:true});
    if(error){ alert('å¯¼å‡ºå¤±è´¥ï¼š'+error.message); return; }
    const map = {}; (data||[]).forEach(r=>{ map[r.word]={meaning:r.meaning, memoryLevel:r.memory_level||0}; });
    downloadJSON(map, 'word-data_cloud.json');
  }else{
    downloadJSON(wordData.original||{}, 'word-data_local.json');
  }
}

async function syncLocalToCloud(){
  if(!currentUser){ alert('è¯·å…ˆç™»å½•'); return; }
  await upsertMany(wordData.original||{});
  await loadAllFromCloud();
  alert('æœ¬åœ°æ•°æ®å·²åŒæ­¥è‡³äº‘ç«¯');
}

function downloadJSON(obj, name){
  const blob = new Blob([JSON.stringify(obj,null,2)], { type:'application/json' });
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
}

/** ================= æ·»åŠ  / åˆ é™¤ ================= */
function onConfirmAdd(){
  const text = els.newDataInput.value||''; if(!text.trim()){ showModal(els.addDataModal,false); return; }
  const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
  const obj = {};
  for(const line of lines){
    const [word, ...rest] = line.split(/\s+/);
    if(!word || rest.length===0) continue;
    const meaning = rest.join(' ');
    obj[word] = { meaning, memoryLevel: wordData.original?.[word]?.memoryLevel || 0 };
  }
  wordData.original = { ...(wordData.original||{}), ...obj };
  saveLocal();
  if(currentUser) upsertMany(obj);
  els.newDataInput.value=''; showModal(els.addDataModal,false); resetLearning();
}

async function onConfirmDelete(){
  const th = parseInt(els.deleteThreshold.value,10);
  if(!(th>=5)){ alert('è¯·è¾“å…¥ä¸å°äº 5 çš„æ•°å­—'); return; }
  for(const k of Object.keys(wordData.original)){ if((wordData.original[k].memoryLevel||0) >= th) delete wordData.original[k]; }
  saveLocal(); resetLearning();
  if(currentUser){ await deleteByThreshold(th); await loadAllFromCloud(); }
  alert(`å·²åˆ é™¤è®°å¿†æ¬¡æ•° â‰¥ ${th} çš„å•è¯`);
  showModal(els.deleteModal,false);
}

/** ================= å·¥å…· & æŒ‡ç¤ºç¯ ================= */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function toggleBtn(id, disabled, text){ const btn=document.getElementById(id); if(!btn) return; btn.disabled=!!disabled; if(text) btn.textContent=text; }

function updateStatusIndicator(){
  const online = navigator.onLine;
  const pending = JSON.parse(localStorage.getItem('words_pending')||'[]').length;
  const parts = [];
  parts.push(online ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿');
  parts.push(currentUser ? 'å·²ç™»å½•' : 'æœªç™»å½•');
  if(currentUser) parts.push(pending>0 ? `å¾…åŒæ­¥(${pending})` : 'å·²åŒæ­¥');
  els.syncBadge.textContent = parts.join(' Â· ');
}

function showHelp(){
  const help = document.createElement('div'); help.className='modal'; help.style.display='flex'; help.style.alignItems='center'; help.style.justifyContent='center';
  help.innerHTML = `<div class="dialog">
    <h3 style="margin:0 0 10px">ç³»ç»Ÿè¯´æ˜</h3>
    <div style="line-height:1.7">
      ç‚¹å‡»â€œæ˜¾ç¤ºé‡Šä¹‰â€æŸ¥çœ‹ä¸­æ–‡ï¼›â€œæ·»åŠ æ•°æ®â€æ¯è¡ŒæŒ‰<span class="warning-text">å•è¯ ç©ºæ ¼ é‡Šä¹‰</span>ï¼›<br/>
      æ”¯æŒå¯¼å…¥/å¯¼å‡º JSONï¼ˆç™»å½•æ—¶å¯¼å…¥/å¯¼å‡ºäº‘ç«¯ï¼›æœªç™»å½•å¯¼å…¥/å¯¼å‡ºæœ¬åœ°ï¼‰ã€‚<br/>
      ç™»å½•åæ‰€æœ‰æ“ä½œä¼šè‡ªåŠ¨ä¿å­˜åˆ° Supabaseï¼Œå¹¶åœ¨å¤šç«¯<span class="warning-text">å®æ—¶åŒæ­¥</span>ï¼›ç¦»çº¿æ—¶å†™å…¥æœ¬åœ°ï¼Œæ¢å¤è”ç½‘åè‡ªåŠ¨è¡¥æ¨ã€‚
    </div>
    <div class="dialog-actions"><button class="btn" onclick="this.closest('.modal').remove()">å…³é—­</button></div>
  </div>`;
  document.body.appendChild(help);
}

window.addEventListener('unhandledrejection', e=>{
  console.error('[unhandledrejection]', e.reason);
  alert('å‡ºé”™äº†ï¼š' + (e.reason?.message || e.reason));
});
</script>
</body>
</html>
