<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>墨墨单词卡</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* CSS 代码开始 */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --light-gray: #e0e0e0;
            --green: #28a745;
            --red: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .hidden {
            display: none !important;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--card-background);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        nav#auth-container button {
            margin-left: 1rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        nav#auth-container button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        #user-info {
            display: flex;
            align-items: center;
        }

        #user-email {
            margin-right: 1rem;
            font-size: 0.9rem;
        }

        main#app-container, #welcome-message {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .word-card {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 3rem 2rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .word {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .meaning {
            font-size: 1.5rem;
            color: #555;
        }

        .controls, .data-controls {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s;
            color: white;
        }

        .btn:active {
            transform: scale(0.95);
        }

        #show-meaning-btn {
            background-color: var(--primary-color);
        }

        .btn-know {
            background-color: var(--green);
        }

        .btn-dont-know {
            background-color: var(--red);
        }

        .btn-data {
            padding: 0.6rem 1.2rem;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-data:hover {
            background-color: #5a6268;
        }
        .btn-danger {
            background-color: var(--secondary-color);
        }
        .btn-danger:hover {
            background-color: #d3901b;
        }

        #progress-indicator {
            margin-top: 1.5rem;
            font-size: 1rem;
            color: #777;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
        }

        #auth-form input, #import-textarea {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            box-sizing: border-box;
        }

        #modal-submit-btn, #submit-import-btn {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }

        .error-message {
            color: var(--red);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            min-height: 1.2em;
        }

        /* 手机端适配 */
        @media (max-width: 600px) {
            .word {
                font-size: 2rem;
            }
            .meaning {
                font-size: 1.2rem;
            }
            .btn {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
            #feedback-buttons {
                display: flex;
                width: 100%;
            }
            #feedback-buttons .btn {
                flex-grow: 1;
            }
            header {
                padding: 1rem;
            }
            .logo {
                font-size: 1.2rem;
            }
        }
        /* CSS 代码结束 */
    </style>
</head>
<body>

    <header>
        <div class="logo">墨墨单词卡</div>
        <nav id="auth-container">
            <button id="login-btn">登录</button>
            <button id="signup-btn">注册</button>
            <div id="user-info" class="hidden">
                <span id="user-email"></span>
                <button id="logout-btn">退出</button>
            </div>
        </nav>
    </header>

    <main id="app-container" class="hidden">
        <div class="word-card">
            <div id="word-display" class="word">...</div>
            <div id="meaning-display" class="meaning hidden">...</div>
        </div>

        <div id="controls-container" class="controls">
            <button id="show-meaning-btn" class="btn">显示意思</button>
            <div id="feedback-buttons" class="hidden">
                <button id="know-btn" class="btn btn-know">我认识</button>
                <button id="dont-know-btn" class="btn btn-dont-know">不认识</button>
            </div>
        </div>

        <div class="data-controls">
            <button id="import-btn" class="btn-data">导入单词</button>
            <button id="export-btn" class="btn-data">导出单词</button>
            <button id="delete-btn" class="btn-data btn-danger">删除熟词 (记忆>5)</button>
        </div>
        
        <div id="progress-indicator"></div>
    </main>
    
    <div id="welcome-message">
        <h1>欢迎使用墨墨单词卡</h1>
        <p>请先登录或注册以开始您的学习之旅</p>
    </div>

    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="modal-title">登录</h2>
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="邮箱" required>
                <input type="password" id="auth-password" placeholder="密码 (至少6位)" required>
                <button type="submit" id="modal-submit-btn">提交</button>
                <p id="auth-error" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>导入单词</h2>
            <p>每行一组，单词和意思用空格或逗号隔开，例如：</p>
            <pre><code>apple 苹果
banana 香蕉,一种水果</code></pre>
            <textarea id="import-textarea" rows="10" placeholder="在此处粘贴您的单词..."></textarea>
            <button id="submit-import-btn">确认导入</button>
        </div>
    </div>

    <script>
        // JavaScript 代码开始

        // =================================================
        // Supabase 配置 (这里是您提供的公共密钥)
        // =================================================
        const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

        const supabase_client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =================================================
        // DOM 元素获取
        // =================================================
        const appContainer = document.getElementById('app-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const wordDisplay = document.getElementById('word-display');
        const meaningDisplay = document.getElementById('meaning-display');
        const showMeaningBtn = document.getElementById('show-meaning-btn');
        const feedbackButtons = document.getElementById('feedback-buttons');
        const knowBtn = document.getElementById('know-btn');
        const dontKnowBtn = document.getElementById('dont-know-btn');
        const progressIndicator = document.getElementById('progress-indicator');
        // Auth elements
        const authContainer = document.getElementById('auth-container');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const userInfo = document.getElementById('user-info');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        // Modal elements
        const authModal = document.getElementById('auth-modal');
        const modalTitle = document.getElementById('modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const authError = document.getElementById('auth-error');
        // Data control elements
        const importBtn = document.getElementById('import-btn');
        const exportBtn = document.getElementById('export-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const importModal = document.getElementById('import-modal');
        const importTextarea = document.getElementById('import-textarea');
        const submitImportBtn = document.getElementById('submit-import-btn');

        // =================================================
        // 应用状态
        // =================================================
        let words = [];
        let currentWordIndex = 0;
        let currentUser = null;
        let isSigningUp = false;

        // =================================================
        // 核心功能函数
        // =================================================

        /**
         * 从 Supabase 获取当前用户的单词列表
         */
        async function fetchWords() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabase_client
                    .from('words')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('memory_strength', { ascending: true }) // 优先背记忆度低的
                    .order('created_at', { ascending: true });

                if (error) throw error;
                
                words = data;
                currentWordIndex = 0;
                displayCurrentWord();
            } catch (error) {
                console.error('获取单词失败:', error.message);
                alert('获取单词列表失败，请检查网络连接。');
            }
        }

        /**
         * 显示当前单词卡片
         */
        function displayCurrentWord() {
            if (words.length === 0) {
                wordDisplay.textContent = '单词库为空';
                meaningDisplay.textContent = '请点击“导入单词”添加新词。';
                showMeaningBtn.classList.remove('hidden');
                feedbackButtons.classList.add('hidden');
                meaningDisplay.classList.remove('hidden');
                showMeaningBtn.classList.add('hidden');
                progressIndicator.textContent = '0 / 0';
                return;
            }
            
            if (currentWordIndex >= words.length) {
                wordDisplay.textContent = '恭喜！';
                meaningDisplay.textContent = '您已完成本轮所有单词的学习！';
                meaningDisplay.classList.remove('hidden');
                showMeaningBtn.classList.add('hidden');
                feedbackButtons.classList.add('hidden');
                progressIndicator.textContent = `完成 ${words.length} / ${words.length}`;
                return;
            }

            const word = words[currentWordIndex];
            wordDisplay.textContent = word.word;
            meaningDisplay.textContent = word.meaning;

            // 重置UI状态
            meaningDisplay.classList.add('hidden');
            showMeaningBtn.classList.remove('hidden');
            feedbackButtons.classList.add('hidden');
            progressIndicator.textContent = `${currentWordIndex + 1} / ${words.length}`;
        }

        /**
         * 更新单词的记忆强度
         * @param {number} change - 记忆强度的变化值 (+1 或 -1)
         */
        async function updateMemoryStrength(change) {
            const word = words[currentWordIndex];
            const newStrength = Math.max(0, word.memory_strength + change); // 记忆度最低为0

            try {
                const { error } = await supabase_client
                    .from('words')
                    .update({ memory_strength: newStrength })
                    .eq('id', word.id);

                if (error) throw error;
                
                // 更新本地数据
                word.memory_strength = newStrength;
                
                // 切换到下一个单词
                currentWordIndex++;
                displayCurrentWord();
            } catch (error) {
                console.error('更新单词失败:', error.message);
                alert('更新单词失败，请稍后重试。');
            }
        }


        // =================================================
        // 认证功能函数
        // =================================================

        function updateUIForAuthState() {
            if (currentUser) {
                // 用户已登录
                loginBtn.classList.add('hidden');
                signupBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userEmailSpan.textContent = currentUser.email;
                
                appContainer.classList.remove('hidden');
                welcomeMessage.classList.add('hidden');
                
                fetchWords(); // 登录后获取单词
            } else {
                // 用户未登录
                loginBtn.classList.remove('hidden');
                signupBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                
                appContainer.classList.add('hidden');
                welcomeMessage.classList.remove('hidden');
                words = []; // 清空单词
            }
        }

        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authError.textContent = '';
            
            try {
                let response;
                if (isSigningUp) {
                    response = await supabase_client.auth.signUp({ email, password });
                } else {
                    response = await supabase_client.auth.signInWithPassword({ email, password });
                }
                
                if (response.error) throw response.error;
                
                // 注册成功后，Supabase会自动登录
                closeAuthModal();
            } catch (error) {
                authError.textContent = error.message;
            }
        }

        async function handleLogout() {
            const { error } = await supabase_client.auth.signOut();
            if (error) {
                console.error('退出失败:', error.message);
            }
            // onAuthStateChange 会自动处理UI更新
        }

        function openAuthModal(isSignup) {
            isSigningUp = isSignup;
            modalTitle.textContent = isSignup ? '注册' : '登录';
            modalSubmitBtn.textContent = isSignup ? '注册' : '登录';
            authEmailInput.value = '';
            authPasswordInput.value = '';
            authError.textContent = '';
            authModal.classList.remove('hidden');
}

        function closeAuthModal() {
            authModal.classList.add('hidden');
        }


        // =================================================
        // 数据导入导出功能
        // =================================================

        function handleImport() {
            importTextarea.value = '';
            importModal.classList.remove('hidden');
        }

        async function submitImport() {
            const text = importTextarea.value.trim();
            if (!text) return;
            
            const lines = text.split('\n');
            const newWords = lines.map(line => {
                line = line.trim();
                if (!line) return null;
                
                const separatorIndex = line.search(/[\s,，]/); // 查找第一个空格或逗号
                if (separatorIndex === -1) {
                     return { user_id: currentUser.id, word: line, meaning: '(无释义)' };
                }
                
                const word = line.substring(0, separatorIndex).trim();
                const meaning = line.substring(separatorIndex + 1).trim();
                
                return { user_id: currentUser.id, word, meaning, memory_strength: 0 };
            }).filter(Boolean); // 过滤掉无效行

            if (newWords.length === 0) {
                alert('没有有效的单词可供导入。');
                return;
            }
            
            try {
                const { error } = await supabase_client.from('words').insert(newWords);
                if (error) throw error;
                
                alert(`成功导入 ${newWords.length} 个单词！`);
                importModal.classList.add('hidden');
                fetchWords(); // 刷新单词列表
            } catch (error) {
                console.error('导入单词失败:', error.message);
                alert('导入单词失败，请检查数据格式或网络。');
            }
        }

        function handleExport() {
            if (words.length === 0) {
                alert('当前没有单词可以导出。');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "word,meaning,memory_strength\n"; // CSV header
            
            words.forEach(word => {
                csvContent += `${word.word},"${word.meaning.replace(/"/g, '""')}",${word.memory_strength}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "my_words.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function handleDelete熟词() {
            const wordsToDelete = words.filter(w => w.memory_strength > 5);
            if (wordsToDelete.length === 0) {
                alert('没有记忆强度大于5的单词需要删除。');
                return;
            }
            
            const confirmed = confirm(`您确定要删除 ${wordsToDelete.length} 个熟词吗？此操作不可撤销。`);
            if (!confirmed) return;
            
            const idsToDelete = wordsToDelete.map(w => w.id);
            
            try {
                const { error } = await supabase_client
                    .from('words')
                    .delete()
                    .in('id', idsToDelete);
                    
                if (error) throw error;
                
                alert('删除成功！');
                fetchWords(); // 刷新列表
            } catch(error) {
                console.error('删除单词失败:', error.message);
                alert('删除单词失败。');
            }
        }


        // =================================================
        // 事件监听器
        // =================================================

        // 核心背词流程
        showMeaningBtn.addEventListener('click', () => {
            meaningDisplay.classList.remove('hidden');
            showMeaningBtn.classList.add('hidden');
            feedbackButtons.classList.remove('hidden');
        });

        knowBtn.addEventListener('click', () => updateMemoryStrength(1));
        dontKnowBtn.addEventListener('click', () => updateMemoryStrength(-1));

        // 认证流程
        loginBtn.addEventListener('click', () => openAuthModal(false));
        signupBtn.addEventListener('click', () => openAuthModal(true));
        logoutBtn.addEventListener('click', handleLogout);
        authForm.addEventListener('submit', handleAuthFormSubmit);
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal || e.target.classList.contains('modal-close')) {
                closeAuthModal();
            }
        });

        // 数据管理流程
        importBtn.addEventListener('click', handleImport);
        exportBtn.addEventListener('click', handleExport);
        deleteBtn.addEventListener('click', handleDelete熟词);
        submitImportBtn.addEventListener('click', submitImport);
        importModal.addEventListener('click', (e) => {
            if (e.target === importModal || e.target.classList.contains('modal-close')) {
                importModal.classList.add('hidden');
            }
        });

        // 监听认证状态变化 (应用启动时和登录/退出时触发)
        supabase_client.auth.onAuthStateChange((_event, session) => {
            currentUser = session ? session.user : null;
            updateUIForAuthState();
        });

        // JavaScript 代码结束
    </script>
</body>
</html>
