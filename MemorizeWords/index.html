<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生词背诵</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* CSS 代码开始 */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --light-gray: #e0e0e0;
            --green: #28a745;
            --red: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .hidden {
            display: none !important;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--card-background);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        nav#auth-container button {
            margin-left: 1rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        nav#auth-container button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        #user-info {
            display: flex;
            align-items: center;
        }

        #user-email {
            margin-right: 1rem;
            font-size: 0.9rem;
        }

        main#app-container, #welcome-message {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .word-card {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 3rem 2rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .word {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .meaning {
            font-size: 1.5rem;
            color: #555;
        }

        .controls {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .round-settings {
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #555;
        }

        #round-size-select {
            padding: 0.3rem 0.5rem;
            border-radius: 5px;
            border: 1px solid var(--light-gray);
        }

        .data-controls {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            color: white;
        }

        .btn:active {
            transform: scale(0.95);
        }

        #show-meaning-btn, #restart-btn {
            background-color: var(--primary-color);
        }

        .btn-know {
            background-color: var(--green);
        }

        .btn-dont-know {
            background-color: var(--red);
        }

        .btn-data {
            padding: 0.6rem 1.2rem;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        .btn-data:hover {
            background-color: #5a6268;
        }
        .btn-danger {
            background-color: var(--secondary-color);
        }
        .btn-danger:hover {
            background-color: #d3901b;
        }
        
        #progress-indicator {
            margin-top: 1.5rem;
            font-size: 1rem;
            color: #777;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
        }

        #auth-form input, #import-textarea {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            box-sizing: border-box;
        }

        #modal-submit-btn, #submit-import-btn {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }

        .error-message {
            color: var(--red);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            min-height: 1.2em;
        }

        /* 手机端适配 */
        @media (max-width: 600px) {
            .word {
                font-size: 2rem;
            }
            .meaning {
                font-size: 1.2rem;
            }
            .btn {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
            #feedback-buttons {
                display: flex;
                width: 100%;
            }
            #feedback-buttons .btn {
                flex-grow: 1;
            }
            header {
                padding: 1rem;
            }
            .logo {
                font-size: 1.2rem;
            }
        }
        /* CSS 代码结束 */
    </style>
</head>
<body>

    <header>
        <div class="logo">生词背诵</div>
        <nav id="auth-container">
            <button id="login-btn">登录</button>
            <button id="signup-btn">注册</button>
            <div id="user-info" class="hidden">
                <span id="user-email"></span>
                <button id="logout-btn">退出</button>
            </div>
        </nav>
    </header>

    <main id="app-container" class="hidden">
        <div class="word-card">
            <div id="word-display" class="word">...</div>
            <div id="meaning-display" class="meaning hidden">...</div>
        </div>

        <div id="controls-container" class="controls">
            <button id="show-meaning-btn" class="btn">显示意思</button>
            <div id="feedback-buttons" class="hidden">
                <button id="know-btn" class="btn btn-know">我认识</button>
                <button id="dont-know-btn" class="btn btn-dont-know">不认识</button>
            </div>
            <button id="restart-btn" class="btn hidden">再来一轮</button>
        </div>

        <div class="round-settings">
            <label for="round-size-select">每轮单词数:</label>
            <select id="round-size-select">
                </select>
        </div>

        <div class="data-controls">
            <button id="import-text-btn" class="btn-data">粘贴文本导入</button>
            <button id="import-excel-add-btn" class="btn-data">从Excel导入(添加)</button>
            <button id="import-excel-overwrite-btn" class="btn-data">Excel导入(覆盖)</button>
            <input type="file" id="excel-file-input" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="hidden">
            <button id="export-btn" class="btn-data">导出单词</button>
            <button id="delete-btn" class="btn-data btn-danger">删除熟词</button>
        </div>
        
        <div id="progress-indicator"></div>
    </main>
    
    <div id="welcome-message">
        <h1>欢迎使用墨墨单词卡</h1>
        <p>请先登录或注册以开始您的学习之旅</p>
    </div>

    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="modal-title">登录</h2>
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="邮箱" required>
                <input type="password" id="auth-password" placeholder="密码 (至少6位)" required>
                <button type="submit" id="modal-submit-btn">提交</button>
                <p id="auth-error" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>粘贴文本导入</h2>
            <p>每行一组，单词和意思用空格或逗号隔开，例如：</p>
            <pre><code>apple 苹果
banana 香蕉,一种水果</code></pre>
            <textarea id="import-textarea" rows="10" placeholder="在此处粘贴您的单词..."></textarea>
            <button id="submit-import-btn">确认导入</button>
        </div>
    </div>

    <script>
        // JavaScript 代码开始

        // =================================================
        // Supabase 配置
        // =================================================
        const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

        const supabase_client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =================================================
        // DOM 元素获取
        // =================================================
        const appContainer = document.getElementById('app-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const wordDisplay = document.getElementById('word-display');
        const meaningDisplay = document.getElementById('meaning-display');
        const showMeaningBtn = document.getElementById('show-meaning-btn');
        const feedbackButtons = document.getElementById('feedback-buttons');
        const knowBtn = document.getElementById('know-btn');
        const dontKnowBtn = document.getElementById('dont-know-btn');
        const restartBtn = document.getElementById('restart-btn');
        const progressIndicator = document.getElementById('progress-indicator');
        const roundSizeSelect = document.getElementById('round-size-select');
        const authContainer = document.getElementById('auth-container');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const userInfo = document.getElementById('user-info');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const authModal = document.getElementById('auth-modal');
        const modalTitle = document.getElementById('modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const authError = document.getElementById('auth-error');
        const importTextBtn = document.getElementById('import-text-btn');
        const importExcelAddBtn = document.getElementById('import-excel-add-btn');
        const importExcelOverwriteBtn = document.getElementById('import-excel-overwrite-btn');
        const excelFileInput = document.getElementById('excel-file-input');
        const exportBtn = document.getElementById('export-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const importModal = document.getElementById('import-modal');
        const importTextarea = document.getElementById('import-textarea');
        const submitImportBtn = document.getElementById('submit-import-btn');

        // =================================================
        // 应用状态
        // =================================================
        let allWords = [];
        let currentUser = null;
        let isSigningUp = false;
        let excelImportMode = 'add';

        // === 学习循环状态 ===
        let reviewPile = [];
        let failedPile = [];
        let currentWord = null;
        let initialRoundWordCount = 0;
        let learnedWordCount = 0;

        // =================================================
        // 核心功能函数
        // =================================================

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function populateRoundSizeOptions() {
            const total = allWords.length;
            const currentVal = roundSizeSelect.value;
            roundSizeSelect.innerHTML = ''; 

            const options = [10, 20, 50];
            options.forEach(opt => {
                if (total >= opt) {
                    const optionEl = document.createElement('option');
                    optionEl.value = opt;
                    optionEl.textContent = `${opt} 个`;
                    roundSizeSelect.appendChild(optionEl);
                }
            });
            
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = `全部 (${total}个)`;
            roundSizeSelect.appendChild(allOption);
            
            if (currentVal && roundSizeSelect.querySelector(`option[value="${currentVal}"]`)) {
                roundSizeSelect.value = currentVal;
            } else {
                allOption.selected = true;
            }
        }

        function startNewRound() {
            if (allWords.length === 0) {
                showNextWord();
                return;
            };

            const shuffled = shuffleArray([...allWords]);
            const selectedSize = roundSizeSelect.value;
            
            let initialWordsForRound;
            if (selectedSize === 'all') {
                initialWordsForRound = shuffled;
            } else {
                const size = parseInt(selectedSize, 10);
                initialWordsForRound = shuffled.slice(0, size);
            }
            
            reviewPile = [...initialWordsForRound];
            failedPile = [];
            initialRoundWordCount = initialWordsForRound.length;
            learnedWordCount = 0;
            
            showNextWord();
        }

        async function fetchWordsAndStart() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabase_client
                    .from('words')
                    .select('*')
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                
                allWords = data;
                populateRoundSizeOptions();
                startNewRound();
            } catch (error) {
                console.error('获取单词失败:', error.message);
                alert('获取单词列表失败，请检查网络连接。');
            }
        }

        function showNextWord() {
            if (reviewPile.length === 0 && failedPile.length > 0) {
                reviewPile = shuffleArray([...failedPile]);
                failedPile = [];
            }
            
            if (reviewPile.length === 0 && failedPile.length === 0) {
                currentWord = null;
                if (initialRoundWordCount > 0) {
                    displayRoundComplete();
                } else {
                    displayCurrentWordUI();
                }
                return;
            }
            
            currentWord = reviewPile.shift();
            displayCurrentWordUI();
        }
        
        function displayCurrentWordUI() {
            showMeaningBtn.classList.remove('hidden');
            feedbackButtons.classList.add('hidden');
            restartBtn.classList.add('hidden');
            meaningDisplay.classList.add('hidden');

            if (!currentWord) {
                wordDisplay.textContent = '单词库为空';
                meaningDisplay.textContent = '请点击导入按钮添加新词。';
                meaningDisplay.classList.remove('hidden');
                showMeaningBtn.classList.add('hidden');
                progressIndicator.textContent = '0 / 0';
                return;
            }
            
            wordDisplay.textContent = currentWord.word;
            meaningDisplay.textContent = currentWord.meaning;
            progressIndicator.textContent = `${learnedWordCount} / ${initialRoundWordCount}`;
        }
        
        function displayRoundComplete() {
            showMeaningBtn.classList.add('hidden');
            feedbackButtons.classList.add('hidden');
            restartBtn.classList.remove('hidden');
            meaningDisplay.classList.remove('hidden');

            wordDisplay.textContent = '恭喜！';
            meaningDisplay.textContent = '您已掌握本轮所有单词！';
            progressIndicator.textContent = `完成 ${initialRoundWordCount} / ${initialRoundWordCount}`;
        }

        async function processAnswer(isKnown) {
            if (!currentWord) return;
            
            const change = isKnown ? 1 : -1;
            // ★★★ 核心修改：移除Math.max(0, ...)，允许记忆强度为负数 ★★★
            const newStrength = currentWord.memory_strength + change;

            try {
                const { error } = await supabase_client
                    .from('words')
                    .update({ memory_strength: newStrength })
                    .eq('id', currentWord.id);
                if (error) throw error;
                
                const wordInAllWords = allWords.find(w => w.id === currentWord.id);
                if(wordInAllWords) {
                    wordInAllWords.memory_strength = newStrength;
                }
                
                if (isKnown) {
                    learnedWordCount++;
                } else {
                    failedPile.push(currentWord);
                }
                
                showNextWord();

            } catch (error) {
                console.error('更新单词失败:', error.message);
                alert('更新单词失败，请检查网络后重试。');
            }
        }
        
        // =================================================
        // 认证功能函数
        // =================================================

        async function updateUIForAuthState() {
            if (currentUser) {
                loginBtn.classList.add('hidden');
                signupBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userEmailSpan.textContent = currentUser.email;
                appContainer.classList.remove('hidden');
                welcomeMessage.classList.add('hidden');
                await fetchWordsAndStart();

            } else {
                loginBtn.classList.remove('hidden');
                signupBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                appContainer.classList.add('hidden');
                welcomeMessage.classList.remove('hidden');
                allWords = [];
                reviewPile = [];
                failedPile = [];
            }
        }

        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authError.textContent = '';
            
            try {
                let response;
                if (isSigningUp) {
                    response = await supabase_client.auth.signUp({ email, password });
                } else {
                    response = await supabase_client.auth.signInWithPassword({ email, password });
                }
                if (response.error) throw response.error;
                closeAuthModal();
            } catch (error) {
                authError.textContent = error.message;
            }
        }

        async function handleLogout() {
            const { error } = await supabase_client.auth.signOut();
            if (error) console.error('退出失败:', error.message);
        }

        function openAuthModal(isSignup) {
            isSigningUp = isSignup;
            modalTitle.textContent = isSignup ? '注册' : '登录';
            modalSubmitBtn.textContent = isSignup ? '注册' : '登录';
            authEmailInput.value = '';
            authPasswordInput.value = '';
            authError.textContent = '';
            authModal.classList.remove('hidden');
        }

        function closeAuthModal() {
            authModal.classList.add('hidden');
        }


        // =================================================
        // 数据导入/导出/删除功能
        // =================================================
        
        function handleTextImport() {
            importTextarea.value = '';
            importModal.classList.remove('hidden');
        }

        async function submitTextImport() {
            const text = importTextarea.value.trim();
            if (!text) return;
            
            const lines = text.split('\n');
            const newWords = lines.map(line => {
                line = line.trim();
                if (!line) return null;
                const separatorIndex = line.search(/[\s,，]/);
                if (separatorIndex === -1) {
                     return { user_id: currentUser.id, word: line, meaning: '(无释义)' };
                }
                const word = line.substring(0, separatorIndex).trim();
                const meaning = line.substring(separatorIndex + 1).trim();
                return { user_id: currentUser.id, word, meaning, memory_strength: 0 };
            }).filter(Boolean);

            if (newWords.length > 0) {
                await uploadNewWords(newWords);
            }
            importModal.classList.add('hidden');
        }
        
        function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        alert('Excel文件为空或格式不正确。');
                        return;
                    }

                    const newWords = jsonData.map(row => {
                        const word = row.word || row.Word || row.单词;
                        const meaning = row.meaning || row.Meaning || row.意思 || row.释义;
                        const strength = row.memory_strength || row.strength || row.记忆强度;

                        if (!word || !meaning) return null;

                        return {
                            user_id: currentUser.id,
                            word: String(word).trim(),
                            meaning: String(meaning).trim(),
                            memory_strength: parseInt(strength, 10) || 0
                        };
                    }).filter(Boolean);

                    if (newWords.length > 0) {
                        if (excelImportMode === 'overwrite') {
                            const confirmed = confirm(`您确定要覆盖所有云端单词吗？\n此操作将首先删除您所有的旧单词，然后导入新单词。此操作不可撤销！`);
                            if (!confirmed) return;

                            alert('正在删除云端旧数据...');
                            const { error: deleteError } = await supabase_client.from('words').delete().eq('user_id', currentUser.id);
                            if (deleteError) throw deleteError;
                            
                            alert('旧数据删除成功，正在上传新数据...');
                        }
                        await uploadNewWords(newWords);
                    } else {
                        alert('在Excel文件中没有找到有效的单词数据。请确保列名是“单词”、“意思”或"word", "meaning"等。');
                    }

                } catch (error) {
                    console.error("解析或处理Excel文件失败:", error);
                    alert("操作失败：" + error.message);
                } finally {
                     event.target.value = '';
                }
            };
            
            reader.onerror = (error) => {
                console.error("读取文件失败:", error);
                alert("读取文件失败。");
            };

            reader.readAsArrayBuffer(file);
        }
        
        async function uploadNewWords(newWords) {
             const actionText = excelImportMode === 'overwrite' ? '覆盖导入' : '添加';
             try {
                alert(`正在${actionText} ${newWords.length} 个新单词...`);
                const { error } = await supabase_client.from('words').insert(newWords);
                if (error) throw error;
                alert(`成功${actionText} ${newWords.length} 个单词！`);
                await fetchWordsAndStart();
            } catch (error) {
                console.error(`${actionText}失败:`, error.message);
                alert(`${actionText}失败，可能是网络问题或数据格式错误。`);
            }
        }

        function handleExport() {
            if (allWords.length === 0) {
                alert('当前没有单词可以导出。');
                return;
            }
            
            const dataToExport = allWords.map(w => ({
                word: w.word,
                meaning: w.meaning,
                memory_strength: w.memory_strength
            }));
            
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "单词列表");

            XLSX.writeFile(workbook, "my_words.xlsx");
        }

        async function handleDelete熟词() {
            const thresholdInput = prompt("请输入要删除的记忆强度阈值（大于等于5）:", "5");
            if (thresholdInput === null) return;

            const threshold = parseInt(thresholdInput, 10);
            if (isNaN(threshold) || threshold < 5) {
                alert("请输入一个有效的数字，且必须大于等于5。");
                return;
            }

            const wordsToDelete = allWords.filter(w => w.memory_strength >= threshold);
            if (wordsToDelete.length === 0) {
                alert(`没有记忆强度大于等于 ${threshold} 的单词需要删除。`);
                return;
            }
            
            const confirmed = confirm(`您确定要删除 ${wordsToDelete.length} 个熟词吗？此操作不可撤销。`);
            if (!confirmed) return;
            
            const idsToDelete = wordsToDelete.map(w => w.id);
            try {
                const { error } = await supabase_client
                    .from('words')
                    .delete()
                    .in('id', idsToDelete);
                if (error) throw error;
                alert('删除成功！');
                await fetchWordsAndStart();
            } catch(error) {
                console.error('删除单词失败:', error.message);
                alert('删除单词失败。');
            }
        }


        // =================================================
        // 事件监听器
        // =================================================

        showMeaningBtn.addEventListener('click', () => {
            meaningDisplay.classList.remove('hidden');
            showMeaningBtn.classList.add('hidden');
            feedbackButtons.classList.remove('hidden');
        });

        knowBtn.addEventListener('click', () => processAnswer(true));
        dontKnowBtn.addEventListener('click', () => processAnswer(false));
        restartBtn.addEventListener('click', startNewRound);
        roundSizeSelect.addEventListener('change', startNewRound);

        loginBtn.addEventListener('click', () => openAuthModal(false));
        signupBtn.addEventListener('click', () => openAuthModal(true));
        logoutBtn.addEventListener('click', handleLogout);
        authForm.addEventListener('submit', handleAuthFormSubmit);
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal || e.target.classList.contains('modal-close')) {
                closeAuthModal();
            }
        });

        importTextBtn.addEventListener('click', handleTextImport);
        
        importExcelAddBtn.addEventListener('click', () => {
            excelImportMode = 'add';
            excelFileInput.click();
        });

        importExcelOverwriteBtn.addEventListener('click', () => {
            excelImportMode = 'overwrite';
            excelFileInput.click();
        });

        excelFileInput.addEventListener('change', handleExcelFile);

        exportBtn.addEventListener('click', handleExport);
        deleteBtn.addEventListener('click', handleDelete熟词);
        submitImportBtn.addEventListener('click', submitTextImport);
        importModal.addEventListener('click', (e) => {
            if (e.target === importModal || e.target.classList.contains('modal-close')) {
                importModal.classList.add('hidden');
            }
        });

        supabase_client.auth.onAuthStateChange((_event, session) => {
            currentUser = session ? session.user : null;
            updateUIForAuthState();
        });

        // JavaScript 代码结束
    </script>
</body>
</html>
