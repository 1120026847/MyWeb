<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè¯èƒŒè¯µ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* CSS ä»£ç å¼€å§‹ */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --light-gray: #e0e0e0;
            --green: #28a745;
            --red: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .hidden {
            display: none !important;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--card-background);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        nav#auth-container button {
            margin-left: 1rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        nav#auth-container button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        #user-info {
            display: flex;
            align-items: center;
        }

        #user-email {
            margin-right: 1rem;
            font-size: 0.9rem;
        }

        main#app-container, #welcome-message {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .word-card {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 3rem 2rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .word {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .meaning {
            font-size: 1.5rem;
            color: #555;
        }

        .controls {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .round-settings {
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #555;
        }

        #round-size-select {
            padding: 0.3rem 0.5rem;
            border-radius: 5px;
            border: 1px solid var(--light-gray);
        }

        .data-controls {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            color: white;
        }

        .btn:active {
            transform: scale(0.95);
        }

        #show-meaning-btn, #restart-btn {
            background-color: var(--primary-color);
        }

        .btn-know {
            background-color: var(--green);
        }

        .btn-dont-know {
            background-color: var(--red);
        }

        .btn-data {
            padding: 0.6rem 1.2rem;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        .btn-data:hover {
            background-color: #5a6268;
        }
        .btn-danger {
            background-color: var(--secondary-color);
        }
        .btn-danger:hover {
            background-color: #d3901b;
        }
        
        #progress-indicator {
            margin-top: 1.5rem;
            font-size: 1rem;
            color: #777;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
        }

        #auth-form input, #import-textarea {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            box-sizing: border-box;
        }

        #modal-submit-btn, #submit-import-btn {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }

        .error-message {
            color: var(--red);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            min-height: 1.2em;
        }

        /* æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 600px) {
            .word {
                font-size: 2rem;
            }
            .meaning {
                font-size: 1.2rem;
            }
            .btn {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
            #feedback-buttons {
                display: flex;
                width: 100%;
            }
            #feedback-buttons .btn {
                flex-grow: 1;
            }
            header {
                padding: 1rem;
            }
            .logo {
                font-size: 1.2rem;
            }
        }
        /* CSS ä»£ç ç»“æŸ */
    </style>
</head>
<body>

    <header>
        <div class="logo">ç”Ÿè¯èƒŒè¯µ</div>
        <nav id="auth-container">
            <button id="login-btn">ç™»å½•</button>
            <button id="signup-btn">æ³¨å†Œ</button>
            <div id="user-info" class="hidden">
                <span id="user-email"></span>
                <button id="logout-btn">é€€å‡º</button>
            </div>
        </nav>
    </header>

    <main id="app-container" class="hidden">
        <div class="word-card">
            <div id="word-display" class="word">...</div>
            <div id="meaning-display" class="meaning hidden">...</div>
        </div>

        <div id="controls-container" class="controls">
            <button id="show-meaning-btn" class="btn">æ˜¾ç¤ºæ„æ€</button>
            <div id="feedback-buttons" class="hidden">
                <button id="know-btn" class="btn btn-know">æˆ‘è®¤è¯†</button>
                <button id="dont-know-btn" class="btn btn-dont-know">ä¸è®¤è¯†</button>
            </div>
            <button id="restart-btn" class="btn hidden">å†æ¥ä¸€è½®</button>
        </div>

        <div class="round-settings">
            <label for="round-size-select">æ¯è½®å•è¯æ•°:</label>
            <select id="round-size-select">
                </select>
        </div>

        <div class="data-controls">
            <button id="import-text-btn" class="btn-data">ç²˜è´´æ–‡æœ¬å¯¼å…¥</button>
            <button id="import-excel-add-btn" class="btn-data">ä»Excelå¯¼å…¥(æ·»åŠ )</button>
            <button id="import-excel-overwrite-btn" class="btn-data">Excelå¯¼å…¥(è¦†ç›–)</button>
            <input type="file" id="excel-file-input" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="hidden">
            <button id="export-btn" class="btn-data">å¯¼å‡ºå•è¯</button>
            <button id="delete-btn" class="btn-data btn-danger">åˆ é™¤ç†Ÿè¯</button>
        </div>
        
        <div id="progress-indicator"></div>
    </main>
    
    <div id="welcome-message">
        <h1>æ¬¢è¿ä½¿ç”¨å¢¨å¢¨å•è¯å¡</h1>
        <p>è¯·å…ˆç™»å½•æˆ–æ³¨å†Œä»¥å¼€å§‹æ‚¨çš„å­¦ä¹ ä¹‹æ—…</p>
    </div>

    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="modal-title">ç™»å½•</h2>
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="é‚®ç®±" required>
                <input type="password" id="auth-password" placeholder="å¯†ç  (è‡³å°‘6ä½)" required>
                <button type="submit" id="modal-submit-btn">æäº¤</button>
                <p id="auth-error" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>ç²˜è´´æ–‡æœ¬å¯¼å…¥</h2>
            <p>æ¯è¡Œä¸€ç»„ï¼Œå•è¯å’Œæ„æ€ç”¨ç©ºæ ¼æˆ–é€—å·éš”å¼€ï¼Œä¾‹å¦‚ï¼š</p>
            <pre><code>apple è‹¹æœ
banana é¦™è•‰,ä¸€ç§æ°´æœ</code></pre>
            <textarea id="import-textarea" rows="10" placeholder="åœ¨æ­¤å¤„ç²˜è´´æ‚¨çš„å•è¯..."></textarea>
            <button id="submit-import-btn">ç¡®è®¤å¯¼å…¥</button>
        </div>
    </div>

    <script>
        // JavaScript ä»£ç å¼€å§‹

        // =================================================
        // Supabase é…ç½®
        // =================================================
        const SUPABASE_URL = 'https://iqdlkybfdzyrneerlphj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxZGxreWJmZHp5cm5lZXJscGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNDg4MzAsImV4cCI6MjA3NDYyNDgzMH0.3vG7uEs1NF5tk4kIcxYIhN4EcGOa-pWIBL028fWRB9Y';

        const supabase_client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =================================================
        // DOM å…ƒç´ è·å–
        // =================================================
        const appContainer = document.getElementById('app-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const wordDisplay = document.getElementById('word-display');
        const meaningDisplay = document.getElementById('meaning-display');
        const showMeaningBtn = document.getElementById('show-meaning-btn');
        const feedbackButtons = document.getElementById('feedback-buttons');
        const knowBtn = document.getElementById('know-btn');
        const dontKnowBtn = document.getElementById('dont-know-btn');
        const restartBtn = document.getElementById('restart-btn');
        const progressIndicator = document.getElementById('progress-indicator');
        const roundSizeSelect = document.getElementById('round-size-select');
        const authContainer = document.getElementById('auth-container');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const userInfo = document.getElementById('user-info');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const authModal = document.getElementById('auth-modal');
        const modalTitle = document.getElementById('modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const authError = document.getElementById('auth-error');
        const importTextBtn = document.getElementById('import-text-btn');
        const importExcelAddBtn = document.getElementById('import-excel-add-btn');
        const importExcelOverwriteBtn = document.getElementById('import-excel-overwrite-btn');
        const excelFileInput = document.getElementById('excel-file-input');
        const exportBtn = document.getElementById('export-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const importModal = document.getElementById('import-modal');
        const importTextarea = document.getElementById('import-textarea');
        const submitImportBtn = document.getElementById('submit-import-btn');

        // =================================================
        // åº”ç”¨çŠ¶æ€
        // =================================================
        let allWords = [];
        let currentUser = null;
        let isSigningUp = false;
        let excelImportMode = 'add';

        // === å­¦ä¹ å¾ªç¯çŠ¶æ€ ===
        let reviewPile = [];
        let failedPile = [];
        let currentWord = null;
        let initialRoundWordCount = 0;
        let learnedWordCount = 0;

        // =================================================
        // æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
        // =================================================

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function populateRoundSizeOptions() {
            const total = allWords.length;
            const currentVal = roundSizeSelect.value;
            roundSizeSelect.innerHTML = ''; 

            const options = [10, 20, 50];
            options.forEach(opt => {
                if (total >= opt) {
                    const optionEl = document.createElement('option');
                    optionEl.value = opt;
                    optionEl.textContent = `${opt} ä¸ª`;
                    roundSizeSelect.appendChild(optionEl);
                }
            });
            
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = `å…¨éƒ¨ (${total}ä¸ª)`;
            roundSizeSelect.appendChild(allOption);
            
            if (currentVal && roundSizeSelect.querySelector(`option[value="${currentVal}"]`)) {
                roundSizeSelect.value = currentVal;
            } else {
                allOption.selected = true;
            }
        }

        function startNewRound() {
            if (allWords.length === 0) {
                showNextWord();
                return;
            };

            const shuffled = shuffleArray([...allWords]);
            const selectedSize = roundSizeSelect.value;
            
            let initialWordsForRound;
            if (selectedSize === 'all') {
                initialWordsForRound = shuffled;
            } else {
                const size = parseInt(selectedSize, 10);
                initialWordsForRound = shuffled.slice(0, size);
            }
            
            reviewPile = [...initialWordsForRound];
            failedPile = [];
            initialRoundWordCount = initialWordsForRound.length;
            learnedWordCount = 0;
            
            showNextWord();
        }

        async function fetchWordsAndStart() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabase_client
                    .from('words')
                    .select('*')
                    .eq('user_id', currentUser.id);
                if (error) throw error;
                
                allWords = data;
                populateRoundSizeOptions();
                startNewRound();
            } catch (error) {
                console.error('è·å–å•è¯å¤±è´¥:', error.message);
                alert('è·å–å•è¯åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
            }
        }

        function showNextWord() {
            if (reviewPile.length === 0 && failedPile.length > 0) {
                reviewPile = shuffleArray([...failedPile]);
                failedPile = [];
            }
            
            if (reviewPile.length === 0 && failedPile.length === 0) {
                currentWord = null;
                if (initialRoundWordCount > 0) {
                    displayRoundComplete();
                } else {
                    displayCurrentWordUI();
                }
                return;
            }
            
            currentWord = reviewPile.shift();
            displayCurrentWordUI();
        }
        
        function displayCurrentWordUI() {
            showMeaningBtn.classList.remove('hidden');
            feedbackButtons.classList.add('hidden');
            restartBtn.classList.add('hidden');
            meaningDisplay.classList.add('hidden');

            if (!currentWord) {
                wordDisplay.textContent = 'å•è¯åº“ä¸ºç©º';
                meaningDisplay.textContent = 'è¯·ç‚¹å‡»å¯¼å…¥æŒ‰é’®æ·»åŠ æ–°è¯ã€‚';
                meaningDisplay.classList.remove('hidden');
                showMeaningBtn.classList.add('hidden');
                progressIndicator.textContent = '0 / 0';
                return;
            }
            
            wordDisplay.textContent = currentWord.word;
            meaningDisplay.textContent = currentWord.meaning;
            progressIndicator.textContent = `${learnedWordCount} / ${initialRoundWordCount}`;
        }
        
        function displayRoundComplete() {
            showMeaningBtn.classList.add('hidden');
            feedbackButtons.classList.add('hidden');
            restartBtn.classList.remove('hidden');
            meaningDisplay.classList.remove('hidden');

            wordDisplay.textContent = 'æ­å–œï¼';
            meaningDisplay.textContent = 'æ‚¨å·²æŒæ¡æœ¬è½®æ‰€æœ‰å•è¯ï¼';
            progressIndicator.textContent = `å®Œæˆ ${initialRoundWordCount} / ${initialRoundWordCount}`;
        }

        async function processAnswer(isKnown) {
            if (!currentWord) return;
            
            const change = isKnown ? 1 : -1;
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤Math.max(0, ...)ï¼Œå…è®¸è®°å¿†å¼ºåº¦ä¸ºè´Ÿæ•° â˜…â˜…â˜…
            const newStrength = currentWord.memory_strength + change;

            try {
                const { error } = await supabase_client
                    .from('words')
                    .update({ memory_strength: newStrength })
                    .eq('id', currentWord.id);
                if (error) throw error;
                
                const wordInAllWords = allWords.find(w => w.id === currentWord.id);
                if(wordInAllWords) {
                    wordInAllWords.memory_strength = newStrength;
                }
                
                if (isKnown) {
                    learnedWordCount++;
                } else {
                    failedPile.push(currentWord);
                }
                
                showNextWord();

            } catch (error) {
                console.error('æ›´æ–°å•è¯å¤±è´¥:', error.message);
                alert('æ›´æ–°å•è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚');
            }
        }
        
        // =================================================
        // è®¤è¯åŠŸèƒ½å‡½æ•°
        // =================================================

        async function updateUIForAuthState() {
            if (currentUser) {
                loginBtn.classList.add('hidden');
                signupBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userEmailSpan.textContent = currentUser.email;
                appContainer.classList.remove('hidden');
                welcomeMessage.classList.add('hidden');
                await fetchWordsAndStart();

            } else {
                loginBtn.classList.remove('hidden');
                signupBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                appContainer.classList.add('hidden');
                welcomeMessage.classList.remove('hidden');
                allWords = [];
                reviewPile = [];
                failedPile = [];
            }
        }

        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authError.textContent = '';
            
            try {
                let response;
                if (isSigningUp) {
                    response = await supabase_client.auth.signUp({ email, password });
                } else {
                    response = await supabase_client.auth.signInWithPassword({ email, password });
                }
                if (response.error) throw response.error;
                closeAuthModal();
            } catch (error) {
                authError.textContent = error.message;
            }
        }

        async function handleLogout() {
            const { error } = await supabase_client.auth.signOut();
            if (error) console.error('é€€å‡ºå¤±è´¥:', error.message);
        }

        function openAuthModal(isSignup) {
            isSigningUp = isSignup;
            modalTitle.textContent = isSignup ? 'æ³¨å†Œ' : 'ç™»å½•';
            modalSubmitBtn.textContent = isSignup ? 'æ³¨å†Œ' : 'ç™»å½•';
            authEmailInput.value = '';
            authPasswordInput.value = '';
            authError.textContent = '';
            authModal.classList.remove('hidden');
        }

        function closeAuthModal() {
            authModal.classList.add('hidden');
        }


        // =================================================
        // æ•°æ®å¯¼å…¥/å¯¼å‡º/åˆ é™¤åŠŸèƒ½
        // =================================================
        
        function handleTextImport() {
            importTextarea.value = '';
            importModal.classList.remove('hidden');
        }

        async function submitTextImport() {
            const text = importTextarea.value.trim();
            if (!text) return;
            
            const lines = text.split('\n');
            const newWords = lines.map(line => {
                line = line.trim();
                if (!line) return null;
                const separatorIndex = line.search(/[\s,ï¼Œ]/);
                if (separatorIndex === -1) {
                     return { user_id: currentUser.id, word: line, meaning: '(æ— é‡Šä¹‰)' };
                }
                const word = line.substring(0, separatorIndex).trim();
                const meaning = line.substring(separatorIndex + 1).trim();
                return { user_id: currentUser.id, word, meaning, memory_strength: 0 };
            }).filter(Boolean);

            if (newWords.length > 0) {
                await uploadNewWords(newWords);
            }
            importModal.classList.add('hidden');
        }
        
        function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚');
                        return;
                    }

                    const newWords = jsonData.map(row => {
                        const word = row.word || row.Word || row.å•è¯;
                        const meaning = row.meaning || row.Meaning || row.æ„æ€ || row.é‡Šä¹‰;
                        const strength = row.memory_strength || row.strength || row.è®°å¿†å¼ºåº¦;

                        if (!word || !meaning) return null;

                        return {
                            user_id: currentUser.id,
                            word: String(word).trim(),
                            meaning: String(meaning).trim(),
                            memory_strength: parseInt(strength, 10) || 0
                        };
                    }).filter(Boolean);

                    if (newWords.length > 0) {
                        if (excelImportMode === 'overwrite') {
                            const confirmed = confirm(`æ‚¨ç¡®å®šè¦è¦†ç›–æ‰€æœ‰äº‘ç«¯å•è¯å—ï¼Ÿ\næ­¤æ“ä½œå°†é¦–å…ˆåˆ é™¤æ‚¨æ‰€æœ‰çš„æ—§å•è¯ï¼Œç„¶åå¯¼å…¥æ–°å•è¯ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
                            if (!confirmed) return;

                            alert('æ­£åœ¨åˆ é™¤äº‘ç«¯æ—§æ•°æ®...');
                            const { error: deleteError } = await supabase_client.from('words').delete().eq('user_id', currentUser.id);
                            if (deleteError) throw deleteError;
                            
                            alert('æ—§æ•°æ®åˆ é™¤æˆåŠŸï¼Œæ­£åœ¨ä¸Šä¼ æ–°æ•°æ®...');
                        }
                        await uploadNewWords(newWords);
                    } else {
                        alert('åœ¨Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å•è¯æ•°æ®ã€‚è¯·ç¡®ä¿åˆ—åæ˜¯â€œå•è¯â€ã€â€œæ„æ€â€æˆ–"word", "meaning"ç­‰ã€‚');
                    }

                } catch (error) {
                    console.error("è§£ææˆ–å¤„ç†Excelæ–‡ä»¶å¤±è´¥:", error);
                    alert("æ“ä½œå¤±è´¥ï¼š" + error.message);
                } finally {
                     event.target.value = '';
                }
            };
            
            reader.onerror = (error) => {
                console.error("è¯»å–æ–‡ä»¶å¤±è´¥:", error);
                alert("è¯»å–æ–‡ä»¶å¤±è´¥ã€‚");
            };

            reader.readAsArrayBuffer(file);
        }
        
        async function uploadNewWords(newWords) {
             const actionText = excelImportMode === 'overwrite' ? 'è¦†ç›–å¯¼å…¥' : 'æ·»åŠ ';
             try {
                alert(`æ­£åœ¨${actionText} ${newWords.length} ä¸ªæ–°å•è¯...`);
                const { error } = await supabase_client.from('words').insert(newWords);
                if (error) throw error;
                alert(`æˆåŠŸ${actionText} ${newWords.length} ä¸ªå•è¯ï¼`);
                await fetchWordsAndStart();
            } catch (error) {
                console.error(`${actionText}å¤±è´¥:`, error.message);
                alert(`${actionText}å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æ•°æ®æ ¼å¼é”™è¯¯ã€‚`);
            }
        }

        function handleExport() {
            if (allWords.length === 0) {
                alert('å½“å‰æ²¡æœ‰å•è¯å¯ä»¥å¯¼å‡ºã€‚');
                return;
            }
            
            const dataToExport = allWords.map(w => ({
                word: w.word,
                meaning: w.meaning,
                memory_strength: w.memory_strength
            }));
            
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "å•è¯åˆ—è¡¨");

            XLSX.writeFile(workbook, "my_words.xlsx");
        }

        async function handleDeleteç†Ÿè¯() {
            const thresholdInput = prompt("è¯·è¾“å…¥è¦åˆ é™¤çš„è®°å¿†å¼ºåº¦é˜ˆå€¼ï¼ˆå¤§äºç­‰äº5ï¼‰:", "5");
            if (thresholdInput === null) return;

            const threshold = parseInt(thresholdInput, 10);
            if (isNaN(threshold) || threshold < 5) {
                alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­—ï¼Œä¸”å¿…é¡»å¤§äºç­‰äº5ã€‚");
                return;
            }

            const wordsToDelete = allWords.filter(w => w.memory_strength >= threshold);
            if (wordsToDelete.length === 0) {
                alert(`æ²¡æœ‰è®°å¿†å¼ºåº¦å¤§äºç­‰äº ${threshold} çš„å•è¯éœ€è¦åˆ é™¤ã€‚`);
                return;
            }
            
            const confirmed = confirm(`æ‚¨ç¡®å®šè¦åˆ é™¤ ${wordsToDelete.length} ä¸ªç†Ÿè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`);
            if (!confirmed) return;
            
            const idsToDelete = wordsToDelete.map(w => w.id);
            try {
                const { error } = await supabase_client
                    .from('words')
                    .delete()
                    .in('id', idsToDelete);
                if (error) throw error;
                alert('åˆ é™¤æˆåŠŸï¼');
                await fetchWordsAndStart();
            } catch(error) {
                console.error('åˆ é™¤å•è¯å¤±è´¥:', error.message);
                alert('åˆ é™¤å•è¯å¤±è´¥ã€‚');
            }
        }


        // =================================================
        // äº‹ä»¶ç›‘å¬å™¨
        // =================================================

        showMeaningBtn.addEventListener('click', () => {
            meaningDisplay.classList.remove('hidden');
            showMeaningBtn.classList.add('hidden');
            feedbackButtons.classList.remove('hidden');
        });

        knowBtn.addEventListener('click', () => processAnswer(true));
        dontKnowBtn.addEventListener('click', () => processAnswer(false));
        restartBtn.addEventListener('click', startNewRound);
        roundSizeSelect.addEventListener('change', startNewRound);

        loginBtn.addEventListener('click', () => openAuthModal(false));
        signupBtn.addEventListener('click', () => openAuthModal(true));
        logoutBtn.addEventListener('click', handleLogout);
        authForm.addEventListener('submit', handleAuthFormSubmit);
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal || e.target.classList.contains('modal-close')) {
                closeAuthModal();
            }
        });

        importTextBtn.addEventListener('click', handleTextImport);
        
        importExcelAddBtn.addEventListener('click', () => {
            excelImportMode = 'add';
            excelFileInput.click();
        });

        importExcelOverwriteBtn.addEventListener('click', () => {
            excelImportMode = 'overwrite';
            excelFileInput.click();
        });

        excelFileInput.addEventListener('change', handleExcelFile);

        exportBtn.addEventListener('click', handleExport);
        deleteBtn.addEventListener('click', handleDeleteç†Ÿè¯);
        submitImportBtn.addEventListener('click', submitTextImport);
        importModal.addEventListener('click', (e) => {
            if (e.target === importModal || e.target.classList.contains('modal-close')) {
                importModal.classList.add('hidden');
            }
        });

        supabase_client.auth.onAuthStateChange((_event, session) => {
            currentUser = session ? session.user : null;
            updateUIForAuthState();
        });

        // JavaScript ä»£ç ç»“æŸ
    </script>
</body>
</html>
