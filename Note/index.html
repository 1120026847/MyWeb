<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Markdown Êó•ËÆ∞Êú¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Markdown Ê∏≤ÊüìÂ∫ì -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Êó•ÊúüÂ∑•ÂÖ∑ -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #111827;
      --border: #e5e7eb;
      --hover: #f3f4f6;
      --accent: #2563eb;
      --danger: #ef4444;
      --ok: #059669;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    a { color: var(--accent); text-decoration: none; }
    .app { display: flex; height: 100vh; overflow: hidden; }
    .sidebar {
      width: 300px; min-width: 260px; max-width: 420px; height: 100%;
      border-right: 1px solid var(--border); background: #fff; display: flex; flex-direction: column;
    }
    .side-top {
      padding: 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px;
    }
    .brand { font-weight: 700; font-size: 16px; flex: 1; }
    .btn, button {
      display: inline-flex; align-items: center; justify-content: center;
      height: 34px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--border);
      background: #fff; cursor: pointer; transition: background .15s, border-color .15s;
      font-size: 13px;
    }
    .btn:hover { background: var(--hover); }
    .btn.primary { border-color: var(--accent); color: #fff; background: var(--accent); }
    .btn.danger { border-color: var(--danger); color: #fff; background: var(--danger); }
    .btn.ghost { border: none; background: transparent; }
    .search { margin: 10px 12px; }
    .search input {
      width: 100%; height: 36px; border: 1px solid var(--border); border-radius: 8px; padding: 0 10px;
    }
    .tree { padding: 8px 8px 80px; overflow: auto; flex: 1; }
    .folder {
      border-radius: 10px; padding: 6px; margin-bottom: 6px;
    }
    .folder-header {
      display: flex; align-items: center; gap: 8px; padding: 6px; border-radius: 8px; cursor: pointer;
    }
    .folder-header:hover { background: var(--hover); }
    .folder-title { font-weight: 600; flex: 1; }
    .row-actions { display: flex; gap: 6px; }
    .article-list { padding-left: 10px; margin-top: 6px; }
    .date-group { margin: 4px 0 8px; color: var(--muted); font-size: 12px; padding-left: 6px; }
    .article {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      padding: 6px 8px; border-radius: 8px; cursor: pointer;
    }
    .article:hover { background: var(--hover); }
    .article.active { background: #eef2ff; }
    .article-title { font-size: 13px; }
    .main {
      flex: 1; display: flex; flex-direction: column; height: 100%;
    }
    .topbar {
      display: flex; gap: 8px; align-items: center; padding: 10px; border-bottom: 1px solid var(--border);
    }
    .menu-button { display: none; }
    .titlebar { display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid var(--border); }
    .titlebar input {
      flex: 1; height: 40px; padding: 0 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px;
    }
    .select { height: 40px; border: 1px solid var(--border); border-radius: 10px; padding: 0 10px; background: #fff; }
    .editor {
      flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 0; height: calc(100% - 0px);
    }
    .pane { height: 100%; }
    .pane-header { padding: 8px 10px; border-bottom: 1px solid var(--border); color: var(--muted); font-size: 12px; }
    .pane-body { height: calc(100% - 41px); }
    #content { width: 100%; height: 100%; border: none; outline: none; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 14px; resize: none; }
    #preview { padding: 12px; overflow: auto; height: 100%; }
    .auth {
      position: fixed; inset: 0; background: #f8fafc; display: grid; place-items: center; z-index: 10;
    }
    .card {
      width: min(480px, 92vw); background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .card h2 { margin: 0 0 12px; }
    .grid { display: grid; gap: 10px; }
    .grid.two { grid-template-columns: 1fr 1fr; }
    .muted { color: var(--muted); font-size: 12px; }
    .spacer { flex: 1; }
    .hidden { display: none !important; }

    @media (max-width: 980px) {
      .editor { grid-template-columns: 1fr; }
    }
    @media (max-width: 780px) {
      .sidebar { position: fixed; z-index: 20; left: 0; top: 0; bottom: 0; transform: translateX(-100%); transition: transform .2s; background: #fff; }
      .sidebar.open { transform: translateX(0); }
      .menu-button { display: inline-flex; }
    }
  </style>
</head>
<body>
<div id="auth" class="auth">
  <div class="card">
    <h2>ÁôªÂΩï‰Ω†ÁöÑÊó•ËÆ∞Êú¨</h2>
    <div class="grid">
      <input id="email" type="email" placeholder="ÈÇÆÁÆ±" />
      <input id="password" type="password" placeholder="ÂØÜÁ†ÅÔºàËá≥Â∞ë 6 ‰ΩçÔºâ" />
      <div class="grid two">
        <button id="loginBtn" class="btn primary">ÁôªÂΩï</button>
        <button id="signupBtn" class="btn">Ê≥®ÂÜåÂπ∂ÁôªÂΩï</button>
      </div>
      <div id="authMsg" class="muted"></div>
    </div>
  </div>
</div>

<div class="app">
  <aside id="sidebar" class="sidebar">
    <div class="side-top">
      <div class="brand">üìì Êó•ËÆ∞Êú¨</div>
      <button id="newFolderBtn" class="btn">Êñ∞Âª∫Êñá‰ª∂Â§π</button>
    </div>
    <div class="search"><input id="searchInput" placeholder="ÊêúÁ¥¢ÊñáÁ´†Ê†áÈ¢ò‚Ä¶" /></div>
    <div id="tree" class="tree"></div>
  </aside>

  <main class="main">
    <div class="topbar">
      <button id="menuBtn" class="btn menu-button">‚ò∞</button>
      <button id="newArticleBtn" class="btn primary">Êñ∞Âª∫ÊñáÁ´†</button>
      <button id="saveBtn" class="btn">‰øùÂ≠ò</button>
      <button id="exportBtn" class="btn">ÂØºÂá∫ .md</button>
      <button id="deleteBtn" class="btn danger">Âà†Èô§</button>
      <div class="spacer"></div>
      <button id="logoutBtn" class="btn">ÈÄÄÂá∫ÁôªÂΩï</button>
    </div>

    <div class="titlebar">
      <input id="titleInput" placeholder="ÊñáÁ´†Ê†áÈ¢ò‚Ä¶" />
      <select id="moveSelect" class="select"></select>
    </div>

    <section class="editor">
      <div class="pane">
        <div class="pane-header">ÁºñËæëÔºàMarkdownÔºâ</div>
        <div class="pane-body"><textarea id="content" placeholder="# Êñ∞ÁöÑ‰∏ÄÂ§©‚Ä¶"></textarea></div>
      </div>
      <div class="pane">
        <div class="pane-header">È¢ÑËßà</div>
        <div id="preview" class="pane-body"></div>
      </div>
    </section>
  </main>
</div>

<script type="module">
  // ====== Supabase ÂàùÂßãÂåñ ======
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== Áä∂ÊÄÅ ======
  let currentUser = null;
  let folders = [];       // {id, name, created_at}
  let articles = [];      // ÊâÄÊúâÊñáÁ´†ÁºìÂ≠òÔºàÂáèÂ∞ëËØ∑Ê±ÇÔºâ {id, folder_id, title, content, created_at, updated_at}
  let selectedFolderId = null;
  let selectedArticleId = null;

  // ====== DOM ======
  const el = (id) => document.getElementById(id);
  const authView = el('auth');
  const email = el('email');
  const password = el('password');
  const loginBtn = el('loginBtn');
  const signupBtn = el('signupBtn');
  const authMsg = el('authMsg');

  const sidebar = el('sidebar');
  const menuBtn = el('menuBtn');
  const newFolderBtn = el('newFolderBtn');
  const newArticleBtn = el('newArticleBtn');
  const saveBtn = el('saveBtn');
  const exportBtn = el('exportBtn');
  const deleteBtn = el('deleteBtn');
  const logoutBtn = el('logoutBtn');
  const searchInput = el('searchInput');

  const tree = el('tree');
  const titleInput = el('titleInput');
  const moveSelect = el('moveSelect');
  const content = el('content');
  const preview = el('preview');

  // ====== Â∑•ÂÖ∑ ======
  const toast = (msg, ok=false) => {
    authMsg.textContent = msg;
    authMsg.style.color = ok ? 'var(--ok)' : 'var(--muted)';
    if (!authView.classList.contains('hidden')) return;
    // ÁÆÄÊòìÊ∞îÊ≥°ÔºàÊéßÂà∂Âè∞Ôºâ
    console.info(msg);
  };

  const groupByMonth = (list) => {
    const map = {};
    for (const a of list) {
      const ym = dayjs(a.created_at).format('YYYY-MM');
      if (!map[ym]) map[ym] = [];
      map[ym].push(a);
    }
    const keys = Object.keys(map).sort((a,b)=> b.localeCompare(a)); // ÂÄíÂ∫è
    return keys.map(k => ({ month: k, items: map[k] }));
  };

  const sanitizeFileName = (s) => s.replace(/[\\/:*?"<>|]/g, '_').trim() || 'untitled';

  const renderMarkdown = () => { preview.innerHTML = marked.parse(content.value || ''); };

  // ====== Auth ÈÄªËæë ======
  loginBtn.onclick = async () => {
    authMsg.textContent = '';
    const { data, error } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
    if (error) { authMsg.textContent = error.message; return; }
    currentUser = data.user;
    authView.classList.add('hidden');
    await bootstrap();
  };

  signupBtn.onclick = async () => {
    authMsg.textContent = '';
    const { error: sErr } = await supabase.auth.signUp({ email: email.value, password: password.value });
    if (sErr) { authMsg.textContent = sErr.message; return; }
    // Ëã•È°πÁõÆÂÖ≥Èó≠‰∫ÜÈÇÆ‰ª∂Á°ÆËÆ§ÔºåËøôÈáå‰ºöÁõ¥Êé•Êúâ sessionÔºõÂê¶ÂàôÊàë‰ª¨ÂÜçÂ∞ùËØïÁî®ÂØÜÁ†ÅÁôªÂΩï
    const { data, error } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
    if (error) {
      authMsg.textContent = 'Ê≥®ÂÜåÊàêÂäüÔºåËØ∑ÂâçÂæÄÈÇÆÁÆ±ÂÆåÊàêÈ™åËØÅÂêéÂÜçÁôªÂΩïÔºàÊàñÂú® Auth ËÆæÁΩÆÂÖ≥Èó≠ Email Á°ÆËÆ§Ôºâ„ÄÇ';
      return;
    }
    currentUser = data.user;
    authView.classList.add('hidden');
    await bootstrap();
  };

  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    location.reload();
  };

  // ====== Êï∞ÊçÆËÆøÈóÆ ======
  async function loadFolders() {
    const { data, error } = await supabase.from('folders').select('*').order('created_at', { ascending: true });
    if (error) throw error;
    folders = data;
  }

  async function loadArticles() {
    // ÊãâÂèñÂΩìÂâçÁî®Êà∑ÂÖ®ÈÉ®ÊñáÁ´†ÔºåÂú®ÂâçÁ´ØÂÅöÂàÜÁªÑ / ËøáÊª§ÔºåÂáèÂ∞ëÈ¢ëÁπÅËØ∑Ê±Ç
    const { data, error } = await supabase.from('articles').select('*').order('created_at', { ascending: false });
    if (error) throw error;
    articles = data;
  }

  async function createFolder() {
    const name = prompt('Êñ∞Âª∫Êñá‰ª∂Â§πÂêçÁß∞Ôºö');
    if (!name) return;
    const { error } = await supabase.from('folders').insert({ name });
    if (error) return alert(error.message);
    await refreshTree();
  }

  async function renameFolder(fid) {
    const f = folders.find(x => x.id === fid);
    const name = prompt('ÈáçÂëΩÂêçÊñá‰ª∂Â§πÔºö', f?.name || '');
    if (!name) return;
    const { error } = await supabase.from('folders').update({ name }).eq('id', fid);
    if (error) return alert(error.message);
    await refreshTree();
    if (selectedFolderId === fid) fillMoveSelect(); // ÂêçÁß∞ÂèòÂåñÊó∂Âà∑Êñ∞‰∏ãÊãâ
  }

  async function deleteFolder(fid) {
    if (!confirm('Âà†Èô§Êñá‰ª∂Â§πÂ∞Ü‰∏ÄÂπ∂Âà†Èô§ÂÖ∂‰∏ãÊâÄÊúâÊñáÁ´†ÔºåÁ°ÆÂÆöÂêóÔºü')) return;
    const { error } = await supabase.from('folders').delete().eq('id', fid);
    if (error) return alert(error.message);
    if (selectedFolderId === fid) {
      selectedFolderId = null;
      selectedArticleId = null;
      clearEditor();
    }
    await refreshTree();
  }

  async function createArticle() {
    if (!selectedFolderId && folders.length) {
      // ÈªòËÆ§ÊîæÂà∞Á¨¨‰∏Ä‰∏™Êñá‰ª∂Â§π
      selectedFolderId = folders[0].id;
    }
    if (!selectedFolderId) {
      alert('ËØ∑ÂÖàÂàõÂª∫‰∏Ä‰∏™Êñá‰ª∂Â§π');
      return;
    }
    const today = dayjs().format('YYYY-MM-DD');
    const { data, error } = await supabase.from('articles').insert({
      folder_id: selectedFolderId,
      title: `Êó•ËÆ∞ - ${today}`,
      content: `# ${today}\n\nÂÜôÁÇπ‰ªÄ‰πàÂêß‚Ä¶`
    }).select().single();
    if (error) return alert(error.message);
    await refreshTree();
    selectArticle(data.id);
  }

  async function saveArticle() {
    if (!selectedArticleId) { alert('Â∞öÊú™ÈÄâÊã©ÊñáÁ´†'); return; }
    const title = titleInput.value.trim() || 'Êú™ÂëΩÂêç';
    const { error } = await supabase.from('articles')
      .update({ title, content: content.value, updated_at: new Date().toISOString(), folder_id: moveSelect.value || null })
      .eq('id', selectedArticleId);
    if (error) return alert(error.message);
    await refreshTree();
    toast('Â∑≤‰øùÂ≠ò', true);
  }

  async function deleteArticle() {
    if (!selectedArticleId) return;
    if (!confirm('Á°ÆÂÆöÂà†Èô§ËøôÁØáÊñáÁ´†ÂêóÔºü')) return;
    const { error } = await supabase.from('articles').delete().eq('id', selectedArticleId);
    if (error) return alert(error.message);
    selectedArticleId = null;
    clearEditor();
    await refreshTree();
  }

  // ====== UI Ê∏≤Êüì ======
  function buildTreeHTML() {
    const query = (searchInput.value || '').toLowerCase();

    const container = document.createElement('div');

    for (const f of folders) {
      // ÂΩìÂâçÊñá‰ª∂Â§πÁöÑÊñáÁ´†
      const list = articles
        .filter(a => a.folder_id === f.id)
        .filter(a => a.title.toLowerCase().includes(query));

      const groups = groupByMonth(list);

      const wrap = document.createElement('div');
      wrap.className = 'folder';

      const header = document.createElement('div');
      header.className = 'folder-header';
      header.onclick = () => { selectedFolderId = f.id; fillMoveSelect(); openSidebar(false); };

      const title = document.createElement('div');
      title.className = 'folder-title';
      title.textContent = `üóÇÔ∏è ${f.name}`;

      const actions = document.createElement('div');
      actions.className = 'row-actions';

      const rnBtn = document.createElement('button');
      rnBtn.className = 'btn ghost';
      rnBtn.textContent = 'ÈáçÂëΩÂêç';
      rnBtn.onclick = (e)=>{ e.stopPropagation(); renameFolder(f.id); };

      const delBtn = document.createElement('button');
      delBtn.className = 'btn ghost';
      delBtn.textContent = 'Âà†Èô§';
      delBtn.onclick = (e)=>{ e.stopPropagation(); deleteFolder(f.id); };

      actions.append(rnBtn, delBtn);
      header.append(title, actions);

      const ul = document.createElement('div');
      ul.className = 'article-list';

      for (const g of groups) {
        const dg = document.createElement('div'); dg.className = 'date-group'; dg.textContent = g.month;
        ul.appendChild(dg);
        for (const a of g.items) {
          const row = document.createElement('div');
          row.className = 'article' + (a.id === selectedArticleId ? ' active' : '');
          row.onclick = () => selectArticle(a.id);

          const atitle = document.createElement('div');
          atitle.className = 'article-title';
          atitle.textContent = a.title;

          const small = document.createElement('div');
          small.className = 'muted';
          small.style.fontSize = '11px';
          small.textContent = dayjs(a.updated_at || a.created_at).format('MM-DD');

          row.append(atitle, small);
          ul.appendChild(row);
        }
      }

      wrap.append(header, ul);
      container.appendChild(wrap);
    }

    return container.innerHTML || '<div class="muted" style="padding:10px;">ËøòÊ≤°Êúâ‰ªª‰ΩïÊñá‰ª∂Â§πÔºåÁÇπÂáª‰∏äÊñπ‚ÄúÊñ∞Âª∫Êñá‰ª∂Â§π‚Äù„ÄÇ</div>';
  }

  function renderTree() {
    tree.innerHTML = buildTreeHTML();
  }

  function fillMoveSelect() {
    moveSelect.innerHTML = '';
    for (const f of folders) {
      const opt = document.createElement('option');
      opt.value = f.id;
      opt.textContent = f.name;
      if (f.id === selectedFolderId) opt.selected = true;
      moveSelect.appendChild(opt);
    }
  }

  function clearEditor() {
    titleInput.value = '';
    content.value = '';
    renderMarkdown();
  }

  function setEditor(a) {
    titleInput.value = a.title || '';
    content.value = a.content || '';
    renderMarkdown();
    moveSelect.value = a.folder_id || '';
  }

  function exportMarkdown() {
    if (!selectedArticleId) { alert('ËØ∑ÈÄâÊã©ÊñáÁ´†'); return; }
    const a = articles.find(x => x.id === selectedArticleId);
    if (!a) return;
    const blob = new Blob([a.content || ''], { type: 'text/markdown;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const ymd = dayjs(a.created_at).format('YYYYMMDD');
    link.href = url;
    link.download = sanitizeFileName(`${a.title || 'note'}_${ymd}.md`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  async function selectArticle(aid) {
    selectedArticleId = aid;
    const a = articles.find(x => x.id === aid);
    if (!a) return;
    selectedFolderId = a.folder_id || null;
    setEditor(a);
    renderTree();
    fillMoveSelect();
    openSidebar(false);
  }

  function openSidebar(open) {
    if (open === undefined) open = !sidebar.classList.contains('open');
    if (open) sidebar.classList.add('open'); else sidebar.classList.remove('open');
  }

  // ====== ‰∫ã‰ª∂ÁªëÂÆö ======
  newFolderBtn.onclick = createFolder;
  newArticleBtn.onclick = createArticle;
  saveBtn.onclick = saveArticle;
  exportBtn.onclick = exportMarkdown;
  deleteBtn.onclick = deleteArticle;
  menuBtn.onclick = ()=> openSidebar();
  searchInput.oninput = () => renderTree();
  content.addEventListener('input', renderMarkdown);

  moveSelect.onchange = async () => {
    if (!selectedArticleId) return;
    const toFolder = moveSelect.value;
    const { error } = await supabase.from('articles').update({ folder_id: toFolder, updated_at: new Date().toISOString() }).eq('id', selectedArticleId);
    if (error) return alert(error.message);
    selectedFolderId = toFolder;
    await refreshTree();
    toast('Â∑≤ÁßªÂä®', true);
  };

  // ====== È¶ñÊ¨°ÂêØÂä® ======
  async function bootstrap() {
    const { data } = await supabase.auth.getUser();
    currentUser = data?.user || null;
    await refreshTree();
    authView.classList.add('hidden');
  }

  async function refreshTree() {
    await loadFolders();
    await loadArticles();
    renderTree();
    fillMoveSelect();
  }

  // Â§ÑÁêÜÂ∑≤Êúâ‰ºöËØù
  (async () => {
    const { data } = await supabase.auth.getSession();
    if (data?.session?.user) {
      currentUser = data.session.user;
      authView.classList.add('hidden');
      await bootstrap();
    } else {
      authView.classList.remove('hidden');
    }
    // ÁõëÂê¨ÁôªÂΩïÁä∂ÊÄÅÂèòÂåñ
    supabase.auth.onAuthStateChange((_event, session) => {
      currentUser = session?.user || null;
    });
  })();
</script>
</body>
</html>
