<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>笔记</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📓</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/quill/2.0.0-rc.2/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/quill/2.0.0-rc.2/quill.min.js"></script>
    <script src="https://web.sdk.qcloud.com/js/cloudbase/latest/cloudbase.full.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/feather-icons/4.29.1/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
    <style>
        .hidden { display: none; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        #editor-container { height: calc(100vh - 200px); }
        .ql-editor { font-size: 16px; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="mainAppView" class="hidden">
        <div id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-white w-64 shadow-lg z-20 md:translate-x-0 -translate-x-full">
            <div class="p-4 flex flex-col h-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">文件夹</h2>
                    <button id="newFolderBtn" class="p-1 hover:bg-gray-200 rounded-full"><i data-feather="plus"></i></button>
                </div>
                <div id="folderList" class="flex-grow overflow-y-auto"></div>
                <div class="border-t pt-2">
                    <div class="flex items-center">
                         <div id="userAvatar" class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mr-2"></div>
                         <span id="userEmail" class="text-sm truncate"></span>
                    </div>
                    <button id="logoutBtn" class="w-full text-left mt-2 p-2 hover:bg-gray-100 rounded text-sm">退出登录</button>
                </div>
            </div>
        </div>

        <div id="mainContent" class="main-content md:ml-64">
            <header id="header" class="bg-white p-2 flex justify-between items-center shadow-sm sticky top-0 z-10">
                <div>
                     <button id="sidebarToggleBtn" class="md:hidden p-2"><i data-feather="menu"></i></button>
                     <button id="newArticleBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-blue-600">新建笔记</button>
                </div>
                <div id="currentFolderName" class="font-semibold truncate">所有笔记</div>
                 <button id="headerToggleBtn" class="p-2"><i data-feather="chevron-up"></i></button>
            </header>

            <div class="flex h-screen">
                <div id="articleListContainer" class="w-1/3 bg-gray-50 border-r overflow-y-auto">
                    <div id="articleList"></div>
                </div>
                <div id="articleDetailContainer" class="w-2/3 p-4 bg-white hidden">
                    <input id="articleTitleInput" type="text" class="w-full text-2xl font-bold p-2 mb-2 border-b focus:outline-none" placeholder="输入标题...">
                    <div id="editor-container"></div>
                    <div class="mt-4 flex justify-end items-center">
                        <span id="saveStatus" class="text-sm text-gray-500 mr-4"></span>
                        <button id="deleteArticleBtn" class="text-red-500 hover:text-red-700 mr-4">删除</button>
                        <button id="saveArticleBtn" class="bg-green-500 text-white px-4 py-2 rounded font-semibold hover:bg-green-600">保存</button>
                    </div>
                </div>
                <div id="welcomeView" class="w-full flex items-center justify-center text-gray-500">
                    <p>选择或创建一篇笔记开始</p>
                </div>
            </div>
        </div>
    </div>

    <div id="authView" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 id="authTitle" class="mt-6 text-center text-3xl font-extrabold text-gray-900">登录您的账户</h2>
            </div>
            <form id="authForm" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">邮箱地址</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="邮箱地址">
                    </div>
                    <div>
                        <label for="password" class="sr-only">密码</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="密码">
                    </div>
                </div>
                <div>
                    <button id="authSubmitBtn" type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        登录
                    </button>
                </div>
            </form>
             <div class="text-sm text-center">
                <a href="#" id="authToggleLink" class="font-medium text-indigo-600 hover:text-indigo-500">
                    还没有账户？去注册
                </a>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // TCB 初始化
        // =================================================================
        const app = cloudbase.init({
            env: 'molijun-0gtahyghc6271173' // ！！！请务必替换成您自己的云开发环境ID
        });
        const auth = app.auth();
        const db = app.database();

        // =================================================================
        // 全局变量和状态
        // =================================================================
        let quill;
        let cos;
        const dom = {
            mainAppView: document.getElementById('mainAppView'),
            authView: document.getElementById('authView'),
            authForm: document.getElementById('authForm'),
            authTitle: document.getElementById('authTitle'),
            authSubmitBtn: document.getElementById('authSubmitBtn'),
            authToggleLink: document.getElementById('authToggleLink'),
            userEmail: document.getElementById('userEmail'),
            userAvatar: document.getElementById('userAvatar'),
            logoutBtn: document.getElementById('logoutBtn'),
            sidebar: document.getElementById('sidebar'),
            mainContent: document.getElementById('mainContent'),
            sidebarToggleBtn: document.getElementById('sidebarToggleBtn'),
            newFolderBtn: document.getElementById('newFolderBtn'),
            folderList: document.getElementById('folderList'),
            header: document.getElementById('header'),
            headerToggleBtn: document.getElementById('headerToggleBtn'),
            currentFolderName: document.getElementById('currentFolderName'),
            newArticleBtn: document.getElementById('newArticleBtn'),
            articleList: document.getElementById('articleList'),
            articleDetailContainer: document.getElementById('articleDetailContainer'),
            welcomeView: document.getElementById('welcomeView'),
            articleTitleInput: document.getElementById('articleTitleInput'),
            editorContainer: document.getElementById('editor-container'),
            saveStatus: document.getElementById('saveStatus'),
            deleteArticleBtn: document.getElementById('deleteArticleBtn'),
            saveArticleBtn: document.getElementById('saveArticleBtn'),
        };
        const state = {
            user: null,
            folders: [],
            articles: [],
            currentFolderId: null,
            currentArticleId: null,
            isLoginView: true,
            autoSaveTimer: null
        };

        // =================================================================
        // 初始化应用
        // =================================================================
        async function initializeApp() {
            try {
                const loginState = await auth.getLoginState();
                if (loginState) {
                    state.user = { email: loginState.user.email, uid: loginState.user.uid };
                    dom.authView.classList.add('hidden');
                    dom.mainAppView.classList.remove('hidden');
                    dom.userEmail.textContent = state.user.email;
                    dom.userAvatar.textContent = (state.user.email[0] || '').toUpperCase();
                    
                    initializeQuill();
                    await fetchData();
                    switchToWelcomeView();

                } else {
                    dom.authView.classList.remove('hidden');
                    dom.mainAppView.classList.add('hidden');
                }
            } catch (e) {
                console.error("初始化失败:", e);
                dom.authView.classList.remove('hidden');
                dom.mainAppView.classList.add('hidden');
            }
            feather.replace(); // 渲染图标
        }

        function initializeQuill() {
             if (quill) return;
             const toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'], ['blockquote', 'code-block'],
                [{ 'header': 1 }, { 'header': 2 }], [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'script': 'sub'}, { 'script': 'super' }], [{ 'indent': '-1'}, { 'indent': '+1' }],
                [{ 'direction': 'rtl' }], [{ 'size': ['small', false, 'large', 'huge'] }],
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                [{ 'color': [] }, { 'background': [] }], [{ 'font': [] }],
                [{ 'align': [] }], ['clean'], ['link', 'image']
            ];

            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: { toolbar: toolbarOptions }
            });

            quill.getModule('toolbar').addHandler('image', () => {
                selectImage();
            });

            quill.on('text-change', () => {
                if(state.autoSaveTimer) clearTimeout(state.autoSaveTimer);
                dom.saveStatus.textContent = '正在输入...';
                state.autoSaveTimer = setTimeout(() => {
                    handleSaveArticle();
                }, 2000); // 2秒后自动保存
            });
        }
        
        // =================================================================
        // 认证相关函数
        // =================================================================
        async function handleAuthSubmit(e) {
            e.preventDefault(); // 阻止表单默认提交行为
            const email = dom.authForm.email.value;
            const password = dom.authForm.password.value;
            dom.authSubmitBtn.disabled = true;
            dom.authSubmitBtn.textContent = '处理中...';

            try {
                if (state.isLoginView) { // 登录
                    await auth.signInWithEmailAndPassword(email, password);
                } else { // 注册
                    await auth.signUpWithEmailAndPassword(email, password);
                    alert('注册成功！请登录。');
                    toggleAuthView(); // 切换回登录视图
                }
                 window.location.reload();
            } catch (error) {
                alert(`操作失败: ${error.message}`);
            } finally {
                dom.authSubmitBtn.disabled = false;
                dom.authSubmitBtn.textContent = state.isLoginView ? '登录' : '注册';
            }
        }

        async function handleLogout() {
            await auth.signOut();
            window.location.reload();
        }
        
        function toggleAuthView(e) {
            if(e) e.preventDefault();
            state.isLoginView = !state.isLoginView;
            if (state.isLoginView) {
                dom.authTitle.textContent = '登录您的账户';
                dom.authSubmitBtn.textContent = '登录';
                dom.authToggleLink.textContent = '还没有账户？去注册';
            } else {
                dom.authTitle.textContent = '创建新账户';
                dom.authSubmitBtn.textContent = '注册';
                dom.authToggleLink.textContent = '已有账户？去登录';
            }
        }

        // =================================================================
        // 数据获取与渲染
        // =================================================================
        async function fetchData() {
            try {
                // 并行获取文件夹和文章
                const [folderRes, articleRes] = await Promise.all([
                    app.callFunction({ name: 'getFolders' }),
                    app.callFunction({ name: 'getArticles' })
                ]);
                
                if (folderRes.result.success) {
                    state.folders = folderRes.result.data;
                } else {
                    throw new Error(folderRes.result.error);
                }

                if (articleRes.result.success) {
                    state.articles = articleRes.result.data;
                } else {
                    throw new Error(articleRes.result.error);
                }

                renderFolders();
                renderArticles(state.currentFolderId);

            } catch (error) {
                alert(`数据加载失败: ${error.message}`);
                console.error(error);
            }
        }

        function renderFolders() {
            dom.folderList.innerHTML = '';
            // 添加 "所有笔记" 选项
            const allNotesItem = document.createElement('div');
            allNotesItem.className = `p-2 rounded cursor-pointer flex justify-between items-center ${state.currentFolderId === null ? 'bg-blue-100' : 'hover:bg-gray-100'}`;
            allNotesItem.textContent = '所有笔记';
            allNotesItem.onclick = () => selectFolder(null);
            dom.folderList.appendChild(allNotesItem);

            // 渲染用户创建的文件夹
            state.folders.forEach(folder => {
                const folderEl = document.createElement('div');
                folderEl.className = `folder-item p-2 rounded cursor-pointer flex justify-between items-center ${state.currentFolderId === folder._id ? 'bg-blue-100' : 'hover:bg-gray-100'}`;
                folderEl.onclick = () => selectFolder(folder._id);
                
                const folderName = document.createElement('span');
                folderName.textContent = folder.name;
                folderEl.appendChild(folderName);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i data-feather="trash-2" class="w-4 h-4 text-gray-500"></i>';
                deleteBtn.className = 'p-1 rounded-full hover:bg-red-100';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    handleDeleteFolder(folder._id, folder.name);
                };
                folderEl.appendChild(deleteBtn);
                dom.folderList.appendChild(folderEl);
            });
            feather.replace();
        }
        
        function renderArticles(folderId) {
            dom.articleList.innerHTML = '';
            const filteredArticles = folderId ? state.articles.filter(a => a.folder_id === folderId) : state.articles;

            if (filteredArticles.length === 0) {
                 dom.articleList.innerHTML = '<p class="p-4 text-center text-gray-500">这个文件夹是空的</p>';
                 return;
            }
            
            filteredArticles.forEach(article => {
                const articleEl = document.createElement('div');
                articleEl.className = `p-4 border-b cursor-pointer ${state.currentArticleId === article._id ? 'bg-white' : 'hover:bg-gray-100'}`;
                articleEl.onclick = () => selectArticle(article._id);
                
                const title = document.createElement('h3');
                title.className = 'font-bold truncate';
                title.textContent = article.title || '无标题';
                articleEl.appendChild(title);
                
                const contentSnippet = document.createElement('p');
                contentSnippet.className = 'text-sm text-gray-600 truncate';
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = article.content;
                contentSnippet.textContent = (tempDiv.textContent || tempDiv.innerText || "").substring(0, 100);
                articleEl.appendChild(contentSnippet);
                
                dom.articleList.appendChild(articleEl);
            });
        }

        function renderArticleDetail(article) {
            dom.articleTitleInput.value = article.title;
            quill.setText(''); // Clear editor before setting content
            if (article.content) {
                try {
                    const delta = JSON.parse(article.content);
                    quill.setContents(delta);
                } catch (e) {
                    quill.clipboard.dangerouslyPasteHTML(article.content);
                }
            }
            dom.saveStatus.textContent = '已保存';
        }

        // =================================================================
        // 事件处理与业务逻辑
        // =================================================================
        function selectFolder(folderId) {
            state.currentFolderId = folderId;
            const folder = state.folders.find(f => f._id === folderId);
            dom.currentFolderName.textContent = folder ? folder.name : '所有笔记';
            renderFolders();
            renderArticles(folderId);
            switchToWelcomeView();
        }
        
        function selectArticle(articleId) {
            state.currentArticleId = articleId;
            const article = state.articles.find(a => a._id === articleId);
            if (article) {
                renderArticleDetail(article);
                renderArticles(state.currentFolderId);
                switchToEditorView();
            }
        }
        
        async function handleNewFolder() {
            const name = prompt("请输入新文件夹的名称：");
            if (name) {
                try {
                    const res = await app.callFunction({ name: 'addFolder', data: { name }});
                    if (!res.result.success) throw new Error(res.result.error);
                    await fetchData();
                } catch (error) {
                    alert(`创建文件夹失败: ${error.message}`);
                }
            }
        }

        async function handleDeleteFolder(folderId, folderName) {
            if (confirm(`确定要删除文件夹 "${folderName}" 吗？`)) {
                try {
                    const res = await app.callFunction({ name: 'deleteFolder', data: { id: folderId }});
                    if (!res.result.success) throw new Error(res.result.error);
                    
                    if (state.currentFolderId === folderId) {
                        state.currentFolderId = null;
                    }
                    await fetchData();

                } catch (error) {
                    alert(`删除文件夹失败: ${error.message}`);
                }
            }
        }

        async function handleNewArticle() {
            try {
                const res = await app.callFunction({
                    name: 'addArticle',
                    data: {
                        title: '无标题笔记',
                        content: '',
                        folder_id: state.currentFolderId
                    }
                });
                if (!res.result.success) throw new Error(res.result.error);
                
                await fetchData();
                selectArticle(res.result.data._id);

            } catch (error) {
                alert(`创建笔记失败: ${error.message}`);
            }
        }
        
        async function handleSaveArticle() {
            if (!state.currentArticleId) return;
            dom.saveStatus.textContent = '正在保存...';
            try {
                const title = dom.articleTitleInput.value;
                const content = JSON.stringify(quill.getContents());
                
                const res = await app.callFunction({
                    name: 'updateArticle',
                    data: {
                        id: state.currentArticleId,
                        title,
                        content
                    }
                });
                if (!res.result.success) throw new Error(res.result.error);
                
                const articleIndex = state.articles.findIndex(a => a._id === state.currentArticleId);
                if (articleIndex > -1) {
                    state.articles[articleIndex].title = title;
                    state.articles[articleIndex].content = content;
                }
                renderArticles(state.currentFolderId);
                dom.saveStatus.textContent = '已保存';

            } catch (error) {
                 dom.saveStatus.textContent = '保存失败!';
                 alert(`保存失败: ${error.message}`);
            }
        }
        
        async function handleDeleteArticle() {
            if (!state.currentArticleId) return;
            if (confirm('确定要删除这篇笔记吗？')) {
                try {
                    const res = await app.callFunction({
                        name: 'deleteArticle',
                        data: { id: state.currentArticleId }
                    });
                    if (!res.result.success) throw new Error(res.result.error);
                    
                    state.currentArticleId = null;
                    await fetchData();
                    switchToWelcomeView();

                } catch (error) {
                    alert(`删除失败: ${error.message}`);
                }
            }
        }

        // =================================================================
        // 图片上传 (COS)
        // =================================================================
        function getCosInstance() {
            if (cos) return cos;
            cos = new COS({
                async getAuthorization(options, callback) {
                    try {
                        const res = await app.callFunction({ name: 'getCosCredential' });
                        if (res.result.code !== 200) throw new Error(res.result.message);
                        
                        const data = res.result.data;
                        callback({
                            TmpSecretId: data.credentials.tmpSecretId,
                            TmpSecretKey: data.credentials.tmpSecretKey,
                            SecurityToken: data.credentials.sessionToken,
                            StartTime: data.startTime,
                            ExpiredTime: data.expiredTime,
                        });
                    } catch (err) {
                        console.error('获取COS凭证失败', err);
                        alert('无法获取上传凭证，请检查后端函数配置');
                    }
                }
            });
            return cos;
        }

        function selectImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    uploadImage(file);
                }
            };
            input.click();
        }

        function uploadImage(file) {
            const cosInstance = getCosInstance();
            const key = `${state.user.uid}/${Date.now()}-${file.name}`;

            cosInstance.putObject({
                Bucket: '您的-COS-存储桶名称', // ！！！请替换
                Region: '您的-COS-存储桶地域', // ！！！请替换
                Key: key,
                Body: file,
                onProgress: function(progressData) {
                    console.log('上传进度', JSON.stringify(progressData));
                }
            }, function(err, data) {
                if (err) {
                    console.error('上传失败', err);
                    alert('图片上传失败!');
                } else {
                    console.log('上传成功', data);
                    const imageUrl = `https://${data.Location}`;
                    const range = quill.getSelection(true);
                    quill.insertEmbed(range.index, 'image', imageUrl);
                }
            });
        }

        // =================================================================
        // UI 切换和辅助函数
        // =================================================================
        function switchToEditorView() {
            dom.welcomeView.classList.add('hidden');
            dom.articleDetailContainer.classList.remove('hidden');
        }

        function switchToWelcomeView() {
            dom.welcomeView.classList.remove('hidden');
            dom.articleDetailContainer.classList.add('hidden');
        }

        function toggleSidebar(forceState) {
            const isHidden = dom.sidebar.classList.contains('-translate-x-full');
            let action = isHidden ? 'show' : 'hide';
            if (forceState) action = forceState;

            if (action === 'show') {
                dom.sidebar.classList.remove('-translate-x-full');
                if (window.innerWidth >= 768) dom.mainContent.classList.add('md:ml-64');
            } else {
                dom.sidebar.classList.add('-translate-x-full');
                if (window.innerWidth >= 768) dom.mainContent.classList.remove('md:ml-64');
            }
        }
        
        function toggleHeader(forceState) {
            // 此功能可根据需要自行实现
        }

        // =================================================================
        // 事件监听 (代码已修复)
        // =================================================================
        window.addEventListener('load', () => {
            // 页面完全加载后，再绑定所有事件监听
            dom.authForm.addEventListener('submit', handleAuthSubmit);
            dom.authToggleLink.addEventListener('click', toggleAuthView);
            dom.logoutBtn.addEventListener('click', handleLogout);
            dom.newFolderBtn.addEventListener('click', handleNewFolder);
            dom.newArticleBtn.addEventListener('click', handleNewArticle);
            dom.saveArticleBtn.addEventListener('click', handleSaveArticle);
            dom.deleteArticleBtn.addEventListener('click', handleDeleteArticle);
            dom.sidebarToggleBtn.addEventListener('click', () => toggleSidebar());
            
            // 最后初始化应用
            initializeApp();
        });

    </script>
</body>
</html>
