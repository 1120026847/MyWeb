<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown 日记本</title>
    <!-- 使用在中国访问更快的 CDN 加载 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Marked.js 用于解析 Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 引入 Supabase-js 客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 引入 Feather Icons 图标库 (使用 BootCDN 解决国内加载问题) -->
    <script src="https://cdn.bootcdn.net/ajax/libs/feather-icons/4.29.1/feather.min.js"></script>
    <script>
        // 自定义 Tailwind CSS 配置
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': {
                            'light': '#f0f4f8',
                            'DEFAULT': '#3b82f6',
                            'dark': '#1e40af',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定义滚动条样式，使其更美观 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c4c4c4;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* Prose a little bit of custom styling for the markdown rendering */
        .prose a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .prose blockquote {
            border-left-color: #3b82f6;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-white antialiased text-slate-800">
    <div id="app" class="relative min-h-screen">
        <!-- 认证页面 (默认显示) -->
        <div id="auth-view" class="flex items-center justify-center min-h-screen bg-brand-light">
            <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-lg">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-slate-900">日记本</h1>
                    <p class="text-slate-500">记录你的想法，整理你的生活</p>
                </div>
                
                <!-- 登录/注册切换 -->
                <div class="flex border border-gray-200 rounded-md p-1">
                    <button id="show-login-tab" class="w-1/2 p-2 rounded-md text-sm font-medium bg-blue-500 text-white">登录</button>
                    <button id="show-register-tab" class="w-1/2 p-2 rounded-md text-sm font-medium text-gray-600">注册</button>
                </div>

                <!-- 登录表单 -->
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="text-sm font-medium text-slate-600">邮箱</label>
                        <input id="login-email" type="email" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="login-password" class="text-sm font-medium text-slate-600">密码</label>
                        <input id="login-password" type="password" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="••••••••">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-brand rounded-md hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-dark transition-colors duration-200">
                        登录
                    </button>
                </form>

                <!-- 注册表单 (默认隐藏) -->
                <form id="register-form" class="hidden space-y-4">
                     <div>
                        <label for="register-email" class="text-sm font-medium text-slate-600">邮箱</label>
                        <input id="register-email" type="email" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="register-password" class="text-sm font-medium text-slate-600">密码</label>
                        <input id="register-password" type="password" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="至少6个字符">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-brand rounded-md hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-dark transition-colors duration-200">
                        注册
                    </button>
                </form>
            </div>
        </div>

        <!-- 主应用界面 (默认隐藏) -->
        <div id="main-app-view" class="hidden h-screen w-full md:flex">
            <!-- 侧边栏 -->
            <aside id="sidebar" class="absolute z-30 md:relative w-72 md:w-80 h-full bg-brand-light border-r border-slate-200 flex flex-col flex-shrink-0 md:translate-x-0 -translate-x-full">
                <!-- 用户信息和操作 -->
                <div class="p-4 border-b border-slate-200">
                    <div id="user-info" class="flex items-center space-x-2">
                        <span class="w-8 h-8 rounded-full bg-brand flex items-center justify-center text-white font-bold text-sm" id="user-avatar"></span>
                        <span class="text-sm font-medium truncate" id="user-email"></span>
                    </div>
                    <button id="logout-button" class="w-full mt-3 px-3 py-1.5 text-xs text-slate-600 bg-slate-200 rounded-md hover:bg-slate-300 transition-colors">
                        退出登录
                    </button>
                </div>
                
                <!-- 新建操作 -->
                <div class="p-4 flex space-x-2">
                    <button id="new-folder-button" class="flex-1 flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors">
                        <i data-feather="folder-plus" class="w-4 h-4 mr-2"></i>
                        新建文件夹
                    </button>
                    <button id="new-article-button" class="flex-1 flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors">
                        <i data-feather="file-plus" class="w-4 h-4 mr-2"></i>
                        新建文章
                    </button>
                </div>

                <!-- 文件夹和文章列表 -->
                <div id="file-tree" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- 动态内容 -->
                </div>
            </aside>

            <!-- 主内容区 -->
            <main id="main-content" class="flex-1 flex flex-col bg-white">
                 <!-- 移动端顶部导航 -->
                <header class="md:hidden flex items-center justify-between p-2 border-b border-slate-200 bg-white">
                    <button id="toggle-sidebar-button" class="p-2 rounded-md hover:bg-slate-100">
                        <i data-feather="menu" class="w-6 h-6"></i>
                    </button>
                    <h2 id="mobile-article-title" class="text-lg font-semibold truncate">日记本</h2>
                    <div id="mobile-editor-controls" class="hidden">
                         <button id="mobile-save-button" class="p-2 rounded-md bg-blue-500 text-white hover:bg-blue-600">
                            <i data-feather="save" class="w-5 h-5"></i>
                        </button>
                    </div>
                </header>
                <!-- 欢迎/空状态 -->
                <div id="welcome-view" class="flex-1 flex flex-col items-center justify-center text-center p-8">
                     <i data-feather="book-open" class="w-16 h-16 text-slate-300 mb-4"></i>
                     <h2 class="text-2xl font-semibold text-slate-800">欢迎使用日记本</h2>
                     <p class="text-slate-500 mt-2">从左侧选择一篇文章开始阅读，或新建一篇文章开始创作。</p>
                </div>

                <!-- 文章视图 (默认隐藏) -->
                <div id="article-view" class="hidden flex-1 flex flex-col">
                    <!-- 文章工具栏 -->
                    <div class="hidden md:flex items-center p-3 border-b border-slate-200 bg-white">
                        <input id="article-title-input" class="text-xl font-semibold flex-1 bg-transparent focus:outline-none focus:ring-0 border-none p-0" value="文章标题">
                        <div id="editor-controls" class="flex items-center space-x-2 ml-4">
                             <button id="edit-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200 transition-colors">
                                 <i data-feather="edit-2" class="w-4 h-4 mr-1.5"></i>编辑
                             </button>
                             <button id="save-button" class="hidden flex items-center px-3 py-1.5 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                                 <i data-feather="save" class="w-4 h-4 mr-1.5"></i>保存
                             </button>
                             <button id="move-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200 transition-colors">
                                 <i data-feather="move" class="w-4 h-4 mr-1.5"></i>移动
                             </button>
                             <button id="export-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200 transition-colors">
                                 <i data-feather="download" class="w-4 h-4 mr-1.5"></i>导出
                             </button>
                             <button id="delete-button" class="flex items-center px-3 py-1.5 text-sm text-red-600 bg-red-50 rounded-md hover:bg-red-100 transition-colors">
                                 <i data-feather="trash-2" class="w-4 h-4 mr-1.5"></i>删除
                             </button>
                        </div>
                    </div>
                    <!-- 编辑器和预览区 -->
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 overflow-hidden">
                        <!-- Markdown 编辑器 -->
                        <textarea id="editor" class="w-full h-full p-6 text-base leading-7 resize-none focus:outline-none font-mono"></textarea>
                        <!-- 预览区 -->
                        <div id="preview" class="w-full h-full p-6 overflow-y-auto prose border-l border-slate-200 bg-gray-50/50"></div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- 全局消息提示 -->
        <div id="toast" class="fixed top-5 right-5 px-4 py-2 rounded-md text-white shadow-lg transition-transform translate-x-[150%]"></div>
        
        <!-- 移动文件夹弹窗 -->
        <div id="move-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                <h3 class="text-lg font-medium">移动文章到...</h3>
                <select id="move-folder-select" class="w-full mt-4 p-2 border rounded-md"></select>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-move" class="px-4 py-2 bg-gray-200 rounded-md">取消</button>
                    <button id="confirm-move" class="px-4 py-2 bg-blue-500 text-white rounded-md">确认移动</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Supabase 配置 ---
        const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- 全局状态 ---
        let state = {
// ... existing code ... -->
            });
        }
        
        async function initializeApp() {
            feather.replace();
            initEventListeners();

            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                state.user = session.user;
                dom.authView.classList.add('hidden');
                dom.mainAppView.classList.remove('hidden');
                dom.mainAppView.classList.add('md:flex');
                
                dom.userEmail.textContent = state.user.email;
                dom.userAvatar.textContent = state.user.email[0].toUpperCase();
                
                await fetchData();

                // 优化：登录后自动打开最新文章
                if (state.articles.length > 0) {
                    selectArticle(state.articles[0].id);
                }
            } else {
                dom.authView.classList.remove('hidden');
                dom.mainAppView.classList.add('hidden');
            }

            supabase.auth.onAuthStateChange((_event, session) => {
                if (_event === 'SIGNED_IN') {
// ... existing code ... -->

