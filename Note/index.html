<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬”è®°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ““</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/quill/2.0.0-rc.2/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/quill/2.0.0-rc.2/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/feather-icons/4.29.1/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
    <!-- æ–°å¢ï¼šPDFå¯¼å‡ºå’Œæ¸²æŸ“åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        tailwind.config = { /* ... ä¿æŒä¸å˜ ... */ }
    </script>
    <style>
        /* ... ä¿æŒä¸å˜ ... */
        /* æ–°å¢ï¼šPDFé˜…è¯»å™¨æ ·å¼ */
        #pdf-viewer-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        #pdf-viewer {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }
        #pdf-viewer canvas {
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .pdf-controls {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
    </style>
</head>
<body class="bg-white antialiased text-slate-800">
    <!-- ... è®¤è¯å’Œä¾§è¾¹æ ç­‰HTMLç»“æ„ä¿æŒä¸å˜ï¼Œä½†ä¸»å†…å®¹åŒºæœ‰æ”¹åŠ¨ ... -->
    <main id="main-content" class="flex-1 flex flex-col bg-white overflow-hidden">
        <!-- ... header ä¿æŒä¸å˜ ... -->
        <div id="welcome-view" class="flex-1 flex flex-col items-center justify-center text-center p-8">
             <i data-feather="book-open" class="w-16 h-16 text-slate-300 mb-4"></i>
             <h2 class="text-2xl font-semibold text-slate-800">æ¬¢è¿ä½¿ç”¨ç¬”è®°</h2>
             <p class="text-slate-500 mt-2">ä»å·¦ä¾§é€‰æ‹©ä¸€ç¯‡æ–‡ç« å¼€å§‹é˜…è¯»ï¼Œæˆ–æ–°å»º/å¯¼å…¥ä¸€ç¯‡æ–‡ç« ã€‚</p>
        </div>
        
        <!-- æ–‡ç« è§†å›¾ç°åœ¨åŒ…å«ä¸¤ä¸ªå­è§†å›¾ï¼šå¯Œæ–‡æœ¬å’ŒPDF -->
        <div id="article-view" class="hidden flex-1 flex flex-col overflow-hidden">
            <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è§†å›¾ -->
            <div id="richtext-editor-view" class="hidden flex-1 flex-col overflow-hidden">
                <div class="p-3 border-b border-slate-200 bg-white flex-shrink-0">
                    <div id="editor-controls" class="hidden md:flex items-center space-x-2">
                         <button id="edit-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="edit-2" class="w-4 h-4 mr-1.5"></i>ç¼–è¾‘</button>
                         <button id="save-button" class="hidden flex items-center px-3 py-1.5 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600"><i data-feather="save" class="w-4 h-4 mr-1.5"></i>ä¿å­˜</button>
                         <button id="move-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="move" class="w-4 h-4 mr-1.5"></i>ç§»åŠ¨</button>
                         <!-- ä¿®æ”¹ï¼šå¯¼å‡ºæŒ‰é’®æ”¹ä¸ºä¸‹æ‹‰èœå• -->
                         <div class="relative inline-block text-left">
                            <button id="export-dropdown-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="download" class="w-4 h-4 mr-1.5"></i>å¯¼å‡º</button>
                            <div id="export-options" class="hidden origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <a href="#" id="export-txt-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">å¯¼å‡ºä¸º TXT</a>
                                <a href="#" id="export-pdf-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">å¯¼å‡ºä¸º PDF</a>
                            </div>
                         </div>
                         <button id="refresh-button" title="åŒæ­¥æ•°æ®" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="refresh-cw" class="w-4 h-4 mr-1.5"></i>åŒæ­¥</button>
                         <button id="force-reload-button" title="å¿½ç•¥æœ¬åœ°è‰ç¨¿ï¼Œä»äº‘ç«¯é‡æ–°åŠ è½½" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="zap-off" class="w-4 h-4 mr-1.5"></i>å¼ºåˆ¶é‡è½½</button>
                    </div>
                </div>
                <div class="flex-1 p-2 md:p-4 overflow-y-auto">
                    <div id="editor-container"></div>
                </div>
            </div>

            <!-- PDFé˜…è¯»å™¨è§†å›¾ -->
            <div id="pdf-reader-view" class="hidden flex-1 flex-col overflow-hidden items-center p-4">
                <div class="pdf-controls mb-4 flex items-center space-x-4">
                    <button id="pdf-prev-page" class="p-2 rounded-md hover:bg-slate-200"><i data-feather="arrow-left"></i></button>
                    <span>ç¬¬ <span id="pdf-current-page"></span> / <span id="pdf-total-pages"></span> é¡µ</span>
                    <button id="pdf-next-page" class="p-2 rounded-md hover:bg-slate-200"><i data-feather="arrow-right"></i></button>
                </div>
                <div id="pdf-viewer-container" class="w-full">
                    <div id="pdf-viewer"></div>
                </div>
            </div>
        </div>
    </main>
    <!-- ... å…¶ä»–modalç­‰HTMLç»“æ„ä¿æŒä¸å˜ï¼Œä½†å¤‡ä»½æ¢å¤éƒ¨åˆ†æœ‰æ”¹åŠ¨ ... -->
     <div class="p-4 border-t border-slate-200">
        <details class="group">
            <summary class="flex items-center justify-between cursor-pointer text-sm font-medium text-slate-600 hover:text-slate-800 list-none">
                <div class="flex items-center">
                    <i data-feather="database" class="w-4 h-4 mr-2"></i>
                    <span>å¤‡ä»½ä¸æ¢å¤</span>
                </div>
                <i data-feather="chevron-down" class="w-4 h-4 transition-transform duration-200 group-open:rotate-180"></i>
            </summary>
            <div class="mt-2 space-y-2">
                <!-- æ–°å¢ï¼šå¯¼å…¥PDFæŒ‰é’® -->
                <button id="import-pdf-button" class="w-full flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="file-text" class="w-4 h-4 mr-2"></i>å¯¼å…¥PDF</button>
                <input type="file" id="import-pdf-input" class="hidden" accept=".pdf">
                <button id="import-button" class="w-full flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="upload" class="w-4 h-4 mr-2"></i>å¯¼å…¥å¤‡ä»½</button>
                <button id="export-all-button" class="w-full flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="download" class="w-4 h-4 mr-2"></i>å¯¼å‡ºå¤‡ä»½</button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
        </details>
    </div>
    <!-- ... -->

    <script type="module">
        // ... Supabase, COSé…ç½®, state, domç­‰å˜é‡å£°æ˜ä¿æŒä¸å˜ ...
        
        // --- æ–°å¢PDFé˜…è¯»å™¨ç›¸å…³çš„å…¨å±€å˜é‡ ---
        let pdfDoc = null;
        let currentPage = 1;

        // ... showToast, formatDate, ç™»å½•/æ³¨å†Œ/ç™»å‡ºå‡½æ•°ä¿æŒä¸å˜ ...
        // ... uploadFileToCOS, insertImageToEditor, handleImageUpload, dataURLtoFile å‡½æ•°ä¿æŒä¸å˜ ...

        // --- æ ¸å¿ƒæ”¹åŠ¨ï¼šæ–‡ç« é€‰æ‹©ä¸æ¸²æŸ“ ---
        function selectArticle(id, startInEditMode = false, ignoreDraft = false) {
            if (state.isEditing && state.selectedArticleId && state.selectedArticleId !== id) { saveDraftToLocalStorage(); }
            
            state.selectedArticleId = id; 
            const article = state.articles.find(a => a.id === id); 
            if (!article) { switchToWelcomeView(); return; }
            
            state.openedArticleTimestamp = article.updated_at;
            dom.welcomeView.classList.add('hidden');
            dom.articleView.classList.remove('hidden');
            dom.articleView.classList.add('flex');
            dom.articleMainTitle.textContent = article.title;

            // æ ¹æ®æ–‡ç« ç±»å‹å†³å®šæ˜¾ç¤ºå“ªä¸ªè§†å›¾
            if (article.type === 'pdf') {
                dom.richtextEditorView.classList.add('hidden');
                dom.pdfReaderView.classList.remove('hidden');
                dom.pdfReaderView.classList.add('flex');
                loadAndRenderPDF(article.content); // PDFæ–‡ç« çš„contentå­—æ®µå­˜çš„æ˜¯URL
            } else { // é»˜è®¤ä¸ºå¯Œæ–‡æœ¬
                dom.pdfReaderView.classList.add('hidden');
                dom.richtextEditorView.classList.remove('hidden');
                dom.richtextEditorView.classList.add('flex');

                const draft = loadDraftFromLocalStorage(id);
                const useDraft = draft && new Date(draft.updatedAt) > new Date(article.updated_at);
                if (!ignoreDraft && useDraft) { 
                    showToast('å·²åŠ è½½è¾ƒæ–°çš„æœ¬åœ°è‰ç¨¿', 'success'); 
                    quill.root.innerHTML = draft.content || ''; 
                    switchToEditMode(); 
                } else { 
                    quill.root.innerHTML = article.content || ''; 
                    if (startInEditMode) { switchToEditMode(); } 
                    else { switchToViewMode(); } 
                }
            }

            renderFileTree(); 
            if (window.innerWidth < 768) { toggleSidebar('hide'); }
        }

        // --- æ–°å¢ï¼šPDFåŠ è½½ä¸æ¸²æŸ“å‡½æ•° ---
        async function loadAndRenderPDF(url) {
            const pdfViewer = dom.pdfViewer;
            pdfViewer.innerHTML = 'æ­£åœ¨åŠ è½½PDF...';
            
            try {
                // ä½¿ç”¨PDF.jsåŠ è½½æ–‡æ¡£
                pdfDoc = await pdfjsLib.getDocument(url).promise;
                dom.pdfTotalPages.textContent = pdfDoc.numPages;
                currentPage = 1;
                renderPDFPage(currentPage);
            } catch (error) {
                pdfViewer.innerHTML = 'åŠ è½½PDFå¤±è´¥ã€‚';
                console.error('Error loading PDF:', error);
            }
        }

        async function renderPDFPage(pageNum) {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            
            const pdfViewer = dom.pdfViewer;
            pdfViewer.innerHTML = ''; // æ¸…ç©ºå†…å®¹
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            pdfViewer.appendChild(canvas);

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            dom.pdfCurrentPage.textContent = pageNum;
        }

        // --- æ–°å¢ï¼šå¯¼å…¥PDFçš„æ ¸å¿ƒé€»è¾‘ ---
        async function handlePDFImport(file) {
            if (!file) return;
            showToast('æ­£åœ¨ä¸Šä¼ PDF...');
            try {
                // å¤ç”¨ä¸Šä¼ å›¾ç‰‡çš„é€»è¾‘ï¼Œä½†ä¸Šä¼ åˆ°pdfsç›®å½•
                const pdfUrl = await uploadFileToCOS(file, 'pdfs');
                
                // åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€ç¯‡æ–°æ–‡ç« ï¼Œç±»å‹ä¸ºpdf
                const { data, error } = await supabase.from('articles').insert({
                    title: file.name,
                    content: pdfUrl, // contentå­—æ®µå­˜å‚¨PDFçš„URL
                    type: 'pdf',
                    user_id: state.user.id
                }).select();
                
                if (error) throw error;
                
                showToast('PDFå¯¼å…¥æˆåŠŸï¼');
                await fetchData();
                selectArticle(data[0].id); // é€‰ä¸­å¹¶æ˜¾ç¤ºæ–°å¯¼å…¥çš„PDF
            } catch(error) {
                showToast(`PDFå¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // --- ä¿®æ”¹ï¼šä¸Šä¼ å‡½æ•°å¢åŠ ä¸€ä¸ªç›®å½•å‚æ•° ---
        async function uploadFileToCOS(file, directory = 'images') {
            // ... å†…éƒ¨é€»è¾‘ä¸å˜ï¼Œåªä¿®æ”¹ key çš„ç”Ÿæˆæ–¹å¼ ...
            const key = `${directory}/${state.user.id}/${Date.now()}-${file.name}`;
            // ... å…¶ä½™ä¸å˜
        }
        
        // --- æ–°å¢ï¼šå¯¼å‡ºä¸ºPDFçš„å‡½æ•° ---
        async function handleExportPDF() {
            const article = state.articles.find(a => a.id === state.selectedArticleId);
            if (!article) return;

            showToast('æ­£åœ¨ç”ŸæˆPDF...');
            
            // å¦‚æœæ˜¯PDFæ–‡ç« ï¼Œç›´æ¥ä¸‹è½½
            if (article.type === 'pdf') {
                window.open(article.content, '_blank');
                showToast('æ­£åœ¨æ‰“å¼€åŸå§‹PDFæ–‡ä»¶...');
                return;
            }

            // å¦‚æœæ˜¯å¯Œæ–‡æœ¬æ–‡ç« ï¼Œåˆ™è¿›è¡Œè½¬æ¢
            const editorContent = dom.editorContainer.querySelector('.ql-editor');
            const { jsPDF } = window.jspdf;

            try {
                const canvas = await html2canvas(editorContent, {
                    scale: 2, // æé«˜æ¸…æ™°åº¦
                    useCORS: true, // å…è®¸åŠ è½½è·¨åŸŸå›¾ç‰‡
                });
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`${article.title}.pdf`);
                showToast('PDFå¯¼å‡ºæˆåŠŸï¼');
            } catch(e) {
                showToast('PDFå¯¼å‡ºå¤±è´¥', 'error');
                console.error(e);
            }
        }

        // ... å…¶ä½™å‡½æ•°åŸºæœ¬ä¿æŒä¸å˜ï¼Œé™¤äº†initEventListeners ...
        function initEventListeners() {
            // ... ä¿ç•™æ‰€æœ‰æ—§çš„ç›‘å¬å™¨ ...

            // æ–°å¢PDFå¯¼å…¥æŒ‰é’®çš„ç›‘å¬
            dom.importPdfButton.addEventListener('click', () => dom.importPdfInput.click());
            dom.importPdfInput.addEventListener('change', (e) => handlePDFImport(e.target.files[0]));
            
            // æ–°å¢PDFç¿»é¡µæŒ‰é’®çš„ç›‘å¬
            dom.pdfPrevPage.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPDFPage(currentPage); } });
            dom.pdfNextPage.addEventListener('click', () => { if (pdfDoc && currentPage < pdfDoc.numPages) { currentPage++; renderPDFPage(currentPage); } });

            // ä¿®æ”¹å¯¼å‡ºæŒ‰é’®çš„é€»è¾‘ä¸ºä¸‹æ‹‰èœå•
            dom.exportDropdownButton.addEventListener('click', () => {
                dom.exportOptions.classList.toggle('hidden');
            });
            dom.exportTxtButton.addEventListener('click', (e) => {
                e.preventDefault();
                handleExportArticle(); // è°ƒç”¨æ—§çš„å¯¼å‡ºTXTå‡½æ•°
                dom.exportOptions.classList.add('hidden');
            });
            dom.exportPdfButton.addEventListener('click', (e) => {
                e.preventDefault();
                handleExportPDF();
                dom.exportOptions.classList.add('hidden');
            });
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­å¯¼å‡ºèœå•
            document.addEventListener('click', (e) => {
                if (!dom.exportDropdownButton.contains(e.target) && !dom.exportOptions.contains(e.target)) {
                    dom.exportOptions.classList.add('hidden');
                }
            });
        }

        // ... initQuill, initializeApp ç­‰å‡½æ•°ä¿æŒä¸å˜ ...
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
