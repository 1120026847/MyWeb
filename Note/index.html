<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown 日记111</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f8f9fa;
            --bg-sidebar: #ffffff;
            --bg-editor: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --accent-hover: #0b5ed7;
            --danger-color: #dc3545;
            --success-color: #198754;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: var(--bg-main);
            color: var(--text-main);
        }
        .sidebar { background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); }
        .editor-container { background-color: var(--bg-editor); }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5c636a; }
        .border-custom { border-color: var(--border-color); }
        .folder-item.active, .diary-item.active { background-color: rgba(13, 110, 253, 0.1); }
        .folder-item:hover, .diary-item:hover { background-color: rgba(13, 110, 253, 0.05); }
        #editor {
            background-color: var(--bg-editor);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 400px;
        }
        /* Markdown Preview Styles for Light Theme */
        .prose-custom { color: var(--text-main); }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { border-bottom: 1px solid var(--border-color); padding-bottom: .3em; }
        .prose-custom h1, .prose-custom h2, .prose-custom h3, .prose-custom h4, .prose-custom h5, .prose-custom h6 { color: var(--text-main); font-weight: 600; }
        .prose-custom a { color: var(--accent-color); text-decoration: none; }
        .prose-custom a:hover { text-decoration: underline; }
        .prose-custom strong { color: var(--text-main); }
        .prose-custom blockquote { border-left: .25em solid var(--accent-color); color: var(--text-muted); background-color: #f8f9fa; padding: 0 1em; }
        .prose-custom code { background-color: rgba(0,0,0,0.05); color: #d63384; padding: .2em .4em; margin: 0; font-size: 85%; border-radius: 6px; }
        .prose-custom pre { background-color: #f6f8fa; padding: 1rem; border-radius: 8px; }
        .prose-custom pre code { background-color: transparent; color: inherit; padding: 0; }
        .prose-custom ul, .prose-custom ol { padding-left: 2em; }
        .prose-custom table { border-collapse: collapse; }
        .prose-custom th, .prose-custom td { border: 1px solid var(--border-color); padding: 8px 12px; }
        .prose-custom tr:nth-child(2n) { background-color: #f6f8fa; }
        .prose-custom img { max-width: 100%; }

        /* Mobile specific styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed; top: 0; left: 0; bottom: 0; z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .modal-overlay {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 40;
            }
        }
    </style>
</head>
<body class="overflow-hidden h-screen">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-[100]">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm border border-custom">
            <h2 id="auth-title" class="text-2xl font-bold text-gray-800 mb-6 text-center">登录您的账户</h2>
            <div id="auth-container" class="space-y-4">
                 <input type="email" id="email-input" placeholder="邮箱地址" class="w-full border border-custom p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                 <input type="password" id="password-input" placeholder="密码 (至少6位)" class="w-full border border-custom p-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                 <button id="auth-action-btn" class="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700 transition font-semibold">登录</button>
            </div>
            <div id="loading-spinner" class="hidden text-center text-gray-700">
                <i class="fas fa-spinner fa-spin text-3xl"></i>
                <p class="mt-2">正在处理...</p>
            </div>
            <p id="auth-message" class="text-center mt-4 text-sm"></p>
            <p class="text-center text-sm text-gray-500 mt-4">
                <span id="auth-toggle-text">还没有账号？</span>
                <a href="#" id="auth-toggle-link" class="font-medium text-blue-600 hover:underline">立即注册</a>
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-container" class="hidden h-screen md:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 md:w-80 lg:w-96 p-4 flex flex-col h-full overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-xl font-bold">我的日记</h1>
                <button id="close-sidebar-btn" class="md-hidden text-2xl text-gray-400 hover:text-black">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex items-center mb-4">
                <input type="text" id="new-folder-name" placeholder="新建文件夹..." class="w-full border border-custom p-2 rounded-l focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="add-folder-btn" class="bg-blue-600 text-white px-3 py-2 rounded-r hover:bg-blue-700"><i class="fas fa-plus"></i></button>
            </div>
            <nav id="folder-list" class="flex-grow">
                <!-- Folders and diaries will be populated here -->
            </nav>
            <div class="mt-auto">
                <button id="logout-btn" class="w-full text-left p-2 rounded hover:bg-red-500/10 text-red-600">
                    <i class="fas fa-sign-out-alt mr-2"></i> 退出登录
                </button>
            </div>
        </aside>

        <!-- Sidebar overlay for mobile -->
        <div id="sidebar-overlay" class="modal-overlay hidden md:hidden"></div>

        <!-- Main content -->
        <main class="main-content flex-1 flex flex-col h-screen overflow-hidden">
            <!-- Top Bar -->
            <div class="flex items-center p-4 border-b border-custom bg-white">
                 <button id="menu-btn" class="md-hidden mr-4 text-2xl">
                    <i class="fas fa-bars"></i>
                </button>
                <div id="current-diary-title" class="text-lg font-semibold truncate">请选择或创建一篇文章</div>
                <div class="ml-auto flex items-center space-x-2">
                    <button id="move-diary-btn" class="btn-secondary px-3 py-1.5 rounded-md hidden"><i class="fas fa-folder-tree"></i> <span class="hidden sm:inline ml-1">移动</span></button>
                    <button id="export-diary-btn" class="btn-secondary px-3 py-1.5 rounded-md hidden"><i class="fas fa-file-export"></i> <span class="hidden sm:inline ml-1">导出</span></button>
                    <button id="delete-diary-btn" class="btn-danger px-3 py-1.5 rounded-md hidden"><i class="fas fa-trash"></i> <span class="hidden sm:inline ml-1">删除</span></button>
                    <button id="edit-btn" class="btn-primary px-3 py-1.5 rounded-md hidden"><i class="fas fa-pencil-alt"></i> <span class="hidden sm:inline ml-1">编辑</span></button>
                    <button id="save-btn" class="btn-success px-3 py-1.5 rounded-md hidden"><i class="fas fa-save"></i> <span class="hidden sm:inline ml-1">保存</span></button>
                </div>
            </div>

            <!-- Editor/Preview Area -->
            <div id="content-area" class="flex-1 p-4 md:p-6 overflow-y-auto">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center text-gray-400">
                    <i class="fas fa-book-open text-6xl mb-4"></i>
                    <h2 class="text-2xl font-semibold text-gray-700">开始您的写作之旅</h2>
                    <p class="mt-2">从左侧选择一个文件夹和文章，或者创建一个新的。</p>
                </div>
                <div id="editor-view" class="hidden h-full">
                    <textarea id="editor" class="w-full h-full p-4 resize-none"></textarea>
                </div>
                <div id="preview-view" class="hidden prose-custom max-w-none">
                    <!-- Rendered markdown will be here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Move Diary Modal -->
    <div id="move-modal" class="modal-overlay hidden items-center justify-center fixed inset-0 z-[60]">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">移动文章到...</h3>
            <select id="move-folder-select" class="w-full p-2 border border-custom rounded mb-4"></select>
            <div class="flex justify-end space-x-2">
                <button id="cancel-move-btn" class="btn-secondary px-4 py-2 rounded">取消</button>
                <button id="confirm-move-btn" class="btn-primary px-4 py-2 rounded">确认移动</button>
            </div>
        </div>
    </div>


    <script type="module">
        const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
        const { createClient } = supabase;
        
        const App = {
            state: {
                user: null, folders: [], diaries: {},
                activeFolderId: null, activeDiaryId: null,
                isEditing: false, isLoginMode: true
            },
            elements: {},
            supabase: null,

            init() {
                console.log("App.init() - Initializing application.");
                this.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                this.cacheDOMElements();
                this.bindEventListeners();
                this.initAuthListener();
            },

            cacheDOMElements() {
                const ids = [
                    'auth-screen', 'app-container', 'email-input', 'password-input', 'auth-action-btn', 
                    'auth-message', 'auth-title', 'auth-toggle-text', 'auth-toggle-link', 'auth-container', 
                    'loading-spinner', 'logout-btn', 'folder-list', 'new-folder-name', 'add-folder-btn', 
                    'current-diary-title', 'editor-view', 'preview-view', 'editor', 'welcome-screen', 
                    'edit-btn', 'save-btn', 'delete-diary-btn', 'export-diary-btn', 'move-diary-btn', 
                    'menu-btn', 'sidebar', 'close-sidebar-btn', 'sidebar-overlay', 'move-modal', 
                    'move-folder-select', 'cancel-move-btn', 'confirm-move-btn'
                ];
                ids.forEach(id => {
                    const key = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    this.elements[key] = document.getElementById(id);
                });
                console.log("App.cacheDOMElements() - DOM elements cached.");
            },

            bindEventListeners() {
                // Simplified and safer event binding
                this.elements.authActionBtn?.addEventListener('click', () => this.handleAuthAction());
                this.elements.authToggleLink?.addEventListener('click', e => {
                    e.preventDefault();
                    this.state.isLoginMode = !this.state.isLoginMode;
                    this.ui.updateAuthUI();
                });
                this.elements.logoutBtn?.addEventListener('click', () => this.auth.signOut());
                this.elements.addFolderBtn?.addEventListener('click', () => this.handlers.addFolder());
                this.elements.newFolderName?.addEventListener('keypress', e => { if (e.key === 'Enter') this.handlers.addFolder(); });
                this.elements.editBtn?.addEventListener('click', () => this.handlers.setEditing(true));
                this.elements.saveBtn?.addEventListener('click', () => this.handlers.saveDiary());
                this.elements.deleteDiaryBtn?.addEventListener('click', () => this.handlers.deleteDiary());
                this.elements.exportDiaryBtn?.addEventListener('click', () => this.handlers.exportDiary());
                this.elements.moveDiaryBtn?.addEventListener('click', () => this.ui.showMoveModal());
                this.elements.cancelMoveBtn?.addEventListener('click', () => this.elements.moveModal.style.display = 'none');
                this.elements.confirmMoveBtn?.addEventListener('click', () => this.handlers.moveDiary());
                this.elements.menuBtn?.addEventListener('click', () => this.ui.toggleSidebar());
                this.elements.closeSidebarBtn?.addEventListener('click', () => this.ui.toggleSidebar());
                this.elements.sidebarOverlay?.addEventListener('click', () => this.ui.toggleSidebar());
                this.elements.folderList?.addEventListener('click', e => this.handlers.handleFolderListClick(e));
                console.log("App.bindEventListeners() - Event listeners bound successfully.");
            },

            initAuthListener() {
                this.supabase.auth.onAuthStateChange(async (_event, session) => {
                    console.log("Auth state changed. Session:", session ? "Exists" : "Null");
                    const userIsAuthenticated = !!session;
                    const userStateIsAuthenticated = !!this.state.user;

                    if (userIsAuthenticated !== userStateIsAuthenticated) {
                        if (userIsAuthenticated) {
                            this.state.user = session.user;
                            this.elements.authScreen.style.display = 'none';
                            this.elements.appContainer.classList.remove('hidden');
                            await this.handlers.loadInitialData();
                        } else {
                            this.state.user = null;
                            this.elements.authScreen.style.display = 'flex';
                            this.elements.appContainer.classList.add('hidden');
                            this.handlers.resetAppState();
                        }
                    }
                });
            },

            auth: {
                async signUp() { /* ... unchanged ... */ },
                async signIn() { /* ... unchanged ... */ },
                signOut() { console.log("Signing out..."); App.supabase.auth.signOut(); }
            },
            
            handleAuthAction() {
                console.log(`Handling auth action. Mode: ${this.state.isLoginMode ? 'Login' : 'Sign Up'}`);
                if (this.state.isLoginMode) this.auth.signIn();
                else this.auth.signUp();
            },
            
            api: { /* ... all api methods unchanged ... */ },

            ui: {
                renderAll() { this.renderFolders(); this.renderContent(); },
                renderFolders() {
                    const { folderList } = App.elements;
                    folderList.innerHTML = '';
                    App.state.folders.forEach(folder => {
                        const folderEl = document.createElement('div');
                        folderEl.innerHTML = `
                            <div class="folder-item cursor-pointer p-2 rounded flex justify-between items-center group ${folder.id === App.state.activeFolderId ? 'active' : ''}" data-folder-id="${folder.id}">
                                <div class="folder-name-container flex items-center flex-grow truncate mr-2">
                                    <i class="fas fa-folder mr-2 ${folder.id === App.state.activeFolderId ? 'fa-folder-open text-blue-500' : 'text-gray-500'}"></i>
                                    <span class="font-semibold truncate">${folder.name}</span>
                                </div>
                                <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button class="rename-folder-btn text-gray-400 hover:text-blue-500 mr-2" title="重命名文件夹"><i class="fas fa-edit"></i></button>
                                    <button class="add-diary-btn text-gray-400 hover:text-green-500 mr-2" title="新建文章"><i class="fas fa-plus-circle"></i></button>
                                    <button class="delete-folder-btn text-gray-400 hover:text-red-500" title="删除文件夹"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                            <div class="diary-list pl-4 border-l border-custom ml-2 ${folder.id === App.state.activeFolderId ? '' : 'hidden'}"></div>
                        `;
                        folderList.appendChild(folderEl);
                        if (folder.id === App.state.activeFolderId) {
                            this.renderDiaries(folder.id, folderEl.querySelector('.diary-list'));
                        }
                    });
                },
                renderDiaries(folderId, container) {
                    container.innerHTML = '';
                    const diaries = App.state.diaries[folderId] || [];
                    diaries.forEach(diary => {
                        const diaryEl = document.createElement('div');
                        diaryEl.className = `diary-item cursor-pointer p-2 my-1 rounded flex justify-between items-center group ${diary.id === App.state.activeDiaryId ? 'active' : ''}`;
                        diaryEl.dataset.diaryId = diary.id;
                        diaryEl.dataset.folderId = folderId; // **FIX**: Ensure folderId is on diary items
                        diaryEl.innerHTML = `
                            <div class="diary-name-container flex items-center truncate">
                               <i class="far fa-file-alt mr-2 text-gray-500"></i>
                               <span class="truncate">${diary.title}</span>
                            </div>
                            <button class="rename-diary-btn text-gray-400 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity" title="重命名文章"><i class="fas fa-edit"></i></button>
                        `;
                        container.appendChild(diaryEl);
                    });
                },
                renderContent() { /* ... unchanged ... */ },
                updateAuthUI() { /* ... unchanged ... */ },
                showAuthLoading(isLoading) { /* ... unchanged ... */ },
                setAuthMessage(message, isError = false) { /* ... unchanged ... */ },
                toggleSidebar() { /* ... unchanged ... */ },
                showMoveModal() { /* ... unchanged ... */ }
            },

            handlers: {
                async loadInitialData() {
                    console.log("Loading initial data for user:", App.state.user.id);
                    const { data, error } = await App.api.fetchFolders();
                    if (error) return console.error('Error fetching folders:', error);
                    App.state.folders = data;
                    for (const folder of App.state.folders) {
                        const { data: diaries, error: diariesError } = await App.api.fetchDiaries(folder.id);
                        if (diariesError) continue;
                        App.state.diaries[folder.id] = diaries;
                    }
                    App.ui.renderAll();
                },
                resetAppState() { /* ... unchanged ... */ },
                handleFolderListClick(e) {
                    const diaryItem = e.target.closest('.diary-item');
                    const folderItem = e.target.closest('.folder-item');
                    if (!folderItem && !diaryItem) return;

                    const folderId = folderItem?.dataset.folderId || diaryItem?.dataset.folderId;
                    const diaryId = diaryItem?.dataset.diaryId;
                    if (!folderId) return;

                    if (e.target.closest('.add-diary-btn')) return this.addDiary(folderId);
                    if (e.target.closest('.rename-folder-btn')) return this.renameFolder(folderId);
                    if (e.target.closest('.delete-folder-btn')) return this.deleteFolder(folderId);
                    if (diaryId) {
                        if (e.target.closest('.rename-diary-btn')) return this.renameDiary(diaryId, folderId);
                        if (e.target.closest('.diary-name-container')) return this.setActiveDiary(folderId, diaryId);
                    }
                    if (e.target.closest('.folder-name-container')) return this.setActiveFolder(folderId);
                },
                setActiveFolder(folderId) { /* ... unchanged ... */ },
                setActiveDiary(folderId, diaryId, options = {}) { /* ... unchanged ... */ },
                setEditing(isEditing, options = {}) { /* ... unchanged ... */ },
                async addFolder() { /* ... unchanged ... */ },
                async renameFolder(folderId) { /* ... unchanged ... */ },
                async deleteFolder(folderId) { /* ... unchanged ... */ },
                async addDiary(folderId) { /* ... unchanged ... */ },
                async renameDiary(diaryId, folderId) { /* ... unchanged ... */ },
                async saveDiary() { /* ... unchanged ... */ },
                async deleteDiary() { /* ... unchanged ... */ },
                async moveDiary() { /* ... unchanged ... */ },
                exportDiary() { /* ... unchanged ... */ }
            }
        };
        
        // Helper functions copied from previous unchanged sections for completeness
        App.auth.signUp = async function() {
            const { emailInput, passwordInput } = App.elements;
            App.ui.setAuthMessage('');
            if (!emailInput.value || !passwordInput.value) return App.ui.setAuthMessage('邮箱和密码不能为空。', true);
            if (passwordInput.value.length < 6) return App.ui.setAuthMessage('密码至少需要6位。', true);
            App.ui.showAuthLoading(true);
            const { error } = await App.supabase.auth.signUp({ email: emailInput.value, password: passwordInput.value });
            App.ui.showAuthLoading(false);
            if (error) App.ui.setAuthMessage(`注册失败: ${error.message}`, true);
            else App.ui.setAuthMessage('注册成功！请检查您的邮箱以完成验证。');
        };
        App.auth.signIn = async function() {
            const { emailInput, passwordInput } = App.elements;
            App.ui.setAuthMessage('');
            if (!emailInput.value || !passwordInput.value) return App.ui.setAuthMessage('邮箱和密码不能为空。', true);
            App.ui.showAuthLoading(true);
            const { error } = await App.supabase.auth.signInWithPassword({ email: emailInput.value, password: passwordInput.value });
            App.ui.showAuthLoading(false);
            if (error) App.ui.setAuthMessage(`登录失败: ${error.message}`, true);
        };
        App.api = {
            async fetchFolders() { return App.supabase.from('folders').select('*').eq('user_id', App.state.user.id).order('created_at', { ascending: true }); },
            async fetchDiaries(folderId) { return App.supabase.from('diaries').select('*').eq('folder_id', folderId).order('created_at', { ascending: false }); },
            async addFolder(name) { return App.supabase.from('folders').insert({ name, user_id: App.state.user.id }).select().single(); },
            async renameFolder(id, name) { return App.supabase.from('folders').update({ name }).eq('id', id).select().single(); },
            async deleteFolder(id) { return App.supabase.from('folders').delete().eq('id', id); },
            async addDiary(folderId, title) { const content = `# ${title}\n\n开始写作...`; return App.supabase.from('diaries').insert({ title, content, folder_id: folderId, user_id: App.state.user.id }).select().single(); },
            async renameDiary(id, title) { return App.supabase.from('diaries').update({ title }).eq('id', id).select().single(); },
            async saveDiary(id, content) { return App.supabase.from('diaries').update({ content }).eq('id', id).select().single(); },
            async deleteDiary(id) { return App.supabase.from('diaries').delete().eq('id', id); },
            async moveDiary(id, folderId) { return App.supabase.from('diaries').update({ folder_id: folderId }).eq('id', id).select().single(); }
        };
        App.ui.renderContent = function() {
            const { activeDiaryId, activeFolderId, diaries } = App.state;
            const { welcomeScreen, editorView, previewView, currentDiaryTitle, editor, editBtn, saveBtn, deleteDiaryBtn, exportDiaryBtn, moveDiaryBtn } = App.elements;
            const diary = activeDiaryId && diaries[activeFolderId]?.find(d => d.id === activeDiaryId);
            if (diary) {
                welcomeScreen.classList.add('hidden');
                currentDiaryTitle.textContent = diary.title;
                editor.value = diary.content;
                previewView.innerHTML = marked.parse(diary.content || '');
                [deleteDiaryBtn, exportDiaryBtn, moveDiaryBtn].forEach(btn => btn.classList.remove('hidden'));
                if (App.state.isEditing) {
                    editorView.classList.remove('hidden'); previewView.classList.add('hidden');
                    editBtn.classList.add('hidden'); saveBtn.classList.remove('hidden');
                } else {
                    editorView.classList.add('hidden'); previewView.classList.remove('hidden');
                    editBtn.classList.remove('hidden'); saveBtn.classList.add('hidden');
                }
            } else {
                welcomeScreen.classList.remove('hidden'); editorView.classList.add('hidden'); previewView.classList.add('hidden');
                currentDiaryTitle.textContent = '请选择或创建一篇文章';
                [editBtn, saveBtn, deleteDiaryBtn, exportDiaryBtn, moveDiaryBtn].forEach(btn => btn.classList.add('hidden'));
            }
        };
        App.ui.updateAuthUI = function() {
            this.setAuthMessage('');
            const { authTitle, authActionBtn, authToggleText, authToggleLink } = App.elements;
            if (App.state.isLoginMode) {
                authTitle.textContent = '登录您的账户'; authActionBtn.textContent = '登录';
                authToggleText.textContent = '还没有账号？'; authToggleLink.textContent = '立即注册';
            } else {
                authTitle.textContent = '创建新账户'; authActionBtn.textContent = '注册';
                authToggleText.textContent = '已有账号？'; authToggleLink.textContent = '立即登录';
            }
        };
        App.ui.showAuthLoading = function(isLoading) {
            const { authContainer, loadingSpinner } = App.elements;
            authContainer.classList.toggle('hidden', isLoading);
            loadingSpinner.classList.toggle('hidden', !isLoading);
        };
        App.ui.setAuthMessage = function(message, isError = false) {
            const { authMessage } = App.elements;
            authMessage.textContent = message;
            authMessage.className = `text-center mt-4 text-sm ${isError ? 'text-red-500' : 'text-green-600'}`;
        };
        App.ui.toggleSidebar = function() {
            App.elements.sidebar.classList.toggle('open');
            App.elements.sidebarOverlay.classList.toggle('hidden');
        };
        App.ui.showMoveModal = function() {
            const { moveFolderSelect, moveModal } = App.elements;
            moveFolderSelect.innerHTML = '';
            App.state.folders.filter(f => f.id !== App.state.activeFolderId).forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id; option.textContent = folder.name;
                moveFolderSelect.appendChild(option);
            });
            if (moveFolderSelect.options.length > 0) moveModal.style.display = 'flex';
            else alert('没有其他文件夹可以移动。');
        };
        App.handlers.resetAppState = function() {
            console.log("Resetting app state.");
            App.state.folders = []; App.state.diaries = {};
            App.state.activeFolderId = null; App.state.activeDiaryId = null;
            App.ui.renderAll();
        };
        App.handlers.setActiveFolder = function(folderId) {
            App.state.activeFolderId = (App.state.activeFolderId === folderId) ? null : folderId;
            if (App.state.activeFolderId !== folderId) this.setActiveDiary(null, null, { skipRender: true });
            App.ui.renderAll();
        };
        App.handlers.setActiveDiary = function(folderId, diaryId, options = {}) {
            App.state.activeFolderId = folderId; App.state.activeDiaryId = diaryId;
            this.setEditing(false, { skipRender: true });
            if (!options.skipRender) App.ui.renderAll();
            if (App.elements.sidebar.classList.contains('open')) App.ui.toggleSidebar();
        };
        App.handlers.setEditing = function(isEditing, options = {}) {
            App.state.isEditing = isEditing;
            if (!options.skipRender) App.ui.renderContent();
        };
        App.handlers.addFolder = async function() {
            const name = App.elements.newFolderName.value.trim();
            if (!name) return;
            const { data, error } = await App.api.addFolder(name);
            if (error) return console.error('Error adding folder:', error);
            App.state.folders.push(data); App.state.diaries[data.id] = [];
            App.elements.newFolderName.value = ''; this.setActiveFolder(data.id);
        };
        App.handlers.renameFolder = async function(folderId) {
            const folder = App.state.folders.find(f => f.id === folderId);
            const newName = prompt('输入新的文件夹名称:', folder.name);
            if (!newName || newName.trim() === '' || newName === folder.name) return;
            const { data, error } = await App.api.renameFolder(folderId, newName.trim());
            if (error) return console.error('Error renaming folder:', error);
            folder.name = data.name; App.ui.renderFolders();
        };
        App.handlers.deleteFolder = async function(folderId) {
            if (!confirm('确定要删除这个文件夹及其所有文章吗？此操作无法撤销。')) return;
            const { error } = await App.api.deleteFolder(folderId);
            if(error) return console.error('Error deleting folder:', error);
            App.state.folders = App.state.folders.filter(f => f.id !== folderId);
            delete App.state.diaries[folderId];
            if (App.state.activeFolderId === folderId) this.setActiveFolder(null);
            else App.ui.renderFolders();
        };
        App.handlers.addDiary = async function(folderId) {
            const title = prompt("请输入新文章的标题：");
            if (!title || title.trim() === '') return;
            const { data, error } = await App.api.addDiary(folderId, title.trim());
            if (error) return console.error('Error adding diary:', error);
            if (!App.state.diaries[folderId]) App.state.diaries[folderId] = [];
            App.state.diaries[folderId].unshift(data); this.setActiveDiary(folderId, data.id);
        };
        App.handlers.renameDiary = async function(diaryId, folderId) {
            const diary = App.state.diaries[folderId]?.find(d => d.id === diaryId);
            if (!diary) return;
            const newTitle = prompt("输入新的文章标题:", diary.title);
            if (!newTitle || newTitle.trim() === '' || newTitle === diary.title) return;
            const { data, error } = await App.api.renameDiary(diaryId, newTitle.trim());
            if (error) return console.error('Error renaming diary:', error);
            diary.title = data.title; App.ui.renderAll();
        };
        App.handlers.saveDiary = async function() {
            const { activeDiaryId, activeFolderId } = App.state;
            if (!activeDiaryId) return;
            const { data, error } = await App.api.saveDiary(activeDiaryId, App.elements.editor.value);
            if (error) return console.error('Error saving diary:', error);
            const idx = App.state.diaries[activeFolderId].findIndex(d => d.id === activeDiaryId);
            if(idx > -1) App.state.diaries[activeFolderId][idx] = data;
            this.setEditing(false);
        };
        App.handlers.deleteDiary = async function() {
            const { activeDiaryId, activeFolderId } = App.state;
            if (!activeDiaryId || !confirm('确定要删除这篇文章吗？')) return;
            const { error } = await App.api.deleteDiary(activeDiaryId);
            if (error) return console.error('Error deleting diary:', error);
            App.state.diaries[activeFolderId] = App.state.diaries[activeFolderId].filter(d => d.id !== activeDiaryId);
            this.setActiveDiary(activeFolderId, null);
        };
        App.handlers.moveDiary = async function() {
            const newFolderId = App.elements.moveFolderSelect.value;
            const { activeDiaryId, activeFolderId } = App.state;
            if (!newFolderId || !activeDiaryId) return;
            const { data, error } = await App.api.moveDiary(activeDiaryId, newFolderId);
            if (error) return console.error('Error moving diary:', error);
            const diary = App.state.diaries[activeFolderId].find(d => d.id === activeDiaryId);
            App.state.diaries[activeFolderId] = App.state.diaries[activeFolderId].filter(d => d.id !== activeDiaryId);
            if (!App.state.diaries[newFolderId]) App.state.diaries[newFolderId] = [];
            App.state.diaries[newFolderId].unshift(data);
            App.elements.moveModal.style.display = 'none';
            this.setActiveDiary(newFolderId, activeDiaryId);
        };
        App.handlers.exportDiary = function() {
            const { activeDiaryId, activeFolderId, diaries } = App.state;
            if (!activeDiaryId) return;
            const diary = diaries[activeFolderId].find(d => d.id === activeDiaryId);
            const blob = new Blob([diary.content], { type: 'text/markdown;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${diary.title.replace(/[\/\\?%*:|"<>]/g, '-')}.md`;
            a.click();
            URL.revokeObjectURL(a.href);
        };

        // Run the app after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>

