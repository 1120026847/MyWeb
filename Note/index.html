<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日记本</title>
    <!-- 使用在中国访问更快的 CDN 加载 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Quill.js 编辑器 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/quill/2.0.0-rc.2/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/quill/2.0.0-rc.2/quill.min.js"></script>
    <!-- 引入 Supabase-js 客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 引入 Feather Icons 图标库 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/feather-icons/4.29.1/feather.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': {
                            'light': '#f0f4f8',
                            'DEFAULT': '#3b82f6',
                            'dark': '#1e40af',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #c4c4c4; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        #sidebar { transition: margin-left 0.3s ease-in-out; }
        #main-app-view.sidebar-collapsed #sidebar {
            margin-left: -18rem; /* w-72 */
        }

        .folder-toggle-icon.collapsed { transform: rotate(-90deg); }
        .folder-toggle-icon { transition: transform 0.2s ease-in-out; }
        
        #editor-container { height: 100%; }
        .ql-editor { font-size: 16px; line-height: 1.6; }
        .ql-toolbar.ql-snow { border-radius: 8px 8px 0 0; }
        .ql-container.ql-snow { border-radius: 0 0 8px 8px; height: calc(100% - 42px); }
        
        #toast { transition: transform 0.3s ease-in-out; }
        summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-white antialiased text-slate-800">
    <div id="app" class="relative min-h-screen">
        <!-- 认证页面 -->
        <div id="auth-view" class="flex items-center justify-center min-h-screen bg-brand-light">
            <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-lg">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-slate-900">日记本</h1>
                    <p class="text-slate-500">记录你的想法，整理你的生活</p>
                </div>
                <div class="flex border border-gray-200 rounded-md p-1">
                    <button id="show-login-tab" class="w-1/2 p-2 rounded-md text-sm font-medium bg-blue-500 text-white">登录</button>
                    <button id="show-register-tab" class="w-1/2 p-2 rounded-md text-sm font-medium text-gray-600">注册</button>
                </div>
                <form id="login-form" class="space-y-4">
                    <div><label for="login-email" class="text-sm font-medium text-slate-600">邮箱</label><input id="login-email" type="email" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="you@example.com"></div>
                    <div><label for="login-password" class="text-sm font-medium text-slate-600">密码</label><input id="login-password" type="password" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="••••••••"></div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-brand rounded-md hover:bg-brand-dark transition-colors">登录</button>
                </form>
                <form id="register-form" class="hidden space-y-4">
                     <div><label for="register-email" class="text-sm font-medium text-slate-600">邮箱</label><input id="register-email" type="email" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="you@example.com"></div>
                     <div><label for="register-password" class="text-sm font-medium text-slate-600">密码</label><input id="register-password" type="password" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="至少6个字符"></div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-brand rounded-md hover:bg-brand-dark transition-colors">注册</button>
                </form>
            </div>
        </div>

        <!-- 主应用界面 -->
        <div id="main-app-view" class="hidden h-screen w-full flex overflow-hidden">
            <aside id="sidebar" class="w-72 h-full bg-brand-light border-r border-slate-200 flex flex-col flex-shrink-0">
                <div class="p-4 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <div id="user-info" class="flex items-center space-x-2 min-w-0"><span class="w-8 h-8 rounded-full bg-brand flex items-center justify-center text-white font-bold text-sm" id="user-avatar"></span><span class="text-sm font-medium truncate" id="user-email"></span></div>
                        <button id="hide-sidebar-button" class="p-2 rounded-md hover:bg-slate-200"><i data-feather="chevrons-left"></i></button>
                    </div>
                    <button id="logout-button" class="w-full mt-3 px-3 py-1.5 text-xs text-slate-600 bg-slate-200 rounded-md hover:bg-slate-300">退出登录</button>
                </div>
                <div class="p-4 flex space-x-2">
                    <button id="new-folder-button" class="flex-1 flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="folder-plus" class="w-4 h-4 mr-2"></i>新建文件夹</button>
                    <button id="new-article-button" class="flex-1 flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="file-plus" class="w-4 h-4 mr-2"></i>新建文章</button>
                </div>
                <div id="file-tree" class="flex-1 overflow-y-auto p-4 space-y-1"></div>
                 <div class="p-4 border-t border-slate-200">
                    <details class="group">
                        <summary class="flex items-center justify-between cursor-pointer text-sm font-medium text-slate-600 hover:text-slate-800 list-none">
                            <div class="flex items-center">
                                <i data-feather="database" class="w-4 h-4 mr-2"></i>
                                <span>备份与恢复</span>
                            </div>
                            <i data-feather="chevron-down" class="w-4 h-4 transition-transform duration-200 group-open:rotate-180"></i>
                        </summary>
                        <div class="mt-2 space-y-2">
                            <button id="import-button" class="w-full flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="upload" class="w-4 h-4 mr-2"></i>导入备份</button>
                            <button id="export-all-button" class="w-full flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="download" class="w-4 h-4 mr-2"></i>导出备份</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                        </div>
                    </details>
                </div>
            </aside>

            <main id="main-content" class="flex-1 flex flex-col bg-white overflow-hidden">
                <header class="flex items-center justify-between p-2 border-b border-slate-200 bg-white relative flex-shrink-0">
                    <button id="toggle-sidebar-button" class="p-2 rounded-md hover:bg-slate-100 flex-shrink-0"><i data-feather="menu" class="w-6 h-6"></i></button>
                    <div class="flex-1 min-w-0 mx-2 text-center md:text-left"><h2 id="mobile-article-title" class="text-lg font-semibold truncate">日记本</h2></div>
                    <div id="mobile-controls" class="flex items-center flex-shrink-0 md:hidden">
                        <div id="mobile-view-controls" class="hidden items-center space-x-1">
                            <button id="mobile-edit-button" class="p-2 rounded-md hover:bg-slate-100"><i data-feather="edit-2" class="w-5 h-5"></i></button>
                            <button id="mobile-more-button" class="p-2 rounded-md hover:bg-slate-100"><i data-feather="more-vertical" class="w-5 h-5"></i></button>
                        </div>
                        <div id="mobile-edit-controls" class="hidden items-center">
                            <button id="mobile-save-button" class="p-2 rounded-md bg-blue-500 text-white hover:bg-blue-600"><i data-feather="save" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="mobile-actions-menu" class="hidden absolute top-full right-2 mt-1 w-40 bg-white rounded-md shadow-lg border z-40">
                        <a href="#" id="mobile-move-button" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><i data-feather="move" class="w-4 h-4 mr-2"></i>移动</a>
                        <a href="#" id="mobile-export-button" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><i data-feather="download" class="w-4 h-4 mr-2"></i>导出</a>
                        <a href="#" id="mobile-refresh-button" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>同步</a>
                        <a href="#" id="mobile-delete-button" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-100"><i data-feather="trash-2" class="w-4 h-4 mr-2"></i>删除</a>
                    </div>
                </header>
                <div id="welcome-view" class="flex-1 flex flex-col items-center justify-center text-center p-8">
                     <i data-feather="book-open" class="w-16 h-16 text-slate-300 mb-4"></i>
                     <h2 class="text-2xl font-semibold text-slate-800">欢迎使用日记本</h2>
                     <p class="text-slate-500 mt-2">从左侧选择一篇文章开始阅读，或新建一篇文章开始创作。</p>
                </div>
                <div id="article-view" class="hidden flex-1 flex flex-col overflow-hidden">
                    <div class="p-3 border-b border-slate-200 bg-white flex-shrink-0">
                        <input id="article-title-input" class="text-xl font-semibold w-full bg-transparent focus:outline-none focus:ring-0 border-none p-0" value="文章标题">
                        <div id="editor-controls" class="hidden md:flex items-center space-x-2 ml-4 mt-2">
                             <button id="edit-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="edit-2" class="w-4 h-4 mr-1.5"></i>编辑</button>
                             <button id="save-button" class="hidden flex items-center px-3 py-1.5 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600"><i data-feather="save" class="w-4 h-4 mr-1.5"></i>保存</button>
                             <button id="move-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="move" class="w-4 h-4 mr-1.5"></i>移动</button>
                             <button id="export-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="download" class="w-4 h-4 mr-1.5"></i>导出为 TXT</button>
                             <button id="refresh-button" title="同步数据" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="refresh-cw" class="w-4 h-4 mr-1.5"></i>同步</button>
                             <button id="delete-button" class="flex items-center px-3 py-1.5 text-sm text-red-600 bg-red-50 rounded-md hover:bg-red-100"><i data-feather="trash-2" class="w-4 h-4 mr-1.5"></i>删除</button>
                        </div>
                    </div>
                    <div class="flex-1 p-2 md:p-4 overflow-y-auto">
                        <div id="editor-container"></div>
                    </div>
                </div>
            </main>
        </div>
        <div id="toast" class="fixed top-5 right-5 px-4 py-2 rounded-md text-white shadow-lg z-50" style="transform: translateX(150%);"></div>
        <div id="move-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                <h3 class="text-lg font-medium">移动文章到...</h3>
                <select id="move-folder-select" class="w-full mt-4 p-2 border rounded-md"></select>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-move" class="px-4 py-2 bg-gray-200 rounded-md">取消</button>
                    <button id="confirm-move" class="px-4 py-2 bg-blue-500 text-white rounded-md">确认移动</button>
                </div>
            </div>
        </div>
        <div id="creation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 id="creation-modal-title" class="text-lg font-medium">创建</h3>
                <input id="creation-modal-input" type="text" class="w-full mt-4 p-2 border rounded-md" placeholder="请输入名称...">
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-creation" class="px-4 py-2 bg-gray-200 rounded-md">取消</button>
                    <button id="confirm-creation" class="px-4 py-2 bg-blue-500 text-white rounded-md">创建</button>
                </div>
            </div>
        </div>
        <div id="folder-context-menu" class="hidden absolute w-40 bg-white rounded-md shadow-lg border z-40">
            <a href="#" id="rename-folder-btn" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><i data-feather="edit-2" class="w-4 h-4 mr-2"></i>重命名</a>
            <a href="#" id="delete-folder-btn" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-100"><i data-feather="trash-2" class="w-4 h-4 mr-2"></i>删除</a>
        </div>
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 id="confirm-modal-title" class="text-lg font-medium">请确认</h3>
                <p id="confirm-modal-text" class="text-sm text-slate-500 mt-2">您确定要继续吗？</p>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="confirm-modal-cancel" class="px-4 py-2 bg-gray-200 rounded-md">取消</button>
                    <button id="confirm-modal-ok" class="px-4 py-2 bg-blue-500 text-white rounded-md">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let state = { user: null, folders: [], articles: [], selectedArticleId: null, openedArticleTimestamp: null, isEditing: false, ui: { isSidebarCollapsed: false, expandedFolders: new Set(), activeFolderMenuId: null, creationType: null } };
        let quill;
        let toastTimeout;

        const dom = {
            authView: document.getElementById('auth-view'), mainAppView: document.getElementById('main-app-view'),
            loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'),
            showLoginTab: document.getElementById('show-login-tab'), showRegisterTab: document.getElementById('show-register-tab'),
            sidebar: document.getElementById('sidebar'), hideSidebarButton: document.getElementById('hide-sidebar-button'), sidebarOverlay: document.getElementById('sidebar-overlay'),
            toggleSidebarButton: document.getElementById('toggle-sidebar-button'), userAvatar: document.getElementById('user-avatar'),
            userEmail: document.getElementById('user-email'), logoutButton: document.getElementById('logout-button'),
            newFolderButton: document.getElementById('new-folder-button'), newArticleButton: document.getElementById('new-article-button'),
            fileTree: document.getElementById('file-tree'), welcomeView: document.getElementById('welcome-view'),
            articleView: document.getElementById('article-view'), articleTitleInput: document.getElementById('article-title-input'),
            mobileArticleTitle: document.getElementById('mobile-article-title'), editorContainer: document.getElementById('editor-container'),
            editorControls: document.getElementById('editor-controls'), editButton: document.getElementById('edit-button'),
            saveButton: document.getElementById('save-button'), moveButton: document.getElementById('move-button'),
            exportButton: document.getElementById('export-button'), refreshButton: document.getElementById('refresh-button'), deleteButton: document.getElementById('delete-button'),
            mobileControls: document.getElementById('mobile-controls'), mobileViewControls: document.getElementById('mobile-view-controls'),
            mobileEditControls: document.getElementById('mobile-edit-controls'), mobileEditButton: document.getElementById('mobile-edit-button'),
            mobileSaveButton: document.getElementById('mobile-save-button'), mobileMoreButton: document.getElementById('mobile-more-button'),
            mobileActionsMenu: document.getElementById('mobile-actions-menu'), mobileMoveButton: document.getElementById('mobile-move-button'),
            mobileExportButton: document.getElementById('mobile-export-button'), mobileRefreshButton: document.getElementById('mobile-refresh-button'), mobileDeleteButton: document.getElementById('mobile-delete-button'),
            toast: document.getElementById('toast'),
            moveModal: document.getElementById('move-modal'), moveFolderSelect: document.getElementById('move-folder-select'),
            cancelMove: document.getElementById('cancel-move'), confirmMove: document.getElementById('confirm-move'),
            folderContextMenu: document.getElementById('folder-context-menu'), renameFolderBtn: document.getElementById('rename-folder-btn'),
            deleteFolderBtn: document.getElementById('delete-folder-btn'),
            creationModal: document.getElementById('creation-modal'), creationModalTitle: document.getElementById('creation-modal-title'),
            creationModalInput: document.getElementById('creation-modal-input'), cancelCreation: document.getElementById('cancel-creation'),
            confirmCreation: document.getElementById('confirm-creation'),
            importButton: document.getElementById('import-button'), exportAllButton: document.getElementById('export-all-button'),
            importFileInput: document.getElementById('import-file-input'),
            confirmModal: document.getElementById('confirm-modal'), confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalText: document.getElementById('confirm-modal-text'), confirmModalCancel: document.getElementById('confirm-modal-cancel'),
            confirmModalOk: document.getElementById('confirm-modal-ok'),
        };

        function showToast(message, type = 'success') { clearTimeout(toastTimeout); dom.toast.textContent = message; dom.toast.className = `fixed top-5 right-5 px-4 py-2 rounded-md text-white shadow-lg z-50 transition-transform transform-gpu ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`; requestAnimationFrame(() => { dom.toast.style.transform = 'translateX(0)'; }); toastTimeout = setTimeout(() => { dom.toast.style.transform = 'translateX(150%)'; }, 3000); }
        function formatDate(d) { return new Date(d).toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }); }
        
        async function handleLogin(e) { e.preventDefault(); const d = { email: dom.loginForm.querySelector('#login-email').value, password: dom.loginForm.querySelector('#login-password').value }; const { error } = await supabase.auth.signInWithPassword(d); if (error) showToast(`登录失败: ${error.message}`, 'error'); else showToast('登录成功！'); }
        async function handleRegister(e) { e.preventDefault(); const d = { email: dom.registerForm.querySelector('#register-email').value, password: dom.registerForm.querySelector('#register-password').value }; if (d.password.length < 6) { showToast('密码长度至少为6位', 'error'); return; } const { error } = await supabase.auth.signUp(d); if (error) showToast(`注册失败: ${error.message}`, 'error'); else showToast('注册成功！请检查您的邮箱进行验证。'); }
        async function handleLogout() { const { error } = await supabase.auth.signOut(); if (error) showToast(`退出失败: ${error.message}`, 'error'); else window.location.reload(); }

        async function fetchData() {
            if (!state.user) return;
            try {
                const { data: folders, error: fe } = await supabase.from('folders').select('*').eq('user_id', state.user.id).order('created_at', { ascending: false });
                if (fe) throw fe;
                const { data: articles, error: ae } = await supabase.from('articles').select('*').eq('user_id', state.user.id).order('updated_at', { ascending: false });
                if (ae) throw ae;
                state.folders = folders || []; state.articles = articles || [];
                renderFileTree();
            } catch (error) { showToast(`数据加载失败: ${error.message}`, 'error'); }
        }
        
        function renderFileTree() {
            dom.fileTree.innerHTML = ''; const fm = new Map(); state.folders.forEach(f => fm.set(f.id, { ...f, articles: [] }));
            const ua = []; state.articles.forEach(a => { if (a.folder_id && fm.has(a.folder_id)) fm.get(a.folder_id).articles.push(a); else ua.push(a); });
            fm.forEach((f) => { const exp = state.ui.expandedFolders.has(f.id); const el = document.createElement('div'); el.innerHTML = `<div class="folder-header flex items-center justify-between p-2 rounded-md group hover:bg-slate-200 cursor-pointer" data-folder-id="${f.id}"><div class="flex items-center flex-1 min-w-0"><i data-feather="chevron-down" class="folder-toggle-icon w-4 h-4 mr-1 text-slate-500 shrink-0 ${!exp ? 'collapsed' : ''}"></i><i data-feather="folder" class="w-4 h-4 mr-2 text-brand shrink-0"></i><span class="font-semibold text-sm truncate">${f.name}</span></div><button class="folder-menu-btn p-1 hover:bg-slate-300 rounded opacity-0 group-hover:opacity-100" data-id="${f.id}"><i data-feather="more-vertical" class="w-4 h-4"></i></button></div><ul class="article-list pl-4 mt-1 space-y-1 ${!exp ? 'hidden' : ''}">${f.articles.map(a => `<li class="article-item text-sm text-slate-600 p-2 rounded-md cursor-pointer hover:bg-slate-200 ${a.id === state.selectedArticleId ? 'bg-blue-100' : ''}" data-id="${a.id}"><div class="truncate">${a.title}</div><div class="text-xs text-slate-400 mt-0.5">${formatDate(a.updated_at)}</div></li>`).join('')}</ul>`; dom.fileTree.appendChild(el); });
            if (ua.length > 0) { const el = document.createElement('div'); el.innerHTML = `<div class="mt-4"><h4 class="text-sm font-semibold text-slate-500 p-2">未分类</h4><ul class="mt-1 space-y-1">${ua.map(a => `<li class="article-item text-sm text-slate-600 p-2 rounded-md cursor-pointer hover:bg-slate-200 ${a.id === state.selectedArticleId ? 'bg-blue-100' : ''}" data-id="${a.id}"><div class="truncate">${a.title}</div><div class="text-xs text-slate-400 mt-0.5">${formatDate(a.updated_at)}</div></li>`).join('')}</ul></div>`; dom.fileTree.appendChild(el); }
            feather.replace();
        }

        function openCreationModal(type) { state.ui.creationType = type; dom.creationModalTitle.textContent = type === 'folder' ? '创建新文件夹' : '创建新文章'; dom.creationModalInput.value = ''; dom.creationModalInput.placeholder = type === 'folder' ? '请输入文件夹名称...' : '请输入文章标题...'; dom.creationModal.classList.remove('hidden'); dom.creationModalInput.focus(); }
        async function handleConfirmCreation() { const type = state.ui.creationType; const name = dom.creationModalInput.value.trim(); if (!name) { showToast('名称不能为空', 'error'); return; } dom.creationModal.classList.add('hidden'); if (type === 'folder') { const { error } = await supabase.from('folders').insert({ name: name, user_id: state.user.id }); if (error) { showToast(`创建文件夹失败: ${error.message}`, 'error'); } else { showToast('文件夹创建成功！'); fetchData(); } } else if (type === 'article') { const { data, error } = await supabase.from('articles').insert({ title: name, content: '', user_id: state.user.id }).select(); if (error) { showToast(`创建文章失败: ${error.message}`, 'error'); } else { showToast('文章创建成功！'); await fetchData(); selectArticle(data[0].id, true); } } }
        function handleNewFolder() { openCreationModal('folder'); }
        function handleNewArticle() { openCreationModal('article'); }
        async function handleRenameFolder(id) { const f = state.folders.find(i => i.id === id); if (!f) return; const n = prompt('请输入新的文件夹名称:', f.name); if (n && n.trim() && n !== f.name) { const { error } = await supabase.from('folders').update({ name: n.trim() }).eq('id', id); if(error) showToast(`重命名失败: ${error.message}`, 'error'); else { showToast('文件夹已重命名'); fetchData(); } } }
        
        function handleToggleFolder(id) { if (state.ui.expandedFolders.has(id)) state.ui.expandedFolders.delete(id); else state.ui.expandedFolders.add(id); renderFileTree(); }
        
        function selectArticle(id, startInEditMode = false, ignoreDraft = false) {
            if (state.isEditing && state.selectedArticleId && state.selectedArticleId !== id) {
                 saveDraftToLocalStorage();
            }
            state.selectedArticleId = id;
            const article = state.articles.find(a => a.id === id);
            if (!article) { switchToWelcomeView(); return; }
            state.openedArticleTimestamp = article.updated_at;
            
            dom.welcomeView.classList.add('hidden');
            dom.articleView.classList.remove('hidden');
            dom.articleView.classList.add('flex');
            dom.articleTitleInput.value = article.title;
            dom.mobileArticleTitle.textContent = article.title;
            
            const draft = loadDraftFromLocalStorage(id);

            if (ignoreDraft) {
                clearDraftFromLocalStorage(id);
                quill.root.innerHTML = article.content || '';
                switchToViewMode();
            } else if (draft) {
                dom.articleTitleInput.value = draft.title;
                quill.root.innerHTML = draft.content;
                switchToEditMode();
            } else {
                quill.root.innerHTML = article.content || '';
                if (startInEditMode) {
                    switchToEditMode();
                } else {
                    switchToViewMode();
                }
            }
            
            renderFileTree();
            if (window.innerWidth < 768) {
                toggleSidebar('hide');
            }
        }

        function switchToEditMode() { state.isEditing = true; quill.enable(true); dom.editButton.classList.add('hidden'); dom.saveButton.classList.remove('hidden'); dom.mobileViewControls.classList.add('hidden'); dom.mobileEditControls.classList.remove('hidden'); dom.mobileEditControls.classList.add('flex'); dom.articleTitleInput.readOnly = false; dom.articleTitleInput.classList.add('bg-slate-100'); quill.focus(); }
        function switchToViewMode() { state.isEditing = false; quill.enable(false); dom.editButton.classList.remove('hidden'); dom.saveButton.classList.add('hidden'); dom.mobileViewControls.classList.remove('hidden'); dom.mobileViewControls.classList.add('flex'); dom.mobileEditControls.classList.add('hidden'); dom.articleTitleInput.readOnly = true; dom.articleTitleInput.classList.remove('bg-slate-100'); if (!state.selectedArticleId) dom.mobileViewControls.classList.add('hidden'); }
        function switchToWelcomeView() { state.selectedArticleId = null; dom.articleView.classList.add('hidden'); dom.welcomeView.classList.remove('hidden'); dom.mobileArticleTitle.textContent = '日记本'; dom.mobileViewControls.classList.add('hidden'); dom.mobileEditControls.classList.add('hidden'); renderFileTree(); }
        
        async function handleSaveArticle() { 
            if (!state.selectedArticleId) return;

            const { data: serverArticle, error: fetchError } = await supabase.from('articles').select('updated_at').eq('id', state.selectedArticleId).single();
            if (fetchError) { showToast('检查文章状态失败', 'error'); return; }

            if (state.openedArticleTimestamp && new Date(serverArticle.updated_at) > new Date(state.openedArticleTimestamp)) {
                const userChoice = await showConfirmation({
                    title: '内容冲突',
                    text: '此笔记已在别处更新。请选择如何处理您的当前修改。',
                    okText: '复制并更新',
                    cancelText: '继续编辑'
                });

                if (userChoice) { 
                    navigator.clipboard.writeText(quill.getText());
                    showToast('当前草稿已复制到剪贴板。');
                    await fetchData();
                    selectArticle(state.selectedArticleId, false, true);
                }
                return;
            }

            const t = dom.articleTitleInput.value.trim(); 
            const c = quill.root.innerHTML; 
            if (!t) { showToast('标题不能为空', 'error'); return; } 
            
            const { data: updatedArticle, error } = await supabase.from('articles').update({ title: t, content: c, updated_at: new Date().toISOString() }).eq('id', state.selectedArticleId).select().single();
            
            if (error) { showToast(`保存失败: ${error.message}`, 'error'); } 
            else { 
                showToast('保存成功！'); 
                state.openedArticleTimestamp = updatedArticle.updated_at;
                clearDraftFromLocalStorage(state.selectedArticleId); 
                await fetchData(); 
                dom.mobileArticleTitle.textContent = t; 
                switchToViewMode(); 
            } 
        }

        async function handleDeleteArticle() { if (!state.selectedArticleId) return; if(await showConfirmation({ title: '删除文章', text: '确定要删除这篇文章吗？此操作不可撤销。', okText: '删除', cancelText: '取消' })) { clearDraftFromLocalStorage(state.selectedArticleId); const { error } = await supabase.from('articles').delete().eq('id', state.selectedArticleId); if (error) showToast(`删除失败: ${error.message}`, 'error'); else { showToast('文章已删除'); switchToWelcomeView(); fetchData(); } } }
        async function handleDeleteFolder(id) { if(await showConfirmation({ title: '删除文件夹', text: '确定要删除这个文件夹吗？其内的所有文章也将被删除！', okText: '删除', cancelText: '取消' })) { const { error } = await supabase.from('folders').delete().eq('id', id); if (error) showToast(`删除失败: ${error.message}`, 'error'); else { showToast('文件夹已删除'); if(state.selectedArticleId && state.articles.find(a => a.id === state.selectedArticleId)?.folder_id === id) switchToWelcomeView(); fetchData(); } } }
        
        function handleExportArticle() { if (!state.selectedArticleId) return; const a = state.articles.find(i => i.id === state.selectedArticleId); if (!a) return; const t = quill.getText(); const b = new Blob([t], { type: 'text/plain;charset=utf-8' }); const u = URL.createObjectURL(b); const l = document.createElement('a'); l.href = u; l.download = `${a.title}.txt`; document.body.appendChild(l); l.click(); document.body.removeChild(l); URL.revokeObjectURL(u); }
        function openMoveModal() { if(!state.selectedArticleId) return; dom.moveFolderSelect.innerHTML = '<option value="">未分类</option>'; state.folders.forEach(f => { const o = document.createElement('option'); o.value = f.id; o.textContent = f.name; dom.moveFolderSelect.appendChild(o); }); const a = state.articles.find(i => i.id === state.selectedArticleId); dom.moveFolderSelect.value = a.folder_id || ""; dom.moveModal.classList.remove('hidden'); }
        async function handleConfirmMove() { const id = dom.moveFolderSelect.value || null; const { error } = await supabase.from('articles').update({ folder_id: id }).eq('id', state.selectedArticleId); if(error) showToast(`移动失败: ${error.message}`, 'error'); else { showToast('文章已移动'); fetchData(); } dom.moveModal.classList.add('hidden'); }
        
        function saveDraftToLocalStorage() { if (!state.isEditing || !state.selectedArticleId) return; const draft = { title: dom.articleTitleInput.value, content: quill.root.innerHTML }; localStorage.setItem(`diary-draft-${state.selectedArticleId}`, JSON.stringify(draft)); }
        function loadDraftFromLocalStorage(id) { const data = localStorage.getItem(`diary-draft-${id}`); return data ? JSON.parse(data) : null; }
        function clearDraftFromLocalStorage(id) { localStorage.removeItem(`diary-draft-${id}`); }

        function handleExportAll() { const data = JSON.stringify({ folders: state.folders, articles: state.articles }); const blob = new Blob([data], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date().toISOString().slice(0, 10); a.download = `diary-backup-${date}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('备份已导出！'); }
        async function handleImportAll(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const data = JSON.parse(event.target.result); if (!data.folders || !data.articles) throw new Error('无效的备份文件格式。'); if (await showConfirmation({ title: '导入备份', text: '警告：这将用导入的数据覆盖您云端的所有笔记和文件夹。此操作不可撤销。您确定要继续吗？', okText: '确认导入', cancelText: '取消' })) { showToast('正在清空云端数据...'); await supabase.from('articles').delete().eq('user_id', state.user.id); await supabase.from('folders').delete().eq('user_id', state.user.id); showToast('正在导入新数据...'); const folderUploads = data.folders.map(f => ({...f, user_id: state.user.id})); const articleUploads = data.articles.map(a => ({...a, user_id: state.user.id})); const { error: folderError } = await supabase.from('folders').insert(folderUploads); if(folderError) throw folderError; const { error: articleError } = await supabase.from('articles').insert(articleUploads); if(articleError) throw articleError; showToast('数据导入成功！'); await fetchData(); } } catch(error) { showToast(`导入失败: ${error.message}`, 'error'); } finally { dom.importFileInput.value = ''; } }; reader.readAsText(file); }
        
        function showConfirmation({ title, text, okText, cancelText }) {
            return new Promise(resolve => {
                dom.confirmModalTitle.textContent = title;
                dom.confirmModalText.textContent = text;
                dom.confirmModalOk.textContent = okText;
                dom.confirmModalCancel.textContent = cancelText;
                dom.confirmModal.classList.remove('hidden');

                const cleanup = () => {
                    dom.confirmModal.classList.add('hidden');
                    dom.confirmModalOk.onclick = null;
                    dom.confirmModalCancel.onclick = null;
                };

                dom.confirmModalOk.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                dom.confirmModalCancel.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }

        function toggleSidebar(forceState) {
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                const isHidden = dom.sidebar.classList.contains('-translate-x-full');
                if (isHidden) {
                    dom.sidebar.classList.remove('-translate-x-full');
                    dom.sidebarOverlay.classList.remove('hidden');
                } else {
                    dom.sidebar.classList.add('-translate-x-full');
                    dom.sidebarOverlay.classList.add('hidden');
                }
            } else {
                const shouldBeCollapsed = forceState ? forceState === 'hide' : !state.ui.isSidebarCollapsed;
                state.ui.isSidebarCollapsed = shouldBeCollapsed;
                dom.mainAppView.classList.toggle('sidebar-collapsed', shouldBeCollapsed);
                localStorage.setItem('sidebarCollapsed', shouldBeCollapsed ? 'true' : 'false');
            }
        }

        function initEventListeners() {
            dom.loginForm.addEventListener('submit', handleLogin); dom.registerForm.addEventListener('submit', handleRegister);
            dom.showLoginTab.addEventListener('click', () => { dom.loginForm.classList.remove('hidden'); dom.registerForm.classList.add('hidden'); dom.showLoginTab.classList.add('bg-blue-500', 'text-white'); dom.showRegisterTab.classList.remove('bg-blue-500', 'text-white'); });
            dom.showRegisterTab.addEventListener('click', () => { dom.registerForm.classList.remove('hidden'); dom.loginForm.classList.add('hidden'); dom.showRegisterTab.classList.add('bg-blue-500', 'text-white'); dom.showLoginTab.classList.remove('bg-blue-500', 'text-white'); });
            const refreshAction = async () => {
                showToast('正在同步数据...');
                const prevId = state.selectedArticleId;
                const isCurrentlyEditing = state.isEditing;
                await fetchData();
                if (prevId && state.articles.some(a => a.id === prevId)) {
                    if (!isCurrentlyEditing) {
                        const newArticleData = state.articles.find(a => a.id === prevId);
                        if (newArticleData) {
                            quill.root.innerHTML = newArticleData.content || '';
                            state.openedArticleTimestamp = newArticleData.updated_at;
                        }
                    }
                }
                showToast('数据同步完成！');
            };

            dom.logoutButton.addEventListener('click', handleLogout); dom.newFolderButton.addEventListener('click', handleNewFolder); dom.newArticleButton.addEventListener('click', handleNewArticle);
            dom.fileTree.addEventListener('click', e => { const ai = e.target.closest('.article-item'), fmb = e.target.closest('.folder-menu-btn'), fh = e.target.closest('.folder-header'); if (fmb) { e.stopPropagation(); state.ui.activeFolderMenuId = fmb.dataset.id; const rect = fmb.getBoundingClientRect(); dom.folderContextMenu.style.top = `${rect.bottom}px`; dom.folderContextMenu.style.left = `${rect.left}px`; dom.folderContextMenu.classList.remove('hidden'); } else if (ai) { selectArticle(ai.dataset.id); } else if (fh) { handleToggleFolder(fh.dataset.folderId); } });
            dom.renameFolderBtn.addEventListener('click', () => { handleRenameFolder(state.ui.activeFolderMenuId); dom.folderContextMenu.classList.add('hidden'); });
            dom.deleteFolderBtn.addEventListener('click', () => { handleDeleteFolder(state.ui.activeFolderMenuId); dom.folderContextMenu.classList.add('hidden'); });
            dom.cancelCreation.addEventListener('click', () => dom.creationModal.classList.add('hidden')); dom.confirmCreation.addEventListener('click', handleConfirmCreation); dom.creationModalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleConfirmCreation(); });
            dom.refreshButton.addEventListener('click', refreshAction); dom.exportAllButton.addEventListener('click', handleExportAll); dom.importButton.addEventListener('click', () => dom.importFileInput.click()); dom.importFileInput.addEventListener('change', handleImportAll);
            dom.mobileRefreshButton.addEventListener('click', () => { refreshAction(); dom.mobileActionsMenu.classList.add('hidden'); });
            dom.editButton.addEventListener('click', switchToEditMode); dom.saveButton.addEventListener('click', handleSaveArticle); dom.deleteButton.addEventListener('click', handleDeleteArticle); dom.exportButton.addEventListener('click', handleExportArticle); dom.moveButton.addEventListener('click', openMoveModal);
            dom.mobileEditButton.addEventListener('click', switchToEditMode); dom.mobileSaveButton.addEventListener('click', handleSaveArticle); dom.mobileMoreButton.addEventListener('click', (e) => { e.stopPropagation(); dom.mobileActionsMenu.classList.toggle('hidden'); });
            dom.mobileMoveButton.addEventListener('click', () => { openMoveModal(); dom.mobileActionsMenu.classList.add('hidden'); }); dom.mobileExportButton.addEventListener('click', () => { handleExportArticle(); dom.mobileActionsMenu.classList.add('hidden'); }); dom.mobileDeleteButton.addEventListener('click', () => { handleDeleteArticle(); dom.mobileActionsMenu.classList.add('hidden'); });
            dom.cancelMove.addEventListener('click', () => dom.moveModal.classList.add('hidden')); dom.confirmMove.addEventListener('click', handleConfirmMove);
            dom.toggleSidebarButton.addEventListener('click', () => toggleSidebar()); 
            dom.hideSidebarButton.addEventListener('click', () => toggleSidebar('hide'));
            dom.sidebarOverlay.addEventListener('click', () => toggleSidebar('hide'));
            document.addEventListener('click', (e) => { 
                if(!dom.mobileMoreButton.contains(e.target) && !dom.mobileActionsMenu.contains(e.target)) {
                    dom.mobileActionsMenu.classList.add('hidden');
                }
                if(!e.target.closest('.folder-menu-btn')) {
                    dom.folderContextMenu.classList.add('hidden');
                }
            });
        }
        
        async function initializeApp() {
            feather.replace(); initEventListeners();
            const toolbarOptions = [
                [{ 'header': [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['blockquote', 'code-block'],
                ['clean']
            ];
            quill = new Quill('#editor-container', { modules: { toolbar: toolbarOptions }, theme: 'snow' });
            quill.on('text-change', () => saveDraftToLocalStorage());
            dom.articleTitleInput.addEventListener('input', () => saveDraftToLocalStorage());
            
            if (localStorage.getItem('sidebarCollapsed') === 'true' && window.innerWidth >= 768) {
                toggleSidebar('hide');
            } else if (window.innerWidth < 768) {
                toggleSidebar('hide');
            }

            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                state.user = session.user;
                dom.authView.classList.add('hidden'); dom.mainAppView.classList.remove('hidden'); 
                dom.userEmail.textContent = state.user.email; dom.userAvatar.textContent = state.user.email[0].toUpperCase();
                await fetchData();
                if (state.articles.length > 0) selectArticle(state.articles[0].id);
                else { switchToWelcomeView(); quill.enable(false); }
            } else {
                switchToWelcomeView(); quill.enable(false);
                dom.authView.classList.remove('hidden'); dom.mainAppView.classList.add('hidden');
            }
            supabase.auth.onAuthStateChange((_, session) => {
                const userJustLoggedIn = _ === 'SIGNED_IN' && state.user?.id !== session?.user?.id;
                const userJustLoggedOut = _ === 'SIGNED_OUT';
                if (userJustLoggedIn || userJustLoggedOut) {
                    window.location.reload();
                }
            });
        }
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>

