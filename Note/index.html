<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>笔记</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📓</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/quill/2.0.0-rc.2/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/quill/2.0.0-rc.2/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/feather-icons/4.29.1/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': { 'light': '#f0f4f8', 'DEFAULT': '#3b82f6', 'dark': '#1e40af' }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #c4c4c4; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        #sidebar { transition: margin-left 0.3s ease-in-out; }
        #main-app-view.sidebar-collapsed #sidebar { margin-left: -18rem; }
        .folder-toggle-icon.collapsed { transform: rotate(-90deg); }
        .folder-toggle-icon { transition: transform 0.2s ease-in-out; }
        #editor-container { height: 100%; min-height: 60vh; }
        .ql-editor { font-size: 16px; line-height: 1.6; }
        .ql-toolbar.ql-snow { border-radius: 8px 8px 0 0; }
        .ql-container.ql-snow { border-radius: 0 0 8px 8px; height: calc(100% - 42px); }
        #toast { transition: transform 0.3s ease-in-out; }
        summary::-webkit-details-marker { display: none; }
        .editor-drag-over { border: 2px dashed #3b82f6 !important; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        
        #pdf-viewer-container { flex-grow: 1; overflow-y: auto; background-color: #f8f9fa; }
        #pdf-viewer { display: flex; flex-direction: column; align-items: center; padding: 20px 0; }
        #pdf-viewer canvas { max-width: 100%; height: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    </style>
</head>
<body class="bg-white antialiased text-slate-800">
    <div id="app" class="relative min-h-screen">
        <div id="auth-view" class="flex items-center justify-center min-h-screen bg-brand-light">
            <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-lg">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-slate-900">笔记</h1>
                    <p class="text-slate-500">记录你的想法，整理你的生活</p>
                </div>
                <div class="flex border border-gray-200 rounded-md p-1">
                    <button id="show-login-tab" class="w-1/2 p-2 rounded-md text-sm font-medium bg-blue-500 text-white">登录</button>
                    <button id="show-register-tab" class="w-1/2 p-2 rounded-md text-sm font-medium text-gray-600">注册</button>
                </div>
                <form id="login-form" class="space-y-4">
                    <div><label for="login-email" class="text-sm font-medium text-slate-600">邮箱</label><input id="login-email" type="email" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="you@example.com"></div>
                    <div><label for="login-password" class="text-sm font-medium text-slate-600">密码</label><input id="login-password" type="password" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="••••••••"></div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-brand rounded-md hover:bg-brand-dark transition-colors">登录</button>
                </form>
                <form id="register-form" class="hidden space-y-4">
                     <div><label for="register-email" class="text-sm font-medium text-slate-600">邮箱</label><input id="register-email" type="email" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="you@example.com"></div>
                     <div><label for="register-password" class="text-sm font-medium text-slate-600">密码</label><input id="register-password" type="password" required class="w-full px-3 py-2 mt-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="至少6个字符"></div>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-brand rounded-md hover:bg-brand-dark transition-colors">注册</button>
                </form>
            </div>
        </div>

        <div id="main-app-view" class="hidden h-screen w-full flex overflow-hidden">
             <aside id="sidebar" class="w-72 h-full bg-brand-light border-r border-slate-200 flex flex-col flex-shrink-0 fixed md:static inset-y-0 left-0 z-40 transform transition-transform -translate-x-full md:translate-x-0">
                <div class="p-4 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <div id="user-info" class="flex items-center space-x-2 min-w-0"><span class="w-8 h-8 rounded-full bg-brand flex items-center justify-center text-white font-bold text-sm" id="user-avatar"></span><span class="text-sm font-medium truncate" id="user-email"></span></div>
                        <button id="hide-sidebar-button" class="p-2 rounded-md hover:bg-slate-200"><i data-feather="chevrons-left"></i></button>
                    </div>
                    <button id="logout-button" class="w-full mt-3 px-3 py-1.5 text-xs text-slate-600 bg-slate-200 rounded-md hover:bg-slate-300">退出登录</button>
                </div>
                <div class="p-4 flex space-x-2">
                    <button id="new-folder-button" class="flex-1 flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="folder-plus" class="w-4 h-4 mr-2"></i>新建文件夹</button>
                    <button id="new-article-button" class="flex-1 flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="file-plus" class="w-4 h-4 mr-2"></i>新建文章</button>
                </div>
                <div id="file-tree" class="flex-1 overflow-y-auto p-4 space-y-1"></div>
                 <div class="p-4 border-t border-slate-200">
                    <details class="group">
                        <summary class="flex items-center justify-between cursor-pointer text-sm font-medium text-slate-600 hover:text-slate-800 list-none">
                            <div class="flex items-center">
                                <i data-feather="database" class="w-4 h-4 mr-2"></i>
                                <span>数据管理</span>
                            </div>
                            <i data-feather="chevron-down" class="w-4 h-4 transition-transform duration-200 group-open:rotate-180"></i>
                        </summary>
                        <div class="mt-2 space-y-2">
                            <button id="import-pdf-button" class="w-full flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="file-text" class="w-4 h-4 mr-2"></i>导入PDF</button>
                            <input type="file" id="import-pdf-input" class="hidden" accept=".pdf">
                            <button id="import-button" class="w-full flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="upload" class="w-4 h-4 mr-2"></i>导入备份</button>
                            <button id="export-all-button" class="w-full flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50"><i data-feather="download" class="w-4 h-4 mr-2"></i>导出备份</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                        </div>
                    </details>
                </div>
            </aside>

            <div id="sidebar-overlay" class="fixed inset-0 bg-black/40 z-30 hidden md:hidden"></div>

            <main id="main-content" class="flex-1 flex flex-col bg-white overflow-hidden">
                <header class="flex items-center justify-between p-2 border-b border-slate-200 bg-white relative flex-shrink-0">
                    <div class="flex items-center flex-1 min-w-0">
                        <button id="toggle-sidebar-button" class="p-2 rounded-md hover:bg-slate-100 flex-shrink-0"><i data-feather="menu" class="w-6 h-6"></i></button>
                        <h2 id="article-main-title" class="text-lg font-semibold truncate ml-2">笔记</h2>
                    </div>

                    <div id="header-pdf-controls" class="hidden items-center space-x-4">
                        <button id="pdf-prev-page" class="p-2 rounded-md hover:bg-slate-200"><i data-feather="arrow-left"></i></button>
                        <span>第 <span id="pdf-current-page"></span> / <span id="pdf-total-pages"></span> 页</span>
                        <button id="pdf-next-page" class="p-2 rounded-md hover:bg-slate-200"><i data-feather="arrow-right"></i></button>
                    </div>

                    <div class="flex items-center flex-1 justify-end">
                        <div id="article-actions" class="hidden md:flex items-center space-x-2">
                            <button id="global-move-button" title="移动文章" class="flex items-center p-2 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="move" class="w-4 h-4"></i></button>
                        </div>
                        <div id="mobile-controls" class="flex items-center flex-shrink-0 md:hidden">
                            <div id="mobile-view-controls" class="hidden items-center space-x-1">
                                <button id="mobile-edit-button" class="p-2 rounded-md hover:bg-slate-100"><i data-feather="edit-2" class="w-5 h-5"></i></button>
                                <button id="mobile-more-button" class="p-2 rounded-md hover:bg-slate-100"><i data-feather="more-vertical" class="w-5 h-5"></i></button>
                            </div>
                            <div id="mobile-edit-controls" class="hidden items-center">
                                <button id="mobile-save-button" class="p-2 rounded-md bg-blue-500 text-white hover:bg-blue-600"><i data-feather="save" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                        <div id="mobile-actions-menu" class="hidden absolute top-full right-2 mt-1 w-48 bg-white rounded-md shadow-lg border z-40">
                            <a href="#" id="mobile-move-button" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><i data-feather="move" class="w-4 h-4 mr-2"></i>移动</a>
                            <a href="#" id="mobile-force-reload-button" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><i data-feather="zap-off" class="w-4 h-4 mr-2"></i>忽略草稿并重载</a>
                            <a href="#" id="mobile-export-button" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><i data-feather="download" class="w-4 h-4 mr-2"></i>导出</a>
                            <a href="#" id="mobile-refresh-button" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>同步</a>
                        </div>
                    </div>
                </header>
                <div id="welcome-view" class="flex-1 flex flex-col items-center justify-center text-center p-8">
                     <i data-feather="book-open" class="w-16 h-16 text-slate-300 mb-4"></i>
                     <h2 class="text-2xl font-semibold text-slate-800">欢迎使用笔记</h2>
                     <p class="text-slate-500 mt-2">从左侧选择一篇文章开始阅读，或新建/导入一篇文章。</p>
                </div>
                
                <div id="article-view" class="hidden flex-1 flex flex-col overflow-hidden">
                    <div id="richtext-editor-view" class="hidden flex-1 flex-col overflow-hidden">
                        <div class="p-3 border-b border-slate-200 bg-white flex-shrink-0">
                            <div id="editor-controls" class="hidden md:flex items-center space-x-2">
                                 <button id="edit-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="edit-2" class="w-4 h-4 mr-1.5"></i>编辑</button>
                                 <button id="save-button" class="hidden flex items-center px-3 py-1.5 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600"><i data-feather="save" class="w-4 h-4 mr-1.5"></i>保存</button>
                                 <div class="relative inline-block text-left">
                                    <button id="export-dropdown-button" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="download" class="w-4 h-4 mr-1.5"></i>导出</button>
                                    <div id="export-options" class="hidden origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                        <a href="#" id="export-txt-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出为 TXT</a>
                                        <a href="#" id="export-pdf-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出为 PDF</a>
                                    </div>
                                 </div>
                                 <button id="refresh-button" title="同步数据" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="refresh-cw" class="w-4 h-4 mr-1.5"></i>同步</button>
                                 <button id="force-reload-button" title="忽略本地草稿，从云端重新加载" class="flex items-center px-3 py-1.5 text-sm bg-slate-100 rounded-md hover:bg-slate-200"><i data-feather="zap-off" class="w-4 h-4 mr-1.5"></i>强制重载</button>
                            </div>
                        </div>
                        <div class="flex-1 p-2 md:p-4 overflow-y-auto">
                            <div id="editor-container"></div>
                        </div>
                    </div>

                    <div id="pdf-reader-view" class="hidden flex-1 flex-col overflow-hidden items-center p-4">
                        <div id="pdf-viewer-container" class="w-full">
                            <div id="pdf-viewer"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        <div id="toast" class="fixed top-5 right-5 px-4 py-2 rounded-md text-white shadow-lg z-50" style="transform: translateX(150%);"></div>
        
        <div id="move-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div class="w-full max-w-md bg-white rounded-lg p-4 space-y-3">
              <h3 class="text-lg font-semibold">移动文章</h3>
              <select id="move-folder-select" class="w-full px-3 py-2 border rounded"></select>
              <div class="flex justify-end space-x-2">
                <button id="cancel-move" class="px-3 py-1.5 rounded bg-slate-100">取消</button>
                <button id="confirm-move" class="px-3 py-1.5 rounded bg-blue-500 text-white">确定</button>
              </div>
            </div>
        </div>
        <div id="creation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div class="w-full max-w-md bg-white rounded-lg p-4 space-y-3">
              <h3 id="creation-modal-title" class="text-lg font-semibold"></h3>
              <input id="creation-modal-input" class="w-full px-3 py-2 border rounded" placeholder="">
              <div class="flex justify-end space-x-2">
                <button id="cancel-creation" class="px-3 py-1.5 rounded bg-slate-100">取消</button>
                <button id="confirm-creation" class="px-3 py-1.5 rounded bg-blue-500 text-white">确定</button>
              </div>
            </div>
        </div>
        <div id="rename-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div class="w-full max-w-md bg-white rounded-lg p-4 space-y-3">
              <h3 id="rename-modal-title" class="text-lg font-semibold"></h3>
              <input id="rename-modal-input" class="w-full px-3 py-2 border rounded">
              <div class="flex justify-end space-x-2">
                <button id="cancel-rename" class="px-3 py-1.5 rounded bg-slate-100">取消</button>
                <button id="confirm-rename" class="px-3 py-1.5 rounded bg-blue-500 text-white">确定</button>
              </div>
            </div>
        </div>
        <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div class="w-full max-w-md bg-white rounded-lg p-4 space-y-3">
              <h3 id="confirm-modal-title" class="text-lg font-semibold"></h3>
              <p id="confirm-modal-text" class="text-slate-600"></p>
              <div class="flex justify-end space-x-2">
                <button id="confirm-modal-cancel" class="px-3 py-1.5 rounded bg-slate-100">取消</button>
                <button id="confirm-modal-ok" class="px-3 py-1.5 rounded bg-blue-500 text-white">确定</button>
              </div>
            </div>
        </div>
        <div id="folder-context-menu" class="hidden absolute z-50 bg-white rounded-md shadow border">
            <a href="#" id="new-article-in-folder-btn" class="block w-full text-left px-4 py-2 text-sm hover:bg-slate-100">在此新建文章</a>
            <a href="#" id="rename-folder-btn" class="block w-full text-left px-4 py-2 text-sm hover:bg-slate-100">重命名文件夹</a>
            <a href="#" id="delete-folder-btn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-slate-100">删除文件夹</a>
        </div>
        <div id="article-context-menu" class="hidden absolute z-50 bg-white rounded-md shadow border">
            <a href="#" id="rename-article-btn" class="block w-full text-left px-4 py-2 text-sm hover:bg-slate-100">重命名文章</a>
            <a href="#" id="delete-article-btn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-slate-100">删除文章</a>
        </div>
    </div>

    <script type="module">
        const { jsPDF } = window.jspdf;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const cosConfig = {
            stsUrl: 'https://1317231591-4lcnljnb97.ap-guangzhou.tencentscf.com', 
            bucket: 'notes-1317231591', 
            region: 'ap-guangzhou',    
        };

        let state = { user: null, folders: [], articles: [], selectedArticleId: null, openedArticleTimestamp: null, isEditing: false, ui: { isSidebarCollapsed: false, expandedFolders: new Set(), activeFolderMenuId: null, activeArticleMenuId: null, creationType: null, creationFolderId: null } };
        let quill;
        let toastTimeout;
        let pdfDoc = null;
        let currentPage = 1;
        let dom = {};

        const on = (el, type, handler) => el && el.addEventListener(type, handler);

        // ... functions like showToast, formatDate, handleLogin, etc. remain here ...
        // ... uploadFileToCOS, handleImageUpload, etc. remain here ...
        // ... All functions down to selectArticle remain the same ...

        function selectArticle(id, startInEditMode = false, ignoreDraft = false) {
            if (state.isEditing && state.selectedArticleId && state.selectedArticleId !== id) { saveDraftToLocalStorage(); }
            state.selectedArticleId = id; const article = state.articles.find(a => a.id === id); if (!article) { switchToWelcomeView(); return; }
            state.openedArticleTimestamp = article.updated_at;
            dom.welcomeView.classList.add('hidden');
            dom.articleView.classList.remove('hidden');
            dom.articleView.classList.add('flex');
            dom.articleMainTitle.textContent = article.title;
            dom.articleActions.classList.remove('hidden');
            
            if (article.type === 'pdf') {
                dom.richtextEditorView.classList.add('hidden');
                dom.pdfReaderView.classList.remove('hidden');
                dom.pdfReaderView.classList.add('flex');
                dom.headerPdfControls.classList.remove('hidden');
                dom.headerPdfControls.classList.add('flex');
                loadAndRenderPDF(article.content);
            } else {
                dom.pdfReaderView.classList.add('hidden');
                dom.richtextEditorView.classList.remove('hidden');
                dom.richtextEditorView.classList.add('flex');
                dom.headerPdfControls.classList.add('hidden');
                const draft = loadDraftFromLocalStorage(id); const useDraft = draft && new Date(draft.updatedAt) > new Date(article.updated_at);
                if (!ignoreDraft && useDraft) { showToast('已加载较新的本地草稿', 'success'); quill.root.innerHTML = draft.content || ''; switchToEditMode(); } 
                else { quill.root.innerHTML = article.content || ''; if (startInEditMode) { switchToEditMode(); } else { switchToViewMode(); } }
            }
            renderFileTree(); if (window.innerWidth < 768) { toggleSidebar('hide'); }
        }

        // ... other functions like loadAndRenderPDF, etc. remain here ...

        function switchToWelcomeView() {
            state.selectedArticleId = null;
            dom.articleView.classList.add('hidden');
            dom.welcomeView.classList.remove('hidden');
            dom.articleMainTitle.textContent = '笔记';
            dom.mobileViewControls.classList.add('hidden');
            dom.mobileEditControls.classList.add('hidden');
            dom.articleActions.classList.add('hidden');
            dom.headerPdfControls.classList.add('hidden'); // Hide PDF controls
            renderFileTree();
        }

        // ... all other functions down to initializeApp remain the same ...

        async function initializeApp() {
            dom = {
                authView: document.getElementById('auth-view'), mainAppView: document.getElementById('main-app-view'), loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), showLoginTab: document.getElementById('show-login-tab'), showRegisterTab: document.getElementById('show-register-tab'), sidebar: document.getElementById('sidebar'), hideSidebarButton: document.getElementById('hide-sidebar-button'), sidebarOverlay: document.getElementById('sidebar-overlay'), toggleSidebarButton: document.getElementById('toggle-sidebar-button'), userAvatar: document.getElementById('user-avatar'), userEmail: document.getElementById('user-email'), logoutButton: document.getElementById('logout-button'), newFolderButton: document.getElementById('new-folder-button'), newArticleButton: document.getElementById('new-article-button'), fileTree: document.getElementById('file-tree'), welcomeView: document.getElementById('welcome-view'), articleView: document.getElementById('article-view'), articleMainTitle: document.getElementById('article-main-title'), editorContainer: document.getElementById('editor-container'), editorControls: document.getElementById('editor-controls'), editButton: document.getElementById('edit-button'), saveButton: document.getElementById('save-button'), refreshButton: document.getElementById('refresh-button'), forceReloadButton: document.getElementById('force-reload-button'), mobileControls: document.getElementById('mobile-controls'), mobileViewControls: document.getElementById('mobile-view-controls'), mobileEditControls: document.getElementById('mobile-edit-controls'), mobileEditButton: document.getElementById('mobile-edit-button'), mobileSaveButton: document.getElementById('mobile-save-button'), mobileMoreButton: document.getElementById('mobile-more-button'), mobileActionsMenu: document.getElementById('mobile-actions-menu'), mobileMoveButton: document.getElementById('mobile-move-button'), mobileExportButton: document.getElementById('mobile-export-button'), mobileRefreshButton: document.getElementById('mobile-refresh-button'), mobileForceReloadButton: document.getElementById('mobile-force-reload-button'), toast: document.getElementById('toast'), moveModal: document.getElementById('move-modal'), moveFolderSelect: document.getElementById('move-folder-select'), cancelMove: document.getElementById('cancel-move'), confirmMove: document.getElementById('confirm-move'), folderContextMenu: document.getElementById('folder-context-menu'), renameFolderBtn: document.getElementById('rename-folder-btn'), deleteFolderBtn: document.getElementById('delete-folder-btn'), newArticleInFolderBtn: document.getElementById('new-article-in-folder-btn'), articleContextMenu: document.getElementById('article-context-menu'), renameArticleBtn: document.getElementById('rename-article-btn'), deleteArticleBtn: document.getElementById('delete-article-btn'), creationModal: document.getElementById('creation-modal'), creationModalTitle: document.getElementById('creation-modal-title'), creationModalInput: document.getElementById('creation-modal-input'), cancelCreation: document.getElementById('cancel-creation'), confirmCreation: document.getElementById('confirm-creation'), renameModal: document.getElementById('rename-modal'), renameModalTitle: document.getElementById('rename-modal-title'), renameModalInput: document.getElementById('rename-modal-input'), cancelRename: document.getElementById('cancel-rename'), confirmRename: document.getElementById('confirm-rename'), importButton: document.getElementById('import-button'), exportAllButton: document.getElementById('export-all-button'), importFileInput: document.getElementById('import-file-input'), confirmModal: document.getElementById('confirm-modal'), confirmModalTitle: document.getElementById('confirm-modal-title'), confirmModalText: document.getElementById('confirm-modal-text'), confirmModalCancel: document.getElementById('confirm-modal-cancel'), confirmModalOk: document.getElementById('confirm-modal-ok'),
                articleActions: document.getElementById('article-actions'), globalMoveButton: document.getElementById('global-move-button'),
                richtextEditorView: document.getElementById('richtext-editor-view'), pdfReaderView: document.getElementById('pdf-reader-view'), pdfViewerContainer: document.getElementById('pdf-viewer-container'), pdfViewer: document.getElementById('pdf-viewer'), 
                headerPdfControls: document.getElementById('header-pdf-controls'), // Added
                pdfPrevPage: document.getElementById('pdf-prev-page'), pdfNextPage: document.getElementById('pdf-next-page'), pdfCurrentPage: document.getElementById('pdf-current-page'), pdfTotalPages: document.getElementById('pdf-total-pages'), 
                importPdfButton: document.getElementById('import-pdf-button'), importPdfInput: document.getElementById('import-pdf-input'), 
                exportDropdownButton: document.getElementById('export-dropdown-button'), exportOptions: document.getElementById('export-options'), exportTxtButton: document.getElementById('export-txt-button'), exportPdfButton: document.getElementById('export-pdf-button'),
            };

            feather.replace(); 
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                state.user = session.user;
                dom.authView.classList.add('hidden'); 
                dom.mainAppView.classList.remove('hidden'); 
                initQuill();
                initEventListeners();
                dom.userEmail.textContent = state.user.email; 
                dom.userAvatar.textContent = state.user.email[0].toUpperCase();
                await fetchData();
                if (state.articles.length > 0) { selectArticle(state.articles[0].id); } 
                else { switchToWelcomeView(); }
            } else {
                initQuill();
                initEventListeners();
                switchToWelcomeView();
                dom.authView.classList.remove('hidden'); 
                dom.mainAppView.classList.add('hidden');
            }
            if (localStorage.getItem('sidebarCollapsed') === 'true' && window.innerWidth >= 768) { toggleSidebar('hide'); }
            supabase.auth.onAuthStateChange((_, session) => {
                const userJustLoggedIn = _ === 'SIGNED_IN' && state.user?.id !== session?.user?.id;
                const userJustLoggedOut = _ === 'SIGNED_OUT';
                if (userJustLoggedIn || userJustLoggedOut) { window.location.reload(); }
            });
        }
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
