<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>时间记录（Excel风格）</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f7f9fc;--card:#fff;--line:#e5e7eb;--text:#0b1220;--muted:#6b7280;
    --accent:#2563eb;--accent-weak:#eef2ff;--danger:#dc2626;--radius:16px;

    /* 统一列宽（移动端用它来计算 sticky 偏移；桌面端可更宽） */
    --w-start:128px;
    --w-end:128px;
    --w-content:260px;
    --w-note:220px;
    --w-duration:100px;
    --w-actions:140px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}

  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .container{padding:12px 16px}
  .nav{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:clamp(18px,4.5vw,22px)}
  .account{margin-left:auto}
  .account-btn{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe;
    padding:8px 12px;border-radius:999px;font-weight:600;max-width:70vw;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }

  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);
        padding:16px;box-shadow:0 6px 26px rgba(0,0,0,.06)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)}

  input,button{border:1px solid var(--line);border-radius:12px;padding:12px;font:inherit;outline:none}
  input:focus,button:focus{border-color:var(--accent)}
  .btn{background:var(--accent);color:#fff;border:none}
  .btn.secondary{background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe}
  .btn.ghost{background:transparent}
  .btn.danger{background:var(--danger)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .right{margin-left:auto}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .toolbar .btn{height:40px}

  /* 表格容器：可横向滚动，sticky 需要非 hidden 的 overflow */
  .grid{
    margin-top:12px;border:1px solid var(--line);border-radius:14px;
    background:#fff; /* 统一白底，消除色差 */
    position:relative;overflow-x:auto; /* 允许横向拖动 */
    -webkit-overflow-scrolling:touch; /* iOS 惯性滚动 */
    touch-action:pan-x pan-y;
  }

  /* 基础列布局（桌面端更宽） */
  .thead,.trow{
    display:grid;
    grid-template-columns:
      140px 140px
      minmax(360px,2fr) minmax(280px,1.6fr)
      var(--w-duration) var(--w-actions);
    min-width: 1100px;
    border-bottom:1px solid var(--line)
  }
  .cell{padding:10px 12px;display:flex;align-items:center;min-width:0;background:#fff}
  .thead .cell{background:#f3f4f6;font-weight:600}

  /* 输入更易点按；移动端≥16px 防止 iOS 放大 */
  .trow input[type="text"]{width:100%;min-width:0;height:46px;font-size:16px;background:#fff}

  .duration{font-variant-numeric:tabular-nums}
  .actions{display:flex;gap:8px;justify-content:flex-end} /* 仅保留保存+删除，两者紧挨即可 */

  .tfoot{display:flex;justify-content:space-between;align-items:center;
         padding:10px 12px;background:#fafafa}
  .tip{font-size:12px;color:var(--muted)}

  /* 右侧冻结：时长 + 操作（桌面&移动端通用） */
  .thead .cell:nth-child(6), .trow .cell:nth-child(6){
    position:sticky; right:0; z-index:4; background:#fff; /* 去掉阴影避免色差 */
  }
  .thead .cell:nth-child(5), .trow .cell:nth-child(5){
    position:sticky; right:var(--w-actions); z-index:3; background:#fff;
  }

  /* —— 移动端：左侧也冻结（开始/结束/内容/备注固定），中间可拖动 —— */
  @media (max-width:680px){
    .toolbar .btn{height:44px}
    .thead,.trow{
      grid-template-columns:
        var(--w-start) var(--w-end) var(--w-content) var(--w-note) var(--w-duration) var(--w-actions);
      min-width: calc(var(--w-start) + var(--w-end) + var(--w-content) + var(--w-note) + var(--w-duration) + var(--w-actions));
    }
    /* 左 4 列固定 */
    .thead .cell:nth-child(1), .trow .cell:nth-child(1){position:sticky; left:0;                                 z-index:5; background:#fff}
    .thead .cell:nth-child(2), .trow .cell:nth-child(2){position:sticky; left:var(--w-start);                    z-index:5; background:#fff}
    .thead .cell:nth-child(3), .trow .cell:nth-child(3){position:sticky; left:calc(var(--w-start)+var(--w-end));  z-index:4; background:#fff}
    .thead .cell:nth-child(4), .trow .cell:nth-child(4){position:sticky; left:calc(var(--w-start)+var(--w-end)+var(--w-content)); z-index:4; background:#fff}

    /* 右 2 列固定（沿用通用规则），取消阴影避免色块差异（已上） */
  }

  /* Toast */
  .toast-wrap{position:fixed;top:16px;left:0;right:0;display:flex;justify-content:center;z-index:20000;pointer-events:none}
  .toast{pointer-events:auto;background:#111827;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 28px rgba(0,0,0,.25);opacity:.98}
  .toast.ok{background:#065f46}.toast.err{background:#7f1d1d}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <h1>时间记录（Excel风格）</h1>
    <div class="account"><button id="accountBtn" class="account-btn">登录 / 注册</button></div>
  </div>
</header>

<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<div class="container" id="guestCard">
  <div class="card"><div class="row"><strong>请先登录</strong><span class="muted">点击右上角「登录 / 注册」进入你的账户</span></div></div>
</div>

<main class="container" id="app" style="display:none">
  <div class="card">
    <div class="toolbar">
      <div class="row" style="gap:8px">
        <span class="muted">选择日期</span>
        <input id="dateInput" type="date" />
      </div>
      <button id="addRow" class="btn">+ 新增一行</button>
      <button id="exportCsv" class="btn secondary">导出 CSV</button>
      <input id="csvFile" type="file" accept=".csv" style="display:none">
      <button id="importCsv" class="btn secondary">导入 CSV</button>
      <div class="right" style="display:flex;gap:10px;align-items:center">
        <div id="syncState" class="muted" style="display:none"><span style="display:inline-block;width:14px;height:14px;border:2px solid #cfe3ff;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite"></span> 正在同步…</div>
        <button id="refreshBtn" class="btn secondary">刷新</button>
      </div>
    </div>

    <div class="grid" id="grid">
      <div class="thead">
        <div class="cell">开始时间</div>
        <div class="cell">结束时间</div>
        <div class="cell">内容</div>
        <div class="cell">备注</div>
        <div class="cell">时长</div>
        <div class="cell">操作</div>
      </div>
      <div id="tbody"></div>
      <div class="tfoot">
        <div class="tip">提示：时间格式如 <b>17:18</b> 或 <b>17:18:17</b>；若跨午夜（结束 &lt; 开始）自动 +24 小时。</div>
        <div id="total" class="muted">合计：00:00:00</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row"><strong>最近 30 天历史</strong><button id="reloadHistory" class="btn secondary">刷新</button></div>
    <div id="historyList" style="margin-top:8px" class="muted">—</div>
  </div>
</main>

<!-- 模态：登录/注册/账户（与你现有的一致） -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-hidden="true">
  <div class="backdrop" id="modalBackdrop"></div>
  <div class="dialog" role="document">
    <button class="close-x" id="modalClose" aria-label="关闭">✕</button>
    <h3 id="dialogTitle">登录 / 注册</h3>
    <div id="dialogBody"></div>
  </div>
</div>

<script>
/* ========= Supabase ========= */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

const TABLE = 'time_entries';
const COL_DATE = 'entry_date';
const COL_START = 'start_time';
const COL_END = 'end_time';
const COL_DUR = 'duration_seconds';
const COL_CONTENT = 'content';
const COL_NOTE = 'note';

const { createClient } = supabase;

/* 安全会话存储（localStorage 不可用时用 Cookie） */
const cookieStorage = {
  getItem:k=>{const m=document.cookie.match(new RegExp('(?:^|; )'+encodeURIComponent(k)+'=([^;]*)'));return m?decodeURIComponent(m[1]):null},
  setItem:(k,v)=>{const e=new Date();e.setFullYear(e.getFullYear()+1);document.cookie=`${encodeURIComponent(k)}=${encodeURIComponent(v)}; Path=/; Expires=${e.toUTCString()}; SameSite=Lax; Secure`},
  removeItem:k=>{document.cookie=`${encodeURIComponent(k)}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax; Secure`}
};
function safeStorage(){try{const t='__sb__'+Math.random();localStorage.setItem(t,'1');localStorage.removeItem(t);return localStorage}catch{return cookieStorage}}
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:false,storage:safeStorage(),storageKey:'sb-time-auth'}
});

/* ========= 状态 & DOM ========= */
let session=null, rows=[], syncing=0;
const $=id=>document.getElementById(id);
const els={app:$('app'),guest:$('guestCard'),date:$('dateInput'),tbody:$('tbody'),total:$('total'),
  add:$('addRow'),exp:$('exportCsv'),imp:$('importCsv'),file:$('csvFile'),refresh:$('refreshBtn'),
  hist:$('historyList'),rehist:$('reloadHistory'),sync:$('syncState'),account:$('accountBtn'),
  modal:$('modal'),backdrop:$('modalBackdrop'),close:$('modalClose'),title:$('dialogTitle'),body:$('dialogBody'),
  toast:document.getElementById('toastWrap'), grid:document.getElementById('grid') };

const toast=(m,t='ok',ms=1600)=>{const n=document.createElement('div');n.className='toast '+(t==='error'?'err':'ok');n.textContent=m;els.toast.appendChild(n);setTimeout(()=>{n.style.transition='opacity .35s';n.style.opacity='0'},ms);setTimeout(()=>n.remove(),ms+400)};
const setSync=v=>{syncing+=v?1:-1; if(syncing<0)syncing=0; els.sync.style.display=syncing>0?'':'none'};

/* ========= 时间工具 ========= */
const parseTime=s=>{s=(s||'').trim();if(!s)return null;const a=s.split(':');if(a.length<2||a.length>3)return null;const h=+a[0],m=+a[1],se=a[2]?+a[2]:0;if([h,m,se].some(Number.isNaN))return null; if(h<0||h>47||m<0||m>59||se<0||se>59)return null;return h*3600+m*60+se};
const fmt=sec=>{sec=Math.max(0,sec|0);const h=String(Math.floor(sec/3600)).padStart(2,'0'),m=String(Math.floor(sec%3600/60)).padStart(2,'0'),s=String(sec%60).padStart(2,'0');return `${h}:${m}:${s}`};
const dur=(s,e)=>{if(s==null||e==null)return 0;let d=e-s; if(d<0)d+=86400; return d};

/* ========= 模态登录/注册/账户 ========= */
let lastFocus=null;
const openModal=(title,html)=>{els.title.textContent=title;els.body.innerHTML=html;lastFocus=document.activeElement;els.modal.classList.add('show');els.modal.removeAttribute('aria-hidden');document.body.style.overflow='hidden';const f=els.body.querySelector('input,button');if(f)setTimeout(()=>f.focus(),0)};
const closeModal=()=>{els.modal.classList.remove('show');els.modal.setAttribute('aria-hidden','true');document.body.style.overflow='';if(lastFocus)lastFocus.focus()};
els.backdrop.onclick=closeModal;els.close.onclick=closeModal;document.addEventListener('keydown',e=>{if(e.key==='Escape'&&els.modal.classList.contains('show'))closeModal()});
function showAuth(){
  openModal('登录 / 注册', `
    <div class="field"><label class="muted">邮箱</label><input id="em" type="email" placeholder="you@example.com" style="font-size:16px"></div>
    <div class="field"><label class="muted">密码（≥6位）</label><input id="pw" type="password" placeholder="******" style="font-size:16px"></div>
    <div class="row" style="gap:8px;justify-content:flex-end"><button id="lg" class="btn">登录</button><button id="sg" class="btn secondary">注册</button></div>
    <div id="hint" class="muted" style="margin-top:6px"></div>
  `);
  const hint=$('hint');
  $('lg').onclick=async()=>{const email=$('em').value.trim(),password=$('pw').value;if(!email||!password)return hint.textContent='请输入邮箱和密码';const {error}=await sb.auth.signInWithPassword({email,password}); if(error)hint.textContent='登录失败：'+error.message; else{hint.textContent='';toast('登录成功');closeModal()}};
  $('sg').onclick=async()=>{const email=$('em').value.trim(),password=$('pw').value;if(!email||!password)return hint.textContent='请输入邮箱和密码';const {error}=await sb.auth.signUp({email,password});hint.textContent=error?('注册失败：'+error.message):'注册成功。如开启邮箱验证，请到邮箱完成确认后再登录。'};
}
function showAccount(u){
  openModal('账户', `<div class="field"><div class="muted">邮箱：${u.email||''}</div></div><div class="row" style="gap:8px;justify-content:flex-end"><button id="lo" class="btn">退出登录</button></div>`);
  $('lo').onclick=async()=>{await sb.auth.signOut();toast('您已退出登录');closeModal()};
}
$('accountBtn').onclick=()=>{session?.user?showAccount(session.user):showAuth()};

/* ========= UI渲染 ========= */
function applySessionUI(){ $('accountBtn').textContent = session?.user?`已登录：${session.user.email||'用户'}`:'登录 / 注册'; $('app').style.display=session?'':'none'; $('guestCard').style.display=session?'none':'' }
function renderTotal(){const sum=rows.reduce((a,b)=>a+(b.duration||0),0);$('total').textContent='合计：'+fmt(sum)}
function rowDOM(item){
  const tr=document.createElement('div');tr.className='trow';
  tr.innerHTML=`<div class="cell"><input type="text" value="${item.start||''}" placeholder="07:30"></div>
                <div class="cell"><input type="text" value="${item.end||''}" placeholder="08:45"></div>
                <div class="cell"><input type="text" value="${item.content||''}" placeholder="内容"></div>
                <div class="cell"><input type="text" value="${item.note||''}" placeholder="备注"></div>
                <div class="cell duration">${fmt(item.duration||0)}</div>
                <div class="cell actions"><button class="btn secondary save">保存</button><button class="btn danger del">删除</button></div>`;
  const [sEl,eEl,cEl,nEl]=tr.querySelectorAll('input');const dEl=tr.querySelector('.duration');
  const recalc=()=>{const s=parseTime(sEl.value),e=parseTime(eEl.value);const d=dur(s,e);item.duration=d;item.start=sEl.value;item.end=eEl.value;dEl.textContent=fmt(d);renderTotal()};
  sEl.oninput=eEl.oninput=recalc;cEl.oninput=()=>item.content=cEl.value;nEl.oninput=()=>item.note=nEl.value;
  tr.querySelector('.del').onclick=()=>removeRow(item);
  tr.querySelector('.save').onclick=()=>saveRow(item,tr.querySelector('.save'));
  return tr;
}
function renderBody(){
  $('tbody').innerHTML='';const f=document.createDocumentFragment();for(const it of rows)f.appendChild(rowDOM(it));
  $('tbody').appendChild(f);renderTotal();
  // 保证加载后从最左侧开始，避免一进来就只看到右边按钮
  $('grid').scrollLeft = 0;
}

/* ========= CRUD ========= */
async function fetchRowsByDate(dateStr, tip=false){
  if(!session){rows=[];renderBody();return}
  setSync(true);
  const { data, error } = await sb.from(TABLE)
    .select(`id, ${COL_START}, ${COL_END}, ${COL_CONTENT}, ${COL_NOTE}, ${COL_DUR}`)
    .eq('user_id', session.user.id)
    .eq(COL_DATE, dateStr)
    .order(COL_START,{ascending:true});
  setSync(false);
  if(error){toast('拉取失败：'+error.message,'error');return}
  rows=(data||[]).map(r=>({id:r.id,start:r[COL_START],end:r[COL_END],content:r[COL_CONTENT]||'',note:r[COL_NOTE]||'',duration:r[COL_DUR]||0}));
  renderBody(); if(tip)toast('已从云端同步');
}
async function saveRow(item, btn){
  if(!session)return toast('请先登录','error');
  const s=parseTime(item.start), e=parseTime(item.end);
  if(s==null||e==null) return toast('时间格式应为 HH:MM 或 HH:MM:SS','error');
  const seconds=dur(s,e);
  btn.disabled=true; setSync(true);
  const payload={ user_id: session.user.id, [COL_DATE]: $('dateInput').value, [COL_START]: item.start, [COL_END]: item.end, [COL_DUR]: seconds, [COL_CONTENT]: item.content||'', [COL_NOTE]: item.note||'' };
  let error;
  if(item.id){ ({error}=await sb.from(TABLE).update(payload).eq('id',item.id)); }
  else{ const res=await sb.from(TABLE).insert(payload).select('id').single(); error=res.error; if(!error) item.id=res.data.id; }
  setSync(false); btn.disabled=false;
  if(error) return toast('保存失败：'+error.message,'error');
  toast('✅ 已保存并同步到云端');
}
async function removeRow(item){
  const idx=rows.indexOf(item); if(idx<0) return;
  if(item.id){ setSync(true); const {error}=await sb.from(TABLE).delete().eq('id',item.id); setSync(false); if(error) return toast('删除失败：'+error.message,'error'); }
  rows.splice(idx,1); renderBody(); toast('🗑️ 已删除');
}

/* ========= CSV ========= */
function toCSV(){
  const header=[COL_DATE,COL_START,COL_END,COL_CONTENT,COL_NOTE];
  const lines=[header.join(',')];
  for(const it of rows){ lines.push([$('dateInput').value,it.start||'',it.end||'',(it.content||'').replace(/,/g,'，'),(it.note||'').replace(/,/g,'，')].join(',')) }
  return lines.join('\n');
}
function download(name,text){const blob=new Blob([text],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;a.click();URL.revokeObjectURL(url)}
function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(Boolean); if(lines.length===0) return [];
  const head=lines[0].split(','); const idx={
    date: head.findIndex(h=>/date|日期|entry/i.test(h)),
    start: head.findIndex(h=>/start/i.test(h)||/开始/.test(h)),
    end: head.findIndex(h=>/end/i.test(h)||/结束/.test(h)),
    content: head.findIndex(h=>/content|内容/i.test(h)),
    note: head.findIndex(h=>/note|备注/i.test(h)),
  };
  const out=[]; for(let i=1;i<lines.length;i++){const c=lines[i].split(',');const d=c[idx.date]||$('dateInput').value;if(d!==$('dateInput').value) continue; const s=c[idx.start]||'', e=c[idx.end]||''; out.push({id:null,start:s,end:e,content:(c[idx.content]||'').replace(/，/g,','),note:(c[idx.note]||'').replace(/，/g,','),duration:dur(parseTime(s),parseTime(e))})}
  return out;
}

/* ========= 历史 ========= */
async function loadHistory(){
  if(!session){$('historyList').textContent='—';return}
  const from=new Date($('dateInput').value); from.setDate(from.getDate()-29);
  setSync(true);
  const { data, error } = await sb.from(TABLE)
    .select(`${COL_DATE}, ${COL_DUR}`)
    .eq('user_id', session.user.id)
    .gte(COL_DATE, from.toISOString().slice(0,10))
    .lte(COL_DATE, $('dateInput').value);
  setSync(false);
  if(error){toast('历史拉取失败：'+error.message,'error');return}
  const map=new Map();
  for(const r of (data||[])){ map.set(r[COL_DATE], (map.get(r[COL_DATE])||0) + (r[COL_DUR]||0)); }
  const items=[...map.entries()].sort((a,b)=>a[0]<b[0]?1:-1);
  $('historyList').innerHTML = items.length ? items.map(([d,s])=>`<div class="row"><div>${d}</div><div class="muted">合计：${fmt(s)}</div></div>`).join('') : '—';
}

/* ========= 事件 ========= */
$('addRow').onclick=()=>{rows.push({id:null,start:'',end:'',content:'',note:'',duration:0});renderBody()};
$('exportCsv').onclick=()=>download(`timelog_${$('dateInput').value}.csv`,toCSV());
$('importCsv').onclick=()=>$('csvFile').click();
$('csvFile').onchange=async e=>{const f=e.target.files[0];if(!f)return;const text=await f.text();const list=parseCSV(text);if(list.length===0)return toast('CSV 没有可导入的当前日期数据','error');rows.push(...list);renderBody();toast(`已加入 ${list.length} 行，记得点“保存”写入云端`)};
$('refreshBtn').onclick=()=>fetchRowsByDate($('dateInput').value,true);
$('reloadHistory').onclick=loadHistory;

/* ========= 认证监听 & 初始化 ========= */
sb.auth.onAuthStateChange((_evt,sess)=>{session=sess;applySessionUI();if(session){fetchRowsByDate($('dateInput').value);loadHistory()}});

(async function init(){
  const today=new Date(); $('dateInput').value=today.toISOString().slice(0,10);
  const {data} = await sb.auth.getSession(); session=data.session||null; applySessionUI();
  if(session){fetchRowsByDate($('dateInput').value);loadHistory()}
  $('dateInput').onchange=()=>{if(session){fetchRowsByDate($('dateInput').value)} renderBody(); loadHistory()}
})();
</script>
</body>
</html>
