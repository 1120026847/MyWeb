<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>时间记录</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#f7f9fc;--card:#fff;--line:#e5e7eb;--text:#0b1220;--muted:#6b7280;
    --accent:#2563eb;--accent-weak:#eef2ff;--danger:#dc2626;--warning:#f97316;--radius:16px;

    /* 列宽（桌面） */
    --w-start:120px;   /* 开始（缩小） */
    --w-end:120px;     /* 结束（缩小） */
    --w-content:360px; /* 内容 */
    --w-note:280px;    /* 备注 */
    --w-duration:100px;/* 时长 */
    --w-actions:140px; /* 操作 */
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}

  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .container{padding:12px 16px}
  .nav{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:clamp(18px,4.5vw,22px)}
  .account{margin-left:auto}
  .account-btn{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe;
    padding:8px 12px;border-radius:999px;font-weight:600;max-width:70vw;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }
  .header-add-btn{
    margin-left: 12px; padding: 4px 10px; font-size: 18px; line-height: 1;
    height: 32px; min-width: 32px; border-radius: 999px;
    background: var(--accent-weak); color: #1e3a8a; border: 1px solid #c7d2fe;
    cursor: pointer;
  }

  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);
        padding:16px;box-shadow:0 6px 26px rgba(0,0,0,.06)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)}

  input,button{border:1px solid var(--line);border-radius:12px;padding:12px;font:inherit;outline:none;background:#fff}
  input:focus,button:focus{border-color:var(--accent)}
  /* iOS 防 1.5 倍放大 */
  input{font-size:16px}
  .btn{background:var(--accent);color:#fff;border:none; cursor:pointer;}
  .btn.secondary{background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe}
  .btn.ghost{background:transparent}
  .btn.danger{background:var(--danger)}
  .btn.warning{background:var(--warning); color:#fff; border-color:var(--warning);}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .right{margin-left:auto}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .toolbar .btn{height:40px}

  /* 表格 */
  .grid{
    margin-top:12px;border:1px solid var(--line);border-radius:14px;
    background:#fff; position:relative; overflow-x:auto;
    -webkit-overflow-scrolling:touch; touch-action:pan-x pan-y;
  }
  .thead,.trow{
    display:grid;
    grid-template-columns:
      var(--w-start) var(--w-end)
      minmax(var(--w-content),2fr) minmax(var(--w-note),1.4fr)
      var(--w-duration) var(--w-actions);
    min-width:1100px;
    border-bottom:1px solid var(--line)
  }
  .cell{padding:10px 12px;display:flex;align-items:center;min-width:0;background:#fff}
  .thead .cell{background:#f3f4f6;font-weight:600}
  .trow input[type="text"]{width:100%;min-width:0;height:46px}
  .duration{font-variant-numeric:tabular-nums}
  .actions{display:flex;gap:8px;justify-content:flex-end}

  .tfoot{display:flex;justify-content:space-between;align-items:center;
         padding:10px 12px;background:#fafafa}
  .tip{font-size:12px;color:var(--muted)}

  /* 紧凑模式（隐藏备注 + 时长） */
  .grid.compact .thead,.grid.compact .trow{
    grid-template-columns: 92px 92px minmax(120px,1fr) 130px; /* 开始 结束 内容 操作 */
    min-width:0;
  }
  .grid.compact .thead .cell:nth-child(4),
  .grid.compact .thead .cell:nth-child(5),
  .grid.compact .trow  .cell:nth-child(4),
  .grid.compact .trow  .cell:nth-child(5){display:none}

  @media (max-width:480px){
    .trow input[type="text"]{height:42px}
    .cell{padding:8px}
    .btn{padding:8px 10px;font-size:14px}
    .btn.danger{padding:8px 10px}
  }

  /* Toast */
  .toast-wrap{position:fixed;top:16px;left:0;right:0;display:flex;justify-content:center;z-index:20000;pointer-events:none}
  .toast{pointer-events:auto;background:#111827;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 28px rgba(0,0,0,.25);opacity:.98}
  .toast.ok{background:#065f46}.toast.err{background:#7f1d1d}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ========= 模态（登录 / 注册 / 账户） ========= */
  .modal{position:fixed;inset:0;z-index:30000;display:none}
  .modal.show{display:block}
  .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  /* 桌面：居中卡片；移动：底部抽屉 */
  .modal .panel{
    position:absolute;left:50%;top:10%;transform:translateX(-50%);
    width:min(92vw,480px);max-height:80vh;overflow:auto;
    background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px
  }
  @media (max-width:680px){
    .modal .panel{
      left:12px;right:12px;top:auto;bottom:12px;transform:none;width:auto;max-height:84vh;
      border-radius:16px 16px 12px 12px
    }
  }
  .modal .close-x{
    position:absolute;right:10px;top:10px;width:36px;height:36px;
    border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer
  }
  .modal .title{margin:0 40px 10px 0;font-size:18px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .panel .btn{height:42px}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <h1>时间记录</h1>
    <button id="headerAddRow" class="header-add-btn" aria-label="新增一行">+</button>
    <div class="account"><button id="accountBtn" class="account-btn">登录 / 注册</button></div>
  </div>
</header>

<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<div class="container" id="guestCard">
  <div class="card"><div class="row"><strong>请先登录</strong><span class="muted">点击右上角「登录 / 注册」进入你的账户</span></div></div>
</div>

<main class="container" id="app" style="display:none">
  <div class="card">
    <div class="toolbar">
      <div class="row" style="gap:8px">
        <span class="muted">选择日期</span>
        <input id="dateInput" type="date" />
      </div>
      <button id="addRow" class="btn">+ 新增一行</button>
      <button id="exportCsv" class="btn secondary">导出数据</button>
      <input id="csvFile" type="file" accept=".xlsx, .xls, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none">
      <button id="importCsv" class="btn secondary">Excel导入</button>
      <button id="toggleCols" class="btn secondary">隐藏备注与时长</button>
      <div class="right" style="display:flex;gap:10px;align-items:center">
        <div id="syncState" class="muted" style="display:none">
          <span style="display:inline-block;width:14px;height:14px;border:2px solid #cfe3ff;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite"></span>
          正在同步…
        </div>
        <button id="refreshBtn" class="btn secondary">刷新</button>
      </div>
    </div>

    <div class="grid" id="grid">
      <div class="thead">
        <div class="cell">开始时间</div>
        <div class="cell">结束时间</div>
        <div class="cell">内容</div>
        <div class="cell">备注</div>
        <div class="cell">时长</div>
        <div class="cell">操作</div>
      </div>
      <div id="tbody"></div>
      <div class="tfoot">
        <div class="tip">提示：时间格式如 <b>17:18</b> 或 <b>17:18:17</b>；若跨午夜（结束 &lt; 开始）自动 +24 小时。</div>
        <div id="total" class="muted">合计：00:00:00</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row"><strong>最近 30 天历史</strong><button id="reloadHistory" class="btn secondary">刷新</button></div>
    <div id="historyList" style="margin-top:8px" class="muted">—</div>
  </div>
</main>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-hidden="true">
  <div class="backdrop" id="modalBackdrop"></div>
  <div class="panel" role="document">
    <button class="close-x" id="modalClose" aria-label="关闭">✕</button>
    <h3 id="dialogTitle" class="title">登录 / 注册</h3>
    <div id="dialogBody"></div>
  </div>
</div>

<script>
/* ========= Supabase ========= */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

const TABLE = 'time_entries';
const COL_DATE = 'entry_date';
const COL_START = 'start_time';
const COL_END = 'end_time';
const COL_DUR = 'duration_seconds';
const COL_CONTENT = 'content';
const COL_NOTE = 'note';

const { createClient } = supabase;

/* 安全会话存储（localStorage 不可用时回退到 Cookie） */
const cookieStorage = {
  getItem:k=>{const m=document.cookie.match(new RegExp('(?:^|; )'+encodeURIComponent(k)+'=([^;]*)'));return m?decodeURIComponent(m[1]):null},
  setItem:(k,v)=>{const e=new Date();e.setFullYear(e.getFullYear()+1);document.cookie=`${encodeURIComponent(k)}=${encodeURIComponent(v)}; Path=/; Expires=${e.toUTCString()}; SameSite=Lax; Secure`},
  removeItem:k=>{document.cookie=`${encodeURIComponent(k)}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax; Secure`}
};
function safeStorage(){try{const t='__sb__'+Math.random();localStorage.setItem(t,'1');localStorage.removeItem(t);return localStorage}catch{return cookieStorage}}
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:false,storage:safeStorage(),storageKey:'sb-time-auth'}
});

/* ========= 状态 & DOM ========= */
let session=null, rows=[], syncing=0;
/* 草稿 & 脏数据保护 + 客户端行ID */
let dirty=false;
const $=id=>document.getElementById(id);
const els={
  app:$('app'),guest:$('guestCard'),date:$('dateInput'),tbody:$('tbody'),total:$('total'),
  add:$('addRow'),exp:$('exportCsv'),imp:$('importCsv'),file:$('csvFile'),refresh:$('refreshBtn'),
  hist:$('historyList'), rehist:$('reloadHistory'),
  sync:$('syncState'),account:$('accountBtn'),
  modal:$('modal'),backdrop:$('modalBackdrop'),close:$('modalClose'),
  title:$('dialogTitle'),body:$('dialogBody'),
  toast:document.getElementById('toastWrap'), grid:$('grid'), toggle:$('toggleCols'),
  headerAdd:$('headerAddRow'),
};

const toast=(m,t='ok',ms=1600)=>{const n=document.createElement('div');n.className='toast '+(t==='error'?'err':'ok');n.textContent=m;els.toast.appendChild(n);setTimeout(()=>{n.style.transition='opacity .35s';n.style.opacity='0'},ms);setTimeout(()=>n.remove(),ms+400)};
function setSync(v){
  syncing += v ? 1 : -1;
  if (syncing < 0) syncing = 0;
  els.sync.style.display = syncing > 0 ? '' : 'none';
  if (v) setTimeout(() => { if (syncing > 0) { syncing = 0; els.sync.style.display = 'none'; } }, 15000);
}

/* ========= 时间与日期 ========= */
const parseTime=s=>{s=(s||'').trim();if(!s)return null;const a=s.split(':');if(a.length<2||a.length>3)return null;const h=+a[0],m=+a[1],se=a[2]?+a[2]:0;if([h,m,se].some(Number.isNaN))return null; if(h<0||h>47||m<0||m>59||se<0||se>59)return null;return h*3600+m*60+se};
const fmt=sec=>{sec=Math.max(0,sec|0);const h=String(Math.floor(sec/3600)).padStart(2,'0'),m=String(Math.floor(sec%3600/60)).padStart(2,'0'),s=String(sec%60).padStart(2,'0');return `${h}:${m}:${s}`};
const dur=(s,e)=>{if(s==null||e==null)return 0;let d=e-s; if(d<0)d+=86400; return d};

function parseDay(yyyy_mm_dd){ return new Date(`${yyyy_mm_dd}T00:00:00`); }
function toDayString(d){ return d.toISOString().slice(0,10); }

/* ========= 稳定的客户端行ID（用于去重合并） ========= */
function genCid(){ try{ return (self.crypto && self.crypto.randomUUID) ? self.crypto.randomUUID() : 'cid-'+Date.now()+'-'+Math.random().toString(36).slice(2); }catch{ return 'cid-'+Date.now()+'-'+Math.random().toString(36).slice(2); } }
function ensureCid(it){ if(!it.cid){ it.cid = it.id ? ('id:'+it.id) : genCid(); } return it; }
function isSameUnsaved(a,b){ return !a.id && !b.id && (a.start||'')===(b.start||'') && (a.end||'')===(b.end||'') && (a.content||'')===(b.content||'') && (a.note||'')===(b.note||''); }

/* ========= 合并：把 server 行合进 local，保护未保存 ========= */
function mergeRows(localRows, serverRows){
  const byId = new Map(serverRows.filter(r=>r.id).map(r=>[r.id, r]));
  const used = new Set();
  const out = [];

  for(const lr of localRows){
    if(lr.id){
      const sr = byId.get(lr.id);
      if(sr){
        used.add(lr.id);
        out.push( ensureCid(lr._dirty ? lr : sr) ); // 未保存保护
      }else{
        out.push( ensureCid(lr) ); // 云端没有（可能被删），先保留本地显示
      }
    }else{
      out.push( ensureCid(lr) );   // 未保存草稿
    }
  }
  for(const sr of serverRows){
    if(sr.id && used.has(sr.id)) continue;
    // 如果本地有一条未保存、内容完全一致的草稿，用云端替换那条，避免“影分身”
    const dupDraftIdx = out.findIndex(r => !r.id && (r.start||'')===sr.start && (r.end||'')===sr.end && (r.content||'')===sr.content && (r.note||'')===sr.note);
    if(dupDraftIdx>=0) out[dupDraftIdx] = ensureCid(sr);
    else out.push( ensureCid(sr) );
  }
  // 排序（按开始时间）
  out.sort((a,b)=> (parseTime(a.start)||0) - (parseTime(b.start)||0) );
  return out;
}

/* ========= 模态（登录 / 注册 / 账户） ========= */
let lastFocus=null;
function openModal(title,html){
  els.title.textContent=title;els.body.innerHTML=html;
  lastFocus=document.activeElement;els.modal.classList.add('show');els.modal.removeAttribute('aria-hidden');
  document.body.style.overflow='hidden';
  const f=els.body.querySelector('input,button');if(f)setTimeout(()=>f.focus(),0);
}
function closeModal(){
  els.modal.classList.remove('show');els.modal.setAttribute('aria-hidden','true');document.body.style.overflow='';
  if(lastFocus)lastFocus.focus();
}
els.backdrop.onclick=closeModal;els.close.onclick=closeModal;
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&els.modal.classList.contains('show'))closeModal()});

function showAuth(){
  openModal('登录 / 注册', `
    <div class="field"><label>邮箱</label><input id="em" type="email" placeholder="you@example.com"></div>
    <div class="field"><label>密码（≥6位）</label><input id="pw" type="password" placeholder="******"></div>
    <div class="row" style="gap:8px;justify-content:flex-end"><button id="lg" class="btn">登录</button><button id="sg" class="btn secondary">注册</button></div>
    <div id="hint" class="muted" style="margin-top:6px"></div>
  `);
  const hint=$('hint');
  $('lg').onclick=async()=>{
    const email=$('em').value.trim(),password=$('pw').value;
    if(!email||!password) return hint.textContent='请输入邮箱和密码';
    setSync(true);
    try{
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ hint.textContent='登录失败：' + error.message; }
      else { hint.textContent=''; toast('登录成功'); closeModal(); }
    }catch(err){ hint.textContent='登录异常：' + (err?.message||err); }
    finally{ setSync(false); }
  };
  $('sg').onclick=async()=>{
    const email=$('em').value.trim(),password=$('pw').value;
    if(!email||!password) return hint.textContent='请输入邮箱和密码';
    setSync(true);
    try{
      const { error } = await sb.auth.signUp({ email, password });
      hint.textContent = error ? ('注册失败：' + error.message) : '注册成功。如开启邮箱验证，请到邮箱完成确认后再登录。';
    }catch(err){ hint.textContent='注册异常：' + (err?.message||err); }
    finally{ setSync(false); }
  };
}
function showAccount(u){
  openModal('账户', `
    <div class="field"><div class="muted">邮箱：${u.email||''}</div></div>
    <div class="row" style="gap:8px;justify-content:flex-end"><button id="lo" class="btn">退出登录</button></div>
  `);
  $('lo').onclick=async()=>{ setSync(true); try{ await sb.auth.signOut(); toast('您已退出登录'); closeModal(); } finally{ setSync(false);} };
}
$('accountBtn').onclick=()=>{session?.user?showAccount(session.user):showAuth()};

/* ========= UI 渲染 ========= */
function applySessionUI(){
  $('accountBtn').textContent = session?.user?`已登录：${session.user.email||'用户'}`:'登录 / 注册';
  $('app').style.display=session?'':'none';
  $('guestCard').style.display=session?'none':'';
}
function renderTotal(){const sum=rows.reduce((a,b)=>a+(b.duration||0),0);$('total').textContent='合计：'+fmt(sum)}

function markDirty(item){ item._dirty = true; dirty = true; }
function draftKey(){
  const uid = session?.user?.id || 'guest';
  return `timelog-draft:${uid}:${$('dateInput').value}`;
}
function hasDraft(){
  try{ return !!localStorage.getItem(draftKey()); }catch{ return false; }
}
function saveDraft(){
  try{
    const drafts = rows.filter(r => !r.id || r._dirty).map(r => ensureCid({...r}));
    if (drafts.length) localStorage.setItem(draftKey(), JSON.stringify(drafts));
  }catch{}
}
function restoreDraft(){
  try{
    const txt = localStorage.getItem(draftKey());
    if(!txt) return false;
    const list = JSON.parse(txt)||[];
    if(list.length){
      let merged=0;
      for(const d of list){
        ensureCid(d);
        const idx = rows.findIndex(r => r.cid===d.cid || isSameUnsaved(r,d));
        if(idx>=0){ rows[idx] = {...rows[idx], ...d, _dirty:true}; }
        else{ rows.push({...d, _dirty:true}); }
        merged++;
      }
      renderBody();
      toast(`已恢复 ${merged} 条未保存项`);
      dirty = true;
    }
    localStorage.removeItem(draftKey());
    return true;
  }catch{ return false; }
}

function rowDOM(item){
  ensureCid(item);
  const tr=document.createElement('div');tr.className='trow';
  const isUnsaved = !item.id || item._dirty;
  const saveBtnClass = isUnsaved ? 'btn warning save' : 'btn secondary save';

  tr.innerHTML=`<div class="cell"><input type="text" value="${item.start||''}" placeholder="07:30"></div>
                <div class="cell"><input type="text" value="${item.end||''}" placeholder="08:45"></div>
                <div class="cell"><input type="text" value="${item.content||''}" placeholder="内容"></div>
                <div class="cell"><input type="text" value="${item.note||''}" placeholder="备注"></div>
                <div class="cell duration">${fmt(item.duration||0)}</div>
                <div class="cell actions"><button class="${saveBtnClass}">保存</button><button class="btn danger del">删除</button></div>`;
  const [sEl,eEl,cEl,nEl]=tr.querySelectorAll('input');
  const dEl=tr.querySelector('.duration');
  const saveBtn = tr.querySelector('.save');

  const recalc=()=>{
    const s=parseTime(sEl.value),e=parseTime(eEl.value);const d=dur(s,e);
    item.duration=d;item.start=sEl.value;item.end=eEl.value;dEl.textContent=fmt(d);renderTotal();
    if(!isUnsaved){ saveBtn.classList.add('warning'); saveBtn.classList.remove('secondary'); }
    markDirty(item);saveDraft();
  };
  const makeDirty = () => {
    if(!isUnsaved){ saveBtn.classList.add('warning'); saveBtn.classList.remove('secondary'); }
    markDirty(item); saveDraft();
  }

  sEl.oninput=eEl.oninput=recalc;
  cEl.oninput=()=>{ item.content=cEl.value; makeDirty(); };
  nEl.oninput=()=>{ item.note=nEl.value;    makeDirty(); };
  tr.querySelector('.del').onclick=()=>{ removeRow(item); saveDraft(); };
  saveBtn.onclick=()=>saveRow(item,saveBtn);
  return tr;
}
function renderBody(){
  $('tbody').innerHTML='';
  const f=document.createDocumentFragment();
  for(const it of rows) f.appendChild(rowDOM(it));
  $('tbody').appendChild(f);
  renderTotal();
}

/* ========= CRUD ========= */
/**
 * 拉取某日数据
 * @param {string} dateStr YYYY-MM-DD
 * @param {{mode?: 'auto'|'merge'|'overwrite', tip?: boolean}} opts
 */
async function fetchRowsByDate(dateStr, opts={}){
  const { mode='auto', tip=false } = opts;
  if(!session){ rows=[]; renderBody(); return; }

  // auto 模式：有草稿/脏数据就跳过（防覆盖）
  if (mode==='auto' && (dirty || hasDraft())) {
    if (tip) toast('有未保存内容，已跳过自动刷新');
    return;
  }

  setSync(true);
  try{
    const { data, error } = await sb.from(TABLE)
      .select(`id, ${COL_START}, ${COL_END}, ${COL_CONTENT}, ${COL_NOTE}, ${COL_DUR}`)
      .eq('user_id', session.user.id)
      .eq(COL_DATE, dateStr)
      .order(COL_START,{ascending:true});
    if(error){ toast('拉取失败：' + error.message,'error'); return; }
    const serverRows = (data||[]).map(r=>ensureCid({
      id:r.id,start:r[COL_START],end:r[COL_END],
      content:r[COL_CONTENT]||'',note:r[COL_NOTE]||'',
      duration:r[COL_DUR]||0
    }));

    if(mode==='merge'){
      rows = mergeRows(rows, serverRows);
    }else{ // auto / overwrite -> 直接用云端
      rows = serverRows;
    }
    renderBody(); if(tip) toast('已从云端同步');
  }catch(err){ toast('同步异常：' + (err?.message||err),'error'); }
  finally{ setSync(false); }
}

async function saveRow(item, btn){
  if(!session) return toast('请先登录','error');
  const s=parseTime(item.start), e=parseTime(item.end);
  if(s==null||e==null) return toast('时间格式应为 HH:MM 或 HH:MM:SS','error');
  const seconds=dur(s,e);
  btn.disabled=true; setSync(true);
  try{
    const payload={ user_id: session.user.id, [COL_DATE]: $('dateInput').value, [COL_START]: item.start, [COL_END]: item.end, [COL_DUR]: seconds, [COL_CONTENT]: item.content||'', [COL_NOTE]: item.note||'' };
    if(item.id){
      const { error } = await sb.from(TABLE).update(payload).eq('id',item.id);
      if(error) return toast('保存失败：' + error.message,'error');
    }else{
      const { data, error } = await sb.from(TABLE).insert(payload).select('id').single();
      if(error) return toast('保存失败：' + error.message,'error');
      item.id=data.id; item.cid = 'id:'+data.id;
    }
    item._dirty=false;
    dirty = rows.some(r=>r._dirty);
    try{ localStorage.removeItem(draftKey()); }catch{}
    toast('✅ 已保存并同步到云端');
    btn.classList.remove('warning');
    btn.classList.add('secondary');
  }catch(err){ toast('保存异常：' + (err?.message||err),'error'); }
  finally{ setSync(false); btn.disabled=false; }
}

async function removeRow(item){
  const idx=rows.indexOf(item); if(idx<0) return;
  if(!item.id){ rows.splice(idx,1); renderBody(); return; }
  setSync(true);
  try{
    const { error } = await sb.from(TABLE).delete().eq('id',item.id);
    if(error) return toast('删除失败：' + error.message,'error');
    rows.splice(idx,1); renderBody(); toast('🗑️ 已删除');
  }catch(err){ toast('删除异常：' + (err?.message||err),'error'); }
  finally{ setSync(false); }
}

/* ========= Excel (XLSX) ========= */
function exportXLSX() {
    const day = $('dateInput').value;
    // Prepare data in a format suitable for SheetJS (array of objects)
    const data = rows.map(it => ({
        '日期': day,
        '开始时间': it.start || '',
        '结束时间': it.end || '',
        '内容': it.content || '',
        '备注': it.note || ''
    }));

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "时间记录");

    // Trigger download
    XLSX.writeFile(workbook, `timelog_${day}.xlsx`, { bookType: 'xlsx', type: 'binary' });
}

function parseXLSX(data) {
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    if (!sheetName) return [];

    const worksheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(worksheet, { raw: false }); // raw:false helps with dates

    const out = [];
    const cur = $('dateInput').value;
    for (const row of json) {
        const startKey = Object.keys(row).find(k => /start|开始/i.test(k));
        const endKey = Object.keys(row).find(k => /end|结束/i.test(k));
        const contentKey = Object.keys(row).find(k => /content|内容/i.test(k));
        const noteKey = Object.keys(row).find(k => /note|备注/i.test(k));
        const dateKey = Object.keys(row).find(k => /date|日期/i.test(k));

        let entryDate = dateKey ? String(row[dateKey]) : cur;
        // Simple check for Excel's numeric date format, convert if needed
        if (!isNaN(entryDate) && Number(entryDate) > 25569) {
            const excelDate = new Date((Number(entryDate) - 25569) * 86400 * 1000);
            entryDate = toDayString(excelDate);
        } else if (/\d{1,2}\/\d{1,2}\/\d{2,4}/.test(entryDate)) { // Handle MM/DD/YYYY etc.
            entryDate = toDayString(new Date(entryDate));
        }

        if (entryDate !== cur) continue;

        const s = startKey ? String(row[startKey] || '') : '';
        const e = endKey ? String(row[endKey] || '') : '';
        out.push(ensureCid({ id: null, start: s, end: e, content: contentKey ? String(row[contentKey] || '') : '', note: noteKey ? String(row[noteKey] || '') : '', duration: dur(parseTime(s), parseTime(e)) }));
    }
    return out;
}


/* ========= 历史 ========= */
async function loadHistory(){
  if(!els.hist){ console.warn('historyList element missing'); return; }
  if(!session){ els.hist.textContent='—'; return; }

  const curStr=$('dateInput').value;
  const from=parseDay(curStr); from.setDate(from.getDate()-29);
  const fromStr=toDayString(from);

  setSync(true);
  try{
    const { data, error } = await sb.from(TABLE)
      .select(`${COL_DATE}, ${COL_DUR}`)
      .eq('user_id', session.user.id)
      .gte(COL_DATE, fromStr)
      .lte(COL_DATE, curStr);
    if(error){ toast('历史拉取失败：' + error.message,'error'); return; }

    const map=new Map();
    for(const r of (data||[])) map.set(r[COL_DATE], (map.get(r[COL_DATE])||0) + (r[COL_DUR]||0));
    const items=[...map.entries()].sort((a,b)=>a[0]<b[0]?1:-1);

    els.hist.innerHTML = items.length
      ? items.map(([d,s])=>`<div class="row"><div>${d}</div><div class="muted">合计：${fmt(s)}</div></div>`).join('')
      : '—';
  }catch(err){
    toast('历史同步异常：' + (err?.message||err),'error');
  }finally{
    setSync(false);
  }
}

/* ========= 视图切换：隐藏/显示 备注 + 时长 ========= */
function applyCompactUI(on){
  if(on){ $('grid').classList.add('compact'); $('toggleCols').textContent='显示备注与时长'; }
  else { $('grid').classList.remove('compact'); $('toggleCols').textContent='隐藏备注与时长'; }
  $('grid').scrollLeft = 0;
  try{ localStorage.setItem('hideNoteDur', on ? '1' : '0'); }catch{}
}

/* ========= 事件 ========= */
function addNewRowAndNotify(){
  rows.push(ensureCid({id:null,start:'',end:'',content:'',note:'',duration:0,_dirty:true}));
  dirty=true;
  renderBody();
  saveDraft();
  toast('已新增一行');
};
els.add.onclick = addNewRowAndNotify;
els.headerAdd.onclick = addNewRowAndNotify;

$('exportCsv').onclick=exportXLSX;
$('importCsv').onclick = () => $('csvFile').click();
$('csvFile').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
        const data = new Uint8Array(event.target.result);
        const list = parseXLSX(data);
        if (list.length === 0) return toast('Excel 文件中没有可导入的当前日期数据', 'error');
        rows.push(...list.map(it => ({ ...ensureCid(it), _dirty: true }))); renderBody(); saveDraft();
        toast(`已加入 ${list.length} 行，记得点“保存”写入云端`);
    } catch (err) {
        console.error("Import error:", err);
        toast('文件解析失败，请确保是有效的 Excel 文件', 'error');
    }
  };
  reader.onerror = () => toast('读取文件失败', 'error');
  reader.readAsArrayBuffer(f);
  e.target.value = '';
};

$('refreshBtn').onclick=()=>fetchRowsByDate($('dateInput').value,{mode:'merge', tip:true});
els.rehist.onclick=loadHistory;
$('toggleCols').onclick=()=>applyCompactUI(!$('grid').classList.contains('compact'));

/* ========= 认证监听 & 初始化 ========= */
// 自动刷新：仅无草稿时才拉，避免覆盖
sb.auth.onAuthStateChange((event,sess)=>{
  session=sess;applySessionUI();
  if(!session){ rows=[]; renderBody(); return; }
  fetchRowsByDate($('dateInput').value, {mode:'auto', tip:true});
});

(async function init(){
  const today=new Date(); $('dateInput').value=today.toISOString().slice(0,10);
  const { data } = await sb.auth.getSession();
  session=data.session||null; applySessionUI();

  // 手机默认紧凑；桌面记忆上次
  const remembered = (()=>{ try{ return localStorage.getItem('hideNoteDur'); }catch{ return null; }})();
  const isSmall = window.matchMedia('(max-width: 480px)').matches;
  applyCompactUI(remembered ? remembered==='1' : isSmall);

  // 切日期：先覆盖拉云端，再恢复草稿
  $('dateInput').onchange=async ()=>{
    saveDraft();            // 先存走当前日期草稿
    rows = []; dirty=false; renderBody();
    if(session){ await fetchRowsByDate($('dateInput').value, {mode:'overwrite'}); }
    loadHistory(); restoreDraft();
  };

  // 初始：覆盖拉云端，然后恢复草稿（浏览器刷新后就能云端+草稿同时出现）
  if(session){ await fetchRowsByDate($('dateInput').value, {mode:'overwrite'}); loadHistory(); }
  restoreDraft();

  // 页面隐藏/显示：隐藏立即存草稿；显示只恢复（不强制拉），避免误覆盖
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden) saveDraft();
    else restoreDraft();
  });
  window.addEventListener('pagehide', saveDraft);
  window.addEventListener('pageshow', ()=>{ restoreDraft(); });
})();
</script>
</body>
</html>
