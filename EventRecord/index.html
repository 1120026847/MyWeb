<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>时间记录表 · Excel 风格 · Supabase 同步</title>

<!-- Supabase v2（非模块） -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

<style>
  :root { --grid:#e5e7eb; --header:#f8fafc; --accent:#4caf50; --blue:#2196f3; --red:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Microsoft Yahei','Noto Sans SC',sans-serif;background:#f5f7fb;color:#111}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .auth input{padding:8px 10px;border:1px solid #ddd;border-radius:8px;min-width:160px}
  .btn{padding:8px 12px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .pill{padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#555}
  .wrap{max-width:1100px;margin:20px auto;background:#fff;border-radius:14px;box-shadow:0 10px 20px rgba(0,0,0,.06);padding:16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .toolbar .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .sheet{margin-top:12px;border:1px solid var(--grid);border-radius:10px;overflow:auto}
  table{border-collapse:collapse;width:100%;table-layout:fixed}
  thead{background:var(--header);position:sticky;top:0;z-index:1}
  th,td{border:1px solid var(--grid);padding:6px}
  th{font-weight:700;text-align:center}
  td input[type="time"]{width:100%;border:none;outline:none;background:transparent;padding:2px}
  td input[type="text"]{width:100%;border:none;outline:none;background:transparent;padding:2px}
  td .num{font-feature-settings:"tnum";font-variant-numeric:tabular-nums}
  tr:nth-child(even) td{background:#fafafa}
  .danger{color:#fff;background:var(--red);border-color:var(--red)}
  .blue{background:var(--blue);border-color:var(--blue);color:#fff}
  .muted{color:#777}
  .status{display:flex;gap:8px;align-items:center}
  .foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:#555}
</style>
</head>
<body>
<header>
  <div class="status">
    <strong>📅 时间记录表</strong>
    <span class="pill" id="syncBadge">未登录</span>
  </div>
  <div class="auth">
    <div id="signed-out" style="display:flex;gap:8px;align-items:center">
      <input type="email" id="email" placeholder="邮箱" />
      <input type="password" id="password" placeholder="密码（≥6位）" />
      <!-- 兜底：type=button + onclick，避免表单提交刷新 -->
      <button class="btn" id="btnSignUp" type="button" onclick="return __signup()">注册</button>
      <button class="btn primary" id="btnSignIn" type="button" onclick="return __signin()">登录</button>
    </div>
    <div id="signed-in" style="display:none;gap:8px;align-items:center">
      <span class="pill" id="userEmail"></span>
      <button class="btn" id="btnSignOut" type="button" onclick="return __signout()">退出</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="toolbar">
    <div>
      日期：
      <input type="date" id="dayPicker" />
      <button class="btn" id="btnToday" type="button">今天</button>
      <span class="muted">（切换日期 = 切换当日表）</span>
    </div>

    <div class="right">
      <button class="btn" id="btnAdd" type="button">新增行</button>
      <button class="btn" id="btnDelete" type="button">删除勾选行</button>
      <button class="btn blue" id="btnLoadCloud" type="button">从云端载入当天</button>
      <button class="btn primary" id="btnSaveCloud" type="button">保存当天到云端</button>
    </div>
  </div>

  <div class="sheet">
    <table>
      <thead>
        <tr>
          <th style="width:44px"><input type="checkbox" id="checkAll"/></th>
          <th style="width:120px">开始时间</th>
          <th style="width:120px">结束时间</th>
          <th>内容</th>
          <th style="width:240px">备注</th>
          <th style="width:120px">时长</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="foot">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="file" id="fileInput" hidden />
      <button class="btn" id="btnImportDay" type="button">导入当天（JSON/CSV）</button>
      <button class="btn" id="btnExportDayCSV" type="button">导出当天 CSV</button>
      <button class="btn" id="btnExportDayJSON" type="button">导出当天 JSON</button>
      <span class="muted">CSV 字段：开始时间,结束时间,内容,备注（建议不含逗号）</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="btnImportMonth" type="button">导入当月（JSON/CSV）</button>
      <button class="btn" id="btnExportMonthCSV" type="button">导出当月 CSV</button>
      <button class="btn" id="btnExportMonthJSON" type="button">导出当月 JSON</button>
    </div>
  </div>
</main>

<script>
/* ================== Supabase 配置 ================== */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

/* ============ 全局（给内联 onclick 用） ============ */
let __sb = null;       // Supabase client
let __user = null;

/* 等待 supabase-js 可用，再创建 client（最稳） */
function waitSupabaseReady(timeoutMs=5000){
  return new Promise((resolve, reject)=>{
    const t0 = Date.now();
    const tick = ()=>{
      if (window.supabase?.createClient){
        __sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
        });
        return resolve(__sb);
      }
      if (Date.now()-t0 > timeoutMs) return reject(new Error('supabase-js 加载超时'));
      setTimeout(tick, 50);
    };
    tick();
  });
}

/* 兜底：若被别处调用，确保拿到 client */
function ensureClient(){ return __sb || (window.supabase?.createClient ? (__sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)) : null); }

/* =============== 全局：状态徽标 & UI =============== */
function updateBadge(){
  const el = document.getElementById('syncBadge');
  if(!el) return;
  const online = navigator.onLine;
  const pending = JSON.parse(localStorage.getItem('grid_pending')||'[]').length;
  const parts = [];
  parts.push(online?'🟢 在线':'🔴 离线');
  parts.push(__user ? '已登录' : '未登录');
  if(__user) parts.push(pending>0 ? `待同步(${pending})` : '已同步');
  el.textContent = parts.join(' · ');
}

function updateAuthUI(){
  const out = document.getElementById('signed-out');
  const _in = document.getElementById('signed-in');
  const mail = document.getElementById('userEmail');
  if(__user){
    if(out) out.style.display='none';
    if(_in) _in.style.display='flex';
    if(mail) mail.textContent = __user.email || '已登录';
  }else{
    if(out) out.style.display='flex';
    if(_in) _in.style.display='none';
  }
  updateBadge();
}

/* =============== 全局：离线队列同步 =============== */
function queuePending(payload){
  const q = JSON.parse(localStorage.getItem('grid_pending')||'[]');
  q.push(payload);
  localStorage.setItem('grid_pending', JSON.stringify(q));
  updateBadge();
}

async function flushPending(){
  if(!__user) return;
  const sb = ensureClient();
  const q = JSON.parse(localStorage.getItem('grid_pending')||'[]');
  if(q.length===0){ updateBadge(); return; }
  for(const it of q){
    if(it.type==='saveDay'){
      const del = await sb.from('event_grid').delete().match({ user_id: __user.id, d: it.d });
      if(del.error){ console.warn('flush del fail', del.error.message); return; }
      const ins = await sb.from('event_grid').insert(it.rows);
      if(ins.error){ console.warn('flush ins fail', ins.error.message); return; }
    }
  }
  localStorage.removeItem('grid_pending');
  updateBadge();
}

/* ============== 全局：登录相关（硬化） ============== */
/* 强制拉会话并刷新 UI —— 登录/注册/退出后都调用一次 */
async function forceRefreshAuthUI() {
  const sb = ensureClient(); if (!sb) return;
  try {
    const { data: { session } } = await sb.auth.getSession();
    __user = session?.user || null;
    if (!__user) {
      const { data: ures } = await sb.auth.getUser();
      __user = ures?.user || null;
    }
  } catch {
    __user = null;
  }
  updateAuthUI();
  if (__user) flushPending(); // 登录后尝试同步队列
}

/* 登录：直接用返回结果更新 UI（不再只依赖 onAuthStateChange） */
async function __signin(){
  try{
    const sb = ensureClient();
    if(!sb){ alert('supabase-js 尚未就绪，请稍后再试或刷新页面'); return false; }
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) throw error;
    __user = data?.user || data?.session?.user || null;   // 关键：立刻用返回数据更新
    updateAuthUI();
    // 双保险：再拉一次会话（避免极端时序）
    await forceRefreshAuthUI();
  }catch(err){
    alert('登录失败：'+(err?.message||err));
  }
  return false;
}

async function __signup(){
  try{
    const sb = ensureClient();
    if(!sb){ alert('supabase-js 尚未就绪，请稍后再试或刷新页面'); return false; }
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const { error } = await sb.auth.signUp({ email, password });
    if(error) throw error;
    alert('注册成功：若开启邮箱验证，请先去邮箱确认再登录');
    await forceRefreshAuthUI();
  }catch(err){
    alert('注册失败：'+(err?.message||err));
  }
  return false;
}

async function __signout(){
  try{
    const sb = ensureClient();
    if(sb) await sb.auth.signOut();
    __user = null;
    updateAuthUI();
  }catch(err){
    alert('退出失败：'+(err?.message||err));
  }
  return false;
}

/* ================= 页面主逻辑 ================= */
window.addEventListener('DOMContentLoaded', () => {
  (async function initPage(){
    // 1) 等 supabase-js
    try { await waitSupabaseReady(); } catch(e){ console.warn(e.message); }

    let rows = []; // [{start_t:'HH:MM:SS', end_t:'HH:MM:SS', content:'', note:''}]
    const els = {
      dayPicker: document.getElementById('dayPicker'),
      btnToday: document.getElementById('btnToday'),
      tbody: document.getElementById('tbody'),
      checkAll: document.getElementById('checkAll'),

      btnAdd: document.getElementById('btnAdd'),
      btnDelete: document.getElementById('btnDelete'),
      btnSaveCloud: document.getElementById('btnSaveCloud'),
      btnLoadCloud: document.getElementById('btnLoadCloud'),

      btnImportDay: document.getElementById('btnImportDay'),
      btnExportDayCSV: document.getElementById('btnExportDayCSV'),
      btnExportDayJSON: document.getElementById('btnExportDayJSON'),

      btnImportMonth: document.getElementById('btnImportMonth'),
      btnExportMonthCSV: document.getElementById('btnExportMonthCSV'),
      btnExportMonthJSON: document.getElementById('btnExportMonthJSON'),

      fileInput: document.getElementById('fileInput'),

      btnSignUp: document.getElementById('btnSignUp'),
      btnSignIn: document.getElementById('btnSignIn'),
      btnSignOut: document.getElementById('btnSignOut'),
    };

    // ---- 小工具 ----
    const pad = n => String(n).padStart(2,'0');
    const todayStr = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const monthEnd = d => new Date(d.getFullYear(), d.getMonth()+1, 0);
    const keyDay = dstr => `sheet:${dstr}`;
    const parseTime = t => { if(!t) return null; if(/^\d{1,2}:\d{2}$/.test(t)) return `${t}:00`; if(/^\d{1,2}:\d{2}:\d{2}$/.test(t)) return t; return null; };
    function durMs(a,b){ if(!a||!b) return 0; const [ah,am,as]=a.split(':').map(Number); const [bh,bm,bs]=b.split(':').map(Number); return ((bh*3600+bm*60+bs)-(ah*3600+am*60+as))*1000; }
    function fmtDur(ms){ const s=Math.max(0,Math.floor(ms/1000)); const sec=s%60; const min=Math.floor(s/60)%60; const hr=Math.floor(s/3600); if(hr>0) return `${hr}时 ${min}分 ${sec}秒`; if(min>0) return `${min}分 ${sec}秒`; return `${sec}秒`; }
    function csvEscape(v){ if(v==null) v=''; v=String(v); if(/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`; return v; }
    function csvParseLine(line){ const out=[]; let i=0; while(i<line.length){ if(line[i]==='"'){ let j=i+1, s=''; while(j<line.length){ if(line[j]==='"' && line[j+1]==='"'){ s+='"'; j+=2; } else if(line[j]==='"'){ j++; break; } else { s+=line[j++]; } } out.push(s); if(line[j]===',') j++; i=j; } else { let j=i; while(j<line.length && line[j]!==',') j++; out.push(line.slice(i,j)); i=j+1; } } return out; }
    function download(blob, name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

    // ---- 本地存取 ----
    function loadLocal(dstr){ try{ rows = JSON.parse(localStorage.getItem(keyDay(dstr))||'[]'); }catch{ rows=[]; } }
    function saveLocal(dstr){ localStorage.setItem(keyDay(dstr), JSON.stringify(rows)); updateBadge(); }

    // ---- 渲染 ----
    function render(){
      els.tbody.innerHTML='';
      rows.forEach((r,idx)=>{
        const tr=document.createElement('tr');

        const tdSel=document.createElement('td');
        tdSel.innerHTML=`<input type="checkbox" data-idx="${idx}" class="rowchk" />`;
        tr.appendChild(tdSel);

        const tdStart=document.createElement('td');
        tdStart.innerHTML=`<input type="time" step="1" value="${r.start_t||''}" />`;
        tdStart.firstChild.onchange=e=>{ r.start_t=parseTime(e.target.value); saveLocal(els.dayPicker.value); render(); };
        tr.appendChild(tdStart);

        const tdEnd=document.createElement('td');
        tdEnd.innerHTML=`<input type="time" step="1" value="${r.end_t||''}" />`;
        tdEnd.firstChild.onchange=e=>{ r.end_t=parseTime(e.target.value); saveLocal(els.dayPicker.value); render(); };
        tr.appendChild(tdEnd);

        const tdContent=document.createElement('td');
        tdContent.innerHTML=`<input type="text" value="${r.content||''}" placeholder="输入内容..."/>`;
        tdContent.firstChild.oninput=e=>{ r.content=e.target.value; saveLocal(els.dayPicker.value); };
        tr.appendChild(tdContent);

        const tdNote=document.createElement('td');
        tdNote.innerHTML=`<input type="text" value="${r.note||''}" placeholder="备注（可空）"/>`;
        tdNote.firstChild.oninput=e=>{ r.note=e.target.value; saveLocal(els.dayPicker.value); };
        tr.appendChild(tdNote);

        const tdDur=document.createElement('td');
        const ms=durMs(r.start_t,r.end_t);
        tdDur.innerHTML=`<span class="num">${fmtDur(ms)}</span>`;
        if(ms<0) tdDur.style.color='var(--red)';
        tr.appendChild(tdDur);

        els.tbody.appendChild(tr);
      });
    }

    // ---- 绑定 UI ----
    function bindUI(){
      els.dayPicker.value = todayStr();
      loadLocal(els.dayPicker.value); render(); updateBadge();

      els.btnToday.onclick = ()=>{ els.dayPicker.value=todayStr(); loadLocal(els.dayPicker.value); render(); };
      els.dayPicker.onchange = ()=>{ loadLocal(els.dayPicker.value); render(); };

      els.btnAdd.onclick = ()=>{ rows.push({start_t:'',end_t:'',content:'',note:''}); saveLocal(els.dayPicker.value); render(); };
      els.checkAll.onclick = e=>{ document.querySelectorAll('.rowchk').forEach(ch=>ch.checked=e.target.checked); };
      els.btnDelete.onclick = ()=>{
        const keep=[]; document.querySelectorAll('.rowchk').forEach((ch,i)=>{ if(!ch.checked) keep.push(rows[i]); });
        rows = keep; saveLocal(els.dayPicker.value); render();
      };

      // 当天导入/导出
      els.btnImportDay.onclick = ()=>{ els.fileInput.accept=".json,.csv"; els.fileInput.onchange = onImportDay; els.fileInput.click(); };
      els.btnExportDayCSV.onclick = ()=>{
        const lines = rows.map(r=>[r.start_t||'',r.end_t||'',r.content||'',r.note||''].map(csvEscape).join(','));
        const csv = `开始时间,结束时间,内容,备注\n${lines.join('\n')}`;
        download(new Blob([csv],{type:'text/csv;charset=utf-8'}), `${els.dayPicker.value}_events.csv`);
      };
      els.btnExportDayJSON.onclick = ()=>{
        download(new Blob([JSON.stringify(rows,null,2)],{type:'application/json'}), `${els.dayPicker.value}_events.json`);
      };

      // 当月导入/导出
      els.btnImportMonth.onclick = ()=>{ els.fileInput.accept=".json,.csv"; els.fileInput.onchange = onImportMonth; els.fileInput.click(); };
      els.btnExportMonthCSV.onclick = exportMonthCSV;
      els.btnExportMonthJSON.onclick = exportMonthJSON;

      // 云端
      els.btnSaveCloud.onclick = saveDayToCloud;
      els.btnLoadCloud.onclick = loadDayFromCloud;

      // 网络状态
      window.addEventListener('online', ()=>{ updateBadge(); flushPending(); });
      window.addEventListener('offline', updateBadge);
    }

    // ---- 导入实现 ----
    async function onImportDay(ev){
      const file = ev.target.files[0]; ev.target.value='';
      if(!file) return;
      const text = await file.text();
      if(file.name.toLowerCase().endsWith('.json')){
        try{ rows = JSON.parse(text)||[]; }catch{ alert('JSON 解析失败'); return; }
      }else{
        const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim()!=='');
        if(lines.length && /开始.*结束.*内容/.test(lines[0])) lines.shift();
        rows = lines.map(line=>{
          const cols = csvParseLine(line).map(s=>s.trim());
          return { start_t:parseTime(cols[0]), end_t:parseTime(cols[1]), content:cols[2]||'', note:cols[3]||'' };
        });
      }
      saveLocal(els.dayPicker.value); render();
    }

    async function onImportMonth(ev){
      const file = ev.target.files[0]; ev.target.value='';
      if(!file) return;
      const text = await file.text();
      let list = [];
      if(file.name.toLowerCase().endsWith('.json')){
        try{ list = JSON.parse(text)||[]; }catch{ alert('JSON 解析失败'); return; }
        // 期望：[{date:'YYYY-MM-DD', start_t, end_t, content, note}]
      }else{
        const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim()!=='');
        if(lines.length && /日期.*开始.*结束.*内容/.test(lines[0])) lines.shift();
        list = lines.map(line=>{
          const c = csvParseLine(line).map(s=>s.trim());
          return { date: c[0], start_t:parseTime(c[1]), end_t:parseTime(c[2]), content:c[3]||'', note:c[4]||'' };
        });
      }
      const byDay = {};
      for(const r of list){ if(!r?.date) continue; (byDay[r.date] ??= []).push({start_t:r.start_t,end_t:r.end_t,content:r.content||'',note:r.note||''}); }
      Object.keys(byDay).forEach(d=> localStorage.setItem(keyDay(d), JSON.stringify(byDay[d])) );
      if(byDay[els.dayPicker.value]){ loadLocal(els.dayPicker.value); render(); }
      alert('导入当月完成（本地缓存）');
    }

    // ---- 当月导出 ----
    async function exportMonthCSV(){
      const d = new Date(els.dayPicker.value);
      const y=d.getFullYear(), m=d.getMonth()+1;
      let data = [];
      if(__user){
        const { data:cloud, error } = await ensureClient().from('event_grid')
          .select('d,start_t,end_t,content,note')
          .eq('user_id', __user.id)
          .gte('d', `${y}-${pad(m)}-01`)
          .lte('d', `${y}-${pad(m)}-${pad(monthEnd(d).getDate())}`)
          .order('d',{ascending:true}).order('start_t',{ascending:true});
        if(error){ alert('云端导出失败：'+error.message); return; }
        data = cloud || [];
      }else{
        const days = monthEnd(d).getDate();
        for(let day=1; day<=days; day++){
          const ds = `${y}-${pad(m)}-${pad(day)}`;
          const arr = JSON.parse(localStorage.getItem(keyDay(ds))||'[]');
          arr.forEach(r=> data.push({d:ds, ...r}));
        }
      }
      const lines = data.map(r=>[r.d, r.start_t||'', r.end_t||'', r.content||'', r.note||''].map(csvEscape).join(','));
      const csv = `日期,开始时间,结束时间,内容,备注\n${lines.join('\n')}`;
      download(new Blob([csv],{type:'text/csv;charset=utf-8'}), `${y}-${pad(m)}_整月时间.csv`);
    }

    async function exportMonthJSON(){
      const d = new Date(els.dayPicker.value);
      const y=d.getFullYear(), m=d.getMonth()+1;
      let data = [];
      if(__user){
        const { data:cloud, error } = await ensureClient().from('event_grid')
          .select('d,start_t,end_t,content,note')
          .eq('user_id', __user.id)
          .gte('d', `${y}-${pad(m)}-01`)
          .lte('d', `${y}-${pad(m)}-${pad(monthEnd(d).getDate())}`)
          .order('d',{ascending:true}).order('start_t',{ascending:true});
        if(error){ alert('云端导出失败：'+error.message); return; }
        data = cloud || [];
      }else{
        const days = monthEnd(d).getDate();
        for(let day=1; day<=days; day++){
          const ds = `${y}-${pad(m)}-${pad(day)}`;
          const arr = JSON.parse(localStorage.getItem(keyDay(ds))||'[]');
          arr.forEach(r=> data.push({d:ds, ...r}));
        }
      }
      download(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}), `${y}-${pad(m)}_整月时间.json`);
    }

    // ---- 云端：保存/读取当天（含“离线入队”） ----
    async function saveDayToCloud(){
      if(!__user){ alert('请先登录'); return; }
      const dstr = els.dayPicker.value;

      // 组装有效行
      const rowsReady = rows
        .filter(r=>r.start_t && r.end_t && (r.content||'').trim())
        .map(r=>({ user_id: __user.id, d:dstr, start_t:r.start_t, end_t:r.end_t, content:r.content.trim(), note:r.note||'' }));

      if(rowsReady.length===0){ alert('没有可保存的行'); return; }

      // 离线：入队待同步
      if(!navigator.onLine){
        queuePending({ type:'saveDay', d:dstr, rows:rowsReady });
        alert('已离线：此次保存加入待同步队列');
        return;
      }

      const sb = ensureClient();
      const del = await sb.from('event_grid').delete().match({ user_id: __user.id, d: dstr });
      if(del.error){ alert('删除旧记录失败：'+del.error.message); return; }
      const ins = await sb.from('event_grid').insert(rowsReady);
      if(ins.error){ alert('插入失败：'+ins.error.message); return; }
      alert('已保存到云端');
    }

    async function loadDayFromCloud(){
      if(!__user){ alert('请先登录'); return; }
      const sb = ensureClient();
      const dstr = els.dayPicker.value;
      const { data, error } = await sb.from('event_grid')
        .select('start_t,end_t,content,note')
        .eq('user_id', __user.id).eq('d', dstr)
        .order('start_t',{ascending:true});
      if(error){ alert('载入失败：'+error.message); return; }
      rows = (data||[]).map(r=>({start_t:r.start_t,end_t:r.end_t,content:r.content||'',note:r.note||''}));
      saveLocal(dstr); render();
    }

    // ---- Auth & 事件 ----
    async function initAuth(){
      const sb = ensureClient();
      // 首次刷新会话
      await forceRefreshAuthUI();

      // 监听会话变化（保留）
      sb.auth.onAuthStateChange((_event, session) => {
        __user = session?.user || null;
        updateAuthUI();
      });

      // 监听本地存储（跨标签/SDK异步写入）
      window.addEventListener('storage', (e) => {
        if (e.key && e.key.includes('auth-token')) forceRefreshAuthUI();
      });

      // 再绑定一次（与内联兜底重复绑定没关系）
      els.btnSignUp.onclick = __signup;
      els.btnSignIn.onclick = __signin;
      els.btnSignOut.onclick = __signout;
    }

    // ---- 初始化 ----
    function initUI(){
      bindUI();
      initAuth();
      window.addEventListener('online', ()=>{ updateBadge(); flushPending(); });
      window.addEventListener('offline', updateBadge);
    }

    // 开始
    initUI();
  })();
});
</script>
</body>
</html>
