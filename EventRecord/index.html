<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ—¶é—´è®°å½•ï¼ˆæœˆè¡¨/æ—¥è¡¨ Â· Excel é£æ ¼ Â· Supabase åŒæ­¥ï¼‰</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root { --grid:#e5e7eb; --header:#f8fafc; --accent:#4caf50; --blue:#2196f3; --red:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Microsoft Yahei','Noto Sans SC',sans-serif;background:#f5f7fb;color:#111}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .auth input{padding:8px 10px;border:1px solid #ddd;border-radius:8px;min-width:160px}
  .btn{padding:8px 12px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .pill{padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#555}
  .wrap{max-width:1100px;margin:20px auto;background:#fff;border-radius:14px;box-shadow:0 10px 20px rgba(0,0,0,.06);padding:16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .toolbar .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .sheet{margin-top:12px;border:1px solid var(--grid);border-radius:10px;overflow:auto}
  table{border-collapse:collapse;width:100%;table-layout:fixed}
  thead{background:var(--header);position:sticky;top:0;z-index:1}
  th,td{border:1px solid var(--grid);padding:6px}
  th{font-weight:700;text-align:center}
  td input[type="time"]{width:100%;border:none;outline:none;background:transparent;padding:2px}
  td input[type="text"]{width:100%;border:none;outline:none;background:transparent;padding:2px}
  td .num{font-feature-settings:"tnum";font-variant-numeric:tabular-nums}
  tr:nth-child(even) td{background:#fafafa}
  .danger{color:#fff;background:var(--red);border-color:var(--red)}
  .blue{background:var(--blue);border-color:var(--blue);color:#fff}
  .muted{color:#777}
  .status{display:flex;gap:8px;align-items:center}
  .foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:#555}
</style>
</head>
<body>
<header>
  <div class="status">
    <strong>ğŸ“… æ—¶é—´è®°å½•è¡¨</strong>
    <span class="pill" id="syncBadge">æœªç™»å½•</span>
  </div>
  <div class="auth">
    <div id="signed-out" style="display:flex;gap:8px;align-items:center">
      <input type="email" id="email" placeholder="é‚®ç®±" />
      <input type="password" id="password" placeholder="å¯†ç ï¼ˆâ‰¥6ä½ï¼‰" />
      <button class="btn" id="btnSignUp">æ³¨å†Œ</button>
      <button class="btn primary" id="btnSignIn">ç™»å½•</button>
    </div>
    <div id="signed-in" style="display:none;gap:8px;align-items:center">
      <span class="pill" id="userEmail"></span>
      <button class="btn" id="btnSignOut">é€€å‡º</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="toolbar">
    <div>
      æ—¥æœŸï¼š
      <input type="date" id="dayPicker" />
      <button class="btn" id="btnToday">ä»Šå¤©</button>
      <span class="muted">ï¼ˆåˆ‡æ¢æ—¥æœŸ = åˆ‡æ¢å½“æ—¥è¡¨ï¼‰</span>
    </div>

    <div class="right">
      <button class="btn" id="btnAdd">æ–°å¢è¡Œ</button>
      <button class="btn" id="btnDelete">åˆ é™¤å‹¾é€‰è¡Œ</button>
      <button class="btn blue" id="btnLoadCloud">ä»äº‘ç«¯è½½å…¥å½“å¤©</button>
      <button class="btn primary" id="btnSaveCloud">ä¿å­˜å½“å¤©åˆ°äº‘ç«¯</button>
    </div>
  </div>

  <div class="sheet">
    <table>
      <thead>
        <tr>
          <th style="width:44px"><input type="checkbox" id="checkAll"/></th>
          <th style="width:120px">å¼€å§‹æ—¶é—´</th>
          <th style="width:120px">ç»“æŸæ—¶é—´</th>
          <th>å†…å®¹</th>
          <th style="width:240px">å¤‡æ³¨</th>
          <th style="width:120px">æ—¶é•¿</th>
        </tr>
      </thead>
      <tbody id="tbody">
      </tbody>
    </table>
  </div>

  <div class="foot">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="file" id="fileInput" hidden />
      <button class="btn" id="btnImportDay">å¯¼å…¥å½“å¤©ï¼ˆJSON/CSVï¼‰</button>
      <button class="btn" id="btnExportDayCSV">å¯¼å‡ºå½“å¤© CSV</button>
      <button class="btn" id="btnExportDayJSON">å¯¼å‡ºå½“å¤© JSON</button>
      <span class="muted">CSV å­—æ®µï¼šå¼€å§‹æ—¶é—´,ç»“æŸæ—¶é—´,å†…å®¹,å¤‡æ³¨ï¼ˆå»ºè®®ä¸å«é€—å·ï¼‰</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="btnImportMonth">å¯¼å…¥å½“æœˆï¼ˆJSON/CSVï¼‰</button>
      <button class="btn" id="btnExportMonthCSV">å¯¼å‡ºå½“æœˆ CSV</button>
      <button class="btn" id="btnExportMonthJSON">å¯¼å‡ºå½“æœˆ JSON</button>
    </div>
  </div>
</main>

<script>
/* =================== Supabaseï¼ˆä½ çš„é¡¹ç›®é…ç½®ï¼‰ =================== */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});

/* =================== çŠ¶æ€ & å…ƒç´  =================== */
let currentUser = null;
let rows = []; // [{start_t:'HH:MM:SS', end_t:'HH:MM:SS', content:'', note:''}]
const els = {
  dayPicker: document.getElementById('dayPicker'),
  btnToday: document.getElementById('btnToday'),
  tbody: document.getElementById('tbody'),
  checkAll: document.getElementById('checkAll'),

  btnAdd: document.getElementById('btnAdd'),
  btnDelete: document.getElementById('btnDelete'),
  btnSaveCloud: document.getElementById('btnSaveCloud'),
  btnLoadCloud: document.getElementById('btnLoadCloud'),

  btnImportDay: document.getElementById('btnImportDay'),
  btnExportDayCSV: document.getElementById('btnExportDayCSV'),
  btnExportDayJSON: document.getElementById('btnExportDayJSON'),

  btnImportMonth: document.getElementById('btnImportMonth'),
  btnExportMonthCSV: document.getElementById('btnExportMonthCSV'),
  btnExportMonthJSON: document.getElementById('btnExportMonthJSON'),

  fileInput: document.getElementById('fileInput'),

  // auth
  signedOut: document.getElementById('signed-out'),
  signedIn: document.getElementById('signed-in'),
  userEmail: document.getElementById('userEmail'),
  syncBadge: document.getElementById('syncBadge'),
};

/* =================== å·¥å…·å‡½æ•° =================== */
const pad = n => String(n).padStart(2,'0');
const todayStr = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
const monthStart = d => new Date(d.getFullYear(), d.getMonth(), 1);
const monthEnd   = d => new Date(d.getFullYear(), d.getMonth()+1, 0);
const keyDay = dstr => `sheet:${dstr}`;
const parseTime = t => {
  if(!t) return null;
  if(/^\d{1,2}:\d{2}$/.test(t)) return `${t}:00`;
  if(/^\d{1,2}:\d{2}:\d{2}$/.test(t)) return t;
  return null;
};
function durMs(a,b){ if(!a||!b) return 0; const [ah,am,as]=a.split(':').map(Number); const [bh,bm,bs]=b.split(':').map(Number); return ((bh*3600+bm*60+bs)-(ah*3600+am*60+as))*1000; }
function fmtDur(ms){ const s=Math.max(0,Math.floor(ms/1000)); const sec=s%60; const min=Math.floor(s/60)%60; const hr=Math.floor(s/3600); if(hr>0) return `${hr}æ—¶ ${min}åˆ† ${sec}ç§’`; if(min>0) return `${min}åˆ† ${sec}ç§’`; return `${sec}ç§’`; }
function csvEscape(v){ if(v==null) v=''; v=String(v); if(/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`; return v; }
function csvParseLine(line){ // ç®€å• CSV è¡Œè§£æï¼ˆä¸æ”¯æŒæ¢è¡Œå†…åµŒï¼‰
  const out=[]; let i=0; while(i<line.length){ if(line[i]==='"'){ let j=i+1, s=''; while(j<line.length){ if(line[j]==='"' && line[j+1]==='"'){ s+='"'; j+=2; } else if(line[j]==='"'){ j++; break; } else { s+=line[j++]; } } out.push(s); if(line[j]===',') j++; i=j; } else { let j=i; while(j<line.length && line[j]!==',') j++; out.push(line.slice(i,j)); i=j+1; } } return out; }

/* =================== æœ¬åœ°å­˜å– =================== */
function loadLocal(dstr){ try{ rows = JSON.parse(localStorage.getItem(keyDay(dstr))||'[]'); }catch{ rows=[]; } }
function saveLocal(dstr){ localStorage.setItem(keyDay(dstr), JSON.stringify(rows)); updateBadge(); }

/* =================== æ¸²æŸ“è¡¨æ ¼ =================== */
function render(){
  els.tbody.innerHTML='';
  rows.forEach((r,idx)=>{
    const tr=document.createElement('tr');

    const tdSel=document.createElement('td');
    tdSel.innerHTML=`<input type="checkbox" data-idx="${idx}" class="rowchk" />`;
    tr.appendChild(tdSel);

    const tdStart=document.createElement('td');
    tdStart.innerHTML=`<input type="time" step="1" value="${r.start_t||''}" />`;
    tdStart.firstChild.onchange=e=>{ r.start_t=parseTime(e.target.value); saveLocal(els.dayPicker.value); render(); };
    tr.appendChild(tdStart);

    const tdEnd=document.createElement('td');
    tdEnd.innerHTML=`<input type="time" step="1" value="${r.end_t||''}" />`;
    tdEnd.firstChild.onchange=e=>{ r.end_t=parseTime(e.target.value); saveLocal(els.dayPicker.value); render(); };
    tr.appendChild(tdEnd);

    const tdContent=document.createElement('td');
    tdContent.innerHTML=`<input type="text" value="${r.content||''}" placeholder="è¾“å…¥å†…å®¹..."/>`;
    tdContent.firstChild.oninput=e=>{ r.content=e.target.value; saveLocal(els.dayPicker.value); };
    tr.appendChild(tdContent);

    const tdNote=document.createElement('td');
    tdNote.innerHTML=`<input type="text" value="${r.note||''}" placeholder="å¤‡æ³¨ï¼ˆå¯ç©ºï¼‰"/>`;
    tdNote.firstChild.oninput=e=>{ r.note=e.target.value; saveLocal(els.dayPicker.value); };
    tr.appendChild(tdNote);

    const tdDur=document.createElement('td');
    const ms=durMs(r.start_t,r.end_t);
    tdDur.innerHTML=`<span class="num">${fmtDur(ms)}</span>`;
    if(ms<0) tdDur.style.color='var(--red)';
    tr.appendChild(tdDur);

    els.tbody.appendChild(tr);
  });
}

/* =================== äº‹ä»¶ç»‘å®š =================== */
function bindUI(){
  els.dayPicker.value = todayStr();
  loadLocal(els.dayPicker.value); render(); updateBadge();

  els.btnToday.onclick = ()=>{ els.dayPicker.value=todayStr(); loadLocal(els.dayPicker.value); render(); };
  els.dayPicker.onchange = ()=>{ loadLocal(els.dayPicker.value); render(); };

  els.btnAdd.onclick = ()=>{ rows.push({start_t:'',end_t:'',content:'',note:''}); saveLocal(els.dayPicker.value); render(); };
  els.checkAll.onclick = e=>{
    document.querySelectorAll('.rowchk').forEach(ch=>ch.checked=e.target.checked);
  };
  els.btnDelete.onclick = ()=>{
    const keep=[]; document.querySelectorAll('.rowchk').forEach((ch,i)=>{ if(!ch.checked) keep.push(rows[i]); });
    rows = keep; saveLocal(els.dayPicker.value); render();
  };

  // å¯¼å…¥/å¯¼å‡ºï¼ˆå½“å¤©ï¼‰
  els.btnImportDay.onclick = ()=>{ els.fileInput.accept=".json,.csv"; els.fileInput.onchange = onImportDay; els.fileInput.click(); };
  els.btnExportDayCSV.onclick = ()=>{
    const lines = rows.map(r=>[r.start_t||'',r.end_t||'',r.content||'',r.note||''].map(csvEscape).join(','));
    const csv = `å¼€å§‹æ—¶é—´,ç»“æŸæ—¶é—´,å†…å®¹,å¤‡æ³¨\n${lines.join('\n')}`;
    download(new Blob([csv],{type:'text/csv;charset=utf-8'}), `${els.dayPicker.value}_events.csv`);
  };
  els.btnExportDayJSON.onclick = ()=>{
    download(new Blob([JSON.stringify(rows,null,2)],{type:'application/json'}), `${els.dayPicker.value}_events.json`);
  };

  // å¯¼å…¥/å¯¼å‡ºï¼ˆå½“æœˆï¼‰
  els.btnImportMonth.onclick = ()=>{ els.fileInput.accept=".json,.csv"; els.fileInput.onchange = onImportMonth; els.fileInput.click(); };
  els.btnExportMonthCSV.onclick = exportMonthCSV;
  els.btnExportMonthJSON.onclick = exportMonthJSON;

  // äº‘ç«¯
  els.btnSaveCloud.onclick = saveDayToCloud;
  els.btnLoadCloud.onclick = loadDayFromCloud;

  // ç½‘ç»œçŠ¶æ€
  window.addEventListener('online', ()=>{ updateBadge(); flushPending(); });
  window.addEventListener('offline', updateBadge);
}

/* =================== å¯¼å…¥å®ç° =================== */
async function onImportDay(ev){
  const file = ev.target.files[0]; ev.target.value='';
  if(!file) return;
  const text = await file.text();
  if(file.name.toLowerCase().endsWith('.json')){
    try{ rows = JSON.parse(text)||[]; }catch{ alert('JSON è§£æå¤±è´¥'); return; }
  }else{ // CSV
    const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim()!=='');
    if(lines.length && /å¼€å§‹.*ç»“æŸ.*å†…å®¹/.test(lines[0])) lines.shift(); // å»è¡¨å¤´
    rows = lines.map(line=>{
      const cols = csvParseLine(line).map(s=>s.trim());
      return { start_t:parseTime(cols[0]), end_t:parseTime(cols[1]), content:cols[2]||'', note:cols[3]||'' };
    });
  }
  saveLocal(els.dayPicker.value); render();
}

async function onImportMonth(ev){
  const file = ev.target.files[0]; ev.target.value='';
  if(!file) return;
  const text = await file.text();
  let list = [];
  if(file.name.toLowerCase().endsWith('.json')){
    try{ list = JSON.parse(text)||[]; }catch{ alert('JSON è§£æå¤±è´¥'); return; }
    // æœŸæœ›æ ¼å¼ï¼š[{date:'YYYY-MM-DD', start_t, end_t, content, note}, ...]
  }else{
    // CSV æœŸæœ›è¡¨å¤´ï¼šæ—¥æœŸ,å¼€å§‹æ—¶é—´,ç»“æŸæ—¶é—´,å†…å®¹,å¤‡æ³¨
    const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim()!=='');
    if(lines.length && /æ—¥æœŸ.*å¼€å§‹.*ç»“æŸ.*å†…å®¹/.test(lines[0])) lines.shift();
    list = lines.map(line=>{
      const c = csvParseLine(line).map(s=>s.trim());
      return { date: c[0], start_t:parseTime(c[1]), end_t:parseTime(c[2]), content:c[3]||'', note:c[4]||'' };
    });
  }
  // å†™å…¥æœ¬åœ°ï¼ˆæŒ‰æ—¥è¦†ç›–ï¼‰
  const byDay = {};
  for(const r of list){ if(!r?.date) continue; (byDay[r.date] ??= []).push({start_t:r.start_t,end_t:r.end_t,content:r.content||'',note:r.note||''}); }
  Object.keys(byDay).forEach(d=> localStorage.setItem(keyDay(d), JSON.stringify(byDay[d])) );
  // å¦‚æœåŒ…å«å½“å‰æ—¥ï¼Œåˆ·æ–°é¡µé¢
  if(byDay[els.dayPicker.value]){ loadLocal(els.dayPicker.value); render(); }
  alert('å¯¼å…¥å½“æœˆå®Œæˆï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰');
}

/* =================== å¯¼å‡ºå½“æœˆ =================== */
async function exportMonthCSV(){
  const d = new Date(els.dayPicker.value);
  const y=d.getFullYear(), m=d.getMonth()+1;
  let data = [];
  if(currentUser){
    const { data:cloud, error } = await sb.from('event_grid')
      .select('d,start_t,end_t,content,note')
      .eq('user_id', currentUser.id)
      .gte('d', `${y}-${pad(m)}-01`)
      .lte('d', `${y}-${pad(m)}-${pad(monthEnd(d).getDate())}`)
      .order('d',{ascending:true}).order('start_t',{ascending:true});
    if(error){ alert('äº‘ç«¯å¯¼å‡ºå¤±è´¥ï¼š'+error.message); return; }
    data = cloud || [];
  }else{
    // æ±‡æ€»æœ¬åœ°ï¼šéå†å½“æœˆæ¯å¤© key
    const days = monthEnd(d).getDate();
    for(let day=1; day<=days; day++){
      const ds = `${y}-${pad(m)}-${pad(day)}`;
      const arr = JSON.parse(localStorage.getItem(keyDay(ds))||'[]');
      arr.forEach(r=> data.push({d:ds, ...r}));
    }
  }
  const lines = data.map(r=>[r.d, r.start_t||'', r.end_t||'', r.content||'', r.note||''].map(csvEscape).join(','));
  const csv = `æ—¥æœŸ,å¼€å§‹æ—¶é—´,ç»“æŸæ—¶é—´,å†…å®¹,å¤‡æ³¨\n${lines.join('\n')}`;
  download(new Blob([csv],{type:'text/csv;charset=utf-8'}), `${y}-${pad(m)}_æ•´æœˆæ—¶é—´.csv`);
}

async function exportMonthJSON(){
  const d = new Date(els.dayPicker.value);
  const y=d.getFullYear(), m=d.getMonth()+1;
  let data = [];
  if(currentUser){
    const { data:cloud, error } = await sb.from('event_grid')
      .select('d,start_t,end_t,content,note')
      .eq('user_id', currentUser.id)
      .gte('d', `${y}-${pad(m)}-01`)
      .lte('d', `${y}-${pad(m)}-${pad(monthEnd(d).getDate())}`)
      .order('d',{ascending:true}).order('start_t',{ascending:true});
    if(error){ alert('äº‘ç«¯å¯¼å‡ºå¤±è´¥ï¼š'+error.message); return; }
    data = cloud || [];
  }else{
    const days = monthEnd(d).getDate();
    for(let day=1; day<=days; day++){
      const ds = `${y}-${pad(m)}-${pad(day)}`;
      const arr = JSON.parse(localStorage.getItem(keyDay(ds))||'[]');
      arr.forEach(r=> data.push({d:ds, ...r}));
    }
  }
  download(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}), `${y}-${pad(m)}_æ•´æœˆæ—¶é—´.json`);
}

function download(blob, name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

/* =================== äº‘ç«¯ï¼ˆä¿å­˜/è¯»å–å½“å¤©ï¼‰ =================== */
async function saveDayToCloud(){
  if(!currentUser){ alert('è¯·å…ˆç™»å½•'); return; }
  const dstr = els.dayPicker.value;
  // ç®€å•ç¨³å¦¥ï¼šå…ˆåˆ å½“æ—¥ï¼Œå†æ•´ä½“æ’å…¥
  const del = await sb.from('event_grid').delete().match({ user_id: currentUser.id, d: dstr });
  if(del.error){ alert('åˆ é™¤æ—§è®°å½•å¤±è´¥ï¼š'+del.error.message); return; }
  const rowsReady = rows
    .filter(r=>r.start_t && r.end_t && r.content?.trim())
    .map(r=>({ user_id: currentUser.id, d:dstr, start_t:r.start_t, end_t:r.end_t, content:r.content.trim(), note:r.note||'' }));
  if(rowsReady.length===0){ alert('æ²¡æœ‰å¯ä¿å­˜çš„è¡Œ'); return; }
  const ins = await sb.from('event_grid').insert(rowsReady);
  if(ins.error){ alert('æ’å…¥å¤±è´¥ï¼š'+ins.error.message); return; }
  alert('å·²ä¿å­˜åˆ°äº‘ç«¯');
}

async function loadDayFromCloud(){
  if(!currentUser){ alert('è¯·å…ˆç™»å½•'); return; }
  const dstr = els.dayPicker.value;
  const { data, error } = await sb.from('event_grid')
    .select('start_t,end_t,content,note')
    .eq('user_id', currentUser.id).eq('d', dstr)
    .order('start_t',{ascending:true});
  if(error){ alert('è½½å…¥å¤±è´¥ï¼š'+error.message); return; }
  rows = (data||[]).map(r=>({start_t:r.start_t,end_t:r.end_t,content:r.content||'',note:r.note||''}));
  saveLocal(dstr); render();
}

/* =================== å¾…åŒæ­¥ï¼ˆç¦»çº¿å…œåº•ï¼‰ =================== */
function queuePending(payload){
  const q = JSON.parse(localStorage.getItem('grid_pending')||'[]');
  q.push(payload);
  localStorage.setItem('grid_pending', JSON.stringify(q));
  updateBadge();
}
async function flushPending(){
  if(!currentUser) return;
  const q = JSON.parse(localStorage.getItem('grid_pending')||'[]');
  if(q.length===0){ updateBadge(); return; }
  for(const it of q){
    if(it.type==='saveDay'){
      const del = await sb.from('event_grid').delete().match({ user_id: currentUser.id, d: it.d });
      if(del.error){ console.warn('flush del fail', del.error.message); return; }
      const ins = await sb.from('event_grid').insert(it.rows);
      if(ins.error){ console.warn('flush ins fail', ins.error.message); return; }
    }
  }
  localStorage.removeItem('grid_pending');
  updateBadge();
}

/* =================== ç™»å½•é€»è¾‘ =================== */
function updateAuthUI(){
  if(currentUser){
    els.signedOut.style.display='none';
    els.signedIn.style.display='flex';
    (document.getElementById('userEmail')||{}).textContent = currentUser.email || 'å·²ç™»å½•';
  }else{
    els.signedOut.style.display='flex';
    els.signedIn.style.display='none';
  }
  updateBadge();
}
function updateBadge(){
  const online = navigator.onLine;
  const pending = JSON.parse(localStorage.getItem('grid_pending')||'[]').length;
  const parts = [];
  parts.push(online?'ğŸŸ¢ åœ¨çº¿':'ğŸ”´ ç¦»çº¿');
  parts.push(currentUser ? 'å·²ç™»å½•' : 'æœªç™»å½•');
  if(currentUser) parts.push(pending>0 ? `å¾…åŒæ­¥(${pending})` : 'å·²åŒæ­¥');
  els.syncBadge.textContent = parts.join(' Â· ');
}

async function initAuth(){
  const { data:{ session } } = await sb.auth.getSession();
  currentUser = session?.user || null;
  updateAuthUI();

  sb.auth.onAuthStateChange(async (_e, s) => {
    currentUser = s?.user || null;
    updateAuthUI();
    if(currentUser) flushPending();
  });

  document.getElementById('btnSignUp').onclick = async ()=>{
    const email=document.getElementById('email').value.trim();
    const password=document.getElementById('password').value;
    try{ await sb.auth.signUp({ email, password }); alert('æ³¨å†ŒæˆåŠŸï¼šå¦‚å¼€å¯é‚®ç®±éªŒè¯ï¼Œè¯·åˆ°é‚®ç®±ç‚¹ç¡®è®¤é“¾æ¥åå†ç™»å½•'); }
    catch(err){ alert('æ³¨å†Œå¤±è´¥ï¼š'+(err?.message||err)); }
  };
  document.getElementById('btnSignIn').onclick = async ()=>{
    const email=document.getElementById('email').value.trim();
    const password=document.getElementById('password').value;
    try{
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error) throw error;
    }catch(err){ alert('ç™»å½•å¤±è´¥ï¼š'+(err?.message||err)); }
  };
  document.getElementById('btnSignOut').onclick = async ()=>{ await sb.auth.signOut(); };
}

/* =================== å¯åŠ¨ =================== */
bindUI();
initAuth();
</script>
</body>
</html>
