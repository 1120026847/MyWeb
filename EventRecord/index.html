<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ—¶é—´è®°å½•ï¼ˆExcelé£æ ¼ï¼‰</title>

<!-- Supabase v2 UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --line:#e5e7eb; --text:#0b1220; --muted:#6b7280;
    --accent:#2563eb; --accent-weak:#eef2ff; --danger:#dc2626;
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}

  /* é¡¶éƒ¨ */
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .container{padding:12px 16px}
  .nav{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:clamp(18px,4.5vw,22px)}
  .account{margin-left:auto}
  .account-btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent-weak);color:#1e3a8a;
               border:1px solid #c7d2fe;padding:8px 12px;border-radius:999px;font-weight:600;max-width:70vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* ä¸»å¡ç‰‡ */
  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 6px 26px rgba(0,0,0,.06)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  input,button{border:1px solid var(--line);border-radius:10px;padding:10px 12px;font:inherit;outline:none}
  input:focus,button:focus{border-color:var(--accent)}
  .btn{background:var(--accent);color:#fff;border:none}
  .btn.secondary{background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe}
  .btn.ghost{background:transparent}
  .btn.danger{background:var(--danger)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)}
  .right{margin-left:auto}

  /* é¡¶éƒ¨å·¥å…·æ¡ */
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .toolbar .btn{height:38px}

  /* è¡¨æ ¼ï¼ˆExcelé£ï¼‰ */
  .grid{margin-top:12px;border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .thead,.trow{display:grid;grid-template-columns:130px 130px 1fr 1fr 120px 180px;gap:0;border-bottom:1px solid var(--line)}
  .cell{padding:10px 12px;display:flex;align-items:center}
  .thead .cell{background:#f3f4f6;font-weight:600}
  .trow input[type="text"]{width:100%;height:36px}
  .trow .duration{font-variant-numeric:tabular-nums}
  .trow .actions{display:flex;gap:8px;justify-content:flex-end}
  .tfoot{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fafafa}
  .tip{font-size:12px;color:var(--muted)}

  /* å†å²å¡ç‰‡ */
  .history{margin-top:14px}
  .history .row{justify-content:space-between}

  /* Toast */
  .toast-wrap{position:fixed;top:16px;left:0;right:0;display:flex;justify-content:center;z-index:20000;pointer-events:none}
  .toast{pointer-events:auto;background:#111827;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 28px rgba(0,0,0,.25);opacity:.98}
  .toast.ok{background:#065f46}.toast.err{background:#7f1d1d}

  /* åŒæ­¥æç¤º */
  .sync{display:inline-flex;align-items:center;gap:8px}
  .spinner{width:14px;height:14px;border:2px solid #cfe3ff;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* æ¨¡æ€ï¼ˆç™»å½•/æ³¨å†Œ/è´¦æˆ·ï¼‰ */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000}
  .modal.show{display:flex}
  .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter: saturate(1.2) blur(1.5px)}
  .dialog{position:relative;width:520px;max-width:92vw;background:#fff;border-radius:16px;border:1px solid var(--line);
          box-shadow:0 20px 60px rgba(0,0,0,.25);padding:16px}
  .dialog h3{margin:0 0 12px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .hint{font-size:12px;color:var(--muted)}
  .dialog .row{justify-content:flex-end}
  .close-x{position:absolute;right:10px;top:8px;background:transparent;border:0;font-size:18px;cursor:pointer}

  /* æ‰‹æœºç«¯ç´§å‡‘ + iOS è¾“å…¥ä¸æ”¾å¤§ï¼ˆ16pxï¼‰ */
  @media (max-width: 900px){
    .thead,.trow{grid-template-columns:110px 110px 1fr 1fr 110px 170px}
  }
  @media (max-width: 680px){
    .thead,.trow{grid-template-columns:92px 92px 1fr 1fr 90px 160px}
    .trow input[type="text"]{height:44px;font-size:16px}
    .toolbar input[type="date"]{height:44px}
    .toolbar .btn{height:44px}
  }
  @media (max-width: 420px){
    .thead,.trow{grid-template-columns:86px 86px 1fr 1fr 84px 140px}
  }
</style>
</head>
<body>
<header>
  <div class="container nav">
    <h1>æ—¶é—´è®°å½•ï¼ˆExcelé£æ ¼ï¼‰</h1>
    <div class="account"><button id="accountBtn" class="account-btn">ç™»å½• / æ³¨å†Œ</button></div>
  </div>
</header>

<!-- Toast -->
<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<!-- æœªç™»å½•æç¤ºï¼ˆæ¨¡æ€å±‚ z-index æ›´é«˜ï¼Œä¸ä¼šé®ç›–ç™»å½•æ¡†ï¼‰ -->
<div class="container" id="guestCard">
  <div class="card">
    <div class="row"><strong>è¯·å…ˆç™»å½•</strong><span class="muted">ç‚¹å‡»å³ä¸Šè§’ã€Œç™»å½• / æ³¨å†Œã€è¿›å…¥ä½ çš„è´¦æˆ·</span></div>
  </div>
</div>

<!-- ä¸»ä½“ -->
<main class="container" id="app" style="display:none">
  <div class="card">
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
      <div class="row" style="gap:8px">
        <span class="muted">é€‰æ‹©æ—¥æœŸ</span>
        <input id="dateInput" type="date" />
      </div>
      <button id="addRow" class="btn">+ æ–°å¢ä¸€è¡Œ</button>
      <button id="exportCsv" class="btn secondary">å¯¼å‡º CSV</button>
      <input id="csvFile" type="file" accept=".csv" style="display:none">
      <button id="importCsv" class="btn secondary">å¯¼å…¥ CSV</button>
      <div class="right sync">
        <div id="syncState" class="muted" style="display:none"><span class="spinner"></span> æ­£åœ¨åŒæ­¥â€¦</div>
        <button id="refreshBtn" class="btn secondary">åˆ·æ–°</button>
      </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="grid" id="grid">
      <div class="thead">
        <div class="cell">å¼€å§‹æ—¶é—´</div>
        <div class="cell">ç»“æŸæ—¶é—´</div>
        <div class="cell">å†…å®¹</div>
        <div class="cell">å¤‡æ³¨</div>
        <div class="cell">æ—¶é•¿</div>
        <div class="cell">æ“ä½œ</div>
      </div>
      <div id="tbody"></div>
      <div class="tfoot">
        <div class="tip">æç¤ºï¼šæ—¶é—´æ ¼å¼å¦‚ <b>17:18</b> æˆ– <b>17:18:17</b>ï¼›è‹¥è·¨åˆå¤œï¼ˆç»“æŸ &lt; å¼€å§‹ï¼‰ä¼šè‡ªåŠ¨ +24 å°æ—¶ã€‚</div>
        <div id="total" class="muted">åˆè®¡ï¼š00:00:00</div>
      </div>
    </div>
  </div>

  <!-- å†å² -->
  <div class="history card">
    <div class="row">
      <strong>æœ€è¿‘ 30 å¤©å†å²</strong>
      <button id="reloadHistory" class="btn secondary">åˆ·æ–°</button>
    </div>
    <div id="historyList" style="margin-top:8px" class="muted">â€”</div>
  </div>
</main>

<!-- ç»Ÿä¸€æ¨¡æ€ï¼ˆç™»å½•/æ³¨å†Œ/è´¦æˆ·ï¼‰ -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-hidden="true">
  <div class="backdrop" id="modalBackdrop"></div>
  <div class="dialog" role="document">
    <button class="close-x" id="modalClose" aria-label="å…³é—­">âœ•</button>
    <h3 id="dialogTitle">ç™»å½• / æ³¨å†Œ</h3>
    <div id="dialogBody"></div>
  </div>
</div>

<script>
/* ===== Supabase é…ç½® ===== */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

/* âœ… å¦‚æœä½ ä¹‹å‰çš„è¡¨åä¸åŒï¼ˆå¦‚ time_recordsï¼‰ï¼Œåªæ”¹è¿™é‡Œ */
const TABLE_NAME = 'time_logs';

const { createClient } = supabase;

/* ===== å®‰å…¨å­˜å‚¨ï¼ˆlocalStorage ä¸å¯ç”¨æ—¶å›é€€ Cookieï¼‰ ===== */
const cookieStorage = {
  getItem: (k)=>{ const m = document.cookie.match(new RegExp('(?:^|; )'+encodeURIComponent(k)+'=([^;]*)')); return m?decodeURIComponent(m[1]):null; },
  setItem: (k,v)=>{ const e=new Date(); e.setFullYear(e.getFullYear()+1);
    document.cookie=`${encodeURIComponent(k)}=${encodeURIComponent(v)}; Path=/; Expires=${e.toUTCString()}; SameSite=Lax; Secure`;
  },
  removeItem: (k)=>{ document.cookie=`${encodeURIComponent(k)}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax; Secure`; }
};
function makeSafeStorage(){
  try{ const t='__sb_test__'+Math.random(); localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }
  catch{ return cookieStorage; }
}
const SAFE_STORAGE = makeSafeStorage();

/* åˆ›å»ºå®¢æˆ·ç«¯ï¼šæ˜¾å¼å¼€å¯ä¼šè¯æŒä¹…åŒ–+è‡ªåŠ¨åˆ·æ–°ï¼Œå¹¶æŒ‡å®š storage/storageKey */
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth:{
    persistSession:true, autoRefreshToken:true, detectSessionInUrl:false,
    storage: SAFE_STORAGE, storageKey: 'sb-time-auth'
  }
});

/* ===== å…¨å±€çŠ¶æ€ ===== */
let session = null;        // ç™»å½•æ€
let rows = [];             // å½“å‰æ—¥æœŸçš„è¡Œ
let syncing = 0;

/* ===== DOM ===== */
const $ = (id)=>document.getElementById(id);
const els = {
  app:$('app'), guest:$('guestCard'), toast:$('toastWrap'),
  accountBtn:$('accountBtn'), date:$('dateInput'), tbody:$('tbody'), total:$('total'),
  addRow:$('addRow'), exportCsv:$('exportCsv'), importCsv:$('importCsv'), csvFile:$('csvFile'),
  refresh:$('refreshBtn'), reloadHistory:$('reloadHistory'), history:$('historyList'),
  syncState:$('syncState'),
  modal:$('modal'), modalBackdrop:$('modalBackdrop'), modalClose:$('modalClose'),
  dialogBody:$('dialogBody'), dialogTitle:$('dialogTitle')
};

/* ===== å°å·¥å…· ===== */
const toast=(msg,type='ok',ms=1600)=>{const t=document.createElement('div');t.className='toast '+(type==='error'?'err':'ok');t.textContent=msg;els.toast.appendChild(t);setTimeout(()=>{t.style.transition='opacity .35s';t.style.opacity='0';},ms);setTimeout(()=>t.remove(),ms+400)};
const setSync=(on)=>{syncing+=on?1:-1; if(syncing<0)syncing=0; els.syncState.style.display = syncing>0?'':'none'};

/* æ—¶é—´è§£æ/æ ¼å¼åŒ– */
function parseTime(s){
  s=(s||'').trim(); if(!s) return null;
  const m=s.split(':').map(n=>n.trim());
  if(m.length<2 || m.length>3) return null;
  const h=+m[0], mi=+m[1], se=m[2]?+m[2]:0;
  if([h,mi,se].some(x=>Number.isNaN(x))) return null;
  if(h<0||h>47||mi<0||mi>59||se<0||se>59) return null;
  return h*3600+mi*60+se;
}
function fmtSec(sec){ sec=Math.max(0, sec|0); const h=String(Math.floor(sec/3600)).padStart(2,'0'); const m=String(Math.floor(sec%3600/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${h}:${m}:${s}`; }
function computeDuration(start,end){ if(start==null||end==null) return 0; let d=end-start; if(d<0) d+=24*3600; return d; }

/* ===== æ¨¡æ€ï¼ˆç™»å½•/æ³¨å†Œ/è´¦æˆ·ï¼‰ ===== */
let lastFocus=null;
function openModal(title, html){
  els.dialogTitle.textContent=title||'å¯¹è¯æ¡†';
  els.dialogBody.innerHTML=html||'';
  lastFocus=document.activeElement;
  els.modal.classList.add('show'); els.modal.removeAttribute('aria-hidden'); document.body.style.overflow='hidden';
  const first=els.dialogBody.querySelector('input,button'); if(first) setTimeout(()=>first.focus(),0);
}
function closeModal(){
  els.modal.classList.remove('show'); els.modal.setAttribute('aria-hidden','true'); document.body.style.overflow='';
  if(lastFocus) lastFocus.focus();
}
els.modalBackdrop.onclick=closeModal; els.modalClose.onclick=closeModal;
document.addEventListener('keydown',e=>{ if(e.key==='Escape' && els.modal.classList.contains('show')) closeModal(); });

function showAuthModal(){
  openModal('ç™»å½• / æ³¨å†Œ', `
    <div class="field">
      <label class="hint">é‚®ç®±</label>
      <input id="authEmail" type="email" placeholder="you@example.com" style="font-size:16px">
    </div>
    <div class="field">
      <label class="hint">å¯†ç ï¼ˆâ‰¥6ä½ï¼‰</label>
      <input id="authPassword" type="password" placeholder="******" style="font-size:16px">
    </div>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <button id="btnLogin" class="btn">ç™»å½•</button>
      <button id="btnSignup" class="btn secondary">æ³¨å†Œ</button>
    </div>
    <div id="authHint" class="hint" style="margin-top:6px"></div>
  `);
  const hint=$('authHint');
  $('btnLogin').onclick=async()=>{
    const email=$('authEmail').value.trim(), password=$('authPassword').value;
    if(!email||!password) return hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
    const {error} = await sb.auth.signInWithPassword({email,password});
    if(error) hint.textContent='ç™»å½•å¤±è´¥ï¼š'+error.message; else { hint.textContent=''; toast('ç™»å½•æˆåŠŸ'); closeModal(); }
  };
  $('btnSignup').onclick=async()=>{
    const email=$('authEmail').value.trim(), password=$('authPassword').value;
    if(!email||!password) return hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
    const {error} = await sb.auth.signUp({email,password});
    hint.textContent = error ? ('æ³¨å†Œå¤±è´¥ï¼š'+error.message) : 'æ³¨å†ŒæˆåŠŸã€‚å¦‚å¼€å¯é‚®ç®±éªŒè¯ï¼Œè¯·åˆ°é‚®ç®±å®Œæˆç¡®è®¤åå†ç™»å½•ã€‚';
  };
}
function showAccountModal(user){
  openModal('è´¦æˆ·', `
    <div class="field"><div class="hint">é‚®ç®±ï¼š${user.email||''}</div></div>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <button id="btnLogout" class="btn">é€€å‡ºç™»å½•</button>
    </div>
  `);
  $('btnLogout').onclick=async()=>{ await sb.auth.signOut(); toast('æ‚¨å·²é€€å‡ºç™»å½•'); closeModal(); };
}
$('accountBtn').onclick=()=>{ session?.user ? showAccountModal(session.user) : showAuthModal(); };

/* ===== UI åˆ‡æ¢ ===== */
function applySessionUI(){
  $('accountBtn').textContent = session?.user ? `å·²ç™»å½•ï¼š${session.user.email||'ç”¨æˆ·'}` : 'ç™»å½• / æ³¨å†Œ';
  els.app.style.display = session ? '' : 'none';
  els.guest.style.display = session ? 'none' : '';
}

/* ===== æ¸²æŸ“ä¸€è¡Œ ===== */
function makeRowDOM(item){
  const tr=document.createElement('div');
  tr.className='trow';
  tr.innerHTML=`
    <div class="cell"><input type="text" value="${item.start||''}" placeholder="07:30"></div>
    <div class="cell"><input type="text" value="${item.end||''}" placeholder="08:45"></div>
    <div class="cell"><input type="text" value="${item.content||''}" placeholder=""></div>
    <div class="cell"><input type="text" value="${item.note||''}" placeholder=""></div>
    <div class="cell duration">${fmtSec(item.duration||0)}</div>
    <div class="cell actions">
      <button class="btn secondary save">ä¿å­˜</button>
      <button class="btn ghost copy">å¤åˆ¶</button>
      <button class="btn danger del">åˆ é™¤</button>
    </div>
  `;
  const [startEl,endEl,contentEl,noteEl] = tr.querySelectorAll('input');
  const durEl = tr.querySelector('.duration');
  function recalc(){
    const s=parseTime(startEl.value), e=parseTime(endEl.value);
    const d=computeDuration(s,e); item.duration=d; durEl.textContent=fmtSec(d);
    item.start=startEl.value; item.end=endEl.value; item.content=contentEl.value; item.note=noteEl.value;
    renderTotal();
  }
  startEl.oninput=endEl.oninput=recalc;
  contentEl.oninput=noteEl.oninput=()=>{ item.content=contentEl.value; item.note=noteEl.value; };
  tr.querySelector('.copy').onclick=()=>{ rows.splice(rows.indexOf(item)+1,0,{...item,id:null}); renderBody(); toast('å·²å¤åˆ¶ä¸€è¡Œ'); };
  tr.querySelector('.del').onclick=()=>removeRow(item);
  tr.querySelector('.save').onclick=()=>saveRow(item, tr.querySelector('.save'));
  return tr;
}

/* æ¸²æŸ“ä¸»ä½“ä¸åˆè®¡ */
function renderBody(){
  els.tbody.innerHTML='';
  const frag=document.createDocumentFragment();
  for(const it of rows){ frag.appendChild(makeRowDOM(it)); }
  els.tbody.appendChild(frag);
  renderTotal();
}
function renderTotal(){
  const sum = rows.reduce((a,b)=>a+(b.duration||0),0);
  els.total.textContent = 'åˆè®¡ï¼š' + fmtSec(sum);
}

/* ===== CRUD åˆ° Supabase ===== */
async function fetchRowsByDate(dateStr, showToast=false){
  if(!session){ rows=[]; renderBody(); return; }
  setSync(true);
  const { data, error } = await sb.from(TABLE_NAME)
    .select('*')
    .eq('user_id', session.user.id)
    .eq('date', dateStr)
    .order('start_time', { ascending: true });
  setSync(false);
  if(error){ toast('æ‹‰å–å¤±è´¥ï¼š'+error.message,'error'); return; }
  rows = (data||[]).map(r=>({
    id:r.id,start:r.start_time,end:r.end_time,content:r.content||'',note:r.note||'',
    duration: computeDuration(parseTime(r.start_time), parseTime(r.end_time))
  }));
  renderBody();
  if(showToast) toast('å·²ä»äº‘ç«¯åŒæ­¥');
}
async function saveRow(item, btn){
  if(!session) return toast('è¯·å…ˆç™»å½•','error');
  const s=parseTime(item.start), e=parseTime(item.end);
  if(s==null||e==null) return toast('æ—¶é—´æ ¼å¼åº”ä¸º HH:MM æˆ– HH:MM:SS','error');
  btn.disabled=true; setSync(true);
  const payload={ user_id:session.user.id, date:els.date.value, start_time:item.start, end_time:item.end, content:item.content||'', note:item.note||'' };
  let error;
  if(item.id){
    ({ error } = await sb.from(TABLE_NAME).update(payload).eq('id', item.id));
  }else{
    const res = await sb.from(TABLE_NAME).insert(payload).select('id').single();
    error = res.error; if(!error) item.id = res.data.id;
  }
  setSync(false); btn.disabled=false;
  if(error) return toast('ä¿å­˜å¤±è´¥ï¼š'+error.message,'error');
  toast('âœ… å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯');
}
async function removeRow(item){
  const i=rows.indexOf(item); if(i<0) return;
  if(item.id){ setSync(true); const { error } = await sb.from(TABLE_NAME).delete().eq('id', item.id); setSync(false); if(error) return toast('åˆ é™¤å¤±è´¥ï¼š'+error.message,'error'); }
  rows.splice(i,1); renderBody(); toast('ğŸ—‘ï¸ å·²åˆ é™¤');
}

/* ===== CSV ===== */
function toCSV(){
  const header=['date','start_time','end_time','content','note'];
  const lines=[header.join(',')];
  for(const it of rows){
    lines.push([els.date.value, it.start||'', it.end||'', (it.content||'').replace(/,/g,'ï¼Œ'), (it.note||'').replace(/,/g,'ï¼Œ')].join(','));
  }
  return lines.join('\n');
}
function download(filename, text){
  const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(Boolean);
  if(lines.length===0) return [];
  const head=lines[0].split(',');
  const idx={
    date: head.findIndex(h=>/date|æ—¥æœŸ/i.test(h)),
    start: head.findIndex(h=>/start/i.test(h)||/å¼€å§‹/.test(h)),
    end: head.findIndex(h=>/end/i.test(h)||/ç»“æŸ/.test(h)),
    content: head.findIndex(h=>/content|å†…å®¹/i.test(h)),
    note: head.findIndex(h=>/note|å¤‡æ³¨/i.test(h)),
  };
  const out=[];
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(',');
    const d=cols[idx.date]||els.date.value;
    if(d!==els.date.value) continue; // åªå¯¼å…¥åˆ°å½“å‰é€‰ä¸­æ—¥æœŸ
    out.push({
      id:null,
      start:cols[idx.start]||'',
      end:cols[idx.end]||'',
      content:(cols[idx.content]||'').replace(/ï¼Œ/g,','),
      note:(cols[idx.note]||'').replace(/ï¼Œ/g,','),
      duration: computeDuration(parseTime(cols[idx.start]||''), parseTime(cols[idx.end]||''))
    });
  }
  return out;
}

/* ===== å†å² ===== */
async function loadHistory(){
  if(!session){ $('historyList').textContent='â€”'; return; }
  const from = new Date(els.date.value); from.setDate(from.getDate()-29);
  setSync(true);
  const { data, error } = await sb.from(TABLE_NAME)
    .select('date,start_time,end_time')
    .eq('user_id', session.user.id)
    .gte('date', from.toISOString().slice(0,10))
    .lte('date', els.date.value);
  setSync(false);
  if(error){ toast('å†å²æ‹‰å–å¤±è´¥ï¼š'+error.message,'error'); return; }
  const map=new Map();
  for(const r of (data||[])){
    const d=computeDuration(parseTime(r.start_time), parseTime(r.end_time));
    map.set(r.date, (map.get(r.date)||0) + d);
  }
  const items=[...map.entries()].sort((a,b)=>a[0]<b[0]?1:-1);
  els.history.innerHTML = items.length? items.map(([d,s])=>`<div class="row"><div>${d}</div><div class="muted">åˆè®¡ï¼š${fmtSec(s)}</div></div>`).join('') : 'â€”';
}

/* ===== äº‹ä»¶ç»‘å®š ===== */
els.addRow.onclick=()=>{ rows.push({id:null,start:'',end:'',content:'',note:'',duration:0}); renderBody(); };
els.exportCsv.onclick=()=>download(`timelog_${els.date.value}.csv`, toCSV());
els.importCsv.onclick=()=>els.csvFile.click();
els.csvFile.onchange=async(e)=>{
  const file=e.target.files[0]; if(!file) return;
  const text=await file.text(); const items=parseCSV(text);
  if(items.length===0) return toast('CSV æ²¡æœ‰å¯å¯¼å…¥çš„å½“å‰æ—¥æœŸæ•°æ®','error');
  rows.push(...items); renderBody(); toast(`å·²åŠ å…¥ ${items.length} è¡Œï¼Œè®°å¾—ç‚¹â€œä¿å­˜â€å†™å…¥äº‘ç«¯`);
};
els.refresh.onclick=()=>fetchRowsByDate(els.date.value,true);
els.reloadHistory.onclick=loadHistory;

/* ===== è®¤è¯ç›‘å¬ & åˆå§‹åŒ– ===== */
sb.auth.onAuthStateChange((_evt, sess)=>{
  session = sess;
  applySessionUI();                 // ç«‹åˆ»åˆ‡æ¢ UI
  if(session){ fetchRowsByDate(els.date.value); loadHistory(); }
}); // å®˜æ–¹å»ºè®®å›è°ƒä¿æŒç²¾ç®€ï¼Œé¿å…åœ¨å›è°ƒé‡Œ await è¿‡å¤šæ“ä½œã€‚å‚è§æ–‡æ¡£ã€‚:contentReference[oaicite:0]{index=0}

(async function init(){
  // é»˜è®¤é€‰æ‹©ä»Šå¤©
  const today=new Date(); els.date.value = today.toISOString().slice(0,10);

  // é¦–å±ä¼šè¯
  const { data } = await sb.auth.getSession();
  session = data.session || null;
  applySessionUI();

  if(session){ fetchRowsByDate(els.date.value); loadHistory(); }

  // æ”¹æ—¥æœŸæ—¶åˆ‡æ¢æ•°æ®
  els.date.onchange=()=>{ if(session){ fetchRowsByDate(els.date.value); } renderBody(); loadHistory(); };
})();
</script>
</body>
</html>
