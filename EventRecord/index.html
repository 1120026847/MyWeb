<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EventRecord · 云端同步版</title>
<style>
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;display:flex;flex-direction:column;background:#f5f7fb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Noto Sans SC','Microsoft Yahei',sans-serif;color:#222}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:5}
  .app-title{font-weight:800}
  .auth{display:flex;gap:8px;align-items:center}
  .auth input{padding:8px 10px;border:1px solid #ddd;border-radius:8px;min-width:160px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid #e1e1e1;background:#fff;cursor:pointer}
  .btn.primary{background:#4CAF50;color:#fff;border-color:#4CAF50}
  .pill{padding:4px 8px;border:1px solid #e1e1e1;border-radius:999px;font-size:12px;color:#666}

  .wrap{flex:1;max-width:960px;margin:20px auto;padding:20px;background:#fff;border-radius:14px;box-shadow:0 10px 20px rgba(0,0,0,.06)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .date-display{font-size:22px;font-weight:700;text-align:center;margin:6px 0 14px}
  .output-box{min-height:260px;border:1px solid #e6e6e6;border-radius:10px;padding:12px;overflow:auto;background:#fafafa}
  .event{padding:6px 8px}
  .event-line{margin:0}
  hr{margin:6px 0;border:0;border-top:1px solid #eee}
  .controls{display:flex;gap:8px;margin:12px 0}
  .edit-box{width:100%;height:92px;border:1px solid #e6e6e6;border-radius:10px;padding:10px;margin-top:6px}

  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:50;align-items:center;justify-content:center}
  .dialog{background:#fff;padding:22px;border-radius:12px;min-width:380px;max-width:92vw}
  .dialog textarea{width:100%;height:120px;margin:8px 0;padding:10px;border:1px solid #ddd;border-radius:8px}
  .dialog .row{display:flex;gap:8px;margin:8px 0}
  .dialog .row input{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px}
  .dialog-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="app-title">⏱️ EventRecord</div>
    <div class="auth">
      <div id="signed-out">
        <input type="email" id="email" placeholder="邮箱"/>
        <input type="password" id="password" placeholder="密码（≥6位）"/>
        <button class="btn" id="btnSignUp">注册</button>
        <button class="btn primary" id="btnSignIn">登录</button>
      </div>
      <div id="signed-in" style="display:none;gap:8px;align-items:center">
        <span class="pill" id="userEmail"></span>
        <span class="pill" id="syncBadge">未登录</span>
        <button class="btn" id="btnSignOut">退出</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="toolbar">
      <button class="btn" onclick="location.href='https://www.molijun.com'">首页</button>
      <button class="btn" id="btnStats">导出统计（txt）</button>
      <button class="btn" id="btnExportJSON">导出 JSON</button>
      <button class="btn" id="btnSyncLocal">同步本地 → 云端</button>
      <button class="btn" id="btnClear">清空全部</button>
      <span style="color:#666;font-size:12px">（未登录仅保存在本地）</span>
    </div>

    <div class="date-display" id="dateDisplay"></div>

    <div class="output-box" id="outputBox"></div>

    <div class="controls">
      <button class="btn primary" id="btnStart">开始记录</button>
      <button class="btn primary" id="btnEnd">结束记录</button>
      <button class="btn" id="btnFree">自由编辑</button>
    </div>

    <div>
      <div>事项内容：</div>
      <div class="edit-box" id="editBox" contenteditable="true"></div>
    </div>
  </main>

  <!-- 自由编辑 -->
  <div class="modal" id="editModal">
    <div class="dialog">
      <h3 style="margin:0 0 6px">自由编辑记录</h3>
      <textarea id="freeContent" placeholder="输入事项内容..."></textarea>
      <div class="row">
        <input type="date" id="freeDate">
      </div>
      <div class="row">
        <input type="time" id="freeStart">
        <input type="time" id="freeEnd">
      </div>
      <div class="dialog-actions">
        <button class="btn" id="btnConfirmFree">确认记录</button>
        <button class="btn" id="btnCancelFree">取消</button>
      </div>
    </div>
  </div>

<script>
/* ================= Supabase（你的项目配置） ================= */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* ================= 状态 & 元素 ================= */
let startTime = null;
let events = []; // {id, content, start_at (ISO), end_at (ISO), duration_ms, created_at}
let currentUser = null;
let rtChannel = null;

const els = {
  dateDisplay: document.getElementById('dateDisplay'),
  outputBox: document.getElementById('outputBox'),
  editBox: document.getElementById('editBox'),
  // toolbar
  btnStats: document.getElementById('btnStats'),
  btnExportJSON: document.getElementById('btnExportJSON'),
  btnSyncLocal: document.getElementById('btnSyncLocal'),
  btnClear: document.getElementById('btnClear'),
  // record
  btnStart: document.getElementById('btnStart'),
  btnEnd: document.getElementById('btnEnd'),
  btnFree: document.getElementById('btnFree'),
  // modal
  editModal: document.getElementById('editModal'),
  freeContent: document.getElementById('freeContent'),
  freeDate: document.getElementById('freeDate'),
  freeStart: document.getElementById('freeStart'),
  freeEnd: document.getElementById('freeEnd'),
  btnConfirmFree: document.getElementById('btnConfirmFree'),
  btnCancelFree: document.getElementById('btnCancelFree'),
  // auth
  signedOut: document.getElementById('signed-out'),
  signedIn: document.getElementById('signed-in'),
  userEmail: document.getElementById('userEmail'),
  syncBadge: document.getElementById('syncBadge'),
};

/* ================= 启动 ================= */
window.addEventListener('load', async () => {
  displayToday();
  restoreLocal();
  renderEvents();
  wireUI();
  await initAuth();
});

function wireUI(){
  els.btnStart.onclick = startTiming;
  els.btnEnd.onclick = endTiming;
  els.btnFree.onclick = () => openFreeModal(true);
  els.btnConfirmFree.onclick = confirmFree;
  els.btnCancelFree.onclick = () => openFreeModal(false);

  els.btnStats.onclick = exportStats;
  els.btnExportJSON.onclick = exportJSON;
  els.btnSyncLocal.onclick = syncLocalToCloud;
  els.btnClear.onclick = clearAll;

  document.getElementById('btnSignUp').onclick = signUp;
  document.getElementById('btnSignIn').onclick = signIn;
  document.getElementById('btnSignOut').onclick = signOut;

  window.addEventListener('online', ()=>{ updateStatusIndicator(); flushPending(); });
  window.addEventListener('offline', updateStatusIndicator);
}

function displayToday(){
  const now = new Date();
  els.dateDisplay.textContent = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;
}

/* ================= 本地存储 ================= */
function restoreLocal(){ try{ events = JSON.parse(localStorage.getItem('events')||'[]'); }catch{} }
function saveLocal(){ localStorage.setItem('events', JSON.stringify(events)); }

/* ================= Auth ================= */
async function initAuth(){
  const { data: { session } } = await sb.auth.getSession();
  currentUser = session?.user || null; updateAuthUI();
  if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
  sb.auth.onAuthStateChange(async (_e, session) => {
    currentUser = session?.user || null; updateAuthUI();
    if(currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
    else { unsubscribeRealtime(); restoreLocal(); renderEvents(); }
  });
}

async function signUp(){
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  try{
    toggleBtn('btnSignUp', true, '注册中…');
    const { error } = await sb.auth.signUp({ email, password });
    if(error) throw error;
    alert('注册成功：若开启邮箱验证，请先到邮箱完成验证再登录。');
  }catch(err){
    console.error('[signUp]', err);
    alert('注册失败：' + (err?.message || err));
  }finally{ toggleBtn('btnSignUp', false, '注册'); }
}

async function signIn(){
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  if(!email || !password){ alert('请输入邮箱和密码'); return; }
  try{
    toggleBtn('btnSignIn', true, '登录中…');
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      const map = {
        'Email not confirmed': '邮箱未验证：请到邮箱点确认链接（或在 Auth/Email 临时关闭 Confirm email）',
        'Invalid login credentials': '邮箱或密码不正确'
      };
      alert('登录失败：' + (map[error.message] || error.message));
      return;
    }
    currentUser = data?.user || (await sb.auth.getUser()).data?.user || null;
    updateAuthUI();
    await loadAllFromCloud();
    subscribeRealtime();
  }catch(err){
    console.error('[signIn] error', err);
    alert('网络或脚本错误：' + (err?.message || err));
  }finally{ toggleBtn('btnSignIn', false, '登录'); }
}

async function signOut(){
  try{
    toggleBtn('btnSignOut', true, '退出中…');
    await sb.auth.signOut();
  }catch(err){
    console.error('[signOut]', err);
    alert('退出失败：' + (err?.message || err));
  }finally{ toggleBtn('btnSignOut', false, '退出'); }
}

function updateAuthUI(){
  if(currentUser){
    els.signedOut.style.display='none';
    els.signedIn.style.display='flex';
    els.userEmail.textContent = currentUser.email || '已登录';
  }else{
    els.signedOut.style.display='block';
    els.signedIn.style.display='none';
  }
  updateStatusIndicator();
}

/* ================= 云端交互 ================= */
async function loadAllFromCloud(){
  if(!currentUser) return;
  const { data, error } = await sb.from('events')
    .select('id, content, start_at, end_at, duration_ms, created_at')
    .eq('user_id', currentUser.id)
    .order('start_at', { ascending: true });
  if(error){ console.warn('加载云端失败：', error.message); return; }
  events = data || [];
  saveLocal();
  renderEvents();
}

async function insertEvent(e){
  if(currentUser){
    const { data, error } = await sb.from('events')
      .insert({ user_id: currentUser.id, ...e })
      .select('*').single();
    if(error){
      console.warn('云端插入失败：', error.message);
      queuePending({type:'insert', row:{ ...e }});
      // 本地先展示
      events.push({ id:'local-'+Date.now(), ...e });
    }else{
      events.push(data);
    }
  }else{
    events.push({ id:'local-'+Date.now(), ...e });
  }
  saveLocal();
  renderEvents();
}

async function clearAll(){
  if(!confirm('确认清空所有记录？（登录状态下会同时删除云端数据）')) return;
  events = [];
  saveLocal(); renderEvents();
  if(currentUser){
    const { error } = await sb.from('events').delete().eq('user_id', currentUser.id);
    if(error){ alert('云端清空失败：'+error.message); }
  }
}

/* ================= Realtime ================= */
function subscribeRealtime(){
  if(rtChannel) sb.removeChannel(rtChannel);
  rtChannel = sb.channel('events-ch');
  rtChannel.on('postgres_changes', { event:'*', schema:'public', table:'events', filter:`user_id=eq.${currentUser.id}` }, async ()=>{ await loadAllFromCloud(); }).subscribe();
}
function unsubscribeRealtime(){ if(rtChannel){ sb.removeChannel(rtChannel); rtChannel=null; } }

/* ================= 待同步队列（离线兜底） ================= */
function queuePending(item){
  const q = JSON.parse(localStorage.getItem('events_pending')||'[]');
  q.push(item);
  localStorage.setItem('events_pending', JSON.stringify(q));
  updateStatusIndicator();
}
async function flushPending(){
  if(!currentUser) return;
  let q = JSON.parse(localStorage.getItem('events_pending')||'[]');
  if(q.length===0){ updateStatusIndicator(); return; }
  for(const it of q){
    if(it.type==='insert'){
      const { error } = await sb.from('events').insert({ user_id: currentUser.id, ...it.row });
      if(error){ console.warn('flush insert 失败', error.message); return; }
    }
  }
  localStorage.removeItem('events_pending');
  await loadAllFromCloud();
  updateStatusIndicator();
}

/* ================= 记录操作 ================= */
function startTiming(){
  startTime = new Date();
  toast(`开始时间：${fmtTime(startTime)}`);
}

async function endTiming(){
  if(!startTime){ alert('请先点击“开始记录”'); return; }
  const content = els.editBox.innerText.trim();
  if(!content){ alert('请输入内容'); return; }
  const end = new Date();
  const duration = end - startTime;
  const e = {
    content,
    start_at: startTime.toISOString(),
    end_at: end.toISOString(),
    duration_ms: duration,
    created_at: new Date().toISOString()
  };
  await insertEvent(e);
  els.editBox.innerText = '';
  startTime = null;
}

/* —— 自由编辑 —— */
function openFreeModal(on){
  if(on){
    els.freeContent.value='';
    els.freeDate.value = new Date().toISOString().slice(0,10);
    els.freeStart.value = '';
    els.freeEnd.value = '';
  }
  els.editModal.style.display = on? 'flex':'none';
}

async function confirmFree(){
  const content = els.freeContent.value.trim();
  const date = els.freeDate.value;
  const s = els.freeStart.value;
  const e = els.freeEnd.value;
  if(!content || !date || !s || !e){ alert('请输入完整的记录'); return; }
  const start = new Date(`${date}T${s}:00`);
  const end = new Date(`${date}T${e}:00`);
  const duration = end - start;
  if(isNaN(duration) || duration < 0){ alert('时间不合法'); return; }

  await insertEvent({
    content,
    start_at: start.toISOString(),
    end_at: end.toISOString(),
    duration_ms: duration,
    created_at: new Date().toISOString()
  });
  openFreeModal(false);
}

/* ================= 渲染 & 导出 ================= */
function renderEvents(){
  // 按日期分组
  const groups = {};
  for(const ev of events){
    const d = isoToDateKey(ev.start_at);
    if(!groups[d]) groups[d] = [];
    groups[d].push(ev);
  }
  const days = Object.keys(groups).sort(); // 升序
  els.outputBox.innerHTML = '';
  for(const day of days){
    const head = document.createElement('div');
    head.style.cssText = 'padding:6px 0;color:#4b5563;font-weight:700;';
    const dt = new Date(day);
    head.textContent = `${dt.getFullYear()}年${dt.getMonth()+1}月${dt.getDate()}日`;
    els.outputBox.appendChild(head);
    for(const ev of groups[day]){
      const div = document.createElement('div');
      div.className='event';
      div.innerHTML = `
        <p class="event-line">开始时间：${fmtTime(ev.start_at)}</p>
        <p class="event-line">内容：${escapeHtml(ev.content)}</p>
        <p class="event-line">结束时间：${fmtTime(ev.end_at)}</p>
        <p class="event-line">间隔时间：${fmtDuration(ev.duration_ms)}</p>
      `;
      els.outputBox.appendChild(div);
      const hr = document.createElement('hr'); els.outputBox.appendChild(hr);
    }
  }
}

function exportStats(){
  const merged = {};
  for(const ev of events){
    merged[ev.content] = (merged[ev.content] || 0) + (ev.duration_ms || 0);
  }
  const total = Object.values(merged).reduce((a,b)=>a+b,0);
  let text = `总的累积时长: ${fmtDuration(total)}\n-------------------------\n`;
  const sorted = Object.entries(merged).sort((a,b)=>b[1]-a[1]);
  sorted.forEach(([content, dur], idx)=>{ text += `${idx+1}. ${content} -> ${fmtDuration(dur)}\n`; });

  const blob = new Blob([text], { type:'text/plain' });
  const now = new Date();
  const filename = `${now.getFullYear()}年${pad(now.getMonth()+1)}月${pad(now.getDate())}日${pad(now.getHours())}时${pad(now.getMinutes())}分${pad(now.getSeconds())}秒统计时间.txt`;
  downloadBlob(blob, filename);
}

function exportJSON(){
  if(currentUser){
    downloadBlob(new Blob([JSON.stringify(events,null,2)],{type:'application/json'}), 'events_cloud.json');
  }else{
    downloadBlob(new Blob([JSON.stringify(events,null,2)],{type:'application/json'}), 'events_local.json');
  }
}

async function syncLocalToCloud(){
  if(!currentUser){ alert('请先登录'); return; }
  const locals = events.filter(e=>String(e.id).startsWith('local-'));
  if(locals.length===0){ alert('没有需要同步的本地记录'); return; }
  const rows = locals.map(({id, ...rest}) => ({ user_id: currentUser.id, ...rest }));
  const { error } = await sb.from('events').insert(rows);
  if(error){ alert('同步失败：'+error.message); return; }
  await loadAllFromCloud();
  alert('本地记录已同步至云端');
}

/* ================= 小工具 ================= */
function fmtTime(x){
  const d = (x instanceof Date) ? x : new Date(x);
  return d.toLocaleTimeString('zh-CN', { hour12:false });
}
function fmtDuration(ms){
  const s = Math.floor(ms/1000);
  const sec = s%60;
  const min = Math.floor(s/60)%60;
  const hr = Math.floor(s/3600);
  if(hr>0) return `${hr}时 ${min}分 ${sec}秒`;
  if(min>0) return `${min}分 ${sec}秒`;
  return `${sec}秒`;
}
function isoToDateKey(iso){
  const d = new Date(iso);
  return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
}
function pad(n){ return String(n).padStart(2,'0'); }
function downloadBlob(blob, filename){ const a=document.createElement('a'); a.download=filename; a.href=URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
function toggleBtn(id, disabled, text){ const btn=document.getElementById(id); if(!btn) return; btn.disabled=!!disabled; if(text) btn.textContent=text; }
function toast(msg){ console.log(msg); }

/* —— 指示灯 —— */
function updateStatusIndicator(){
  const online = navigator.onLine;
  const pending = JSON.parse(localStorage.getItem('events_pending')||'[]').length;
  const parts = [];
  parts.push(online ? '🟢 在线' : '🔴 离线');
  parts.push(currentUser ? '已登录' : '未登录');
  if(currentUser) parts.push(pending>0 ? `待同步(${pending})` : '已同步');
  els.syncBadge.textContent = parts.join(' · ');
}

/* —— 兜底 —— */
window.addEventListener('unhandledrejection', e=>{
  console.error('[unhandledrejection]', e.reason);
  alert('出错了：' + (e.reason?.message || e.reason));
});
</script>
</body>
</html>
