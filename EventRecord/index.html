<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Record Â· äº‘ç«¯åŒæ­¥ç‰ˆ</title>
  <style>
    :root {
      --bg:#fff; --fg:#222; --muted:#777; --line:#ddd; --brand:#4f46e5; --brand-2:#22c55e;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'PingFang SC', 'Noto Sans CJK SC', 'Microsoft Yahei', sans-serif;
      margin: 0; display: flex; flex-direction: column; min-height: 100vh; color: var(--fg); background: var(--bg);
    }
    header {
      display: flex; gap: 12px; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid var(--line); position: sticky; top: 0; background: var(--bg); z-index: 5;
    }
    .app-title { font-weight: 700; }
    .auth-bar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .auth-bar input { padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; min-width: 180px; }
    .btn {
      padding: 8px 12px; border: 1px solid var(--line); background: #f7f7f7; border-radius: 8px; cursor: pointer;
    }
    .btn.primary { background: var(--brand); color: white; border-color: var(--brand); }
    .btn.ghost { background: transparent; }
    .btn.small { padding: 6px 10px; }
    .pill { padding: 4px 8px; border-radius: 999px; border: 1px solid var(--line); font-size: 12px; color: var(--muted); }

    .toolbar { display: flex; gap: 8px; padding: 8px 16px; border-bottom: 1px solid var(--line); align-items: center; flex-wrap: wrap; }
    .menu { margin-left: auto; position: relative; }
    .menu > button { font-size: 18px; }
    .menu-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 4px); background: white; border: 1px solid var(--line); box-shadow: 0 10px 30px rgba(0,0,0,.08); min-width: 180px; border-radius: 10px; overflow: hidden; z-index:10; }
    .menu:hover .menu-dropdown { display: block; }
    .menu-dropdown button, .menu-dropdown label {
      display: block; width: 100%; text-align: left; padding: 10px 12px; border: 0; background: white; cursor: pointer;
    }
    .menu-dropdown button:hover, .menu-dropdown label:hover { background: #f5f5f5; }

    main { display: flex; flex-direction: column; gap: 12px; padding: 16px; flex: 1; }
    .date-display { text-align: center; font-size: 20px; font-weight: 700; margin: 4px 0 8px; }
    .output-box { flex: 1; width: 100%; border: 1px solid var(--line); padding: 10px; overflow-y: auto; border-radius: 10px; background: #fff; }
    .edit-box { width: 100%; height: 100px; border: 1px solid var(--line); padding: 10px; border-radius: 10px; }

    .button-row { display: flex; gap: 10px; flex-wrap: wrap; }

    .event-line { margin: 0; }
    hr { margin: 4px 0; border: 0; border-top: 1px dashed var(--line); }

    .dialog-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); align-items: center; justify-content: center; z-index: 1000; }
    .dialog { background: white; padding: 16px; border-radius: 10px; min-width: 320px; }
    .dialog textarea { width: 100%; }

    footer { display: flex; align-items: center; justify-content: center; height: 40px; background: #f7f7f7; border-top: 1px solid var(--line); }
    #test-link { font-size: 12px; color: var(--muted); }
    #test-link a { color: inherit; text-decoration: none; }
  </style>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="app-title">ğŸ•’ Event Record</div>
    <div class="auth-bar">
      <div id="auth-signed-out">
        <input type="email" id="email" placeholder="é‚®ç®±" />
        <input type="password" id="password" placeholder="å¯†ç ï¼ˆâ‰¥6ä½ï¼‰" />
        <button class="btn" id="btnSignUp">æ³¨å†Œ</button>
        <button class="btn primary" id="btnSignIn">ç™»å½•</button>
      </div>
      <div id="auth-signed-in" style="display:none; gap:8px; align-items:center;">
        <span class="pill" id="userEmail"></span>
        <span class="pill" id="syncStatus">æœªåŒæ­¥</span>
        <button class="btn" id="btnSignOut">é€€å‡º</button>
      </div>
    </div>
  </header>

  <div class="toolbar">
    <span class="pill" id="todayTag">ä»Šå¤©</span>
    <div class="menu">
      <button class="btn ghost">â‹®</button>
      <div class="menu-dropdown">
        <button id="btnStats">ç»Ÿè®¡ï¼ˆä¸‹è½½TXTï¼‰</button>
        <button id="btnClearLocal">æ¸…ç©ºæœ¬åœ°å†…å®¹</button>
        <button id="btnToggleEdit">ç¼–è¾‘å†…å®¹</button>
        <button id="btnExportJson">å¯¼å‡ºJSONï¼ˆäº‘ç«¯/æœ¬åœ°ï¼‰</button>
        <label for="importJson">å¯¼å…¥JSON â†’ æ’å…¥äº‘ç«¯/æœ¬åœ°</label>
        <input id="importJson" type="file" accept="application/json" style="display:none;" />
        <button id="btnSyncNow">ç«‹å³åŒæ­¥ï¼ˆç¦»çº¿ç¼“å­˜â†’äº‘ç«¯ï¼‰</button>
      </div>
    </div>
  </div>

  <main>
    <div class="date-display" id="dateDisplay"></div>
    <div class="output-box" id="outputBox" contenteditable="false"></div>

    <div class="button-row">
      <button class="btn primary" id="btnStart">å¼€å§‹è®°å½•</button>
      <button class="btn" id="btnEnd">ç»“æŸè®°å½•</button>
      <button class="btn" id="btnFreeEdit">è‡ªç”±ç¼–è¾‘</button>
    </div>

    <div class="edit-box" contenteditable="true" id="editBox" placeholder="è¾“å…¥å½“å‰æ­£åœ¨åšçš„äº‹æƒ…â€¦"></div>
  </main>

  <!-- è‡ªç”±ç¼–è¾‘å¼¹çª— -->
  <div class="dialog-overlay" id="dialogOverlay">
    <div class="dialog">
      <textarea id="dialogEditBox" rows="4" placeholder="è¾“å…¥äº‹é¡¹å†…å®¹..."></textarea>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <input type="time" id="startTimeInput" />
        <input type="time" id="endTimeInput" />
      </div>
      <div style="display:flex; gap:8px; margin-top:10px; justify-content:flex-end;">
        <button class="btn primary" id="btnConfirmEdit">ç¡®è®¤è®°å½•</button>
        <button class="btn" id="btnCancelEdit">å–æ¶ˆè®°å½•</button>
      </div>
    </div>
  </div>

  <!-- æ¸…ç©ºç¡®è®¤å¼¹çª— -->
  <div class="dialog-overlay" id="clearDialogOverlay">
    <div class="dialog">
      <p>åªä¼šæ¸…ç©º<span style="color:var(--brand)">æœ¬åœ°ç¼“å­˜</span>ï¼ˆä¸ä¼šåˆ é™¤äº‘ç«¯æ•°æ®ï¼‰ã€‚ç¡®è®¤æ¸…ç©ºå—ï¼Ÿ</p>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn primary" id="btnConfirmClear">ç¡®å®šæ¸…ç©º</button>
        <button class="btn" id="btnCancelClear">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <footer>
    <p id="test-link"><a href="https://beian.miit.gov.cn/" target="_blank">é—½ICPå¤‡2023004461å·-1</a></p>
  </footer>

  <script>
    // ======================== åŸºæœ¬çŠ¶æ€ ========================
    let startTime = null;            // è®¡æ—¶å¼€å§‹æ—¶é—´ï¼ˆDateï¼‰
    let events = [];                 // é¡µé¢å†…å±•ç¤ºçš„äº‹ä»¶æ•°ç»„ï¼ˆä½œä¸ºç¼“å­˜ï¼‰
    let isEditing = false;           // æ˜¯å¦æ­£åœ¨ç¼–è¾‘ outputBox

    // Supabase å®¢æˆ·ç«¯
    // TODO: æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Supabase é¡¹ç›®é…ç½®
    const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null;
    let realtimeChannel = null;

    const els = {
      dateDisplay: document.getElementById('dateDisplay'),
      outputBox: document.getElementById('outputBox'),
      editBox: document.getElementById('editBox'),
      dialogOverlay: document.getElementById('dialogOverlay'),
      dialogEditBox: document.getElementById('dialogEditBox'),
      startTimeInput: document.getElementById('startTimeInput'),
      endTimeInput: document.getElementById('endTimeInput'),
      clearDialogOverlay: document.getElementById('clearDialogOverlay'),
      syncStatus: document.getElementById('syncStatus'),
      userEmail: document.getElementById('userEmail'),
      authOut: document.getElementById('auth-signed-out'),
      authIn: document.getElementById('auth-signed-in'),
      todayTag: document.getElementById('todayTag'),
      importJson: document.getElementById('importJson'),
    };

    // ======================== åˆå§‹åŒ– ========================
    window.addEventListener('load', async () => {
      displayCurrentDate();
      restoreLocalCache();
      wireUI();
      await initAuth();
    });

    function displayCurrentDate() {
      const now = new Date();
      const s = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
      els.dateDisplay.textContent = s;
    }

    function wireUI() {
      document.getElementById('btnStart').onclick = startTiming;
      document.getElementById('btnEnd').onclick = endTiming;
      document.getElementById('btnFreeEdit').onclick = showEditDialog;

      document.getElementById('btnStats').onclick = outputStatisticsTXT;
      document.getElementById('btnClearLocal').onclick = showClearDialog;
      document.getElementById('btnToggleEdit').onclick = toggleEdit;
      document.getElementById('btnExportJson').onclick = exportJSON;
      document.getElementById('btnSyncNow').onclick = flushPending;
      els.importJson.onchange = importJSON;

      document.getElementById('btnConfirmEdit').onclick = confirmEdit;
      document.getElementById('btnCancelEdit').onclick = hideEditDialog;

      document.getElementById('btnConfirmClear').onclick = clearLocal;
      document.getElementById('btnCancelClear').onclick = hideClearDialog;

      // Auth buttons
      document.getElementById('btnSignUp').onclick = signUp;
      document.getElementById('btnSignIn').onclick = signIn;
      document.getElementById('btnSignOut').onclick = signOut;

      // ç½‘ç»œæ¢å¤åå°è¯•åŒæ­¥
      window.addEventListener('online', flushPending);
    }

    // ======================== æœ¬åœ°ç¼“å­˜ ========================
    function restoreLocalCache() {
      try {
        const saved = localStorage.getItem('events');
        if (saved) {
          events = JSON.parse(saved);
          displayEvents();
        }
      } catch(e) { console.warn('è¯»å–æœ¬åœ°ç¼“å­˜å¤±è´¥', e); }
    }
    function saveLocalCache() {
      localStorage.setItem('events', JSON.stringify(events));
    }

    // ======================== è®¡æ—¶/è®°å½• ========================
    function startTiming() {
      startTime = new Date();
      appendLine(`å¼€å§‹æ—¶é—´ï¼š${startTime.toLocaleTimeString()}`);
    }

    async function endTiming() {
      const content = els.editBox.innerText.trim();
      if (!content) { alert('è¯·è¾“å…¥å†…å®¹'); return; }
      const endTime = new Date();
      if (!startTime) startTime = new Date(endTime.getTime()); // å…œåº•
      const duration = endTime - startTime;

      const event = {
        // å±•ç¤ºå­—æ®µ
        content,
        startTime: startTime.toLocaleTimeString(),
        endTime: endTime.toLocaleTimeString(),
        duration,
        // äº‘ç«¯å­—æ®µï¼ˆå«æ—¥æœŸï¼‰
        start_time_iso: startTime.toISOString(),
        end_time_iso: endTime.toISOString(),
      };

      events.push(event);
      displayEvents();
      saveLocalCache();
      els.editBox.innerText = '';

      if (currentUser) {
        await insertEventToCloud(event);
      }
    }

    // è‡ªç”±ç¼–è¾‘å¼¹çª—
    function showEditDialog(){ els.dialogOverlay.style.display = 'flex'; }
    function hideEditDialog(){ els.dialogOverlay.style.display = 'none'; }

    async function confirmEdit(){
      const content = els.dialogEditBox.value.trim();
      const s = els.startTimeInput.value; // HH:mm
      const e = els.endTimeInput.value;   // HH:mm
      if (!content || !s || !e) { alert('è¯·è¾“å…¥å®Œæ•´çš„è®°å½•'); return; }

      const now = new Date();
      const [sh, sm] = s.split(':').map(Number);
      const [eh, em] = e.split(':').map(Number);
      let sd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), sh, sm, 0);
      let ed = new Date(now.getFullYear(), now.getMonth(), now.getDate(), eh, em, 0);
      if (ed < sd) ed.setDate(ed.getDate() + 1); // è·¨æ—¥
      const duration = ed - sd;

      const event = {
        content,
        startTime: sd.toLocaleTimeString(),
        endTime: ed.toLocaleTimeString(),
        duration,
        start_time_iso: sd.toISOString(),
        end_time_iso: ed.toISOString(),
      };
      events.push(event);
      displayEvents();
      saveLocalCache();
      hideEditDialog();

      if (currentUser) {
        await insertEventToCloud(event);
      }

      // æ¸…ç©ºå¼¹çª—è¾“å…¥
      els.dialogEditBox.value=''; els.startTimeInput.value=''; els.endTimeInput.value='';
    }

    function appendLine(html){
      els.outputBox.insertAdjacentHTML('beforeend', `<p class="event-line">${html}</p>`);
    }

    function displayEvents(){
      els.outputBox.innerHTML = '';
      events.forEach(ev => {
        els.outputBox.insertAdjacentHTML('beforeend', `
          <div class="event">
            <p class="event-line">å¼€å§‹æ—¶é—´ï¼š${ev.startTime}</p>
            <p class="event-line">å†…å®¹ï¼š${ev.content}</p>
            <p class="event-line">ç»“æŸæ—¶é—´ï¼š${ev.endTime}</p>
            <p class="event-line">é—´éš”æ—¶é—´ï¼š${formatElapsedTime(ev.duration)}</p>
          </div>
          <hr />
        `);
      });
    }

    function formatElapsedTime(ms){
      const totalSeconds = Math.floor(ms/1000);
      const seconds = totalSeconds % 60;
      const totalMinutes = Math.floor(totalSeconds/60);
      const minutes = totalMinutes % 60;
      const hours = Math.floor(totalMinutes/60);
      if (hours>0) return `${hours}æ—¶ ${minutes}åˆ† ${seconds}ç§’`;
      if (minutes>0) return `${minutes}åˆ† ${seconds}ç§’`;
      return `${seconds}ç§’`;
    }

    // ======================== ç¼–è¾‘ outputBox ========================
    async function toggleEdit(){
      const editBtn = document.getElementById('btnToggleEdit');
      if (isEditing){
        // ä»æ–‡æœ¬è§£æ â†’ è¦†ç›–ä»Šå¤©çš„äº‘ç«¯æ•°æ®ï¼ˆä»…å½“å·²ç™»å½•ï¼‰
        const updated = parseEventsFromText(els.outputBox.innerText);
        events = updated; displayEvents(); saveLocalCache();
        els.outputBox.contentEditable = 'false';
        editBtn.textContent = 'ç¼–è¾‘å†…å®¹';
        isEditing = false;
        if (currentUser){ await overwriteTodayOnCloud(updated); }
      } else {
        els.outputBox.contentEditable = 'true';
        editBtn.textContent = 'é”å®šå†…å®¹';
        isEditing = true;
      }
    }

    function parseEventsFromText(text){
      const lines = text.split('\n');
      const updated = []; let cur = {};
      for (const line of lines){
        if (line.startsWith('å¼€å§‹æ—¶é—´ï¼š')){
          cur.startTime = line.split('ï¼š')[1].trim();
        } else if (line.startsWith('å†…å®¹ï¼š')){
          cur.content = line.split('ï¼š')[1].trim();
        } else if (line.startsWith('ç»“æŸæ—¶é—´ï¼š')){
          cur.endTime = line.split('ï¼š')[1].trim();
        } else if (line.startsWith('é—´éš”æ—¶é—´ï¼š')){
          const durText = line.split('ï¼š')[1].trim();
          cur.duration = parseDurationText(durText);
          // ç”¨ä»Šå¤©æ—¥æœŸæ‹¼ ISOï¼Œå°½åŠ›è¿˜åŸ
          const today = new Date();
          const toDate = (hhmmss)=>{
            const [h,m,s] = hhmmss.split(':').map(Number);
            return new Date(today.getFullYear(), today.getMonth(), today.getDate(), h||0, m||0, s||0);
          }
          const sd = toDate(cur.startTime);
          const ed = toDate(cur.endTime);
          if (ed < sd) ed.setDate(ed.getDate()+1);
          cur.start_time_iso = sd.toISOString();
          cur.end_time_iso = ed.toISOString();
          updated.push({...cur});
          cur = {};
        }
      }
      return updated;
    }

    function parseDurationText(t){
      const parts = t.match(/(\d+)(æ—¶|åˆ†|ç§’)/g) || [];
      let ms = 0;
      for (const part of parts){
        const v = parseInt(part);
        if (part.endsWith('æ—¶')) ms += v*60*60*1000;
        else if (part.endsWith('åˆ†')) ms += v*60*1000;
        else if (part.endsWith('ç§’')) ms += v*1000;
      }
      return ms;
    }

    // ======================== TXT ç»Ÿè®¡å¯¼å‡º ========================
    function outputStatisticsTXT(){
      const merged = {};
      for (const ev of events){
        merged[ev.content] = (merged[ev.content]||0) + (ev.duration||0);
      }
      const total = Object.values(merged).reduce((a,b)=>a+b,0);
      let text = `æ€»çš„ç´¯ç§¯æ—¶é•¿: ${formatElapsedTime(total)}\n-------------------------\n`;
      const sorted = Object.entries(merged).sort((a,b)=>b[1]-a[1]);
      sorted.forEach(([content, dur], i)=>{ text += `${i+1}. ${content} -> ${formatElapsedTime(dur)}\n`; });
      const blob = new Blob([text], { type: 'text/plain' });
      const now = new Date();
      const pad = n=>String(n).padStart(2,'0');
      const filename = `${now.getFullYear()}å¹´${pad(now.getMonth()+1)}æœˆ${pad(now.getDate())}æ—¥${pad(now.getHours())}æ—¶${pad(now.getMinutes())}åˆ†${pad(now.getSeconds())}ç§’ç»Ÿè®¡æ—¶é—´.txt`;
      downloadBlob(blob, filename);
    }

    function downloadBlob(blob, filename){
      const a = document.createElement('a');
      a.download = filename; a.href = URL.createObjectURL(blob); a.target = '_blank'; a.style.display='none';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // ======================== JSON å¯¼å‡º/å¯¼å…¥ ========================
    async function exportJSON(){
      if (currentUser){
        const { data, error } = await sb.from('events').select('*').eq('user_id', currentUser.id).order('start_time', { ascending: true });
        if (error){ alert('å¯¼å‡ºå¤±è´¥ï¼š'+error.message); return; }
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        downloadBlob(blob, 'events-export.json');
      } else {
        const blob = new Blob([JSON.stringify(events, null, 2)], { type: 'application/json' });
        downloadBlob(blob, 'events-export-local.json');
      }
    }

    async function importJSON(e){
      const file = e.target.files?.[0]; if (!file) return;
      const text = await file.text();
      try {
        const arr = JSON.parse(text);
        if (!Array.isArray(arr)) throw new Error('JSON æ ¼å¼åº”ä¸ºæ•°ç»„');
        if (currentUser){
          const rows = arr.map(x=>({
            user_id: currentUser.id,
            content: x.content || x.CONTENT || '',
            start_time: x.start_time || x.start_time_iso || new Date().toISOString(),
            end_time: x.end_time || x.end_time_iso || new Date().toISOString(),
            duration_ms: x.duration_ms ?? x.duration ?? 0,
          }));
          const { error } = await sb.from('events').insert(rows);
          if (error) throw error;
          await loadAllFromCloud();
        } else {
          // å¯¼å…¥åˆ°æœ¬åœ°ç¼“å­˜
          const mapped = arr.map(x=>({
            content: x.content || '',
            startTime: x.startTime || new Date(x.start_time||Date.now()).toLocaleTimeString(),
            endTime: x.endTime || new Date(x.end_time||Date.now()).toLocaleTimeString(),
            duration: x.duration ?? x.duration_ms ?? 0,
            start_time_iso: x.start_time || x.start_time_iso || new Date().toISOString(),
            end_time_iso: x.end_time || x.end_time_iso || new Date().toISOString(),
          }));
          events.push(...mapped); displayEvents(); saveLocalCache();
        }
        alert('å¯¼å…¥å®Œæˆ');
      } catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message); }
      e.target.value = '';
    }

    // ======================== Supabase - è®¤è¯ ========================
    async function initAuth(){
      const { data: { session } } = await sb.auth.getSession();
      currentUser = session?.user || null; updateAuthUI();
      if (currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
      sb.auth.onAuthStateChange(async (_event, session) => {
        currentUser = session?.user || null; updateAuthUI();
        if (currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
        else { unsubscribeRealtime(); }
      });
    }

    function updateAuthUI(){
      if (currentUser){
        els.authOut.style.display = 'none';
        els.authIn.style.display = 'flex';
        els.userEmail.textContent = currentUser.email || 'å·²ç™»å½•';
        els.syncStatus.textContent = 'å·²ç™»å½•';
      } else {
        els.authOut.style.display = 'block';
        els.authIn.style.display = 'none';
        els.syncStatus.textContent = 'æœªç™»å½•';
      }
    }

    async function signUp(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await sb.auth.signUp({ email, password });
      if (error) alert('æ³¨å†Œå¤±è´¥ï¼š'+error.message); else alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç»§ç»­ç™»å½•ã€‚');
    }

    async function signIn(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) alert('ç™»å½•å¤±è´¥ï¼š'+error.message);
    }

    async function signOut(){
      await sb.auth.signOut();
      // ä»…é€€å‡ºç™»å½•ï¼Œä¸æ¸…ç©ºæœ¬åœ°ç¼“å­˜
    }

    // ======================== Supabase - æ•°æ® ========================
    async function insertEventToCloud(ev){
      if (!currentUser) return;
      const row = {
        user_id: currentUser.id,
        content: ev.content,
        start_time: ev.start_time_iso || new Date().toISOString(),
        end_time: ev.end_time_iso || new Date().toISOString(),
        duration_ms: ev.duration || 0,
      };
      const { error } = await sb.from('events').insert(row);
      if (error){
        console.warn('äº‘ç«¯æ’å…¥å¤±è´¥ï¼ŒåŠ å…¥å¾…åŒæ­¥é˜Ÿåˆ—ï¼š', error.message);
        queuePending(row); setSyncBadge('å¾…åŒæ­¥');
      } else {
        setSyncBadge('å·²åŒæ­¥');
      }
    }

    async function loadAllFromCloud(){
      if (!currentUser) return;
      const { data, error } = await sb.from('events').select('*').eq('user_id', currentUser.id).order('start_time', { ascending: true });
      if (error){ console.warn('åŠ è½½äº‘ç«¯å¤±è´¥ï¼š', error.message); return; }
      // æ˜ å°„ä¸ºé¡µé¢å±•ç¤ºç»“æ„
      events = (data||[]).map(r=>({
        content: r.content,
        startTime: new Date(r.start_time).toLocaleTimeString(),
        endTime: new Date(r.end_time).toLocaleTimeString(),
        duration: r.duration_ms,
        start_time_iso: r.start_time,
        end_time_iso: r.end_time,
      }));
      displayEvents(); saveLocalCache();
    }

    // è¦†ç›–â€œä»Šå¤©â€çš„äº‘ç«¯æ•°æ®ï¼ˆç”¨äºä»æ–‡æœ¬ç¼–è¾‘å™¨åŒæ­¥ï¼‰
    async function overwriteTodayOnCloud(list){
      if (!currentUser) return;
      const today = new Date();
      const y = today.getFullYear(), m = today.getMonth()+1, d = today.getDate();
      const pad = n=>String(n).padStart(2,'0');
      const start = `${y}-${pad(m)}-${pad(d)}T00:00:00.000Z`;
      const end   = `${y}-${pad(m)}-${pad(d)}T23:59:59.999Z`;
      // å…ˆåˆ ä»Šå¤©ï¼Œå†æ’å…¥
      const { error: delErr } = await sb.from('events')
        .delete()
        .eq('user_id', currentUser.id)
        .gte('start_time', start)
        .lte('start_time', end);
      if (delErr){ console.warn('åˆ é™¤ä»Šå¤©äº‘ç«¯æ•°æ®å¤±è´¥ï¼š', delErr.message); }
      const rows = list.map(ev=>({
        user_id: currentUser.id,
        content: ev.content,
        start_time: ev.start_time_iso || new Date().toISOString(),
        end_time: ev.end_time_iso || new Date().toISOString(),
        duration_ms: ev.duration || 0,
      }));
      const { error: insErr } = await sb.from('events').insert(rows);
      if (insErr){ console.warn('æ‰¹é‡æ’å…¥å¤±è´¥ï¼š', insErr.message); setSyncBadge('å¾…åŒæ­¥'); }
      else setSyncBadge('å·²åŒæ­¥');
    }

    // ======================== Supabase - Realtime ========================
    function subscribeRealtime(){
      if (!currentUser) return;
      if (realtimeChannel) sb.removeChannel(realtimeChannel);
      realtimeChannel = sb.channel('events-ch');
      realtimeChannel.on('postgres_changes', { event: '*', schema: 'public', table: 'events', filter: `user_id=eq.${currentUser.id}` }, async (payload) => {
        // ä»»æ„å¢åˆ æ”¹ â†’ é‡æ–°æ‹‰å–
        await loadAllFromCloud();
      }).subscribe();
    }
    function unsubscribeRealtime(){ if (realtimeChannel){ sb.removeChannel(realtimeChannel); realtimeChannel = null; } }

    // ======================== å¾…åŒæ­¥é˜Ÿåˆ—ï¼ˆç¦»çº¿ï¼‰ ========================
    function queuePending(row){
      const q = JSON.parse(localStorage.getItem('pending')||'[]');
      q.push(row); localStorage.setItem('pending', JSON.stringify(q));
    }
    async function flushPending(){
      if (!currentUser) return;
      const q = JSON.parse(localStorage.getItem('pending')||'[]');
      if (q.length===0) { setSyncBadge('å·²åŒæ­¥'); return; }
      const { error } = await sb.from('events').insert(q);
      if (!error){ localStorage.removeItem('pending'); setSyncBadge('å·²åŒæ­¥'); }
      else { console.warn('åŒæ­¥å¤±è´¥ï¼š', error.message); setSyncBadge('å¾…åŒæ­¥'); }
    }
    function setSyncBadge(text){ els.syncStatus.textContent = text; }

    // ======================== æ¸…ç©º/å¼¹çª— ========================
    function showClearDialog(){ els.clearDialogOverlay.style.display = 'flex'; }
    function hideClearDialog(){ els.clearDialogOverlay.style.display = 'none'; }
    function clearLocal(){ events = []; displayEvents(); saveLocalCache(); hideClearDialog(); }
  </script>

  <!-- å¯é€‰ï¼šCloudflare Insightsï¼ˆä¿ç•™ä½ çš„è„šæœ¬ï¼‰ -->
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"70f3b625243c456f9ab4034f8b8b3974","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
