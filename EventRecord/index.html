<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Record · 云端同步版</title>
  <style>
    :root {
      --bg:#fff; --fg:#222; --muted:#777; --line:#ddd; --brand:#4f46e5; --brand-2:#22c55e;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'PingFang SC', 'Noto Sans CJK SC', 'Microsoft Yahei', sans-serif;
      margin: 0; display: flex; flex-direction: column; min-height: 100vh; color: var(--fg); background: var(--bg);
    }
    header {
      display: flex; gap: 12px; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid var(--line); position: sticky; top: 0; background: var(--bg); z-index: 5;
    }
    .app-title { font-weight: 700; }
    .auth-bar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .auth-bar input { padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; min-width: 180px; }
    .btn {
      padding: 8px 12px; border: 1px solid var(--line); background: #f7f7f7; border-radius: 8px; cursor: pointer;
    }
    .btn.primary { background: var(--brand); color: white; border-color: var(--brand); }
    .btn.ghost { background: transparent; }
    .btn.small { padding: 6px 10px; }
    .pill { padding: 4px 8px; border-radius: 999px; border: 1px solid var(--line); font-size: 12px; color: var(--muted); }

    .toolbar { display: flex; gap: 8px; padding: 8px 16px; border-bottom: 1px solid var(--line); align-items: center; flex-wrap: wrap; }
    .menu { margin-left: auto; position: relative; }
    .menu > button { font-size: 18px; }
    .menu-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 4px); background: white; border: 1px solid var(--line); box-shadow: 0 10px 30px rgba(0,0,0,.08); min-width: 180px; border-radius: 10px; overflow: hidden; z-index:10; }
    .menu:hover .menu-dropdown { display: block; }
    .menu-dropdown button, .menu-dropdown label {
      display: block; width: 100%; text-align: left; padding: 10px 12px; border: 0; background: white; cursor: pointer;
    }
    .menu-dropdown button:hover, .menu-dropdown label:hover { background: #f5f5f5; }

    main { display: flex; flex-direction: column; gap: 12px; padding: 16px; flex: 1; }
    .date-display { text-align: center; font-size: 20px; font-weight: 700; margin: 4px 0 8px; }
    .output-box { flex: 1; width: 100%; border: 1px solid var(--line); padding: 10px; overflow-y: auto; border-radius: 10px; background: #fff; }
    .edit-box { width: 100%; height: 100px; border: 1px solid var(--line); padding: 10px; border-radius: 10px; }

    .button-row { display: flex; gap: 10px; flex-wrap: wrap; }

    .event-line { margin: 0; }
    hr { margin: 4px 0; border: 0; border-top: 1px dashed var(--line); }

    .dialog-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); align-items: center; justify-content: center; z-index: 1000; }
    .dialog { background: white; padding: 16px; border-radius: 10px; min-width: 320px; }
    .dialog textarea { width: 100%; }

    footer { display: flex; align-items: center; justify-content: center; height: 40px; background: #f7f7f7; border-top: 1px solid var(--line); }
    #test-link { font-size: 12px; color: var(--muted); }
    #test-link a { color: inherit; text-decoration: none; }
  </style>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="app-title">🕒 Event Record</div>
    <div class="auth-bar">
      <div id="auth-signed-out">
        <input type="email" id="email" placeholder="邮箱" />
        <input type="password" id="password" placeholder="密码（≥6位）" />
        <button class="btn" id="btnSignUp">注册</button>
        <button class="btn primary" id="btnSignIn">登录</button>
      </div>
      <div id="auth-signed-in" style="display:none; gap:8px; align-items:center;">
        <span class="pill" id="userEmail"></span>
        <span class="pill" id="syncStatus">未同步</span>
        <button class="btn" id="btnSignOut">退出</button>
      </div>
    </div>
  </header>

  <div class="toolbar">
    <span class="pill" id="todayTag">今天</span>
    <div class="menu">
      <button class="btn ghost">⋮</button>
      <div class="menu-dropdown">
        <button id="btnStats">统计（下载TXT）</button>
        <button id="btnClearLocal">清空本地内容</button>
        <button id="btnToggleEdit">编辑内容</button>
        <button id="btnExportJson">导出JSON（云端/本地）</button>
        <label for="importJson">导入JSON → 插入云端/本地</label>
        <input id="importJson" type="file" accept="application/json" style="display:none;" />
        <button id="btnSyncNow">立即同步（离线缓存→云端）</button>
      </div>
    </div>
  </div>

  <main>
    <div class="date-display" id="dateDisplay"></div>
    <div class="output-box" id="outputBox" contenteditable="false"></div>

    <div class="button-row">
      <button class="btn primary" id="btnStart">开始记录</button>
      <button class="btn" id="btnEnd">结束记录</button>
      <button class="btn" id="btnFreeEdit">自由编辑</button>
    </div>

    <div class="edit-box" contenteditable="true" id="editBox" placeholder="输入当前正在做的事情…"></div>
  </main>

  <!-- 自由编辑弹窗 -->
  <div class="dialog-overlay" id="dialogOverlay">
    <div class="dialog">
      <textarea id="dialogEditBox" rows="4" placeholder="输入事项内容..."></textarea>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <input type="time" id="startTimeInput" />
        <input type="time" id="endTimeInput" />
      </div>
      <div style="display:flex; gap:8px; margin-top:10px; justify-content:flex-end;">
        <button class="btn primary" id="btnConfirmEdit">确认记录</button>
        <button class="btn" id="btnCancelEdit">取消记录</button>
      </div>
    </div>
  </div>

  <!-- 清空确认弹窗 -->
  <div class="dialog-overlay" id="clearDialogOverlay">
    <div class="dialog">
      <p>只会清空<span style="color:var(--brand)">本地缓存</span>（不会删除云端数据）。确认清空吗？</p>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn primary" id="btnConfirmClear">确定清空</button>
        <button class="btn" id="btnCancelClear">取消</button>
      </div>
    </div>
  </div>

  <footer>
    <p id="test-link"><a href="https://beian.miit.gov.cn/" target="_blank">闽ICP备2023004461号-1</a></p>
  </footer>

  <script>
    // ======================== 基本状态 ========================
    let startTime = null;            // 计时开始时间（Date）
    let events = [];                 // 页面内展示的事件数组（作为缓存）
    let isEditing = false;           // 是否正在编辑 outputBox

    // Supabase 客户端
    // TODO: 替换为你自己的 Supabase 项目配置
    const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null;
    let realtimeChannel = null;

    const els = {
      dateDisplay: document.getElementById('dateDisplay'),
      outputBox: document.getElementById('outputBox'),
      editBox: document.getElementById('editBox'),
      dialogOverlay: document.getElementById('dialogOverlay'),
      dialogEditBox: document.getElementById('dialogEditBox'),
      startTimeInput: document.getElementById('startTimeInput'),
      endTimeInput: document.getElementById('endTimeInput'),
      clearDialogOverlay: document.getElementById('clearDialogOverlay'),
      syncStatus: document.getElementById('syncStatus'),
      userEmail: document.getElementById('userEmail'),
      authOut: document.getElementById('auth-signed-out'),
      authIn: document.getElementById('auth-signed-in'),
      todayTag: document.getElementById('todayTag'),
      importJson: document.getElementById('importJson'),
    };

    // ======================== 初始化 ========================
    window.addEventListener('load', async () => {
      displayCurrentDate();
      restoreLocalCache();
      wireUI();
      await initAuth();
    });

    function displayCurrentDate() {
      const now = new Date();
      const s = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;
      els.dateDisplay.textContent = s;
    }

    function wireUI() {
      document.getElementById('btnStart').onclick = startTiming;
      document.getElementById('btnEnd').onclick = endTiming;
      document.getElementById('btnFreeEdit').onclick = showEditDialog;

      document.getElementById('btnStats').onclick = outputStatisticsTXT;
      document.getElementById('btnClearLocal').onclick = showClearDialog;
      document.getElementById('btnToggleEdit').onclick = toggleEdit;
      document.getElementById('btnExportJson').onclick = exportJSON;
      document.getElementById('btnSyncNow').onclick = flushPending;
      els.importJson.onchange = importJSON;

      document.getElementById('btnConfirmEdit').onclick = confirmEdit;
      document.getElementById('btnCancelEdit').onclick = hideEditDialog;

      document.getElementById('btnConfirmClear').onclick = clearLocal;
      document.getElementById('btnCancelClear').onclick = hideClearDialog;

      // Auth buttons
      document.getElementById('btnSignUp').onclick = signUp;
      document.getElementById('btnSignIn').onclick = signIn;
      document.getElementById('btnSignOut').onclick = signOut;

      // 网络恢复后尝试同步
      window.addEventListener('online', flushPending);
    }

    // ======================== 本地缓存 ========================
    function restoreLocalCache() {
      try {
        const saved = localStorage.getItem('events');
        if (saved) {
          events = JSON.parse(saved);
          displayEvents();
        }
      } catch(e) { console.warn('读取本地缓存失败', e); }
    }
    function saveLocalCache() {
      localStorage.setItem('events', JSON.stringify(events));
    }

    // ======================== 计时/记录 ========================
    function startTiming() {
      startTime = new Date();
      appendLine(`开始时间：${startTime.toLocaleTimeString()}`);
    }

    async function endTiming() {
      const content = els.editBox.innerText.trim();
      if (!content) { alert('请输入内容'); return; }
      const endTime = new Date();
      if (!startTime) startTime = new Date(endTime.getTime()); // 兜底
      const duration = endTime - startTime;

      const event = {
        // 展示字段
        content,
        startTime: startTime.toLocaleTimeString(),
        endTime: endTime.toLocaleTimeString(),
        duration,
        // 云端字段（含日期）
        start_time_iso: startTime.toISOString(),
        end_time_iso: endTime.toISOString(),
      };

      events.push(event);
      displayEvents();
      saveLocalCache();
      els.editBox.innerText = '';

      if (currentUser) {
        await insertEventToCloud(event);
      }
    }

    // 自由编辑弹窗
    function showEditDialog(){ els.dialogOverlay.style.display = 'flex'; }
    function hideEditDialog(){ els.dialogOverlay.style.display = 'none'; }

    async function confirmEdit(){
      const content = els.dialogEditBox.value.trim();
      const s = els.startTimeInput.value; // HH:mm
      const e = els.endTimeInput.value;   // HH:mm
      if (!content || !s || !e) { alert('请输入完整的记录'); return; }

      const now = new Date();
      const [sh, sm] = s.split(':').map(Number);
      const [eh, em] = e.split(':').map(Number);
      let sd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), sh, sm, 0);
      let ed = new Date(now.getFullYear(), now.getMonth(), now.getDate(), eh, em, 0);
      if (ed < sd) ed.setDate(ed.getDate() + 1); // 跨日
      const duration = ed - sd;

      const event = {
        content,
        startTime: sd.toLocaleTimeString(),
        endTime: ed.toLocaleTimeString(),
        duration,
        start_time_iso: sd.toISOString(),
        end_time_iso: ed.toISOString(),
      };
      events.push(event);
      displayEvents();
      saveLocalCache();
      hideEditDialog();

      if (currentUser) {
        await insertEventToCloud(event);
      }

      // 清空弹窗输入
      els.dialogEditBox.value=''; els.startTimeInput.value=''; els.endTimeInput.value='';
    }

    function appendLine(html){
      els.outputBox.insertAdjacentHTML('beforeend', `<p class="event-line">${html}</p>`);
    }

    function displayEvents(){
      els.outputBox.innerHTML = '';
      events.forEach(ev => {
        els.outputBox.insertAdjacentHTML('beforeend', `
          <div class="event">
            <p class="event-line">开始时间：${ev.startTime}</p>
            <p class="event-line">内容：${ev.content}</p>
            <p class="event-line">结束时间：${ev.endTime}</p>
            <p class="event-line">间隔时间：${formatElapsedTime(ev.duration)}</p>
          </div>
          <hr />
        `);
      });
    }

    function formatElapsedTime(ms){
      const totalSeconds = Math.floor(ms/1000);
      const seconds = totalSeconds % 60;
      const totalMinutes = Math.floor(totalSeconds/60);
      const minutes = totalMinutes % 60;
      const hours = Math.floor(totalMinutes/60);
      if (hours>0) return `${hours}时 ${minutes}分 ${seconds}秒`;
      if (minutes>0) return `${minutes}分 ${seconds}秒`;
      return `${seconds}秒`;
    }

    // ======================== 编辑 outputBox ========================
    async function toggleEdit(){
      const editBtn = document.getElementById('btnToggleEdit');
      if (isEditing){
        // 从文本解析 → 覆盖今天的云端数据（仅当已登录）
        const updated = parseEventsFromText(els.outputBox.innerText);
        events = updated; displayEvents(); saveLocalCache();
        els.outputBox.contentEditable = 'false';
        editBtn.textContent = '编辑内容';
        isEditing = false;
        if (currentUser){ await overwriteTodayOnCloud(updated); }
      } else {
        els.outputBox.contentEditable = 'true';
        editBtn.textContent = '锁定内容';
        isEditing = true;
      }
    }

    function parseEventsFromText(text){
      const lines = text.split('\n');
      const updated = []; let cur = {};
      for (const line of lines){
        if (line.startsWith('开始时间：')){
          cur.startTime = line.split('：')[1].trim();
        } else if (line.startsWith('内容：')){
          cur.content = line.split('：')[1].trim();
        } else if (line.startsWith('结束时间：')){
          cur.endTime = line.split('：')[1].trim();
        } else if (line.startsWith('间隔时间：')){
          const durText = line.split('：')[1].trim();
          cur.duration = parseDurationText(durText);
          // 用今天日期拼 ISO，尽力还原
          const today = new Date();
          const toDate = (hhmmss)=>{
            const [h,m,s] = hhmmss.split(':').map(Number);
            return new Date(today.getFullYear(), today.getMonth(), today.getDate(), h||0, m||0, s||0);
          }
          const sd = toDate(cur.startTime);
          const ed = toDate(cur.endTime);
          if (ed < sd) ed.setDate(ed.getDate()+1);
          cur.start_time_iso = sd.toISOString();
          cur.end_time_iso = ed.toISOString();
          updated.push({...cur});
          cur = {};
        }
      }
      return updated;
    }

    function parseDurationText(t){
      const parts = t.match(/(\d+)(时|分|秒)/g) || [];
      let ms = 0;
      for (const part of parts){
        const v = parseInt(part);
        if (part.endsWith('时')) ms += v*60*60*1000;
        else if (part.endsWith('分')) ms += v*60*1000;
        else if (part.endsWith('秒')) ms += v*1000;
      }
      return ms;
    }

    // ======================== TXT 统计导出 ========================
    function outputStatisticsTXT(){
      const merged = {};
      for (const ev of events){
        merged[ev.content] = (merged[ev.content]||0) + (ev.duration||0);
      }
      const total = Object.values(merged).reduce((a,b)=>a+b,0);
      let text = `总的累积时长: ${formatElapsedTime(total)}\n-------------------------\n`;
      const sorted = Object.entries(merged).sort((a,b)=>b[1]-a[1]);
      sorted.forEach(([content, dur], i)=>{ text += `${i+1}. ${content} -> ${formatElapsedTime(dur)}\n`; });
      const blob = new Blob([text], { type: 'text/plain' });
      const now = new Date();
      const pad = n=>String(n).padStart(2,'0');
      const filename = `${now.getFullYear()}年${pad(now.getMonth()+1)}月${pad(now.getDate())}日${pad(now.getHours())}时${pad(now.getMinutes())}分${pad(now.getSeconds())}秒统计时间.txt`;
      downloadBlob(blob, filename);
    }

    function downloadBlob(blob, filename){
      const a = document.createElement('a');
      a.download = filename; a.href = URL.createObjectURL(blob); a.target = '_blank'; a.style.display='none';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // ======================== JSON 导出/导入 ========================
    async function exportJSON(){
      if (currentUser){
        const { data, error } = await sb.from('events').select('*').eq('user_id', currentUser.id).order('start_time', { ascending: true });
        if (error){ alert('导出失败：'+error.message); return; }
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        downloadBlob(blob, 'events-export.json');
      } else {
        const blob = new Blob([JSON.stringify(events, null, 2)], { type: 'application/json' });
        downloadBlob(blob, 'events-export-local.json');
      }
    }

    async function importJSON(e){
      const file = e.target.files?.[0]; if (!file) return;
      const text = await file.text();
      try {
        const arr = JSON.parse(text);
        if (!Array.isArray(arr)) throw new Error('JSON 格式应为数组');
        if (currentUser){
          const rows = arr.map(x=>({
            user_id: currentUser.id,
            content: x.content || x.CONTENT || '',
            start_time: x.start_time || x.start_time_iso || new Date().toISOString(),
            end_time: x.end_time || x.end_time_iso || new Date().toISOString(),
            duration_ms: x.duration_ms ?? x.duration ?? 0,
          }));
          const { error } = await sb.from('events').insert(rows);
          if (error) throw error;
          await loadAllFromCloud();
        } else {
          // 导入到本地缓存
          const mapped = arr.map(x=>({
            content: x.content || '',
            startTime: x.startTime || new Date(x.start_time||Date.now()).toLocaleTimeString(),
            endTime: x.endTime || new Date(x.end_time||Date.now()).toLocaleTimeString(),
            duration: x.duration ?? x.duration_ms ?? 0,
            start_time_iso: x.start_time || x.start_time_iso || new Date().toISOString(),
            end_time_iso: x.end_time || x.end_time_iso || new Date().toISOString(),
          }));
          events.push(...mapped); displayEvents(); saveLocalCache();
        }
        alert('导入完成');
      } catch(err){ alert('导入失败：'+err.message); }
      e.target.value = '';
    }

    // ======================== Supabase - 认证 ========================
    async function initAuth(){
      const { data: { session } } = await sb.auth.getSession();
      currentUser = session?.user || null; updateAuthUI();
      if (currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
      sb.auth.onAuthStateChange(async (_event, session) => {
        currentUser = session?.user || null; updateAuthUI();
        if (currentUser){ await loadAllFromCloud(); subscribeRealtime(); flushPending(); }
        else { unsubscribeRealtime(); }
      });
    }

    function updateAuthUI(){
      if (currentUser){
        els.authOut.style.display = 'none';
        els.authIn.style.display = 'flex';
        els.userEmail.textContent = currentUser.email || '已登录';
        els.syncStatus.textContent = '已登录';
      } else {
        els.authOut.style.display = 'block';
        els.authIn.style.display = 'none';
        els.syncStatus.textContent = '未登录';
      }
    }

    async function signUp(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await sb.auth.signUp({ email, password });
      if (error) alert('注册失败：'+error.message); else alert('注册成功，请继续登录。');
    }

    async function signIn(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) alert('登录失败：'+error.message);
    }

    async function signOut(){
      await sb.auth.signOut();
      // 仅退出登录，不清空本地缓存
    }

    // ======================== Supabase - 数据 ========================
    async function insertEventToCloud(ev){
      if (!currentUser) return;
      const row = {
        user_id: currentUser.id,
        content: ev.content,
        start_time: ev.start_time_iso || new Date().toISOString(),
        end_time: ev.end_time_iso || new Date().toISOString(),
        duration_ms: ev.duration || 0,
      };
      const { error } = await sb.from('events').insert(row);
      if (error){
        console.warn('云端插入失败，加入待同步队列：', error.message);
        queuePending(row); setSyncBadge('待同步');
      } else {
        setSyncBadge('已同步');
      }
    }

    async function loadAllFromCloud(){
      if (!currentUser) return;
      const { data, error } = await sb.from('events').select('*').eq('user_id', currentUser.id).order('start_time', { ascending: true });
      if (error){ console.warn('加载云端失败：', error.message); return; }
      // 映射为页面展示结构
      events = (data||[]).map(r=>({
        content: r.content,
        startTime: new Date(r.start_time).toLocaleTimeString(),
        endTime: new Date(r.end_time).toLocaleTimeString(),
        duration: r.duration_ms,
        start_time_iso: r.start_time,
        end_time_iso: r.end_time,
      }));
      displayEvents(); saveLocalCache();
    }

    // 覆盖“今天”的云端数据（用于从文本编辑器同步）
    async function overwriteTodayOnCloud(list){
      if (!currentUser) return;
      const today = new Date();
      const y = today.getFullYear(), m = today.getMonth()+1, d = today.getDate();
      const pad = n=>String(n).padStart(2,'0');
      const start = `${y}-${pad(m)}-${pad(d)}T00:00:00.000Z`;
      const end   = `${y}-${pad(m)}-${pad(d)}T23:59:59.999Z`;
      // 先删今天，再插入
      const { error: delErr } = await sb.from('events')
        .delete()
        .eq('user_id', currentUser.id)
        .gte('start_time', start)
        .lte('start_time', end);
      if (delErr){ console.warn('删除今天云端数据失败：', delErr.message); }
      const rows = list.map(ev=>({
        user_id: currentUser.id,
        content: ev.content,
        start_time: ev.start_time_iso || new Date().toISOString(),
        end_time: ev.end_time_iso || new Date().toISOString(),
        duration_ms: ev.duration || 0,
      }));
      const { error: insErr } = await sb.from('events').insert(rows);
      if (insErr){ console.warn('批量插入失败：', insErr.message); setSyncBadge('待同步'); }
      else setSyncBadge('已同步');
    }

    // ======================== Supabase - Realtime ========================
    function subscribeRealtime(){
      if (!currentUser) return;
      if (realtimeChannel) sb.removeChannel(realtimeChannel);
      realtimeChannel = sb.channel('events-ch');
      realtimeChannel.on('postgres_changes', { event: '*', schema: 'public', table: 'events', filter: `user_id=eq.${currentUser.id}` }, async (payload) => {
        // 任意增删改 → 重新拉取
        await loadAllFromCloud();
      }).subscribe();
    }
    function unsubscribeRealtime(){ if (realtimeChannel){ sb.removeChannel(realtimeChannel); realtimeChannel = null; } }

    // ======================== 待同步队列（离线） ========================
    function queuePending(row){
      const q = JSON.parse(localStorage.getItem('pending')||'[]');
      q.push(row); localStorage.setItem('pending', JSON.stringify(q));
    }
    async function flushPending(){
      if (!currentUser) return;
      const q = JSON.parse(localStorage.getItem('pending')||'[]');
      if (q.length===0) { setSyncBadge('已同步'); return; }
      const { error } = await sb.from('events').insert(q);
      if (!error){ localStorage.removeItem('pending'); setSyncBadge('已同步'); }
      else { console.warn('同步失败：', error.message); setSyncBadge('待同步'); }
    }
    function setSyncBadge(text){ els.syncStatus.textContent = text; }

    // ======================== 清空/弹窗 ========================
    function showClearDialog(){ els.clearDialogOverlay.style.display = 'flex'; }
    function hideClearDialog(){ els.clearDialogOverlay.style.display = 'none'; }
    function clearLocal(){ events = []; displayEvents(); saveLocalCache(); hideClearDialog(); }
  </script>

  <!-- 可选：Cloudflare Insights（保留你的脚本） -->
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"70f3b625243c456f9ab4034f8b8b3974","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
