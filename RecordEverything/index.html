<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å¤‡å¿˜å½•</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f7f9fc;--card:#fff;--line:#e5e7eb;--text:#0b1220;--muted:#6b7280;
    --accent:#2563eb;--accent-weak:#eef2ff;--danger:#dc2626;--radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}

  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .container{padding:12px 16px}
  .nav{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:clamp(18px,4.5vw,22px)}
  .account{margin-left:auto}
  .account-btn{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe;
    padding:8px 12px;border-radius:999px;font-weight:600;max-width:70vw;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }

  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);
        padding:16px;box-shadow:0 6px 26px rgba(0,0,0,.06)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)}

  textarea,button{border:1px solid var(--line);border-radius:12px;padding:12px;font:inherit;background:#fff}
  textarea{width:100%;min-height:260px;resize:vertical;font-size:16px;outline:none}
  textarea:focus,button:focus{border-color:var(--accent)}
  .btn{background:var(--accent);color:#fff;border:none}
  .btn.secondary{background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe}
  .btn.ghost{background:transparent}
  .btn.danger{background:var(--danger)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .toolbar .btn{height:40px}

  /* å†²çªæç¤ºæ¡ */
  .conflict{
    display:none;align-items:center;gap:8px;margin-top:10px;
    padding:10px;border:1px dashed #c7d2fe;border-radius:12px;background:#f8faff;color:#1e3a8a
  }

  /* Toast */
  .toast-wrap{position:fixed;top:16px;left:0;right:0;display:flex;justify-content:center;z-index:20000;pointer-events:none}
  .toast{pointer-events:auto;background:#111827;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 28px rgba(0,0,0,.25);opacity:.98}
  .toast.ok{background:#065f46}.toast.err{background:#7f1d1d}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* æ¨¡æ€ï¼ˆç™»å½•/æ³¨å†Œ/é€€å‡ºï¼‰ */
  .modal{position:fixed;inset:0;z-index:30000;display:none}
  .modal.show{display:block}
  .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .modal .panel{
    position:absolute;left:50%;top:10%;transform:translateX(-50%);
    width:min(92vw,480px);max-height:80vh;overflow:auto;
    background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px
  }
  @media (max-width:680px){
    .modal .panel{
      left:12px;right:12px;top:auto;bottom:12px;transform:none;width:auto;max-height:84vh;
      border-radius:16px 16px 12px 12px
    }
  }
  .modal .close-x{
    position:absolute;right:10px;top:10px;width:36px;height:36px;
    border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer
  }
  .modal .title{margin:0 40px 10px 0;font-size:18px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .field label{font-size:12px;color:var(--muted)}
  .panel .btn{height:42px}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <h1>å¤‡å¿˜å½•</h1>
    <div class="account"><button id="accountBtn" class="account-btn">ç™»å½• / æ³¨å†Œ</button></div>
  </div>
</header>

<!-- Toast -->
<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<!-- æœªç™»å½•æç¤º -->
<div class="container" id="guestCard">
  <div class="card"><div class="row"><strong>è¯·å…ˆç™»å½•</strong><span class="muted">ç‚¹å‡»å³ä¸Šè§’ã€Œç™»å½• / æ³¨å†Œã€è¿›å…¥ä½ çš„è´¦æˆ·</span></div></div>
</div>

<!-- ä¸»ä½“ -->
<main class="container" id="app" style="display:none">
  <div class="card">
    <div class="toolbar" style="justify-content:flex-end;">
      <div id="syncState" class="muted" style="display:none">
        <span style="display:inline-block;width:14px;height:14px;border:2px solid #cfe3ff;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite"></span>
        æ­£åœ¨åŒæ­¥â€¦
      </div>
      <button id="refreshBtn" class="btn secondary">åˆ·æ–°</button>
    </div>

    <textarea id="memoInput" placeholder="å†™ç‚¹ä»€ä¹ˆâ€¦ï¼ˆç™»å½•åè‡ªåŠ¨ä¸äº‘ç«¯åŒæ­¥ä¿å­˜ï¼‰"></textarea>

    <!-- äº‘ç«¯ vs æœ¬åœ° å†²çªæç¤ºæ¡ -->
    <div id="conflictBar" class="conflict">
      <span>å·²ä¿ç•™æœ¬åœ°è‰ç¨¿ï¼ŒåŒæ—¶æ£€æµ‹åˆ°ä¸äº‘ç«¯å†…å®¹ä¸ä¸€è‡´ã€‚</span>
      <button id="useCloud" class="btn secondary">ç”¨äº‘ç«¯è¦†ç›–</button>
      <button id="appendCloud" class="btn secondary">æŠŠäº‘ç«¯è¿½åŠ åˆ°æœ«å°¾</button>
    </div>

    <div class="row" style="margin-top:10px;gap:10px">
      <button id="saveBtn" class="btn">ä¿å­˜</button>
      <button id="clearBtn" class="btn secondary">æ¸…ç©º</button>
      <button id="copyBtn" class="btn secondary">å¤åˆ¶</button>
    </div>
  </div>
</main>

<!-- æ¨¡æ€ï¼šç™»å½•/æ³¨å†Œ/è´¦æˆ· -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-hidden="true">
  <div class="backdrop" id="modalBackdrop"></div>
  <div class="panel" role="document">
    <button class="close-x" id="modalClose" aria-label="å…³é—­">âœ•</button>
    <h3 id="dialogTitle" class="title">ç™»å½• / æ³¨å†Œ</h3>
    <div id="dialogBody"></div>
  </div>
</div>

<script>
/* ========= Supabase ========= */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

const TABLE = 'memos';
const { createClient } = supabase;

/* å®‰å…¨ä¼šè¯å­˜å‚¨ï¼ˆlocalStorage ä¸å¯ç”¨æ—¶ç”¨ Cookieï¼‰ */
const cookieStorage = {
  getItem:k=>{const m=document.cookie.match(new RegExp('(?:^|; )'+encodeURIComponent(k)+'=([^;]*)'));return m?decodeURIComponent(m[1]):null},
  setItem:(k,v)=>{const e=new Date();e.setFullYear(e.getFullYear()+1);document.cookie=`${encodeURIComponent(k)}=${encodeURIComponent(v)}; Path=/; Expires=${e.toUTCString()}; SameSite=Lax; Secure`},
  removeItem:k=>{document.cookie=`${encodeURIComponent(k)}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax; Secure`}
};
function safeStorage(){try{const t='__sb__'+Math.random();localStorage.setItem(t,'1');localStorage.removeItem(t);return localStorage}catch{return cookieStorage}}
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:false,storage:safeStorage(),storageKey:'sb-memo-auth'}
});

/* ========= çŠ¶æ€ & DOM ========= */
let session=null, syncing=0, dirty=false;
let serverCache = ''; // æœ€è¿‘ä¸€æ¬¡äº‘ç«¯å†…å®¹ï¼Œç”¨äºå†²çªæç¤º
const $=id=>document.getElementById(id);
const els={
  app:$('app'),guest:$('guestCard'),memo:$('memoInput'),
  save:$('saveBtn'),clear:$('clearBtn'),copy:$('copyBtn'),
  refresh:$('refreshBtn'),sync:$('syncState'),account:$('accountBtn'),
  modal:$('modal'),backdrop:$('modalBackdrop'),close:$('modalClose'),
  title:$('dialogTitle'),body:$('dialogBody'),
  toast:document.getElementById('toastWrap'),
  conflict:$('conflictBar'), useCloud:$('useCloud'), appendCloud:$('appendCloud')
};
const toast=(m,t='ok',ms=1600)=>{const n=document.createElement('div');n.className='toast '+(t==='error'?'err':'ok');n.textContent=m;els.toast.appendChild(n);setTimeout(()=>{n.style.transition='opacity .35s';n.style.opacity='0'},ms);setTimeout(()=>n.remove(),ms+400)};
function setSync(v){
  syncing += v ? 1 : -1; if (syncing < 0) syncing = 0;
  els.sync.style.display = syncing > 0 ? '' : 'none';
  if (v) setTimeout(() => { if (syncing > 0) { syncing = 0; els.sync.style.display = 'none'; } }, 15000);
}

/* ========= è‰ç¨¿ï¼šæœ¬åœ°æŒä¹…åŒ–ï¼ˆlocalStorageï¼‰ ========= */
const draftKey = ()=> {
  const uid = session?.user?.id || 'guest';
  return `memo-draft:${uid}`;
};
const hasDraft   = ()=>{ try{return !!localStorage.getItem(draftKey())}catch{return false}};
const readDraft  = ()=>{ try{const t=localStorage.getItem(draftKey()); return t?JSON.parse(t):null}catch{return null}};
const writeDraft = ()=>{ try{localStorage.setItem(draftKey(), JSON.stringify({content: els.memo.value || '', ts: Date.now()}));}catch{} };
const clearDraft = ()=>{ try{localStorage.removeItem(draftKey())}catch{} };

function markDirty(){ dirty = true; writeDraft(); showConflictIfNeeded(); }
function restoreDraft(tip=true){
  const d = readDraft();
  if(d && typeof d.content === 'string' && d.content !== els.memo.value){
    els.memo.value = d.content;
    dirty = true;
    if(tip) toast('å·²æ¢å¤æœ¬åœ°è‰ç¨¿ï¼ˆæœªè¦†ç›–äº‘ç«¯ï¼‰');
    showConflictIfNeeded();
    return true;
  }
  return false;
}

/* ========= å†²çªæç¤º ========= */
function showConflictIfNeeded(){
  // ä¸æœ€è¿‘äº‘ç«¯å†…å®¹ä¸åŒä¸”æœ‰ä¼šè¯æ—¶æ‰æç¤º
  const conflict = session && els.memo.value !== (serverCache || '');
  els.conflict.style.display = conflict ? 'flex' : 'none';
}

/* ========= æ¨¡æ€ï¼ˆç™»å½• / æ³¨å†Œ / è´¦æˆ·ï¼‰ ========= */
let lastFocus=null;
function openModal(title,html){
  els.title.textContent=title;els.body.innerHTML=html;
  lastFocus=document.activeElement;els.modal.classList.add('show');els.modal.removeAttribute('aria-hidden');
  document.body.style.overflow='hidden';
  const f=els.body.querySelector('input,button');if(f)setTimeout(()=>f.focus(),0);
}
function closeModal(){
  els.modal.classList.remove('show');els.modal.setAttribute('aria-hidden','true');document.body.style.overflow='';
  if(lastFocus)lastFocus.focus();
}
els.backdrop.onclick=closeModal;els.close.onclick=closeModal;
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&els.modal.classList.contains('show'))closeModal()});

function showAuth(){
  openModal('ç™»å½• / æ³¨å†Œ', `
    <div class="field"><label>é‚®ç®±</label><input id="em" type="email" placeholder="you@example.com"></div>
    <div class="field"><label>å¯†ç ï¼ˆâ‰¥6ä½ï¼‰</label><input id="pw" type="password" placeholder="******"></div>
    <div class="row" style="gap:8px;justify-content:flex-end"><button id="lg" class="btn">ç™»å½•</button><button id="sg" class="btn secondary">æ³¨å†Œ</button></div>
    <div id="hint" class="muted" style="margin-top:6px"></div>
  `);
  const hint=document.getElementById('hint');
  document.getElementById('lg').onclick=async()=>{
    const email=document.getElementById('em').value.trim(),password=document.getElementById('pw').value;
    if(!email||!password) return hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
    setSync(true);
    try{
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ hint.textContent='ç™»å½•å¤±è´¥ï¼š'+error.message; }
      else { hint.textContent=''; toast('ç™»å½•æˆåŠŸ'); closeModal(); fetchMemo({mode:'overwrite', tip:true}).then(()=>restoreDraft(false)); }
    }catch(err){ hint.textContent='ç™»å½•å¼‚å¸¸ï¼š'+(err?.message||err); }
    finally{ setSync(false); }
  };
  document.getElementById('sg').onclick=async()=>{
    const email=document.getElementById('em').value.trim(),password=document.getElementById('pw').value;
    if(!email||!password) return hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
    setSync(true);
    try{
      const { error } = await sb.auth.signUp({ email, password });
      hint.textContent = error ? ('æ³¨å†Œå¤±è´¥ï¼š'+error.message) : 'æ³¨å†ŒæˆåŠŸã€‚å¦‚å¼€å¯é‚®ç®±éªŒè¯ï¼Œè¯·åˆ°é‚®ç®±ç¡®è®¤åå†ç™»å½•ã€‚';
    }catch(err){ hint.textContent='æ³¨å†Œå¼‚å¸¸ï¼š'+(err?.message||err); }
    finally{ setSync(false); }
  };
}
function showAccount(u){
  openModal('è´¦æˆ·', `
    <div class="field"><div class="muted">é‚®ç®±ï¼š${u.email||''}</div></div>
    <div class="row" style="gap:8px;justify-content:flex-end"><button id="lo" class="btn">é€€å‡ºç™»å½•</button></div>
  `);
  document.getElementById('lo').onclick=async()=>{ setSync(true); try{ await sb.auth.signOut(); toast('æ‚¨å·²é€€å‡ºç™»å½•'); closeModal(); applySessionUI(); } finally{ setSync(false);} };
}
els.account.onclick=()=>{session?.user?showAccount(session.user):showAuth()};

/* ========= è¯»å†™å¤‡å¿˜å½•ï¼ˆå«è‰ç¨¿åˆå¹¶ç­–ç•¥ï¼‰ ========= */
async function fetchMemo({ mode='auto', tip=false } = {}){
  if(!session){ els.memo.value=''; serverCache=''; showConflictIfNeeded(); return; }
  setSync(true);
  try{
    const { data, error } = await sb.from(TABLE).select('id, content').eq('user_id', session.user.id).limit(1).maybeSingle();
    if(error){ toast('æ‹‰å–å¤±è´¥ï¼š'+error.message,'error'); return; }
    const content = data?.content || '';
    serverCache = content;
    // åˆå¹¶ç­–ç•¥
    if(mode === 'overwrite'){
      // ç”¨äº‘ç«¯å¡«å……ï¼Œä½†å¦‚æœæœ‰è‰ç¨¿ï¼Œç¨å restoreDraft() ä¼šæŠŠæœ¬åœ°è¦†ç›–å›æ¥
      els.memo.value = content;
      dirty = false;
    }else{
      // auto / mergeï¼šä¿ç•™æœ¬åœ°è¾“å…¥ï¼Œä¸è¦†ç›–ï¼›åªæç¤ºå†²çª
      if(!dirty && !hasDraft()){
        // åªæœ‰åœ¨æœ¬åœ°â€œå¹²å‡€â€æ—¶æ‰è¦†ç›– UI
        els.memo.value = content;
      }
      // å¦‚æœæœ¬åœ°å’Œäº‘ç«¯ä¸åŒï¼Œå±•ç¤ºå†²çªæ¡
    }
    showConflictIfNeeded();
    if(tip) toast('å·²ä»äº‘ç«¯åŒæ­¥ï¼ˆæœ¬åœ°è‰ç¨¿å·²ä¿ç•™ï¼‰');
  }catch(err){ toast('åŒæ­¥å¼‚å¸¸ï¼š'+(err?.message||err),'error'); }
  finally{ setSync(false); }
}

async function saveMemo(){
  if(!session) return toast('è¯·å…ˆç™»å½•','error');
  const payload = { user_id: session.user.id, content: els.memo.value };
  setSync(true);
  try{
    // å•è¡Œè¦†ç›–å†™å…¥ï¼ˆuser_id å”¯ä¸€ï¼‰ï¼šupsert + onConflict
    const { error } = await sb.from(TABLE).upsert(payload, { onConflict: 'user_id' }).select();
    if(error){ toast('ä¿å­˜å¤±è´¥ï¼š'+error.message,'error'); return; }
    serverCache = els.memo.value;
    dirty = false; clearDraft();
    showConflictIfNeeded();
    toast('âœ… å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯');
  }catch(err){ toast('ä¿å­˜å¼‚å¸¸ï¼š'+(err?.message||err),'error'); }
  finally{ setSync(false); }
}

async function clearMemo(){
  els.memo.value = '';
  markDirty();
  await saveMemo();
}

async function copyMemo(){
  try{
    await navigator.clipboard.writeText(els.memo.value || '');
    toast('ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  }catch(err){
    toast('å¤åˆ¶å¤±è´¥ï¼š'+(err?.message||err),'error');
  }
}

/* ========= ç»‘å®šäº‹ä»¶ ========= */
// è¾“å…¥ -> æ ‡è®°è„ & èŠ‚æµå†™è‰ç¨¿
let draftTimer=null;
els.memo.addEventListener('input', ()=>{
  dirty = true;
  if(draftTimer) clearTimeout(draftTimer);
  draftTimer = setTimeout(()=>{ writeDraft(); showConflictIfNeeded(); }, 250);
});
els.save.onclick = saveMemo;
els.clear.onclick = clearMemo;
els.copy.onclick = copyMemo;
// æ‰‹åŠ¨åˆ·æ–°ï¼šä»…åŒæ­¥äº‘ç«¯ï¼Œä¸è¦†ç›–æœ¬åœ°ï¼Œå¿…è¦æ—¶ç»™å‡ºå†²çªæŒ‰é’®
els.refresh.onclick = ()=> fetchMemo({ mode:'merge', tip:true });

// å†²çªå¤„ç†æŒ‰é’®
els.useCloud.onclick = ()=>{ els.memo.value = serverCache || ''; markDirty(); showConflictIfNeeded(); toast('å·²ç”¨äº‘ç«¯è¦†ç›–å½“å‰æ–‡æœ¬ï¼ˆå°šæœªä¿å­˜ï¼‰'); };
els.appendCloud.onclick = ()=>{ 
  const nl = els.memo.value && !els.memo.value.endsWith('\n') ? '\n' : '';
  els.memo.value = (els.memo.value || '') + nl + (serverCache || '');
  markDirty(); showConflictIfNeeded(); toast('å·²å°†äº‘ç«¯å†…å®¹è¿½åŠ åˆ°æ–‡æœ¬æœ«å°¾ï¼ˆå°šæœªä¿å­˜ï¼‰'); 
};

/* ========= ä¼šè¯ç›‘å¬ & åˆå§‹åŒ– ========= */
sb.auth.onAuthStateChange((_evt,sess)=>{session=sess;applySessionUI(); if(session){ fetchMemo({mode:'overwrite'}).then(()=>restoreDraft(false)); }});

function applySessionUI(){
  els.account.textContent = session?.user?`å·²ç™»å½•ï¼š${session.user.email||'ç”¨æˆ·'}`:'ç™»å½• / æ³¨å†Œ';
  $('app').style.display=session?'':'none';
  $('guestCard').style.display=session?'none':'';
  showConflictIfNeeded();
}

(async function init(){
  const { data } = await sb.auth.getSession();
  session = data.session || null;
  applySessionUI();
  if(session){ await fetchMemo({mode:'overwrite'}); }
  // é¦–æ¬¡è¿›å…¥å°è¯•æ¢å¤è‰ç¨¿ï¼ˆä¼˜å…ˆæœ¬åœ°ï¼‰
  restoreDraft(false);

  /* é¡µé¢å¯è§æ€§ & ç”Ÿå‘½å‘¨æœŸï¼š
     - éšè—/åˆ‡åå°/é”å±ï¼šä¿å­˜è‰ç¨¿
     - è¿”å›/æ¢å¤ï¼ˆbfcache æˆ–åˆ·æ–°ï¼‰ï¼šå°è¯•æ¢å¤è‰ç¨¿ï¼Œå¹¶é‡æ–°å¯¹æ¯”äº‘ç«¯ */
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState === 'hidden'){ writeDraft(); }  // é¡µé¢ä¸å¯è§æ—¶ç«‹å³è½ç›˜
    else { restoreDraft(false); showConflictIfNeeded(); }        // å›åˆ°å‰å°å°è¯•æ¢å¤
  });
  window.addEventListener('pagehide', writeDraft);              // ç§»åŠ¨ç«¯æ›´å¯é 
  window.addEventListener('pageshow', ()=>{ restoreDraft(false); showConflictIfNeeded(); }); // å‰è¿›/åé€€/åˆ·æ–°æ¢å¤
})();
</script>
</body>
</html>
