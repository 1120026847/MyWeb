<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Todo æ¸…å•</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{ --bg:#f7f9fc; --card:#fff; --line:#e5e7eb; --text:#0b1220; --muted:#6b7280;
         --accent:#2563eb; --accent-weak:#eef2ff; --danger:#dc2626; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .container{width:100%;padding:12px 16px}
  .nav{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:clamp(18px,4.5vw,22px)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 4px 24px rgba(0,0,0,.06)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  input,button,textarea{border:1px solid var(--line);border-radius:10px;padding:10px 12px;font:inherit;outline:none} /* æ–°å¢ textarea */
  input:focus,button:focus,textarea:focus{border-color:var(--accent)} /* æ–°å¢ textarea */
  .btn{background:var(--accent);color:#fff;border:none}
  .btn.secondary{background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe}
  .btn.danger{background:var(--danger)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .tabs{display:flex;gap:8px;background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:4px}
  .tab{padding:6px 12px;border-radius:999px;border:0;background:transparent;cursor:pointer}
  .tab.active{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.06);border:1px solid var(--line)}
  .add-wrap{display:flex;gap:10px}
  .add-wrap input{flex:1;min-width:200px}
  .list{margin-top:12px;display:grid;gap:10px}
  .item{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px; cursor: pointer;} /* æ–°å¢ cursor:pointer */
  .item:hover{background-color: #f9fafb;} /* æ–°å¢ hover æ•ˆæœ */
  .item.done .title{color:#94a3b8;text-decoration:line-through}
  .title{flex:1;min-width:120px}
  .item-buttons{display: flex; gap: 6px;} /* æ–°å¢ï¼šç”¨äºåŒ…è£¹æŒ‰é’® */
  input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent); cursor: pointer;} /* æ–°å¢ cursor:pointer */
  .account{margin-left:auto}
  .account-btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent-weak);color:#1e3a8a;
               border:1px solid #c7d2fe;padding:8px 12px;border-radius:999px;font-weight:600;max-width:70vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* Toast */
  .toast-wrap{position:fixed;top:16px;left:0;right:0;display:flex;justify-content:center;z-index:20000;pointer-events:none}
  .toast{pointer-events:auto;background:#111827;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 28px rgba(0,0,0,.25);opacity:.98}
  .toast.ok{background:#065f46}.toast.err{background:#7f1d1d}
  /* åŒæ­¥æç¤º */
  .sync{display:inline-flex;align-items:center;gap:8px}
  .spinner{width:14px;height:14px;border:2px solid #cfe3ff;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* æ¨¡æ€ï¼ˆç™»å½•/æ³¨å†Œ/è´¦æˆ·ï¼‰ */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000}
  .modal.show{display:flex}
  .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(1.2) blur(1.5px)}
  .dialog{position:relative;width:520px;max-width:92vw;background:#fff;border-radius:16px;border:1px solid var(--line);
          box-shadow:0 20px 60px rgba(0,0,0,.25);padding:16px}
  .dialog h3{margin:0 0 12px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .hint{font-size:12px;color:var(--muted)}
  .dialog .row{justify-content:flex-end}
  .close-x{position:absolute;right:10px;top:8px;background:transparent;border:0;font-size:18px;cursor:pointer}
  /* æ‰‹æœºç«¯æ›´ç´§å‡‘ + iOS é˜²ç¼©æ”¾ */
  @media (max-width: 640px){
    .add-wrap{display:grid;grid-template-columns:1fr auto;column-gap:8px;row-gap:8px;align-items:center}
    .add-wrap input{min-width:0;width:100%;height:44px;line-height:44px;font-size:16px;padding:10px 12px}
    .add-wrap .btn{height:44px;padding:10px 12px}
    .tabs{grid-column:1/-1;justify-content:center;padding:2px}
    .tab{font-size:12.5px;padding:4px 10px;min-height:40px;line-height:1}
    .item{padding:10px}
  }
  @media (max-width: 400px){ .tab{padding:3px 8px;font-size:12px} }
</style>
</head>
<body>
<header>
  <div class="container nav">
    <h1>Todo æ¸…å•</h1>
    <div class="account"><button id="accountBtn" class="account-btn">ç™»å½• / æ³¨å†Œ</button></div>
  </div>
</header>

<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<main class="container" id="app" style="display:none">
  <div class="card">
    <div class="add-wrap">
      <input id="newTodo" type="text" placeholder="è¾“å…¥æ–°ä»»åŠ¡ï¼Œå¦‚ï¼šå­¦ä¹  30 åˆ†é’Ÿè‹±è¯­" />
      <button id="addBtn" class="btn">æ·»åŠ </button>
      <div class="right tabs" role="tablist" aria-label="ç­›é€‰">
        <button class="tab active" data-filter="all">å…¨éƒ¨</button>
        <button class="tab" data-filter="active">å¾…å®Œæˆ</button>
        <button class="tab" data-filter="completed">å·²å®Œæˆ</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div id="summary" class="muted">â€”</div>
      <div class="right sync">
        <div id="syncState" class="muted" style="display:none"><span class="spinner"></span> æ­£åœ¨åŒæ­¥â€¦</div>
        <button id="exportBtn" class="btn secondary">å¯¼å‡ºä¸º CSV</button>
        <button id="refreshBtn" class="btn secondary">åˆ·æ–°</button>
        <button id="clearCompleted" class="btn secondary">æ¸…ç©ºå·²å®Œæˆ</button>
      </div>
    </div>
  </div>
  <div id="list" class="list" style="margin-top:12px"></div>
</main>

<div class="container" id="guestCard">
  <div class="card">
    <div class="row"><strong>è¯·å…ˆç™»å½•</strong><span class="muted">ç‚¹å‡»å³ä¸Šè§’ã€Œç™»å½• / æ³¨å†Œã€è¿›å…¥ä½ çš„è´¦æˆ·</span></div>
  </div>
</div>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-hidden="true">
  <div class="backdrop" id="modalBackdrop"></div>
  <div class="dialog" role="document">
    <button class="close-x" id="modalClose" aria-label="å…³é—­">âœ•</button>
    <h3 id="dialogTitle">ç™»å½• / æ³¨å†Œ</h3>
    <div id="dialogBody"></div>
  </div>
</div>

<script>
/* ========= ä½ çš„ Supabase é…ç½® ========= */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

const { createClient } = supabase;

/* ========= SafeStorageï¼šlocalStorage å¯ç”¨å°±ç”¨ï¼›å¦åˆ™å›é€€ Cookie ========= */
/* è¯´æ˜ï¼šsupabase-js é»˜è®¤ç”¨ localStorage æŒä¹…åŒ–ä¼šè¯ï¼›å½“ç¯å¢ƒä¸æ”¯æŒæ—¶éœ€è‡ªå®šä¹‰ storageã€‚ */
const cookieStorage = {
  getItem: (key) => {
    const m = document.cookie.match(new RegExp('(?:^|; )' + encodeURIComponent(key) + '=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : null;
  },
  setItem: (key, value) => {
    const expires = new Date(); expires.setFullYear(expires.getFullYear() + 1);
    document.cookie = `${encodeURIComponent(key)}=${encodeURIComponent(value)}; Path=/; Expires=${expires.toUTCString()}; SameSite=Lax; Secure`;
  },
  removeItem: (key) => {
    document.cookie = `${encodeURIComponent(key)}=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax; Secure`;
  }
};
function makeSafeStorage(){
  try{
    const t='__sb_test__'+Math.random();
    window.localStorage.setItem(t,'1');
    window.localStorage.removeItem(t);
    return window.localStorage;      // æ­£å¸¸ç”¨ localStorage
  }catch(e){
    return cookieStorage;            // å—é™ç¯å¢ƒå›é€€åˆ° Cookie
  }
}
const SAFE_STORAGE = makeSafeStorage();

/* æ˜¾å¼æŒ‡å®š auth é€‰é¡¹ï¼ˆæŒä¹…åŒ–+è‡ªåŠ¨åˆ·æ–°+è‡ªå®šä¹‰ storageKeyï¼‰ */
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,      // é»˜è®¤å³ä¸º trueï¼Œè¿™é‡Œæ˜¾å¼å£°æ˜ã€‚
    autoRefreshToken: true,
    detectSessionInUrl: false, // æœªä½¿ç”¨ OAuth å›è°ƒï¼Œå¯å…³é—­
    storage: SAFE_STORAGE,     // å…³é”®ï¼šè‡ªå®šä¹‰å­˜å‚¨é€‚é…å™¨
    storageKey: 'sb-todo-auth' // é¿å…ä¸åŒåŸŸå…¶ä»–é¡¹ç›®é”®åå†²çª
  }
});

/* ========= çŠ¶æ€ ========= */
let session = null;
let todos = [];
let currentFilter = 'all';
let syncing = 0;

/* ========= DOM ========= */
const $ = (id)=>document.getElementById(id);
const els = {
  app: $('app'), guestCard: $('guestCard'), list: $('list'),
  newTodo: $('newTodo'), addBtn: $('addBtn'), summary: $('summary'),
  clearCompleted: $('clearCompleted'), refreshBtn: $('refreshBtn'),
  exportBtn: $('exportBtn'), // æ–°å¢
  tabs: Array.from(document.querySelectorAll('.tab')),
  accountBtn: $('accountBtn'),
  toastWrap: $('toastWrap'), syncState: $('syncState'),
  modal: $('modal'), modalBackdrop: $('modalBackdrop'),
  modalClose: $('modalClose'), dialogBody: $('dialogBody'), dialogTitle: $('dialogTitle')
};

/* ========= å·¥å…· ========= */
const toast = (msg, type='ok', ms=1600)=>{
  const t = document.createElement('div');
  t.className = 'toast ' + (type==='error' ? 'err':'ok');
  t.textContent = msg;
  els.toastWrap.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .35s'; t.style.opacity='0'; }, ms);
  setTimeout(()=> t.remove(), ms+400);
};
const setSyncing = (on)=>{ syncing += on ? 1 : -1; if (syncing<0) syncing=0; els.syncState.style.display = syncing>0 ? '' : 'none'; };
const renderSummary = ()=>{
  const all = todos.length, done = todos.filter(t=>t.completed).length, left = all - done;
  els.summary.textContent = `å…± ${all} é¡¹ Â· å¾…å®Œæˆ ${left} Â· å·²å®Œæˆ ${done}`;
};
/* ç«‹å³åˆ‡æ¢ UIï¼ˆä¸ç­‰ç½‘ç»œï¼‰ï¼Œé¿å…â€œå·²ç™»å½•ä½†å¡ç‰‡æœªéšè—â€çš„è§†è§‰å»¶è¿Ÿ */
function applySessionUI(){
  els.accountBtn.textContent = session?.user ? `å·²ç™»å½•ï¼š${session.user.email||'ç”¨æˆ·'}` : 'ç™»å½• / æ³¨å†Œ';
  els.app.style.display = session ? '' : 'none';
  els.guestCard.style.display = session ? 'none' : '';
}

/* ========= æ¨¡æ€ ========= */
let lastFocus = null;
function openModal(title, html){
  els.dialogTitle.textContent = title || 'å¯¹è¯æ¡†';
  els.dialogBody.innerHTML = html || '';
  lastFocus = document.activeElement;
  els.modal.classList.add('show'); els.modal.removeAttribute('aria-hidden'); document.body.style.overflow='hidden';
  const first = els.dialogBody.querySelector('input,button,select,textarea'); if (first) setTimeout(()=>first.focus(),0);
}
function closeModal(){
  els.modal.classList.remove('show'); els.modal.setAttribute('aria-hidden','true'); document.body.style.overflow='';
  if (lastFocus) lastFocus.focus();
}
els.modalBackdrop.onclick = closeModal; els.modalClose.onclick = closeModal;
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && els.modal.classList.contains('show')) closeModal(); });

/* ========= è´¦å· UI ========= */
function showAuthModal(){
  openModal('ç™»å½• / æ³¨å†Œ', `
    <div class="field">
      <label class="hint">é‚®ç®±</label>
      <input id="authEmail" type="email" placeholder="you@example.com" style="font-size:16px">
    </div>
    <div class="field">
      <label class="hint">å¯†ç ï¼ˆâ‰¥6ä½ï¼‰</label>
      <input id="authPassword" type="password" placeholder="******" style="font-size:16px">
    </div>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <button id="btnDoLogin" class="btn">ç™»å½•</button>
      <button id="btnDoSignup" class="btn secondary">æ³¨å†Œ</button>
    </div>
    <div id="authHint" class="hint" style="margin-top:6px"></div>
  `);
  const hint = $('authHint');
  $('btnDoLogin').onclick = async ()=>{
    const email = $('authEmail').value.trim(), password = $('authPassword').value;
    if(!email || !password) return hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) hint.textContent = 'ç™»å½•å¤±è´¥ï¼š' + error.message;
    else { hint.textContent=''; toast('ç™»å½•æˆåŠŸ'); closeModal(); }
  };
  $('btnDoSignup').onclick = async ()=>{
    const email = $('authEmail').value.trim(), password = $('authPassword').value;
    if(!email || !password) return hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
    const { error } = await sb.auth.signUp({ email, password });
    hint.textContent = error ? ('æ³¨å†Œå¤±è´¥ï¼š' + error.message) : 'æ³¨å†ŒæˆåŠŸã€‚å¦‚å¼€å¯é‚®ç®±éªŒè¯ï¼Œè¯·åˆ°é‚®ç®±å®Œæˆç¡®è®¤åå†ç™»å½•ã€‚';
  };
}
function showAccountModal(user){
  openModal('è´¦æˆ·', `
    <div class="field"><div class="hint">é‚®ç®±ï¼š${user.email||''}</div></div>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <button id="btnLogout" class="btn">é€€å‡ºç™»å½•</button>
    </div>
  `);
  $('btnLogout').onclick = async ()=>{ await sb.auth.signOut(); toast('æ‚¨å·²é€€å‡ºç™»å½•'); closeModal(); };
}
$('accountBtn').onclick = ()=>{ session?.user ? showAccountModal(session.user) : showAuthModal(); };

// æ–°å¢ï¼šæ˜¾ç¤ºä»»åŠ¡å¤‡æ³¨/è¯¦æƒ…çš„æ¨¡æ€æ¡†
function showNotesModal(todo) {
  openModal('ä»»åŠ¡å¤‡æ³¨ / è¯¦æƒ…', `
    <div class="field">
      <label class="hint">ä»»åŠ¡åç§°</label>
      <p style="margin:0; padding: 8px 12px; background: #f3f4f6; border-radius: 8px;">${todo.title.replace(/</g,'&lt;')}</p>
    </div>
    <div class="field">
      <label class="hint">å¤‡æ³¨ï¼ˆå¯å¡«å†™å®Œæˆæƒ…å†µç­‰ï¼‰</label>
      <textarea id="todoNotes" rows="5" style="font-size: 15px; padding: 10px 12px;">${todo.notes ? todo.notes.replace(/</g,'&lt;') : ''}</textarea>
    </div>
    <div class="row">
      <button id="saveNotesBtn" class="btn">ä¿å­˜å¤‡æ³¨</button>
    </div>
  `);
  $('saveNotesBtn').onclick = async () => {
    const newNotes = $('todoNotes').value;
    await updateNotes(todo, newNotes);
    closeModal();
  };
}

/* ========= æ•°æ®ï¼šCRUD + åé¦ˆ ========= */
async function fetchTodos(showToast=false){
  if(!session){ todos=[]; render(); return; }
  setSyncing(true);
  const { data, error } = await sb.from('todos').select('*').eq('user_id', session.user.id).order('created_at', {ascending:false});
  setSyncing(false);
  if(error){ toast('æ‹‰å–å¤±è´¥ï¼š'+error.message,'error'); return; }
  todos = data || []; render(); if(showToast) toast('å·²ä»äº‘ç«¯åŒæ­¥');
}
async function addTodo(title){
  if(!session) return toast('è¯·å…ˆç™»å½•','error');
  title = (title||'').trim(); if(!title) return;
  els.addBtn.disabled = true; setSyncing(true);
  // ä¿®æ”¹ï¼šæ’å…¥æ•°æ®æ—¶ï¼Œå¢åŠ  notes å­—æ®µ
  const { error } = await sb.from('todos').insert({ user_id: session.user.id, title, completed:false, notes: '' });
  setSyncing(false); els.addBtn.disabled = false;
  if(error) return toast('æ·»åŠ å¤±è´¥ï¼š'+error.message,'error');
  els.newTodo.value=''; await fetchTodos(); toast('âœ… å·²æ·»åŠ å¹¶åŒæ­¥åˆ°äº‘ç«¯');
}
async function toggleTodo(todo, el){
  if(!session) return; el.disabled = true; setSyncing(true);
  const { error } = await sb.from('todos').update({ completed: !todo.completed }).eq('id', todo.id);
  setSyncing(false); el.disabled = false;
  if(error) return toast('æ›´æ–°å¤±è´¥ï¼š'+error.message,'error');
  await fetchTodos(); toast(todo.completed ? 'å·²æ¢å¤ä¸ºå¾…å®Œæˆï¼ˆå·²åŒæ­¥ï¼‰' : 'å·²å®Œæˆï¼ˆå·²åŒæ­¥ï¼‰');
}
async function renameTodo(todo, newTitle){
  newTitle = newTitle.trim(); if(!newTitle || newTitle===todo.title) return;
  setSyncing(true); const { error } = await sb.from('todos').update({ title:newTitle }).eq('id', todo.id);
  setSyncing(false); if(error) return toast('é‡å‘½åå¤±è´¥ï¼š'+error.message,'error');
  await fetchTodos(); toast('åç§°å·²æ›´æ–°å¹¶åŒæ­¥');
}
// æ–°å¢ï¼šæ›´æ–°å¤‡æ³¨çš„å‡½æ•°
async function updateNotes(todo, newNotes) {
  newNotes = (newNotes || '').trim();
  if (newNotes === (todo.notes || '').trim()) return; // å†…å®¹æœªå˜ï¼Œåˆ™ä¸æ›´æ–°
  setSyncing(true);
  const { error } = await sb.from('todos').update({ notes: newNotes }).eq('id', todo.id);
  setSyncing(false);
  if (error) return toast('å¤‡æ³¨æ›´æ–°å¤±è´¥ï¼š' + error.message, 'error');
  await fetchTodos();
  toast('å¤‡æ³¨å·²ä¿å­˜å¹¶åŒæ­¥');
}
async function removeTodo(todo, btn){
  btn.disabled = true; setSyncing(true);
  const { error } = await sb.from('todos').delete().eq('id', todo.id);
  setSyncing(false); btn.disabled = false;
  if(error) return toast('åˆ é™¤å¤±è´¥ï¼š'+error.message,'error');
  await fetchTodos(); toast('ğŸ—‘ï¸ å·²åˆ é™¤å¹¶åŒæ­¥');
}
async function clearCompleted(){
  if(!session) return;
  setSyncing(true);
  const { error } = await sb.from('todos').delete().eq('user_id', session.user.id).eq('completed', true);
  setSyncing(false);
  if(error) return toast('æ¸…ç©ºå¤±è´¥ï¼š'+error.message,'error');
  await fetchTodos(); toast('å·²æ¸…ç©ºå·²å®Œæˆå¹¶åŒæ­¥');
}
// æ–°å¢ï¼šå¯¼å‡ºä¸º CSV çš„åŠŸèƒ½
function exportTodosToCSV() {
  if (todos.length === 0) {
    return toast('æ²¡æœ‰å¯å¯¼å‡ºçš„ä»»åŠ¡', 'info');
  }
  // Helper to escape CSV fields
  const escapeCSV = (field) => {
    if (field === null || field === undefined) field = '';
    const str = String(field);
    // If the field contains a comma, a double quote, or a newline, enclose it in double quotes.
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
      // Escape existing double quotes by doubling them
      return `"${str.replace(/"/g, '""')}"`;
    }
    return str;
  };

  const headers = ['ä»»åŠ¡åç§°', 'æ˜¯å¦å®Œæˆ', 'å¤‡æ³¨'];
  const rows = todos.map(t => [
    escapeCSV(t.title),
    t.completed ? 'æ˜¯' : 'å¦',
    escapeCSV(t.notes)
  ].join(','));
  
  const csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n' + rows.join('\n');
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  const date = new Date().toISOString().split('T')[0];
  link.setAttribute("download", `todos-export-${date}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  toast('ä»»åŠ¡å·²å¼€å§‹å¯¼å‡º');
}


/* ========= æ¸²æŸ“ ========= */
// æ–°å¢ï¼šä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºå°†æ ‡é¢˜å˜ä¸ºå¯ç¼–è¾‘çŠ¶æ€
function makeTitleEditable(todo, titleEl) {
    const row = titleEl.parentElement;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = todo.title;
    input.style.width = '100%';
    input.style.flex = '1';

    input.onblur = () => renameTodo(todo, input.value);
    input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); };
    
    row.replaceChild(input, titleEl);
    input.focus();
    input.select();
}

function render(){
  renderSummary();
  els.tabs.forEach(btn=>btn.classList.toggle('active', btn.dataset.filter===currentFilter));
  els.list.innerHTML = '';
  const frag = document.createDocumentFragment();
  for(const t of todos.filter(it=>{
    if(currentFilter==='active') return !it.completed;
    if(currentFilter==='completed') return it.completed;
    return true;
  })){
    const row = document.createElement('div');
    row.className = 'item' + (t.completed ? ' done' : '');
    
    // ä¿®æ”¹ï¼šinnerHTML ç»“æ„ï¼Œå¢åŠ äº†ä¿®æ”¹æŒ‰é’®å’ŒæŒ‰é’®å®¹å™¨
    row.innerHTML = `
      <input type="checkbox" ${t.completed?'checked':''} aria-label="å®Œæˆ">
      <div class="title" title="åŒå‡»å¯é‡å‘½å">${t.title.replace(/</g,'&lt;')}</div>
      <div class="item-buttons">
        <button class="btn secondary edit-btn">ä¿®æ”¹</button>
        <button class="btn danger remove-btn">åˆ é™¤</button>
      </div>
    `;

    // ä¿®æ”¹ï¼šäº‹ä»¶ç›‘å¬é€»è¾‘
    const chk = row.querySelector('input[type="checkbox"]');
    const titleEl = row.querySelector('.title');
    const editBtn = row.querySelector('.edit-btn');
    const delBtn = row.querySelector('.remove-btn');

    // æ•´ä¸ªä»»åŠ¡é¡¹çš„ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºå¼¹å‡ºå¤‡æ³¨æ¨¡æ€æ¡†
    row.onclick = (e) => {
      // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯æŒ‰é’®æˆ–å¤é€‰æ¡†ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸è§¦å‘å¤‡æ³¨å¼¹çª—
      if (e.target === chk || e.target === editBtn || e.target === delBtn) {
        return;
      }
      showNotesModal(t);
    };

    chk.onchange = ()=>toggleTodo(t, chk);
    titleEl.ondblclick = ()=> makeTitleEditable(t, titleEl);
    editBtn.onclick = ()=> makeTitleEditable(t, titleEl);
    delBtn.onclick = ()=>removeTodo(t, delBtn);
    
    frag.appendChild(row);
  }
  els.list.appendChild(frag);
}

/* ========= äº‹ä»¶ ========= */
els.addBtn.onclick = ()=>addTodo(els.newTodo.value);
els.newTodo.onkeydown = (e)=>{ if(e.key==='Enter') addTodo(els.newTodo.value); };
els.clearCompleted.onclick = clearCompleted;
els.refreshBtn.onclick = ()=>fetchTodos(true);
els.tabs.forEach(btn=> btn.onclick = ()=>{ currentFilter = btn.dataset.filter; render(); });
els.exportBtn.onclick = exportTodosToCSV; // æ–°å¢

/* ========= è®¤è¯ç›‘å¬ & åˆå§‹åŒ– ========= */
/* ç›‘å¬ç™»å½•/é€€å‡º â†’ ç«‹åˆ»åˆ‡ UIï¼Œç„¶åæ‹‰æ•°æ®ï¼ˆé¿å…æ…¢ç½‘æ—¶ UI ä¸æ›´æ–°ï¼‰ */
sb.auth.onAuthStateChange((_evt, sess)=>{
  session = sess;
  applySessionUI();   // ç«‹åˆ»åˆ‡æ¢ UI
  fetchTodos();       // ç„¶åæ‹‰å–äº‘ç«¯
});

(async function init(){
  const { data } = await sb.auth.getSession(); // è¯»å–æŒä¹…åŒ–ä¼šè¯
  session = data.session || null;
  applySessionUI();   // é¦–å±æŒ‰ä¼šè¯æ˜¾ç¤º
  await fetchTodos(); // å¦‚å·²ç™»å½•ï¼Œæ‹‰ä¸€æ¬¡æ•°æ®
})();
</script>
</body>
</html>
