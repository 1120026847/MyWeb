<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Todo æ¸…å•</title>

<!-- Supabase v2 UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --line:#e5e7eb; --text:#0b1220; --muted:#6b7280;
    --accent:#2563eb; --accent-weak:#eef2ff; --danger:#dc2626; --ok:#16a34a;
    --radius:12px; --gap:12px; --pad:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .container{width:100%;padding:12px 16px}
  .nav{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:clamp(18px,4.5vw,22px);letter-spacing:.4px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 4px 24px rgba(0,0,0,.06)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  input,button{border:1px solid var(--line);border-radius:10px;padding:10px 12px;font:inherit;outline:none}
  input:focus,button:focus{border-color:var(--accent)}
  .btn{background:var(--accent);color:#fff;border:none}
  .btn.secondary{background:var(--accent-weak);color:#1e3a8a;border:1px solid #c7d2fe}
  .btn.ghost{background:transparent}
  .btn.danger{background:var(--danger)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .tabs{display:flex;gap:8px;background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:4px}
  .tab{padding:6px 12px;border-radius:999px;border:0;background:transparent;cursor:pointer}
  .tab.active{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.06);border:1px solid var(--line)}
  .add-wrap{display:flex;gap:10px}
  .add-wrap input{flex:1;min-width:200px}
  .list{margin-top:12px;display:grid;gap:10px}
  .item{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  .item.done .title{color:#94a3b8;text-decoration:line-through}
  .title{flex:1;min-width:120px}
  .actions{display:flex;gap:8px}
  input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent)}
  /* è´¦å·èœå• */
  .account{margin-left:auto;position:relative}
  .account-btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent-weak);color:#1e3a8a;
               border:1px solid #c7d2fe;padding:8px 12px;border-radius:999px;font-weight:600;max-width:70vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .dropdown{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid var(--line);
            border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.08);padding:12px;width:320px;max-width:90vw;display:none}
  .dropdown.open{display:block}
  .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
  .hint{font-size:12px;color:var(--muted)}
  /* Toast */
  .toast-wrap{position:fixed;top:16px;left:0;right:0;display:flex;justify-content:center;z-index:50;pointer-events:none}
  .toast{pointer-events:auto;background:#111827;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 28px rgba(0,0,0,.25);opacity:.98}
  .toast.ok{background:#065f46}.toast.err{background:#7f1d1d}
  /* åŒæ­¥å°èŠèŠ± */
  .sync{display:inline-flex;align-items:center;gap:8px}
  .spinner{width:14px;height:14px;border:2px solid #cfe3ff;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ===== æ‰‹æœºç«¯ç´§å‡‘æ¨¡å¼ï¼šè¾“å…¥æ›´å¤§ã€ç­›é€‰æ›´å° ===== */
  @media (max-width: 640px) {
    .add-wrap{
      display: grid;
      grid-template-columns: 1fr auto;
      column-gap: 8px; row-gap: 8px; align-items:center;
    }
    .add-wrap input{
      min-width: 0; width:100%;
      height:44px; line-height:44px; font-size:16px; /* é˜² iOS è‡ªåŠ¨æ”¾å¤§ */
      padding:10px 12px;
    }
    .add-wrap .btn{height:44px;padding:10px 12px}
    .add-wrap .tabs{
      grid-column: 1 / -1; justify-content:center; padding:2px;
    }
    .tab{font-size:12.5px;padding:4px 10px;min-height:40px;line-height:1}
    .item{padding:10px}
  }
  @media (max-width: 400px){
    .tab{padding:3px 8px;font-size:12px}
  }
</style>
</head>
<body>
<header>
  <div class="container nav">
    <h1>Todo æ¸…å•</h1>
    <div class="account" id="account">
      <button id="accountBtn" class="account-btn">ç™»å½• / æ³¨å†Œ</button>
      <div id="accountDropdown" class="dropdown" role="menu"></div>
    </div>
  </div>
</header>

<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<main class="container" id="app" style="display:none">
  <div class="card">
    <!-- æ·»åŠ åŒº -->
    <div class="add-wrap">
      <input id="newTodo" type="text" placeholder="è¾“å…¥æ–°ä»»åŠ¡ï¼Œå¦‚ï¼šå­¦ä¹  30 åˆ†é’Ÿè‹±è¯­" />
      <button id="addBtn" class="btn">æ·»åŠ </button>
      <div class="right tabs" role="tablist" aria-label="ç­›é€‰">
        <button class="tab active" data-filter="all">å…¨éƒ¨</button>
        <button class="tab" data-filter="active">å¾…å®Œæˆ</button>
        <button class="tab" data-filter="completed">å·²å®Œæˆ</button>
      </div>
    </div>
    <!-- æ±‡æ€»/æ“ä½œ -->
    <div class="row" style="margin-top:10px">
      <div id="summary" class="muted">â€”</div>
      <div class="right sync">
        <div id="syncState" class="muted" style="display:none"><span class="spinner"></span> æ­£åœ¨åŒæ­¥â€¦</div>
        <button id="refreshBtn" class="btn secondary">åˆ·æ–°</button>
        <button id="clearCompleted" class="btn secondary">æ¸…ç©ºå·²å®Œæˆ</button>
      </div>
    </div>
  </div>

  <!-- åˆ—è¡¨ -->
  <div id="list" class="list" style="margin-top:12px"></div>
</main>

<!-- æœªç™»å½•æç¤º -->
<div class="container" id="guestCard">
  <div class="card">
    <div class="row">
      <strong>è¯·å…ˆç™»å½•</strong>
      <span class="muted">ç‚¹å‡»å³ä¸Šè§’ã€Œç™»å½• / æ³¨å†Œã€è¿›å…¥ä½ çš„è´¦æˆ·</span>
    </div>
  </div>
</div>

<script>
/* ====== ä½ çš„ Supabase é…ç½® ====== */
const SUPABASE_URL = 'https://cvkqzkipgmtzqprqadyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2a3F6a2lwZ210enFwcnFhZHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDMzMDIsImV4cCI6MjA3MzQ3OTMwMn0.I2DygNtjxa324smxKfIBHCOtFmrGQF4kRRkwPv-7VOY';

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // createClient é»˜è®¤æŒä¹…åŒ–ä¼šè¯ã€‚:contentReference[oaicite:0]{index=0}

/* ====== çŠ¶æ€ ====== */
let session = null;
let todos = [];
let currentFilter = 'all';
let syncing = 0; // >0 æ˜¾ç¤ºâ€œæ­£åœ¨åŒæ­¥â€¦â€

/* ====== DOM ====== */
const els = {
  app: document.getElementById('app'),
  guestCard: document.getElementById('guestCard'),
  list: document.getElementById('list'),
  newTodo: document.getElementById('newTodo'),
  addBtn: document.getElementById('addBtn'),
  summary: document.getElementById('summary'),
  clearCompleted: document.getElementById('clearCompleted'),
  refreshBtn: document.getElementById('refreshBtn'),
  tabs: Array.from(document.querySelectorAll('.tab')),
  accountBtn: document.getElementById('accountBtn'),
  accountDropdown: document.getElementById('accountDropdown'),
  toastWrap: document.getElementById('toastWrap'),
  syncState: document.getElementById('syncState'),
};

/* ====== å°å·¥å…· ====== */
const toast = (msg, type='ok', ms=1600)=>{
  const t = document.createElement('div');
  t.className = 'toast ' + (type==='error' ? 'err':'ok');
  t.textContent = msg;
  els.toastWrap.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity .35s'; t.style.opacity='0'; }, ms);
  setTimeout(()=> t.remove(), ms+400);
};
const setSyncing = (on)=>{
  syncing += on ? 1 : -1;
  if (syncing < 0) syncing = 0;
  els.syncState.style.display = syncing > 0 ? '' : 'none';
};
const renderSummary = ()=>{
  const all = todos.length;
  const done = todos.filter(t=>t.completed).length;
  const left = all - done;
  els.summary.textContent = `å…± ${all} é¡¹ Â· å¾…å®Œæˆ ${left} Â· å·²å®Œæˆ ${done}`;
};
const byFilter = (t)=>{
  if (currentFilter==='active') return !t.completed;
  if (currentFilter==='completed') return t.completed;
  return true;
};

/* ====== è´¦å·ä¸‹æ‹‰ ====== */
const closeDropdown = ()=>{ els.accountDropdown.classList.remove('open'); };
const toggleDropdown = ()=>{ els.accountDropdown.classList.toggle('open'); };
document.addEventListener('click', (e)=>{
  const account = document.getElementById('account');
  if (!account.contains(e.target)) closeDropdown();
});
els.accountBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleDropdown(); });

function renderAccountMenu(user){
  if (user){
    els.accountBtn.textContent = `å·²ç™»å½•ï¼š${user.email||'ç”¨æˆ·'}`;
    els.accountDropdown.innerHTML = `
      <div class="field"><div class="hint">é‚®ç®±ï¼š${user.email||''}</div></div>
      <button id="btnLogout" class="btn" style="width:100%">é€€å‡ºç™»å½•</button>
    `;
    document.getElementById('btnLogout').onclick = async ()=>{
      await sb.auth.signOut();
      toast('æ‚¨å·²é€€å‡ºç™»å½•');
      closeDropdown();
    };
  }else{
    els.accountBtn.textContent = 'ç™»å½• / æ³¨å†Œ';
    els.accountDropdown.innerHTML = `
      <div class="field">
        <label class="hint">é‚®ç®±</label>
        <input id="email" type="email" placeholder="you@example.com">
      </div>
      <div class="field">
        <label class="hint">å¯†ç ï¼ˆâ‰¥6ä½ï¼‰</label>
        <input id="password" type="password" placeholder="******">
      </div>
      <div class="row" style="gap:8px">
        <button id="btnLogin" class="btn">ç™»å½•</button>
        <button id="btnSignup" class="btn secondary">æ³¨å†Œ</button>
      </div>
      <div id="authHint" class="hint" style="margin-top:6px"></div>
    `;
    const hint = document.getElementById('authHint');
    document.getElementById('btnLogin').onclick = async ()=>{
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) return hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
      const { error } = await sb.auth.signInWithPassword({ email, password }); // é‚®ç®±+å¯†ç ç™»å½•ã€‚:contentReference[oaicite:1]{index=1}
      if (error) hint.textContent = 'ç™»å½•å¤±è´¥ï¼š' + error.message;
      else { hint.textContent=''; toast('ç™»å½•æˆåŠŸ'); closeDropdown(); }
    };
    document.getElementById('btnSignup').onclick = async ()=>{
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) return hint.textContent='è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
      const { error } = await sb.auth.signUp({ email, password });
      if (error) hint.textContent = 'æ³¨å†Œå¤±è´¥ï¼š' + error.message;
      else hint.textContent = 'æ³¨å†ŒæˆåŠŸã€‚å¦‚é¡¹ç›®å¼€å¯é‚®ç®±éªŒè¯ï¼Œè¯·åˆ°é‚®ç®±å®Œæˆç¡®è®¤åå†ç™»å½•ã€‚';
    };
  }
}

/* ====== æ•°æ®å±‚ï¼ˆCRUD + åé¦ˆ + åŒæ­¥ï¼‰ ====== */
async function fetchTodos(showToast = false){
  if (!session) { todos=[]; render(); return; }
  setSyncing(true);
  const { data, error } = await sb
    .from('todos')
    .select('*')              // é»˜è®¤æœ€å¤š 1000 è¡Œï¼Œå¤Ÿç”¨ï¼›å¯ç”¨ range() åˆ†é¡µã€‚:contentReference[oaicite:2]{index=2}
    .eq('user_id', session.user.id)
    .order('created_at', { ascending:false });
  setSyncing(false);
  if (error) { toast('æ‹‰å–å¤±è´¥ï¼š'+error.message, 'error'); return; }
  todos = data || [];
  render();
  if (showToast) toast('å·²ä»äº‘ç«¯åŒæ­¥');
}

async function addTodo(title){
  if (!session) return toast('è¯·å…ˆç™»å½•','error');
  title = (title||'').trim();
  if (!title) return;
  els.addBtn.disabled = true;
  setSyncing(true);
  const { data, error } = await sb
    .from('todos')
    .insert({ user_id: session.user.id, title, completed:false })
    .select()
    .single(); // insert é»˜è®¤ä¸è¿”å›ï¼Œéœ€è¦ .select().single()ã€‚:contentReference[oaicite:3]{index=3}
  setSyncing(false);
  els.addBtn.disabled = false;
  if (error) return toast('æ·»åŠ å¤±è´¥ï¼š'+error.message, 'error');
  els.newTodo.value = '';
  // ä¸ºé˜²æ­¢å¹¶å‘ï¼Œç›´æ¥å…¨é‡åˆ·æ–°
  await fetchTodos();
  toast('âœ… å·²æ·»åŠ å¹¶åŒæ­¥åˆ°äº‘ç«¯');
}

async function toggleTodo(todo, checkboxEl){
  if (!session) return;
  checkboxEl.disabled = true;
  setSyncing(true);
  const { error } = await sb.from('todos')
    .update({ completed: !todo.completed })
    .eq('id', todo.id);
  setSyncing(false);
  checkboxEl.disabled = false;
  if (error) return toast('æ›´æ–°å¤±è´¥ï¼š'+error.message, 'error');
  await fetchTodos();
  toast(todo.completed ? 'å·²æ¢å¤ä¸ºå¾…å®Œæˆï¼ˆå·²åŒæ­¥ï¼‰' : 'å·²å®Œæˆï¼ˆå·²åŒæ­¥ï¼‰');
}

async function renameTodo(todo, newTitle){
  newTitle = newTitle.trim();
  if (!newTitle || newTitle === todo.title) return;
  setSyncing(true);
  const { error } = await sb.from('todos')
    .update({ title: newTitle })
    .eq('id', todo.id);
  setSyncing(false);
  if (error) return toast('é‡å‘½åå¤±è´¥ï¼š'+error.message, 'error');
  await fetchTodos();
  toast('åç§°å·²æ›´æ–°å¹¶åŒæ­¥');
}

async function removeTodo(todo, btn){
  btn.disabled = true;
  setSyncing(true);
  const { error } = await sb.from('todos').delete().eq('id', todo.id);
  setSyncing(false);
  btn.disabled = false;
  if (error) return toast('åˆ é™¤å¤±è´¥ï¼š'+error.message, 'error');
  await fetchTodos();
  toast('ğŸ—‘ï¸ å·²åˆ é™¤å¹¶åŒæ­¥');
}

async function clearCompleted(){
  if (!session) return;
  setSyncing(true);
  const { error } = await sb.from('todos')
    .delete()
    .eq('user_id', session.user.id)
    .eq('completed', true);
  setSyncing(false);
  if (error) return toast('æ¸…ç©ºå¤±è´¥ï¼š'+error.message, 'error');
  await fetchTodos();
  toast('å·²æ¸…ç©ºå·²å®Œæˆå¹¶åŒæ­¥');
}

/* ====== æ¸²æŸ“åˆ—è¡¨ ====== */
function render(){
  // æ˜¾éš
  document.getElementById('app').style.display = session ? '' : 'none';
  document.getElementById('guestCard').style.display = session ? 'none' : '';
  if (!session){ return; }

  renderSummary();

  // æ ‡ç­¾æ¿€æ´»æ€
  els.tabs.forEach(btn=> btn.classList.toggle('active', btn.dataset.filter===currentFilter));

  // åˆ—è¡¨
  els.list.innerHTML = '';
  const frag = document.createDocumentFragment();
  for (const t of todos.filter(byFilter)){
    const row = document.createElement('div');
    row.className = 'item' + (t.completed ? ' done':'');
    row.innerHTML = `
      <input type="checkbox" ${t.completed?'checked':''} aria-label="å®Œæˆ">
      <div class="title" title="åŒå‡»å¯é‡å‘½å">${t.title.replace(/</g,'&lt;')}</div>
      <div class="actions"><button class="btn danger">åˆ é™¤</button></div>
    `;
    const chk = row.querySelector('input[type="checkbox"]');
    chk.onchange = ()=> toggleTodo(t, chk);

    const titleEl = row.querySelector('.title');
    titleEl.ondblclick = ()=>{
      const input = document.createElement('input');
      input.type = 'text'; input.value = t.title; input.style.width='100%';
      const save = async ()=>{
        await renameTodo(t, input.value);
      };
      input.onblur = save;
      input.onkeydown = (e)=>{ if (e.key==='Enter'){ input.blur(); } };
      row.replaceChild(input, titleEl);
      input.focus(); input.select();
    };

    const del = row.querySelector('.btn.danger');
    del.onclick = ()=> removeTodo(t, del);

    frag.appendChild(row);
  }
  els.list.appendChild(frag);
}

/* ====== äº‹ä»¶ç»‘å®š ====== */
els.addBtn.onclick = ()=> addTodo(els.newTodo.value);
els.newTodo.addEventListener('keydown', (e)=>{ if (e.key==='Enter') addTodo(els.newTodo.value); });
els.clearCompleted.onclick = clearCompleted;
els.refreshBtn.onclick = ()=> fetchTodos(true);
els.tabs.forEach(btn=>{
  btn.onclick = ()=>{ currentFilter = btn.dataset.filter; render(); };
});

/* ====== è®¤è¯ç›‘å¬ä¸åˆå§‹åŒ– ====== */
sb.auth.onAuthStateChange((_evt, sess)=>{
  session = sess;
  renderAccountMenu(sess?.user || null);
  fetchTodos(); // ç›‘å¬å˜åŒ–åæ‹‰ä¸€æ¬¡æ•°æ®ï¼ˆæ³¨æ„ï¼šå›è°ƒé‡Œå°½é‡ä¿æŒè½»é‡ï¼‰ã€‚:contentReference[oaicite:4]{index=4}
});

(async function init(){
  const { data } = await sb.auth.getSession(); // è·å–æŒä¹…åŒ–ä¼šè¯
  session = data.session || null;
  renderAccountMenu(session?.user || null);
  await fetchTodos();
})();
</script>
</body>
</html>
